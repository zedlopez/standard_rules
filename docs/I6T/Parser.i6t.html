<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head><title>Parser</title>
  <style>
li { padding-bottom: .16rem; padding-top: .16rem; }
ul.unloaded { list-style-type: none; margin-top: 0; margin-bottom: 0; padding-left: 1rem; }
details summary { 
  cursor: pointer;
}
a { text-decoration: none;
padding-bottom: .5px;
border-bottom: 1px dotted black;
}
span.th, span.td { display: table-cell; }
span.td { padding-left: 2rem; padding-top: .1rem; padding-bottom: .1rem; }
span.th { width:4rem; text-align: right; }
td { padding-bottom: .16rem; padding-top: .16rem; }
span.tr { display: table-row; }
.pre-lines { font-family: monospace; margin-left: 3rem; line-height: 1.5rem; }
h1 { margin: 0; }
.fixed { font-family: monospace; background-color: #e7e7d7; }
.em { font-style: italic; }
.center { text-align: center; }
    body { font-family: sans-serif; margin: .75rem 0 3rem 3rem; background-color: #fafaf0; width: 80rem; }
    .pre { font-family: monospace; margin: auto; width: 80rem; }
#front_matter,.text { width: 48rem; }
/* h3 { margin-top: 1.5rem; padding-top: 1.5rem; }*/
.text { border-bottom: .5px solid black; border-top: .5px solid black; margin-top: 1rem;
padding-bottom: .5rem; margin-bottom: 1.5rem; margin-top: 1.75rem; padding-top: .25rem;}
footer { margin-top: 3rem; padding-top: 1rem; border-top: .5px solid black; margin-bottom: 0;}
/*.subtitle { font-weight: bold; font-size: 1.2rem; }*/
.dstring { font-weight: bold;
  color: #095097; }
.sstring { font-weight: bold;
  color: #095097; }
.comment {  
  color: #156D15; } /* #207D20; */
td.content { padding-right: 2rem; vertical-align: top;}
header { border-bottom: 1px solid black; padding-top: .75rem; padding-bottom: .75rem; margin-bottom: 1rem;}
    </style>
</head>
<body>
<header>
<h1>I6 Template Layer</h1>
<div class="subtitle"><a href="http://inform7.com/">Inform 7 6M62</a> &bull; <a href="./index.html">Contents</a> &bull; <a href="./Introduction.i6t.html">Introduction</a> 
&bull; <a href="fn_index.html">Function Index</a> 
&bull; <a href="rules_index.html">Rules Index</a> 
</div></header>
<div id="front_matter">
<h2><a href="./Parser.i6t.txt">Parser.i6t</a></h2><details><summary>Parser contents</summary><ul class="unloaded"><li><a href="./Parser.i6t.html#parser-grammar-line-variables">Grammar Line Variables</a></li><li><a href="./Parser.i6t.html#parser-grammar-token-variables">Grammar Token Variables</a></li><li><a href="./Parser.i6t.html#parser-match-list-variables">Match List Variables</a></li><li><a href="./Parser.i6t.html#parser-words">Words</a></li><li><a href="./Parser.i6t.html#parser-snippets">Snippets</a></li><li><a href="./Parser.i6t.html#parser-unpacking-grammar-lines">Unpacking Grammar Lines</a></li><li><a href="./Parser.i6t.html#parser-extracting-verb-numbers">Extracting Verb Numbers</a></li><li><a href="./Parser.i6t.html#parser-keyboard-primitive">Keyboard Primitive</a></li><li><a href="./Parser.i6t.html#parser-reading-the-command">Reading the Command</a></li><li><a href="./Parser.i6t.html#parser-parser-proper">Parser Proper</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-a">Parser Letter A</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-b">Parser Letter B</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-c">Parser Letter C</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-d">Parser Letter D</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-e">Parser Letter E</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-f">Parser Letter F</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-g">Parser Letter G</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-h">Parser Letter H</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-i">Parser Letter I</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-j">Parser Letter J</a></li><li><a href="./Parser.i6t.html#parser-parser-letter-k">Parser Letter K</a></li><li><a href="./Parser.i6t.html#parser-end-of-parser-proper">End of Parser Proper</a></li><li><a href="./Parser.i6t.html#parser-internal-rule">Internal Rule</a></li><li><a href="./Parser.i6t.html#parser-parse-token">Parse Token</a></li><li><a href="./Parser.i6t.html#parser-parse-token-letter-a">Parse Token Letter A</a></li><li><a href="./Parser.i6t.html#parser-parse-token-letter-b">Parse Token Letter B</a></li><li><a href="./Parser.i6t.html#parser-parse-token-letter-c">Parse Token Letter C</a></li><li><a href="./Parser.i6t.html#parser-parse-token-letter-d">Parse Token Letter D</a></li><li><a href="./Parser.i6t.html#parser-parse-token-letter-e">Parse Token Letter E</a></li><li><a href="./Parser.i6t.html#parser-parse-token-letter-f">Parse Token Letter F</a></li><li><a href="./Parser.i6t.html#parser-descriptors">Descriptors</a></li><li><a href="./Parser.i6t.html#parser-parsing-descriptors">Parsing Descriptors</a></li><li><a href="./Parser.i6t.html#parser-preposition-chain">Preposition Chain</a></li><li><a href="./Parser.i6t.html#parser-creature">Creature</a></li><li><a href="./Parser.i6t.html#parser-noun-domain">Noun Domain</a></li><li><a href="./Parser.i6t.html#parser-adjudicate">Adjudicate</a></li><li><a href="./Parser.i6t.html#parser-revisemulti">ReviseMulti</a></li><li><a href="./Parser.i6t.html#parser-match-list">Match List</a></li><li><a href="./Parser.i6t.html#parser-scorematchl">ScoreMatchL</a></li><li><a href="./Parser.i6t.html#parser-bestguess">BestGuess</a></li><li><a href="./Parser.i6t.html#parser-singlebestguess">SingleBestGuess</a></li><li><a href="./Parser.i6t.html#parser-identical">Identical</a></li><li><a href="./Parser.i6t.html#parser-print-command">Print Command</a></li><li><a href="./Parser.i6t.html#parser-cantsee">CantSee</a></li><li><a href="./Parser.i6t.html#parser-multiple-object-list">Multiple Object List</a></li><li><a href="./Parser.i6t.html#parser-scope">Scope</a></li><li><a href="./Parser.i6t.html#parser-scope-level-0">Scope Level 0</a></li><li><a href="./Parser.i6t.html#parser-searchscope">SearchScope</a></li><li><a href="./Parser.i6t.html#parser-scopewithin">ScopeWithin</a></li><li><a href="./Parser.i6t.html#parser-doscopeactionandrecurse">DoScopeActionAndRecurse</a></li><li><a href="./Parser.i6t.html#parser-doscopeaction">DoScopeAction</a></li><li><a href="./Parser.i6t.html#parser-parsing-object-names">Parsing Object Names</a></li><li><a href="./Parser.i6t.html#parser-trygivenobject">TryGivenObject</a></li><li><a href="./Parser.i6t.html#parser-refers">Refers</a></li><li><a href="./Parser.i6t.html#parser-nounword">NounWord</a></li><li><a href="./Parser.i6t.html#parser-trynumber">TryNumber</a></li><li><a href="./Parser.i6t.html#parser-gender">Gender</a></li><li><a href="./Parser.i6t.html#parser-noticing-plurals">Noticing Plurals</a></li><li><a href="./Parser.i6t.html#parser-pronoun-handling">Pronoun Handling</a></li><li><a href="./Parser.i6t.html#parser-yesno-questions">Yes/No Questions</a></li><li><a href="./Parser.i6t.html#parser-number-words">Number Words</a></li><li><a href="./Parser.i6t.html#parser-choose-objects">Choose Objects</a></li><li><a href="./Parser.i6t.html#parser-default-topic">Default Topic</a></li></ul></details><h3 id="parser-grammar-line-variables">Grammar Line Variables.</h3><p><p> This is the I6 library parser in mostly untouched form: reformatted for template file use, and with paragraph divisions, but otherwise hardly changed at all. It is a complex algorithm but one which is known to produce good results for the most part, and it is well understood from (at time of writing) fifteen years of use. A few I7 additions have been made, but none disrupting the basic method. For instance, I7&#39;s system for resolving ambiguities is implemented by providing a <span class="fixed"><a href="./Parser.i6t.html#line3917">ChooseObjects</a></span> routine, just as a user of the I6 library would do.<p></p><p> The I6 parser uses a huge number of global variables, which is not to modern programming tastes: in the early days of Inform, the parser was essentially written in assembly-language only lightly structured by C-like syntaxes, and the Z-machine&#39;s 240 globals were more or less registers. The I6 library made no distinction between which were &quot;private&quot; to the parser and which allowed to be accessed by the user&#39;s code at large. The I7 template does impose that boundary, though not very strongly: the variables defined in <a href="./Output.i6t.html">Output.i6t</a> are for general access, while the ones below should only be read or written by the parser.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line29">29</span><span class="td">Global best_etype;                  <span class="comment">! Preferred error number so far</span></span></span>
<span class="tr"><span class="th" id="line30">30</span><span class="td">Global nextbest_etype;              <span class="comment">! Preferred one, if ASKSCOPE_PE disallowed</span></span></span>
<span class="tr"><span class="th" id="line31">31</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line32">32</span><span class="td">Global parser_inflection;           <span class="comment">! A property (usually &quot;name&quot;) to find object names in</span></span></span>
<span class="tr"><span class="th" id="line33">33</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line34">34</span><span class="td">Array pattern --&gt; 32;               <span class="comment">! For the current pattern match</span></span></span>
<span class="tr"><span class="th" id="line35">35</span><span class="td">Global pcount;                      <span class="comment">! and a marker within it</span></span></span>
<span class="tr"><span class="th" id="line36">36</span><span class="td">Array pattern2 --&gt; 32;              <span class="comment">! And another, which stores the best match</span></span></span>
<span class="tr"><span class="th" id="line37">37</span><span class="td">Global pcount2;                     <span class="comment">! so far</span></span></span>
<span class="tr"><span class="th" id="line38">38</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line39">39</span><span class="td">Array  line_ttype--&gt;32;             <span class="comment">! For storing an analysed grammar line</span></span></span>
<span class="tr"><span class="th" id="line40">40</span><span class="td">Array  line_tdata--&gt;32;</span></span>
<span class="tr"><span class="th" id="line41">41</span><span class="td">Array  line_token--&gt;32;</span></span>
<span class="tr"><span class="th" id="line42">42</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line43">43</span><span class="td">Global nsns;                        <span class="comment">! Number of special_numbers entered so far</span></span></span>
<span class="tr"><span class="th" id="line44">44</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line45">45</span><span class="td">Global params_wanted;               <span class="comment">! Number of parameters needed (which may change in parsing)</span></span></span>
<span class="tr"><span class="th" id="line46">46</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line47">47</span><span class="td">Global inferfrom;                   <span class="comment">! The point from which the rest of the command must be inferred</span></span></span>
<span class="tr"><span class="th" id="line48">48</span><span class="td">Global inferword;                   <span class="comment">! And the preposition inferred</span></span></span>
<span class="tr"><span class="th" id="line49">49</span><span class="td">Global dont_infer;                  <span class="comment">! Another dull flag</span></span></span>
<span class="tr"><span class="th" id="line50">50</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line51">51</span><span class="td">Global cobj_flag = 0;</span></span>
<span class="tr"><span class="th" id="line52">52</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line53">53</span><span class="td">Global oops_from;                   <span class="comment">! The &quot;first mistake&quot; word number</span></span></span>
<span class="tr"><span class="th" id="line54">54</span><span class="td">Global saved_oops;                  <span class="comment">! Used in working this out</span></span></span>
<span class="tr"><span class="th" id="line55">55</span><span class="td">Array  oops_workspace -&gt; 64;        <span class="comment">! Used temporarily by &quot;oops&quot; routine</span></span></span>
<span class="tr"><span class="th" id="line56">56</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line57">57</span><span class="td">Global held_back_mode;              <span class="comment">! Flag: is there some input from last time</span></span></span>
<span class="tr"><span class="th" id="line58">58</span><span class="td">Global hb_wn;                       <span class="comment">! left over?  (And a save value for wn.)</span></span></span>
<span class="tr"><span class="th" id="line59">59</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (Used for full stops and &quot;then&quot;.)</span></span></span>
<span class="tr"><span class="th" id="line60">60</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line61">61</span><span class="td">Global usual_grammar_after;         <span class="comment">! Point from which usual grammar is parsed (it may vary from</span></span></span>
<span class="tr"><span class="th" id="line62">62</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! the above if user&#39;s routines match multi-word verbs)</span></span></span>
</div><div class='text'>
<h3 id="parser-grammar-token-variables">Grammar Token Variables.</h3><p><p> More globals, but dealing at the level of individual tokens now.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line68">68</span><span class="td">Constant PATTERN_NULL = $ffff;      <span class="comment">! Entry for a token producing no text</span></span></span>
<span class="tr"><span class="th" id="line69">69</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line70">70</span><span class="td">Global found_ttype;                 <span class="comment">! Used to break up tokens into type</span></span></span>
<span class="tr"><span class="th" id="line71">71</span><span class="td">Global found_tdata;                 <span class="comment">! and data (by AnalyseToken)</span></span></span>
<span class="tr"><span class="th" id="line72">72</span><span class="td">Global token_filter;                <span class="comment">! For noun filtering by user routines</span></span></span>
<span class="tr"><span class="th" id="line73">73</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line74">74</span><span class="td">Global length_of_noun;              <span class="comment">! Set by NounDomain to no of words in noun</span></span></span>
<span class="tr"><span class="th" id="line75">75</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line76">76</span><span class="td">Global lookahead;                   <span class="comment">! The token after the one now being matched</span></span></span>
<span class="tr"><span class="th" id="line77">77</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line78">78</span><span class="td">Global multi_mode;                  <span class="comment">! Multiple mode</span></span></span>
<span class="tr"><span class="th" id="line79">79</span><span class="td">Global multi_wanted;                <span class="comment">! Number of things needed in multitude</span></span></span>
<span class="tr"><span class="th" id="line80">80</span><span class="td">Global multi_had;                   <span class="comment">! Number of things actually found</span></span></span>
<span class="tr"><span class="th" id="line81">81</span><span class="td">Global multi_context;               <span class="comment">! What token the multi-obj was accepted for</span></span></span>
<span class="tr"><span class="th" id="line82">82</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line83">83</span><span class="td">Global indef_mode;                  <span class="comment">! &quot;Indefinite&quot; mode - ie, &quot;take a brick&quot;</span></span></span>
<span class="tr"><span class="th" id="line84">84</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! is in this mode</span></span></span>
<span class="tr"><span class="th" id="line85">85</span><span class="td">Global indef_type;                  <span class="comment">! Bit-map holding types of specification</span></span></span>
<span class="tr"><span class="th" id="line86">86</span><span class="td">Global indef_wanted;                <span class="comment">! Number of items wanted (INDEF_ALL_WANTED for all)</span></span></span>
<span class="tr"><span class="th" id="line87">87</span><span class="td">Constant INDEF_ALL_WANTED = 32767;</span></span>
<span class="tr"><span class="th" id="line88">88</span><span class="td">Global indef_guess_p;               <span class="comment">! Plural-guessing flag</span></span></span>
<span class="tr"><span class="th" id="line89">89</span><span class="td">Global indef_owner;                 <span class="comment">! Object which must hold these items</span></span></span>
<span class="tr"><span class="th" id="line90">90</span><span class="td">Global indef_cases;                 <span class="comment">! Possible gender and numbers of them</span></span></span>
<span class="tr"><span class="th" id="line91">91</span><span class="td">Global indef_possambig;             <span class="comment">! Has a possibly dangerous assumption</span></span></span>
<span class="tr"><span class="th" id="line92">92</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! been made about meaning of a descriptor?</span></span></span>
<span class="tr"><span class="th" id="line93">93</span><span class="td">Global indef_nspec_at;              <span class="comment">! Word at which a number like &quot;two&quot; was parsed</span></span></span>
<span class="tr"><span class="th" id="line94">94</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (for backtracking)</span></span></span>
<span class="tr"><span class="th" id="line95">95</span><span class="td">Global allow_plurals;               <span class="comment">! Whether plurals presently allowed or not</span></span></span>
<span class="tr"><span class="th" id="line96">96</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line97">97</span><span class="td">Global take_all_rule;               <span class="comment">! Slightly different rules apply to &quot;take all&quot; than other uses</span></span></span>
<span class="tr"><span class="th" id="line98">98</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! of multiple objects, to make adjudication produce more</span></span></span>
<span class="tr"><span class="th" id="line99">99</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! pragmatically useful results</span></span></span>
<span class="tr"><span class="th" id="line100">100</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (Not a flag: possible values 0, 1, 2)</span></span></span>
<span class="tr"><span class="th" id="line101">101</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line102">102</span><span class="td">Global dict_flags_of_noun;          <span class="comment">! Of the noun currently being parsed</span></span></span>
<span class="tr"><span class="th" id="line103">103</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (a bitmap in #dict_par1 format)</span></span></span>
<span class="tr"><span class="th" id="line104">104</span><span class="td">Global pronoun__word;               <span class="comment">! Saved value</span></span></span>
<span class="tr"><span class="th" id="line105">105</span><span class="td">Global pronoun__obj;                <span class="comment">! Saved value</span></span></span>
<span class="tr"><span class="th" id="line106">106</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line107">107</span><span class="td">Constant comma_word = <span class="sstring">&#39;comma,&#39;</span>;     <span class="comment">! An &quot;untypeable word&quot; used to substitute</span></span></span>
<span class="tr"><span class="th" id="line108">108</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! for commas in parse buffers</span></span></span>
</div><div class='text'>
<h3 id="parser-match-list-variables">Match List Variables.</h3><p><p> The most difficult tokens to match are those which refer to objects, since there is such a variety of names which can be given to any individual object, and we don&#39;t of course know which object or objects are meant. We store the possibilities (up to <span class="fixed">MATCH_LIST_WORDS</span>, anyway) in a data structure called the match list.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line117">117</span><span class="td">Array  match_list --&gt; MATCH_LIST_WORDS;    <span class="comment">! An array of matched objects so far</span></span></span>
<span class="tr"><span class="th" id="line118">118</span><span class="td">Array  match_classes --&gt; MATCH_LIST_WORDS; <span class="comment">! An array of equivalence classes for them</span></span></span>
<span class="tr"><span class="th" id="line119">119</span><span class="td">Array  match_scores --&gt; MATCH_LIST_WORDS;  <span class="comment">! An array of match scores for them</span></span></span>
<span class="tr"><span class="th" id="line120">120</span><span class="td">Global number_matched;              <span class="comment">! How many items in it?  (0 means none)</span></span></span>
<span class="tr"><span class="th" id="line121">121</span><span class="td">Global number_of_classes;           <span class="comment">! How many equivalence classes?</span></span></span>
<span class="tr"><span class="th" id="line122">122</span><span class="td">Global match_length;                <span class="comment">! How many words long are these matches?</span></span></span>
<span class="tr"><span class="th" id="line123">123</span><span class="td">Global match_from;                  <span class="comment">! At what word of the input do they begin?</span></span></span>
</div><div class='text'>
<h3 id="parser-words">Words.</h3><p><p> The player&#39;s command is broken down into a numbered sequence of words, which break at spaces or certain punctuation (see the DM4). The numbering runs upwards from 1 to <span class="fixed"><a href="./Parser.i6t.html#line157">WordCount()</a></span>. The following utility routines provide access to words in the current command; because buffers have different definitions in Z and Glulx, so these routines must vary also.<p></p><p> The actual text of each word is stored as a sequence of ZSCII values in a <span class="fixed">-&gt;</span> (byte) array, with address <span class="fixed"><a href="./Parser.i6t.html#line158">WordAddress(x)</a></span> and length <span class="fixed"><a href="./Parser.i6t.html#line159">WordLength(x)</a></span>.<p></p><p> We picture the command as a stream of words to be read one at a time, with the global variable <span class="fixed"><a href="./Output.i6t.html#line283">wn</a></span> being the &quot;current word&quot; marker. <span class="fixed"><a href="./Parser.i6t.html#line172">NextWord</a></span>, which takes no arguments, returns: (a) 0 if the word at <span class="fixed"><a href="./Output.i6t.html#line283">wn</a></span> is unrecognised by the dictionary or <span class="fixed"><a href="./Output.i6t.html#line283">wn</a></span> is out of range, (b) <span class="fixed"><a href="./Parser.i6t.html#line107">comma_word</a></span> if the word was a comma, (c) <span class="fixed"><a href="./Language.i6t.html#line43">THEN1__WD</a></span> if it was a full stop (because of the Infocom tradition that a full stop abbreviates for the word &quot;then&quot;: e.g., TAKE BOX. EAST was read as two commands in succession), (d) or the dictionary address if the word was recognised.<p></p><p> The current word marker <span class="fixed"><a href="./Output.i6t.html#line283">wn</a></span> is always advanced.<p></p><p> <span class="fixed"><a href="./Parser.i6t.html#line183">NextWordStopped</a></span> does the same, but returns <em>-1</em> when <span class="fixed"><a href="./Output.i6t.html#line283">wn</a></span> is out of range (e.g., by having advanced past the last word in the command).<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line152">152</span><span class="td">#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line153">153</span><span class="td">[ WordCount; return parse-&gt;1; ];</span></span>
<span class="tr"><span class="th" id="line154">154</span><span class="td">[ WordAddress wordnum; return buffer + parse-&gt;(wordnum*4+1); ];</span></span>
<span class="tr"><span class="th" id="line155">155</span><span class="td">[ WordLength wordnum; return parse-&gt;(wordnum*4); ];</span></span>
<span class="tr"><span class="th" id="line156">156</span><span class="td">#Ifnot;</span></span>
<span class="tr"><span class="th" id="line157">157</span><span class="td">[ WordCount; return parse--&gt;0; ];</span></span>
<span class="tr"><span class="th" id="line158">158</span><span class="td">[ WordAddress wordnum; return buffer + parse--&gt;(wordnum*3); ];</span></span>
<span class="tr"><span class="th" id="line159">159</span><span class="td">[ WordLength wordnum; return parse--&gt;(wordnum*3-1); ];</span></span>
<span class="tr"><span class="th" id="line160">160</span><span class="td">#Endif;</span></span>
<span class="tr"><span class="th" id="line161">161</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line162">162</span><span class="td">[ WordFrom w p i j wc;</span></span>
<span class="tr"><span class="th" id="line163">163</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE; wc = p-&gt;1; i = w*2-1;</span></span>
<span class="tr"><span class="th" id="line164">164</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; wc = p--&gt;0; i = w*3-2; #Endif;</span></span>
<span class="tr"><span class="th" id="line165">165</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((w &lt; 1) || (w &gt; wc)) return 0;</span></span>
<span class="tr"><span class="th" id="line166">166</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;j = p--&gt;i;</span></span>
<span class="tr"><span class="th" id="line167">167</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (j == <span class="sstring">&#39;,//&#39;</span>) j = comma_word;</span></span>
<span class="tr"><span class="th" id="line168">168</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (j == <span class="sstring">&#39;.//&#39;</span>) j = THEN1__WD;</span></span>
<span class="tr"><span class="th" id="line169">169</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return j;</span></span>
<span class="tr"><span class="th" id="line170">170</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line171">171</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line172">172</span><span class="td">[ NextWord i j wc;</span></span>
<span class="tr"><span class="th" id="line173">173</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE; wc = parse-&gt;1; i = wn*2-1;</span></span>
<span class="tr"><span class="th" id="line174">174</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; wc = parse--&gt;0; i = wn*3-2; #Endif;</span></span>
<span class="tr"><span class="th" id="line175">175</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn++;</span></span>
<span class="tr"><span class="th" id="line176">176</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((wn &lt; 2) || (wn &gt; wc+1)) return 0;</span></span>
<span class="tr"><span class="th" id="line177">177</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;j = parse--&gt;i;</span></span>
<span class="tr"><span class="th" id="line178">178</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (j == <span class="sstring">&#39;,//&#39;</span>) j = comma_word;</span></span>
<span class="tr"><span class="th" id="line179">179</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (j == <span class="sstring">&#39;.//&#39;</span>) j = THEN1__WD;</span></span>
<span class="tr"><span class="th" id="line180">180</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return j;</span></span>
<span class="tr"><span class="th" id="line181">181</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line182">182</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line183">183</span><span class="td">[ NextWordStopped wc;</span></span>
<span class="tr"><span class="th" id="line184">184</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE; wc = parse-&gt;1; #Ifnot; wc = parse--&gt;0; #Endif;</span></span>
<span class="tr"><span class="th" id="line185">185</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((wn &lt; 1) || (wn &gt; wc)) { wn++; return -1; }</span></span>
<span class="tr"><span class="th" id="line186">186</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return NextWord();</span></span>
<span class="tr"><span class="th" id="line187">187</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-snippets">Snippets.</h3><p><p> Although the idea is arguably implicit in I6, the formal concept of &quot;snippet&quot; is new in I7. A snippet is a value which represents a word range in the command most recently typed by the player. These words number consecutively upwards from 1, as noted above. The correspondence between <em>(w<sub>1</sub>, w<sub>2</sub>)</em>, the word range, and <em>V</em>, the number used to represent it as an I6 value, is: <p class="center"><em> V = 100w<sub>1</sub> + (w<sub>2</sub>-w<sub>1</sub>+1) </em></p> so that the remainder mod 100 is the number of words in the range. We require that <em>1 &le; w<sub>1</sub> &le; w<sub>2</sub> &le; N</em>, where <em>N</em> is the number of words in the current player&#39;s command. The entire command is therefore represented by: <p class="center"><em> C = 100 + N </em></p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line203">203</span><span class="td">[ PrintSnippet snip from to i w1 w2;</span></span>
<span class="tr"><span class="th" id="line204">204</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;w1 = snip/100; w2 = w1 + (snip%100) - 1;</span></span>
<span class="tr"><span class="th" id="line205">205</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((w2&lt;w1) || (w1&lt;1) || (w2&gt;WordCount())) {</span></span>
<span class="tr"><span class="th" id="line206">206</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((w1 == 1) &amp;&amp; (w2 == 0)) rfalse;</span></span>
<span class="tr"><span class="th" id="line207">207</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return RunTimeProblem(RTP_SAYINVALIDSNIPPET, w1, w2);</span></span>
<span class="tr"><span class="th" id="line208">208</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line209">209</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;from = WordAddress(w1); to = WordAddress(w2) + WordLength(w2) - 1;</span></span>
<span class="tr"><span class="th" id="line210">210</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=from: i&lt;=to: i++) print (char) i-&gt;0;</span></span>
<span class="tr"><span class="th" id="line211">211</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line212">212</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line213">213</span><span class="td">[ SpliceSnippet snip t i w1 w2 nextw at endsnippet newlen;</span></span>
<span class="tr"><span class="th" id="line214">214</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;w1 = snip/100; w2 = w1 + (snip%100) - 1;</span></span>
<span class="tr"><span class="th" id="line215">215</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((w2&lt;w1) || (w1&lt;1)) {</span></span>
<span class="tr"><span class="th" id="line216">216</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((w1 == 1) &amp;&amp; (w2 == 0)) return;</span></span>
<span class="tr"><span class="th" id="line217">217</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return RunTimeProblem(RTP_SPLICEINVALIDSNIPPET, w1, w2);</span></span>
<span class="tr"><span class="th" id="line218">218</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line219">219</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@push say__p; @push say__pc;</span></span>
<span class="tr"><span class="th" id="line220">220</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;nextw = w2 + 1;</span></span>
<span class="tr"><span class="th" id="line221">221</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at = WordAddress(w1) - buffer;</span></span>
<span class="tr"><span class="th" id="line222">222</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (nextw &lt;= WordCount()) endsnippet = 100*nextw + (WordCount() - nextw + 1);</span></span>
<span class="tr"><span class="th" id="line223">223</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;buffer2--&gt;0 = 120;</span></span>
<span class="tr"><span class="th" id="line224">224</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;newlen = VM_PrintToBuffer(buffer2, 120, SpliceSnippet__TextPrinter, t, endsnippet);</span></span>
<span class="tr"><span class="th" id="line225">225</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0: (i&lt;newlen) &amp;&amp; (at+i&lt;120): i++) buffer-&gt;(at+i) = buffer2-&gt;(WORDSIZE+i);</span></span>
<span class="tr"><span class="th" id="line226">226</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE; buffer-&gt;1 = at+i; #ifnot; buffer--&gt;0 = at+i; #endif;</span></span>
<span class="tr"><span class="th" id="line227">227</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (:at+i&lt;120:i++) buffer-&gt;(at+i) = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line228">228</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;VM_Tokenise(buffer, parse);</span></span>
<span class="tr"><span class="th" id="line229">229</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;players_command = 100 + WordCount();</span></span>
<span class="tr"><span class="th" id="line230">230</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@pull say__pc; @pull say__p;</span></span>
<span class="tr"><span class="th" id="line231">231</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line232">232</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line233">233</span><span class="td">[ SpliceSnippet__TextPrinter t endsnippet;</span></span>
<span class="tr"><span class="th" id="line234">234</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;TEXT_TY_Say(t);</span></span>
<span class="tr"><span class="th" id="line235">235</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (endsnippet) { print <span class="dstring">&quot; &quot;</span>; PrintSnippet(endsnippet); }</span></span>
<span class="tr"><span class="th" id="line236">236</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line237">237</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line238">238</span><span class="td">[ SnippetIncludes test snippet w1 w2 wlen i j;</span></span>
<span class="tr"><span class="th" id="line239">239</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;w1 = snippet/100; w2 = w1 + (snippet%100) - 1;</span></span>
<span class="tr"><span class="th" id="line240">240</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((w2&lt;w1) || (w1&lt;1)) {</span></span>
<span class="tr"><span class="th" id="line241">241</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((w1 == 1) &amp;&amp; (w2 == 0)) rfalse;</span></span>
<span class="tr"><span class="th" id="line242">242</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return RunTimeProblem(RTP_INCLUDEINVALIDSNIPPET, w1, w2);</span></span>
<span class="tr"><span class="th" id="line243">243</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line244">244</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (metaclass(test) == Routine) {</span></span>
<span class="tr"><span class="th" id="line245">245</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wlen = snippet%100;</span></span>
<span class="tr"><span class="th" id="line246">246</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=w1, j=wlen: j&gt;0: i++, j--) {</span></span>
<span class="tr"><span class="th" id="line247">247</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (((test)(i, 0)) ~= GPR_FAIL) return i*100+wn-i;</span></span>
<span class="tr"><span class="th" id="line248">248</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line249">249</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line250">250</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line251">251</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line252">252</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line253">253</span><span class="td">[ SnippetMatches snippet topic_gpr rv;</span></span>
<span class="tr"><span class="th" id="line254">254</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn=1;</span></span>
<span class="tr"><span class="th" id="line255">255</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (topic_gpr == 0) rfalse;</span></span>
<span class="tr"><span class="th" id="line256">256</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (metaclass(topic_gpr) == Routine) {</span></span>
<span class="tr"><span class="th" id="line257">257</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv = (topic_gpr)(snippet/100, snippet%100);</span></span>
<span class="tr"><span class="th" id="line258">258</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (rv ~= GPR_FAIL) rtrue;</span></span>
<span class="tr"><span class="th" id="line259">259</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line260">260</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line261">261</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RunTimeProblem(RTP_BADTOPIC);</span></span>
<span class="tr"><span class="th" id="line262">262</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line263">263</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-unpacking-grammar-lines">Unpacking Grammar Lines.</h3><p><p> Grammar lines are sequences of tokens in an array built into the story file, but in a format which differs depending on the virtual machine in use, so the following code unpacks the data into more convenient if larger arrays which are VM-independent.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line272">272</span><span class="td">[ UnpackGrammarLine line_address i size;</span></span>
<span class="tr"><span class="th" id="line273">273</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;32 : i++) {</span></span>
<span class="tr"><span class="th" id="line274">274</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_token--&gt;i = ENDIT_TOKEN;</span></span>
<span class="tr"><span class="th" id="line275">275</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_ttype--&gt;i = ELEMENTARY_TT;</span></span>
<span class="tr"><span class="th" id="line276">276</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_tdata--&gt;i = ENDIT_TOKEN;</span></span>
<span class="tr"><span class="th" id="line277">277</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line278">278</span><span class="td">#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line279">279</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;action_to_be = 256*(line_address-&gt;0) + line_address-&gt;1;</span></span>
<span class="tr"><span class="th" id="line280">280</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;action_reversed = ((action_to_be &amp; $400) ~= 0);</span></span>
<span class="tr"><span class="th" id="line281">281</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;action_to_be = action_to_be &amp; $3ff;</span></span>
<span class="tr"><span class="th" id="line282">282</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;line_address--;</span></span>
<span class="tr"><span class="th" id="line283">283</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;size = 3;</span></span>
<span class="tr"><span class="th" id="line284">284</span><span class="td">#Ifnot; <span class="comment">! GLULX</span></span></span>
<span class="tr"><span class="th" id="line285">285</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@aloads line_address 0 action_to_be;</span></span>
<span class="tr"><span class="th" id="line286">286</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;action_reversed = (((line_address-&gt;2) &amp; 1) ~= 0);</span></span>
<span class="tr"><span class="th" id="line287">287</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;line_address = line_address - 2;</span></span>
<span class="tr"><span class="th" id="line288">288</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;size = 5;</span></span>
<span class="tr"><span class="th" id="line289">289</span><span class="td">#Endif;</span></span>
<span class="tr"><span class="th" id="line290">290</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;params_wanted = 0;</span></span>
<span class="tr"><span class="th" id="line291">291</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : : i++) {</span></span>
<span class="tr"><span class="th" id="line292">292</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_address = line_address + size;</span></span>
<span class="tr"><span class="th" id="line293">293</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_address-&gt;0 == ENDIT_TOKEN) break;</span></span>
<span class="tr"><span class="th" id="line294">294</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_token--&gt;i = line_address;</span></span>
<span class="tr"><span class="th" id="line295">295</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AnalyseToken(line_address);</span></span>
<span class="tr"><span class="th" id="line296">296</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (found_ttype ~= PREPOSITION_TT) params_wanted++;</span></span>
<span class="tr"><span class="th" id="line297">297</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_ttype--&gt;i = found_ttype;</span></span>
<span class="tr"><span class="th" id="line298">298</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_tdata--&gt;i = found_tdata;</span></span>
<span class="tr"><span class="th" id="line299">299</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line300">300</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return line_address + 1;</span></span>
<span class="tr"><span class="th" id="line301">301</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line302">302</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line303">303</span><span class="td">[ AnalyseToken token;</span></span>
<span class="tr"><span class="th" id="line304">304</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (token == ENDIT_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line305">305</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found_ttype = ELEMENTARY_TT;</span></span>
<span class="tr"><span class="th" id="line306">306</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found_tdata = ENDIT_TOKEN;</span></span>
<span class="tr"><span class="th" id="line307">307</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line308">308</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line309">309</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;found_ttype = (token-&gt;0) &amp; $$1111;</span></span>
<span class="tr"><span class="th" id="line310">310</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;found_tdata = (token+1)--&gt;0;</span></span>
<span class="tr"><span class="th" id="line311">311</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-extracting-verb-numbers">Extracting Verb Numbers.</h3><p><p> A long tale of woe lies behind the following. Infocom games stored verb numbers in a single byte in dictionary entries, but they did so counting downwards, so that verb number 0 was stored as 255, 1 as 254, and so on. Inform followed suit so that debugging of Inform 1 could be aided by using the then-available tools for dumping dictionaries from Infocom story files; by using the Infocom format for dictionary tables, Inform&#39;s life was easier.<p></p><p> But there was an implicit restriction there of 255 distinct verbs (not 256 since not all words were verbs). When Glulx raised almost all of the Z-machine limits, it made space for 65535 verbs instead of 255, but it appears that nobody remembered to implement this in I6-for-Glulx and the Glulx form of the I6 library. This was only put right in March 2009, and the following routine was added to concentrate lookups of this field in one place.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line329">329</span><span class="td">[ DictionaryWordToVerbNum dword verbnum;</span></span>
<span class="tr"><span class="th" id="line330">330</span><span class="td">#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line331">331</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;verbnum = $ff-(dword-&gt;#dict_par2);</span></span>
<span class="tr"><span class="th" id="line332">332</span><span class="td">#Ifnot; <span class="comment">! GLULX</span></span></span>
<span class="tr"><span class="th" id="line333">333</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;dword = dword + #dict_par2 - 1;</span></span>
<span class="tr"><span class="th" id="line334">334</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@aloads dword 0 verbnum;</span></span>
<span class="tr"><span class="th" id="line335">335</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;verbnum = $ffff-verbnum;</span></span>
<span class="tr"><span class="th" id="line336">336</span><span class="td">#Endif;</span></span>
<span class="tr"><span class="th" id="line337">337</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return verbnum;</span></span>
<span class="tr"><span class="th" id="line338">338</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-keyboard-primitive">Keyboard Primitive.</h3><p><p> This is the primitive routine to read from the keyboard: it usually delegates this to a routine specific to the virtual machine being used, but sometimes uses a hacked version to allow TEST commands to work. (When a TEST is running, the text in the walk-through provided is fed into the buffer as if it had been typed at the keyboard.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line348">348</span><span class="td">[ KeyboardPrimitive a_buffer a_table;</span></span>
<span class="tr"><span class="th" id="line349">349</span><span class="td">#Ifdef DEBUG; #Iftrue ({-value:NUMBER_CREATED(test_scenario)} &gt; 0);</span></span>
<span class="tr"><span class="th" id="line350">350</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return TestKeyboardPrimitive(a_buffer, a_table);</span></span>
<span class="tr"><span class="th" id="line351">351</span><span class="td">#Endif; #Endif;</span></span>
<span class="tr"><span class="th" id="line352">352</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return VM_ReadKeyboard(a_buffer, a_table);</span></span>
<span class="tr"><span class="th" id="line353">353</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-reading-the-command">Reading the Command.</h3><p><p> The <span class="fixed"><a href="./Parser.i6t.html#line376">Keyboard</a></span> routine actually receives the player&#39;s words, putting the words in <span class="fixed">a_buffer</span> and their dictionary addresses in <span class="fixed">a_table</span>. It is assumed that the table is the same one on each (standard) call. Much of the code handles the OOPS and UNDO commands, which are not actions and do not pass through the rest of the parser. The undo state is saved &ndash; it is essentially an internal saved game, in the VM interpreter&#39;s memory rather than in an external file &ndash; and note that this is therefore also where execution picks up if an UNDO has been typed. Since UNDO recreates the former machine state perfectly, it might seem impossible to tell that an UNDO had occurred, but in fact the VM passes information back in the form of a return code from the relevant instruction, and this allows us to detect an undo. (We deal with it by printing the current location and asking another command.)<p></p><p> <span class="fixed"><a href="./Parser.i6t.html#line376">Keyboard</a></span> can also be used by miscellaneous routines in the game to ask yes/no questions and the like, without invoking the rest of the parser.<p></p><p> The return value is the number of words typed.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line376">376</span><span class="td">[ Keyboard  a_buffer a_table  nw i w w2 x1 x2;</span></span>
<span class="tr"><span class="th" id="line377">377</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;sline1 = score; sline2 = turns;</span></span>
<span class="tr"><span class="th" id="line378">378</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line379">379</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;while (true) {</span></span>
<span class="tr"><span class="th" id="line380">380</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Save the start of the buffer, in case &quot;oops&quot; needs to restore it</span></span></span>
<span class="tr"><span class="th" id="line381">381</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;64 : i++) oops_workspace-&gt;i = a_buffer-&gt;i;</span></span>
<span class="tr"><span class="th" id="line382">382</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line383">383</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! In case of an array entry corruption that shouldn&#39;t happen, but would be</span></span></span>
<span class="tr"><span class="th" id="line384">384</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! disastrous if it did:</span></span></span>
<span class="tr"><span class="th" id="line385">385</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line386">386</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a_buffer-&gt;0 = INPUT_BUFFER_LEN;</span></span>
<span class="tr"><span class="th" id="line387">387</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a_table-&gt;0 = 15;  <span class="comment">! Allow to split input into this many words</span></span></span>
<span class="tr"><span class="th" id="line388">388</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line389">389</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line390">390</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Print the prompt, and read in the words and dictionary addresses</span></span></span>
<span class="tr"><span class="th" id="line391">391</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintPrompt();</span></span>
<span class="tr"><span class="th" id="line392">392</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DrawStatusLine();</span></span>
<span class="tr"><span class="th" id="line393">393</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KeyboardPrimitive(a_buffer, a_table);</span></span>
<span class="tr"><span class="th" id="line394">394</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line395">395</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Set nw to the number of words</span></span></span>
<span class="tr"><span class="th" id="line396">396</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE; nw = a_table-&gt;1; #Ifnot; nw = a_table--&gt;0; #Endif;</span></span>
<span class="tr"><span class="th" id="line397">397</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line398">398</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If the line was blank, get a fresh line</span></span></span>
<span class="tr"><span class="th" id="line399">399</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (nw == 0) {</span></span>
<span class="tr"><span class="th" id="line400">400</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@push etype; etype = BLANKLINE_PE;</span></span>
<span class="tr"><span class="th" id="line401">401</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;players_command = 100;</span></span>
<span class="tr"><span class="th" id="line402">402</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(PRINTING_A_PARSER_ERROR_ACT);</span></span>
<span class="tr"><span class="th" id="line403">403</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ForActivity(PRINTING_A_PARSER_ERROR_ACT) == false) {</span></span>
<span class="tr"><span class="th" id="line404">404</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;X&#39;</span>, noun); new_line;</span></span>
<span class="tr"><span class="th" id="line405">405</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line406">406</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndActivity(PRINTING_A_PARSER_ERROR_ACT);</span></span>
<span class="tr"><span class="th" id="line407">407</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull etype;</span></span>
<span class="tr"><span class="th" id="line408">408</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line409">409</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line410">410</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line411">411</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Unless the opening word was OOPS, return</span></span></span>
<span class="tr"><span class="th" id="line412">412</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Conveniently, a_table--&gt;1 is the first word on both the Z-machine and Glulx</span></span></span>
<span class="tr"><span class="th" id="line413">413</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line414">414</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w = a_table--&gt;1;</span></span>
<span class="tr"><span class="th" id="line415">415</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (w == OOPS1__WD or OOPS2__WD or OOPS3__WD) {</span></span>
<span class="tr"><span class="th" id="line416">416</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (oops_from == 0) { PARSER_COMMAND_INTERNAL_RM(<span class="sstring">&#39;A&#39;</span>); new_line; continue; }</span></span>
<span class="tr"><span class="th" id="line417">417</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (nw == 1) { PARSER_COMMAND_INTERNAL_RM(<span class="sstring">&#39;B&#39;</span>); new_line; continue; }</span></span>
<span class="tr"><span class="th" id="line418">418</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (nw &gt; 2) { PARSER_COMMAND_INTERNAL_RM(<span class="sstring">&#39;C&#39;</span>); new_line; continue; }</span></span>
<span class="tr"><span class="th" id="line419">419</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line420">420</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! So now we know: there was a previous mistake, and the player has</span></span></span>
<span class="tr"><span class="th" id="line421">421</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! attempted to correct a single word of it.</span></span></span>
<span class="tr"><span class="th" id="line422">422</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line423">423</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;INPUT_BUFFER_LEN : i++) buffer2-&gt;i = a_buffer-&gt;i;</span></span>
<span class="tr"><span class="th" id="line424">424</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line425">425</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1 = a_table-&gt;9;  <span class="comment">! Start of word following &quot;oops&quot;</span></span></span>
<span class="tr"><span class="th" id="line426">426</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2 = a_table-&gt;8;  <span class="comment">! Length of word following &quot;oops&quot;</span></span></span>
<span class="tr"><span class="th" id="line427">427</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line428">428</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x1 = a_table--&gt;6; <span class="comment">! Start of word following &quot;oops&quot;</span></span></span>
<span class="tr"><span class="th" id="line429">429</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x2 = a_table--&gt;5; <span class="comment">! Length of word following &quot;oops&quot;</span></span></span>
<span class="tr"><span class="th" id="line430">430</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line431">431</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line432">432</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Repair the buffer to the text that was in it before the &quot;oops&quot;</span></span></span>
<span class="tr"><span class="th" id="line433">433</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! was typed:</span></span></span>
<span class="tr"><span class="th" id="line434">434</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;64 : i++) a_buffer-&gt;i = oops_workspace-&gt;i;</span></span>
<span class="tr"><span class="th" id="line435">435</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_Tokenise(a_buffer,a_table);</span></span>
<span class="tr"><span class="th" id="line436">436</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line437">437</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Work out the position in the buffer of the word to be corrected:</span></span></span>
<span class="tr"><span class="th" id="line438">438</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line439">439</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w = a_table-&gt;(4*oops_from + 1); <span class="comment">! Start of word to go</span></span></span>
<span class="tr"><span class="th" id="line440">440</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w2 = a_table-&gt;(4*oops_from);    <span class="comment">! Length of word to go</span></span></span>
<span class="tr"><span class="th" id="line441">441</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line442">442</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w = a_table--&gt;(3*oops_from);      <span class="comment">! Start of word to go</span></span></span>
<span class="tr"><span class="th" id="line443">443</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w2 = a_table--&gt;(3*oops_from - 1); <span class="comment">! Length of word to go</span></span></span>
<span class="tr"><span class="th" id="line444">444</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line445">445</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line446">446</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Write spaces over the word to be corrected:</span></span></span>
<span class="tr"><span class="th" id="line447">447</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;w2 : i++) a_buffer-&gt;(i+w) = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line448">448</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line449">449</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (w2 &lt; x2) {</span></span>
<span class="tr"><span class="th" id="line450">450</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If the replacement is longer than the original, move up...</span></span></span>
<span class="tr"><span class="th" id="line451">451</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=INPUT_BUFFER_LEN-1 : i&gt;=w+x2 : i--)</span></span>
<span class="tr"><span class="th" id="line452">452</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a_buffer-&gt;i = a_buffer-&gt;(i-x2+w2);</span></span>
<span class="tr"><span class="th" id="line453">453</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line454">454</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...increasing buffer size accordingly.</span></span></span>
<span class="tr"><span class="th" id="line455">455</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line456">456</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a_buffer-&gt;1 = (a_buffer-&gt;1) + (x2-w2);</span></span>
<span class="tr"><span class="th" id="line457">457</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line458">458</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a_buffer--&gt;0 = (a_buffer--&gt;0) + (x2-w2);</span></span>
<span class="tr"><span class="th" id="line459">459</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line460">460</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line461">461</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line462">462</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Write the correction in:</span></span></span>
<span class="tr"><span class="th" id="line463">463</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;x2 : i++) a_buffer-&gt;(i+w) = buffer2-&gt;(i+x1);</span></span>
<span class="tr"><span class="th" id="line464">464</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line465">465</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_Tokenise(a_buffer, a_table);</span></span>
<span class="tr"><span class="th" id="line466">466</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE; nw = a_table-&gt;1; #Ifnot; nw = a_table--&gt;0; #Endif;</span></span>
<span class="tr"><span class="th" id="line467">467</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line468">468</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return nw;</span></span>
<span class="tr"><span class="th" id="line469">469</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line470">470</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line471">471</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Undo handling</span></span></span>
<span class="tr"><span class="th" id="line472">472</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line473">473</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((w == UNDO1__WD or UNDO2__WD or UNDO3__WD) &amp;&amp; (nw==1)) {</span></span>
<span class="tr"><span class="th" id="line474">474</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Perform_Undo();</span></span>
<span class="tr"><span class="th" id="line475">475</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line476">476</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line477">477</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = VM_Save_Undo();</span></span>
<span class="tr"><span class="th" id="line478">478</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef PREVENT_UNDO; undo_flag = 0; #endif;</span></span>
<span class="tr"><span class="th" id="line479">479</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifndef PREVENT_UNDO; undo_flag = 2; #endif;</span></span>
<span class="tr"><span class="th" id="line480">480</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == -1) undo_flag = 0;</span></span>
<span class="tr"><span class="th" id="line481">481</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == 0) undo_flag = 1;</span></span>
<span class="tr"><span class="th" id="line482">482</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == 2) {</span></span>
<span class="tr"><span class="th" id="line483">483</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_RestoreWindowColours();</span></span>
<span class="tr"><span class="th" id="line484">484</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_Style(SUBHEADER_VMSTY);</span></span>
<span class="tr"><span class="th" id="line485">485</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SL_Location(); print <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line486">486</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! print (name) location, &quot;^&quot;;</span></span></span>
<span class="tr"><span class="th" id="line487">487</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_Style(NORMAL_VMSTY);</span></span>
<span class="tr"><span class="th" id="line488">488</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMMEDIATELY_UNDO_RM(<span class="sstring">&#39;E&#39;</span>); new_line;</span></span>
<span class="tr"><span class="th" id="line489">489</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line490">490</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line491">491</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return nw;</span></span>
<span class="tr"><span class="th" id="line492">492</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line493">493</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-parser-proper">Parser Proper.</h3><p><p> The main parser routine is something of a leviathan, and it has traditionally been divided into 11 lettered parts:<p></p><p> (A) Get the input, do OOPS and AGAIN (B) Is it a direction, and so an implicit GO? If so go to (K) (C) Is anyone being addressed? (D) Get the command verb: try all the syntax lines for that verb (E) Break down a syntax line into analysed tokens (F) Look ahead for advance warning for <span class="fixed">multiexcept</span>/<span class="fixed">multiinside</span> (G) Parse each token in turn (calling <span class="fixed"><a href="./Parser.i6t.html#line1469">ParseToken</a></span> to do most of the work) (H) Cheaply parse otherwise unrecognised conversation and return (I) Print best possible error message (J) Retry the whole lot (K) Last thing: check for THEN and further instructions(s), return.<p></p><p> This lettering has been preserved here, with the code under each letter now being the body of &quot;Parser Letter A&quot;, &quot;Parser Letter B&quot; and so on.<p></p><p> Note that there are three different places where a return can happen. The routine returns only when a sensible request has been made; for a fairly thorough description of its output, which is written into the <span class="fixed">parser_results</span> array and also into several globals (see <a href="./OrderOfPlay.i6t.html">OrderOfPlay.i6t</a>).<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line520">520</span><span class="td">[ Parser__parse</span></span>
<span class="tr"><span class="th" id="line521">521</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;syntax line num_lines line_address i j k token l m inferred_go;</span></span>
<span class="tr"><span class="th" id="line522">522</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;cobj_flag = 0;</span></span>
<span class="tr"><span class="th" id="line523">523</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;ACTION_PRES = 0;</span></span>
<span class="tr"><span class="th" id="line524">524</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;NO_INPS_PRES = 0;</span></span>
<span class="tr"><span class="th" id="line525">525</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP1_PRES = 0;</span></span>
<span class="tr"><span class="th" id="line526">526</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP2_PRES = 0;</span></span>
<span class="tr"><span class="th" id="line527">527</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;meta = false;</span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-a">Parser Letter A.</h3><p><p> Get the input, do OOPS and AGAIN.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line533">533</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (held_back_mode) {</span></span>
<span class="tr"><span class="th" id="line534">534</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;held_back_mode = false; wn = hb_wn;</span></span>
<span class="tr"><span class="th" id="line535">535</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (verb_wordnum &gt; 0) i = WordAddress(verb_wordnum); else i = WordAddress(1);</span></span>
<span class="tr"><span class="th" id="line536">536</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = WordAddress(wn);</span></span>
<span class="tr"><span class="th" id="line537">537</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i&lt;=j) for (: i&lt;j : i++) i-&gt;0 = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line538">538</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = NextWord();</span></span>
<span class="tr"><span class="th" id="line539">539</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == AGAIN1__WD or AGAIN2__WD or AGAIN3__WD) {</span></span>
<span class="tr"><span class="th" id="line540">540</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Delete the words &quot;then again&quot; from the again buffer,</span></span></span>
<span class="tr"><span class="th" id="line541">541</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! in which we have just realised that it must occur:</span></span></span>
<span class="tr"><span class="th" id="line542">542</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! prevents an infinite loop on &quot;i. again&quot;</span></span></span>
<span class="tr"><span class="th" id="line543">543</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line544">544</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = WordAddress(wn-2)-buffer;</span></span>
<span class="tr"><span class="th" id="line545">545</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wn &gt; num_words) j = INPUT_BUFFER_LEN-1;</span></span>
<span class="tr"><span class="th" id="line546">546</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else j = WordAddress(wn)-buffer;</span></span>
<span class="tr"><span class="th" id="line547">547</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (: i&lt;j : i++) buffer3-&gt;i = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line548">548</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line549">549</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line550">550</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_Tokenise(buffer, parse);</span></span>
<span class="tr"><span class="th" id="line551">551</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line563">ReParse</a>;</span></span>
<span class="tr"><span class="th" id="line552">552</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line553">553</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line554">554</span><span class="td">&nbsp;&nbsp;.ReType;</span></span>
<span class="tr"><span class="th" id="line555">555</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line556">556</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;cobj_flag = 0;</span></span>
<span class="tr"><span class="th" id="line557">557</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actors_location = ScopeCeiling(player);</span></span>
<span class="tr"><span class="th" id="line558">558</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(READING_A_COMMAND_ACT); if (ForActivity(READING_A_COMMAND_ACT)==false) {</span></span>
<span class="tr"><span class="th" id="line559">559</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Keyboard(buffer,parse);</span></span>
<span class="tr"><span class="th" id="line560">560</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num_words = WordCount(); players_command = 100 + num_words;</span></span>
<span class="tr"><span class="th" id="line561">561</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;} if (EndActivity(READING_A_COMMAND_ACT)) jump <a href="./Parser.i6t.html#line554">ReType</a>;</span></span>
<span class="tr"><span class="th" id="line562">562</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line563">563</span><span class="td">&nbsp;&nbsp;.ReParse;</span></span>
<span class="tr"><span class="th" id="line564">564</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line565">565</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_inflection = name;</span></span>
<span class="tr"><span class="th" id="line566">566</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line567">567</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Initially assume the command is aimed at the player, and the verb</span></span></span>
<span class="tr"><span class="th" id="line568">568</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! is the first word</span></span></span>
<span class="tr"><span class="th" id="line569">569</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line570">570</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;num_words = WordCount(); players_command = 100 + num_words;</span></span>
<span class="tr"><span class="th" id="line571">571</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = 1; inferred_go = false;</span></span>
<span class="tr"><span class="th" id="line572">572</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line573">573</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef LanguageToInformese;</span></span>
<span class="tr"><span class="th" id="line574">574</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LanguageToInformese();</span></span>
<span class="tr"><span class="th" id="line575">575</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Re-tokenise:</span></span></span>
<span class="tr"><span class="th" id="line576">576</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;VM_Tokenise(buffer,parse);</span></span>
<span class="tr"><span class="th" id="line577">577</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! LanguageToInformese</span></span></span>
<span class="tr"><span class="th" id="line578">578</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line579">579</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;num_words = WordCount(); players_command = 100 + num_words;</span></span>
<span class="tr"><span class="th" id="line580">580</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line581">581</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;k=0;</span></span>
<span class="tr"><span class="th" id="line582">582</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line583">583</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2) {</span></span>
<span class="tr"><span class="th" id="line584">584</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[ &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line585">585</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;num_words : i++) {</span></span>
<span class="tr"><span class="th" id="line586">586</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line587">587</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line588">588</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = parse--&gt;(i*2 + 1);</span></span>
<span class="tr"><span class="th" id="line589">589</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line590">590</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = parse--&gt;(i*3 + 1);</span></span>
<span class="tr"><span class="th" id="line591">591</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line592">592</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = WordAddress(i+1);</span></span>
<span class="tr"><span class="th" id="line593">593</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = WordLength(i+1);</span></span>
<span class="tr"><span class="th" id="line594">594</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;~&quot;</span>; for (m=0 : m&lt;l : m++) print (char) k-&gt;m; print <span class="dstring">&quot;~ &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line595">595</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line596">596</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (j == 0) print <span class="dstring">&quot;?&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line597">597</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line598">598</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line599">599</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (UnsignedCompare(j, HDR_DICTIONARY--&gt;0) &gt;= 0 &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line600">600</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UnsignedCompare(j, HDR_HIGHMEMORY--&gt;0) &lt; 0)</span></span>
<span class="tr"><span class="th" id="line601">601</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print (address) j;</span></span>
<span class="tr"><span class="th" id="line602">602</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else print j;</span></span>
<span class="tr"><span class="th" id="line603">603</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line604">604</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (j-&gt;0 == $60) print (address) j;</span></span>
<span class="tr"><span class="th" id="line605">605</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else print j;</span></span>
<span class="tr"><span class="th" id="line606">606</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line607">607</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line608">608</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i ~= num_words-1) print <span class="dstring">&quot; / &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line609">609</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line610">610</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot; ]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line611">611</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line612">612</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line613">613</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;verb_wordnum = 1;</span></span>
<span class="tr"><span class="th" id="line614">614</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actor = player;</span></span>
<span class="tr"><span class="th" id="line615">615</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actors_location = ScopeCeiling(player);</span></span>
<span class="tr"><span class="th" id="line616">616</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;usual_grammar_after = 0;</span></span>
<span class="tr"><span class="th" id="line617">617</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line618">618</span><span class="td">&nbsp;&nbsp;.AlmostReParse;</span></span>
<span class="tr"><span class="th" id="line619">619</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line620">620</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;scope_token = 0;</span></span>
<span class="tr"><span class="th" id="line621">621</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;action_to_be = NULL;</span></span>
<span class="tr"><span class="th" id="line622">622</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line623">623</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Begin from what we currently think is the verb word</span></span></span>
<span class="tr"><span class="th" id="line624">624</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line625">625</span><span class="td">&nbsp;&nbsp;.BeginCommand;</span></span>
<span class="tr"><span class="th" id="line626">626</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line627">627</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = verb_wordnum;</span></span>
<span class="tr"><span class="th" id="line628">628</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;verb_word = NextWordStopped();</span></span>
<span class="tr"><span class="th" id="line629">629</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line630">630</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If there&#39;s no input here, we must have something like &quot;person,&quot;.</span></span></span>
<span class="tr"><span class="th" id="line631">631</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line632">632</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word == -1) {</span></span>
<span class="tr"><span class="th" id="line633">633</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = STUCK_PE; jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line634">634</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line635">635</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word == comma_word) {</span></span>
<span class="tr"><span class="th" id="line636">636</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = COMMABEGIN_PE; jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line637">637</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line638">638</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line639">639</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Now try for &quot;again&quot; or &quot;g&quot;, which are special cases: don&#39;t allow &quot;again&quot; if nothing</span></span></span>
<span class="tr"><span class="th" id="line640">640</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! has previously been typed; simply copy the previous text across</span></span></span>
<span class="tr"><span class="th" id="line641">641</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line642">642</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word == AGAIN2__WD or AGAIN3__WD) verb_word = AGAIN1__WD;</span></span>
<span class="tr"><span class="th" id="line643">643</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word == AGAIN1__WD) {</span></span>
<span class="tr"><span class="th" id="line644">644</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (actor ~= player) {</span></span>
<span class="tr"><span class="th" id="line645">645</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = ANIMAAGAIN_PE;</span></span>
<span class="tr"><span class="th" id="line646">646</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line647">647</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line648">648</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line649">649</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (buffer3-&gt;1 == 0) {</span></span>
<span class="tr"><span class="th" id="line650">650</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARSER_COMMAND_INTERNAL_RM(<span class="sstring">&#39;D&#39;</span>); new_line;</span></span>
<span class="tr"><span class="th" id="line651">651</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line554">ReType</a>;</span></span>
<span class="tr"><span class="th" id="line652">652</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line653">653</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line654">654</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (buffer3--&gt;0 == 0) {</span></span>
<span class="tr"><span class="th" id="line655">655</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARSER_COMMAND_INTERNAL_RM(<span class="sstring">&#39;D&#39;</span>); new_line;</span></span>
<span class="tr"><span class="th" id="line656">656</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line554">ReType</a>;</span></span>
<span class="tr"><span class="th" id="line657">657</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line658">658</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line659">659</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;INPUT_BUFFER_LEN : i++) buffer-&gt;i = buffer3-&gt;i;</span></span>
<span class="tr"><span class="th" id="line660">660</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_Tokenise(buffer,parse);</span></span>
<span class="tr"><span class="th" id="line661">661</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num_words = WordCount(); players_command = 100 + num_words;</span></span>
<span class="tr"><span class="th" id="line662">662</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line563">ReParse</a>;</span></span>
<span class="tr"><span class="th" id="line663">663</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line664">664</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line665">665</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Save the present input in case of an &quot;again&quot; next time</span></span></span>
<span class="tr"><span class="th" id="line666">666</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line667">667</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word ~= AGAIN1__WD)</span></span>
<span class="tr"><span class="th" id="line668">668</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;INPUT_BUFFER_LEN : i++) buffer3-&gt;i = buffer-&gt;i;</span></span>
<span class="tr"><span class="th" id="line669">669</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line670">670</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (usual_grammar_after == 0) {</span></span>
<span class="tr"><span class="th" id="line671">671</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = verb_wordnum;</span></span>
<span class="tr"><span class="th" id="line672">672</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = RunRoutines(actor, grammar); </span></span>
<span class="tr"><span class="th" id="line673">673</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line674">674</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2 &amp;&amp; actor.grammar ~= 0 or NULL)</span></span>
<span class="tr"><span class="th" id="line675">675</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot; [Grammar property returned &quot;</span>, i, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line676">676</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line677">677</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line678">678</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((i ~= 0 or 1) &amp;&amp; (VM_InvalidDictionaryAddress(i))) {</span></span>
<span class="tr"><span class="th" id="line679">679</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usual_grammar_after = verb_wordnum; i=-i;</span></span>
<span class="tr"><span class="th" id="line680">680</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line681">681</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line682">682</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == 1) {</span></span>
<span class="tr"><span class="th" id="line683">683</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;ACTION_PRES = action;</span></span>
<span class="tr"><span class="th" id="line684">684</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;NO_INPS_PRES = 0;</span></span>
<span class="tr"><span class="th" id="line685">685</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP1_PRES = noun;</span></span>
<span class="tr"><span class="th" id="line686">686</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP2_PRES = second;</span></span>
<span class="tr"><span class="th" id="line687">687</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (noun) parser_results--&gt;NO_INPS_PRES = 1;</span></span>
<span class="tr"><span class="th" id="line688">688</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (second) parser_results--&gt;NO_INPS_PRES = 2;</span></span>
<span class="tr"><span class="th" id="line689">689</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line690">690</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line691">691</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i ~= 0) { verb_word = i; wn--; verb_wordnum--; }</span></span>
<span class="tr"><span class="th" id="line692">692</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else { wn = verb_wordnum; verb_word = NextWord(); }</span></span>
<span class="tr"><span class="th" id="line693">693</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line694">694</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else usual_grammar_after = 0;</span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-b">Parser Letter B.</h3><p><p> Is the command a direction name, and so an implicit GO? If so, go to (K).<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line700">700</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef LanguageIsVerb;</span></span>
<span class="tr"><span class="th" id="line701">701</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word == 0) {</span></span>
<span class="tr"><span class="th" id="line702">702</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = wn; verb_word = LanguageIsVerb(buffer, parse, verb_wordnum);</span></span>
<span class="tr"><span class="th" id="line703">703</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = i;</span></span>
<span class="tr"><span class="th" id="line704">704</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line705">705</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! LanguageIsVerb</span></span></span>
<span class="tr"><span class="th" id="line706">706</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line707">707</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If the first word is not listed as a verb, it must be a direction</span></span></span>
<span class="tr"><span class="th" id="line708">708</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! or the name of someone to talk to</span></span></span>
<span class="tr"><span class="th" id="line709">709</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line710">710</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word == 0 || ((verb_word-&gt;#dict_par1) &amp; 1) == 0) {</span></span>
<span class="tr"><span class="th" id="line711">711</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line712">712</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! So is the first word an object contained in the special object &quot;compass&quot;</span></span></span>
<span class="tr"><span class="th" id="line713">713</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (i.e., a direction)?  This needs use of NounDomain, a routine which</span></span></span>
<span class="tr"><span class="th" id="line714">714</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! does the object matching, returning the object number, or 0 if none found,</span></span></span>
<span class="tr"><span class="th" id="line715">715</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! or REPARSE_CODE if it has restructured the parse table so the whole parse</span></span></span>
<span class="tr"><span class="th" id="line716">716</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! must be begun again...</span></span></span>
<span class="tr"><span class="th" id="line717">717</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line718">718</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = verb_wordnum; indef_mode = false; token_filter = 0; parameters = 0;</span></span>
<span class="tr"><span class="th" id="line719">719</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@push actor; @push action; @push action_to_be;</span></span>
<span class="tr"><span class="th" id="line720">720</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actor = player; meta = false; action = ##Go; action_to_be = ##Go;</span></span>
<span class="tr"><span class="th" id="line721">721</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = NounDomain(compass, 0, 0);</span></span>
<span class="tr"><span class="th" id="line722">722</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull action_to_be; @pull action; @pull actor;</span></span>
<span class="tr"><span class="th" id="line723">723</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == REPARSE_CODE) jump <a href="./Parser.i6t.html#line563">ReParse</a>;</span></span>
<span class="tr"><span class="th" id="line724">724</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line725">725</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If it is a direction, send back the results:</span></span></span>
<span class="tr"><span class="th" id="line726">726</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! action=GoSub, no of arguments=1, argument 1=the direction.</span></span></span>
<span class="tr"><span class="th" id="line727">727</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line728">728</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((l~=0) &amp;&amp; (l ofclass K3_direction)) {</span></span>
<span class="tr"><span class="th" id="line729">729</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;ACTION_PRES = ##Go;</span></span>
<span class="tr"><span class="th" id="line730">730</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;NO_INPS_PRES = 1;</span></span>
<span class="tr"><span class="th" id="line731">731</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP1_PRES = l;</span></span>
<span class="tr"><span class="th" id="line732">732</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inferred_go = true;</span></span>
<span class="tr"><span class="th" id="line733">733</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1397">LookForMore</a>;</span></span>
<span class="tr"><span class="th" id="line734">734</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line735">735</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line736">736</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;} <span class="comment">! end of first-word-not-a-verb</span></span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-c">Parser Letter C.</h3><p><p> Is anyone being addressed?<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line742">742</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Only check for a comma (a &quot;someone, do something&quot; command) if we are</span></span></span>
<span class="tr"><span class="th" id="line743">743</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! not already in the middle of one.  (This simplification stops us from</span></span></span>
<span class="tr"><span class="th" id="line744">744</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! worrying about &quot;robot, wizard, you are an idiot&quot;, telling the robot to</span></span></span>
<span class="tr"><span class="th" id="line745">745</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! tell the wizard that she is an idiot.)</span></span></span>
<span class="tr"><span class="th" id="line746">746</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line747">747</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (actor == player) {</span></span>
<span class="tr"><span class="th" id="line748">748</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=2 : j&lt;=num_words : j++) {</span></span>
<span class="tr"><span class="th" id="line749">749</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i=NextWord();</span></span>
<span class="tr"><span class="th" id="line750">750</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == comma_word) jump <a href="./Parser.i6t.html#line758">Conversation</a>;</span></span>
<span class="tr"><span class="th" id="line751">751</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line752">752</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line753">753</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line824">NotConversation</a>;</span></span>
<span class="tr"><span class="th" id="line754">754</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line755">755</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! NextWord nudges the word number wn on by one each time, so we&#39;ve now</span></span></span>
<span class="tr"><span class="th" id="line756">756</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! advanced past a comma.  (A comma is a word all on its own in the table.)</span></span></span>
<span class="tr"><span class="th" id="line757">757</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line758">758</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.Conversation;</span></span>
<span class="tr"><span class="th" id="line759">759</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line760">760</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;j = wn - 1;</span></span>
<span class="tr"><span class="th" id="line761">761</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line762">762</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Use NounDomain (in the context of &quot;animate creature&quot;) to see if the</span></span></span>
<span class="tr"><span class="th" id="line763">763</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! words make sense as the name of someone held or nearby</span></span></span>
<span class="tr"><span class="th" id="line764">764</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line765">765</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = 1; lookahead = HELD_TOKEN;</span></span>
<span class="tr"><span class="th" id="line766">766</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;scope_reason = TALKING_REASON;</span></span>
<span class="tr"><span class="th" id="line767">767</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;l = NounDomain(player,actors_location,6);</span></span>
<span class="tr"><span class="th" id="line768">768</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;scope_reason = PARSING_REASON;</span></span>
<span class="tr"><span class="th" id="line769">769</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (l == REPARSE_CODE) jump <a href="./Parser.i6t.html#line563">ReParse</a>;</span></span>
<span class="tr"><span class="th" id="line770">770</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (l == 0) {</span></span>
<span class="tr"><span class="th" id="line771">771</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word &amp;&amp; ((verb_word-&gt;#dict_par1) &amp; 1)) jump <a href="./Parser.i6t.html#line824">NotConversation</a>;</span></span>
<span class="tr"><span class="th" id="line772">772</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = MISSINGPERSON_PE; jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line773">773</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line774">774</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line775">775</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.Conversation2;</span></span>
<span class="tr"><span class="th" id="line776">776</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line777">777</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! The object addressed must at least be &quot;talkable&quot; if not actually &quot;animate&quot;</span></span></span>
<span class="tr"><span class="th" id="line778">778</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (the distinction allows, for instance, a microphone to be spoken to,</span></span></span>
<span class="tr"><span class="th" id="line779">779</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! without the parser thinking that the microphone is human).</span></span></span>
<span class="tr"><span class="th" id="line780">780</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line781">781</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (l hasnt animate &amp;&amp; l hasnt talkable) {</span></span>
<span class="tr"><span class="th" id="line782">782</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = ANIMALISTEN_PE; noun = l; jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line783">783</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line784">784</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line785">785</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Check that there aren&#39;t any mystery words between the end of the person&#39;s</span></span></span>
<span class="tr"><span class="th" id="line786">786</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! name and the comma (eg, throw out &quot;dwarf sdfgsdgs, go north&quot;).</span></span></span>
<span class="tr"><span class="th" id="line787">787</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line788">788</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (wn ~= j) {</span></span>
<span class="tr"><span class="th" id="line789">789</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word &amp;&amp; ((verb_word-&gt;#dict_par1) &amp; 1)) jump <a href="./Parser.i6t.html#line824">NotConversation</a>;</span></span>
<span class="tr"><span class="th" id="line790">790</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = TOTALK_PE; jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line791">791</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line792">792</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line793">793</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! The player has now successfully named someone.  Adjust &quot;him&quot;, &quot;her&quot;, &quot;it&quot;:</span></span></span>
<span class="tr"><span class="th" id="line794">794</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line795">795</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;PronounNotice(l);</span></span>
<span class="tr"><span class="th" id="line796">796</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line797">797</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Set the global variable &quot;actor&quot;, adjust the number of the first word,</span></span></span>
<span class="tr"><span class="th" id="line798">798</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! and begin parsing again from there.</span></span></span>
<span class="tr"><span class="th" id="line799">799</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line800">800</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;verb_wordnum = j + 1;</span></span>
<span class="tr"><span class="th" id="line801">801</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line802">802</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Stop things like &quot;me, again&quot;:</span></span></span>
<span class="tr"><span class="th" id="line803">803</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line804">804</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (l == player) {</span></span>
<span class="tr"><span class="th" id="line805">805</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = verb_wordnum;</span></span>
<span class="tr"><span class="th" id="line806">806</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (NextWordStopped() == AGAIN1__WD or AGAIN2__WD or AGAIN3__WD) {</span></span>
<span class="tr"><span class="th" id="line807">807</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = ANIMAAGAIN_PE;</span></span>
<span class="tr"><span class="th" id="line808">808</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line809">809</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line810">810</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line811">811</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line812">812</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actor = l;</span></span>
<span class="tr"><span class="th" id="line813">813</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actors_location = ScopeCeiling(l);</span></span>
<span class="tr"><span class="th" id="line814">814</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line815">815</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 1)</span></span>
<span class="tr"><span class="th" id="line816">816</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[Actor is &quot;</span>, (the) actor, <span class="dstring">&quot; in &quot;</span>, (name) actors_location, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line817">817</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line818">818</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line625">BeginCommand</a>;</span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-d">Parser Letter D.</h3><p><p> Get the verb: try all the syntax lines for that verb.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line824">824</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.NotConversation;</span></span>
<span class="tr"><span class="th" id="line825">825</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word == 0 || ((verb_word-&gt;#dict_par1) &amp; 1) == 0) {</span></span>
<span class="tr"><span class="th" id="line826">826</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verb_word = UnknownVerb(verb_word);</span></span>
<span class="tr"><span class="th" id="line827">827</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (verb_word ~= 0) jump <a href="./Parser.i6t.html#line831">VerbAccepted</a>;</span></span>
<span class="tr"><span class="th" id="line828">828</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = VERB_PE;</span></span>
<span class="tr"><span class="th" id="line829">829</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line830">830</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line831">831</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.VerbAccepted;</span></span>
<span class="tr"><span class="th" id="line832">832</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line833">833</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! We now definitely have a verb, not a direction, whether we got here by the</span></span></span>
<span class="tr"><span class="th" id="line834">834</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! &quot;take ...&quot; or &quot;person, take ...&quot; method.  Get the meta flag for this verb:</span></span></span>
<span class="tr"><span class="th" id="line835">835</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line836">836</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;meta = ((verb_word-&gt;#dict_par1) &amp; 2)/2;</span></span>
<span class="tr"><span class="th" id="line837">837</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line838">838</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! You can&#39;t order other people to &quot;full score&quot; for you, and so on...</span></span></span>
<span class="tr"><span class="th" id="line839">839</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line840">840</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (meta == 1 &amp;&amp; actor ~= player) {</span></span>
<span class="tr"><span class="th" id="line841">841</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = VERB_PE;</span></span>
<span class="tr"><span class="th" id="line842">842</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;meta = 0;</span></span>
<span class="tr"><span class="th" id="line843">843</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line844">844</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line845">845</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line846">846</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Now let i be the corresponding verb number...</span></span></span>
<span class="tr"><span class="th" id="line847">847</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line848">848</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = DictionaryWordToVerbNum(verb_word);</span></span>
<span class="tr"><span class="th" id="line849">849</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line850">850</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...then look up the i-th entry in the verb table, whose address is at word</span></span></span>
<span class="tr"><span class="th" id="line851">851</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! 7 in the Z-machine (in the header), so as to get the address of the syntax</span></span></span>
<span class="tr"><span class="th" id="line852">852</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! table for the given verb...</span></span></span>
<span class="tr"><span class="th" id="line853">853</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line854">854</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line855">855</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;syntax = (HDR_STATICMEMORY--&gt;0)--&gt;i;</span></span>
<span class="tr"><span class="th" id="line856">856</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line857">857</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;syntax = (#grammar_table)--&gt;(i+1);</span></span>
<span class="tr"><span class="th" id="line858">858</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line859">859</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line860">860</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...and then see how many lines (ie, different patterns corresponding to the</span></span></span>
<span class="tr"><span class="th" id="line861">861</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! same verb) are stored in the parse table...</span></span></span>
<span class="tr"><span class="th" id="line862">862</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line863">863</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;num_lines = (syntax-&gt;0) - 1;</span></span>
<span class="tr"><span class="th" id="line864">864</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line865">865</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...and now go through them all, one by one.</span></span></span>
<span class="tr"><span class="th" id="line866">866</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! To prevent pronoun_word 0 being misunderstood,</span></span></span>
<span class="tr"><span class="th" id="line867">867</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line868">868</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;pronoun_word = NULL; pronoun_obj = NULL;</span></span>
<span class="tr"><span class="th" id="line869">869</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line870">870</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line871">871</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 1)</span></span>
<span class="tr"><span class="th" id="line872">872</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[Parsing for the verb &quot;</span>, (address) verb_word, <span class="dstring">&quot; (&quot;</span>, num_lines+1, <span class="dstring">&quot; lines)]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line873">873</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line874">874</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line875">875</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;best_etype = STUCK_PE; nextbest_etype = STUCK_PE;</span></span>
<span class="tr"><span class="th" id="line876">876</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;multiflag = false;</span></span>
<span class="tr"><span class="th" id="line877">877</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line878">878</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! &quot;best_etype&quot; is the current failure-to-match error - it is by default</span></span></span>
<span class="tr"><span class="th" id="line879">879</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! the least informative one, &quot;don&#39;t understand that sentence&quot;.</span></span></span>
<span class="tr"><span class="th" id="line880">880</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! &quot;nextbest_etype&quot; remembers the best alternative to having to ask a</span></span></span>
<span class="tr"><span class="th" id="line881">881</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! scope token for an error message (i.e., the best not counting ASKSCOPE_PE).</span></span></span>
<span class="tr"><span class="th" id="line882">882</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! multiflag is used here to prevent inappropriate MULTI_PE errors</span></span></span>
<span class="tr"><span class="th" id="line883">883</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! in addition to its unrelated duties passing information to action routines</span></span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-e">Parser Letter E.</h3><p><p> Break down a syntax line into analysed tokens.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line889">889</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;line_address = syntax + 1;</span></span>
<span class="tr"><span class="th" id="line890">890</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line891">891</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (line=0 : line&lt;=num_lines : line++) {</span></span>
<span class="tr"><span class="th" id="line892">892</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line893">893</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Unpack the syntax line from Inform format into three arrays; ensure that</span></span></span>
<span class="tr"><span class="th" id="line894">894</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! the sequence of tokens ends in an ENDIT_TOKEN.</span></span></span>
<span class="tr"><span class="th" id="line895">895</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line896">896</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line_address = UnpackGrammarLine(line_address);</span></span>
<span class="tr"><span class="th" id="line897">897</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line898">898</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line899">899</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 1) {</span></span>
<span class="tr"><span class="th" id="line900">900</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2) new_line;</span></span>
<span class="tr"><span class="th" id="line901">901</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[line &quot;</span>, line; DebugGrammarLine();</span></span>
<span class="tr"><span class="th" id="line902">902</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line903">903</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line904">904</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line905">905</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line906">906</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! We aren&#39;t in &quot;not holding&quot; or inferring modes, and haven&#39;t entered</span></span></span>
<span class="tr"><span class="th" id="line907">907</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! any parameters on the line yet, or any special numbers; the multiple</span></span></span>
<span class="tr"><span class="th" id="line908">908</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! object is still empty.</span></span></span>
<span class="tr"><span class="th" id="line909">909</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line910">910</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inferfrom = 0;</span></span>
<span class="tr"><span class="th" id="line911">911</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters = 0;</span></span>
<span class="tr"><span class="th" id="line912">912</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nsns = 0; special_word = 0;</span></span>
<span class="tr"><span class="th" id="line913">913</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = 0;</span></span>
<span class="tr"><span class="th" id="line914">914</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multi_context = 0;</span></span>
<span class="tr"><span class="th" id="line915">915</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = STUCK_PE;</span></span>
<span class="tr"><span class="th" id="line916">916</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line917">917</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Put the word marker back to just after the verb</span></span></span>
<span class="tr"><span class="th" id="line918">918</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line919">919</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = verb_wordnum+1;</span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-f">Parser Letter F.</h3><p><p> Look ahead for advance warning for <span class="fixed">multiexcept</span>/<span class="fixed">multiinside</span>.<p></p><p> There are two special cases where parsing a token now has to be affected by the result of parsing another token later, and these two cases (multiexcept and multiinside tokens) are helped by a quick look ahead, to work out the future token now. We can only carry this out in the simple (but by far the most common) case:<p> <div class="pre-lines">multiexcept &lt;one or more prepositions&gt; noun</div><p> and similarly for <span class="fixed">multiinside</span>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line935">935</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;advance_warning = -1; indef_mode = false;</span></span>
<span class="tr"><span class="th" id="line936">936</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0,m=false,pcount=0 : line_token--&gt;pcount ~= ENDIT_TOKEN : pcount++) {</span></span>
<span class="tr"><span class="th" id="line937">937</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_token = 0;</span></span>
<span class="tr"><span class="th" id="line938">938</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line939">939</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_ttype--&gt;pcount ~= PREPOSITION_TT) i++;</span></span>
<span class="tr"><span class="th" id="line940">940</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line941">941</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_ttype--&gt;pcount == ELEMENTARY_TT) {</span></span>
<span class="tr"><span class="th" id="line942">942</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_tdata--&gt;pcount == MULTI_TOKEN) m = true;</span></span>
<span class="tr"><span class="th" id="line943">943</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_tdata--&gt;pcount == MULTIEXCEPT_TOKEN or MULTIINSIDE_TOKEN  &amp;&amp; i == 1) {</span></span>
<span class="tr"><span class="th" id="line944">944</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! First non-preposition is &quot;multiexcept&quot; or</span></span></span>
<span class="tr"><span class="th" id="line945">945</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! &quot;multiinside&quot;, so look ahead.</span></span></span>
<span class="tr"><span class="th" id="line946">946</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line947">947</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line948">948</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2) print <span class="dstring">&quot; [Trying look-ahead]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line949">949</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line950">950</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line951">951</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! We need this to be followed by 1 or more prepositions.</span></span></span>
<span class="tr"><span class="th" id="line952">952</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line953">953</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcount++;</span></span>
<span class="tr"><span class="th" id="line954">954</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_ttype--&gt;pcount == PREPOSITION_TT) {</span></span>
<span class="tr"><span class="th" id="line955">955</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! skip ahead to a preposition word in the input</span></span></span>
<span class="tr"><span class="th" id="line956">956</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do {</span></span>
<span class="tr"><span class="th" id="line957">957</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = NextWord();</span></span>
<span class="tr"><span class="th" id="line958">958</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} until ((wn &gt; num_words) ||</span></span>
<span class="tr"><span class="th" id="line959">959</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(l &amp;&amp; (l-&gt;#dict_par1) &amp; 8 ~= 0));</span></span>
<span class="tr"><span class="th" id="line960">960</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line961">961</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wn &gt; num_words) {</span></span>
<span class="tr"><span class="th" id="line962">962</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line963">963</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2)</span></span>
<span class="tr"><span class="th" id="line964">964</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot; [Look-ahead aborted: prepositions missing]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line965">965</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif;</span></span>
<span class="tr"><span class="th" id="line966">966</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line999">EmptyLine</a>;</span></span>
<span class="tr"><span class="th" id="line967">967</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line968">968</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line969">969</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do {</span></span>
<span class="tr"><span class="th" id="line970">970</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (PrepositionChain(l, pcount) ~= -1) {</span></span>
<span class="tr"><span class="th" id="line971">971</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! advance past the chain</span></span></span>
<span class="tr"><span class="th" id="line972">972</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((line_token--&gt;pcount)-&gt;0 &amp; $20 ~= 0) {</span></span>
<span class="tr"><span class="th" id="line973">973</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcount++;</span></span>
<span class="tr"><span class="th" id="line974">974</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ((line_token--&gt;pcount ~= ENDIT_TOKEN) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line975">975</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((line_token--&gt;pcount)-&gt;0 &amp; $10 ~= 0))</span></span>
<span class="tr"><span class="th" id="line976">976</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcount++;</span></span>
<span class="tr"><span class="th" id="line977">977</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line978">978</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcount++;</span></span>
<span class="tr"><span class="th" id="line979">979</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line980">980</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line981">981</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! try to find another preposition word</span></span></span>
<span class="tr"><span class="th" id="line982">982</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do {</span></span>
<span class="tr"><span class="th" id="line983">983</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = NextWord();</span></span>
<span class="tr"><span class="th" id="line984">984</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} until ((wn &gt;= num_words) ||</span></span>
<span class="tr"><span class="th" id="line985">985</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(l &amp;&amp; (l-&gt;#dict_par1) &amp; 8 ~= 0));</span></span>
<span class="tr"><span class="th" id="line986">986</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line987">987</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l &amp;&amp; (l-&gt;#dict_par1) &amp; 8) continue;</span></span>
<span class="tr"><span class="th" id="line988">988</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line989">989</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! lookahead failed</span></span></span>
<span class="tr"><span class="th" id="line990">990</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line991">991</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2)</span></span>
<span class="tr"><span class="th" id="line992">992</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot; [Look-ahead aborted: prepositions dont match]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line993">993</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line994">994</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1242">LineFailed</a>;</span></span>
<span class="tr"><span class="th" id="line995">995</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line996">996</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wn &lt;= num_words) l = NextWord();</span></span>
<span class="tr"><span class="th" id="line997">997</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} until (line_ttype--&gt;pcount ~= PREPOSITION_TT);</span></span>
<span class="tr"><span class="th" id="line998">998</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line999">999</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.EmptyLine;</span></span>
<span class="tr"><span class="th" id="line1000">1000</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! put back the non-preposition we just read</span></span></span>
<span class="tr"><span class="th" id="line1001">1001</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn--;</span></span>
<span class="tr"><span class="th" id="line1002">1002</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1003">1003</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((line_ttype--&gt;pcount == ELEMENTARY_TT) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line1004">1004</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(line_tdata--&gt;pcount == NOUN_TOKEN)) {</span></span>
<span class="tr"><span class="th" id="line1005">1005</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = Descriptors();  <span class="comment">! skip past THE etc</span></span></span>
<span class="tr"><span class="th" id="line1006">1006</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l~=0) etype=l;  <span class="comment">! don&#39;t allow multiple objects</span></span></span>
<span class="tr"><span class="th" id="line1007">1007</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = parser_results--&gt;INP1_PRES; @push k; @push parameters;</span></span>
<span class="tr"><span class="th" id="line1008">1008</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters = 1; parser_results--&gt;INP1_PRES = 0;</span></span>
<span class="tr"><span class="th" id="line1009">1009</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = NounDomain(actors_location, actor, NOUN_TOKEN, true);</span></span>
<span class="tr"><span class="th" id="line1010">1010</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull parameters; @pull k; parser_results--&gt;INP1_PRES = k;</span></span>
<span class="tr"><span class="th" id="line1011">1011</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1012">1012</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2) {</span></span>
<span class="tr"><span class="th" id="line1013">1013</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot; [Advanced to ~noun~ token: &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1014">1014</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == REPARSE_CODE) print <span class="dstring">&quot;re-parse request]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1015">1015</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line1016">1016</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == 1) print <span class="dstring">&quot;but multiple found]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1017">1017</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == 0) print <span class="dstring">&quot;error &quot;</span>, etype, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1018">1018</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l &gt;= 2) print (the) l, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1019">1019</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1020">1020</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1021">1021</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1022">1022</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == REPARSE_CODE) jump <a href="./Parser.i6t.html#line563">ReParse</a>;</span></span>
<span class="tr"><span class="th" id="line1023">1023</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l &gt;= 2) advance_warning = l;</span></span>
<span class="tr"><span class="th" id="line1024">1024</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1025">1025</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1026">1026</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></span>
<span class="tr"><span class="th" id="line1027">1027</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1028">1028</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1029">1029</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1030">1030</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1031">1031</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Slightly different line-parsing rules will apply to &quot;take multi&quot;, to</span></span></span>
<span class="tr"><span class="th" id="line1032">1032</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! prevent &quot;take all&quot; behaving correctly but misleadingly when there&#39;s</span></span></span>
<span class="tr"><span class="th" id="line1033">1033</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! nothing to take.</span></span></span>
<span class="tr"><span class="th" id="line1034">1034</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1035">1035</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;take_all_rule = 0;</span></span>
<span class="tr"><span class="th" id="line1036">1036</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m &amp;&amp; params_wanted == 1 &amp;&amp; action_to_be == ##Take)</span></span>
<span class="tr"><span class="th" id="line1037">1037</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;take_all_rule = 1;</span></span>
<span class="tr"><span class="th" id="line1038">1038</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1039">1039</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! And now start again, properly, forearmed or not as the case may be.</span></span></span>
<span class="tr"><span class="th" id="line1040">1040</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! As a precaution, we clear all the variables again (they may have been</span></span></span>
<span class="tr"><span class="th" id="line1041">1041</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! disturbed by the call to NounDomain, which may have called outside</span></span></span>
<span class="tr"><span class="th" id="line1042">1042</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! code, which may have done anything!).</span></span></span>
<span class="tr"><span class="th" id="line1043">1043</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1044">1044</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inferfrom = 0;</span></span>
<span class="tr"><span class="th" id="line1045">1045</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters = 0;</span></span>
<span class="tr"><span class="th" id="line1046">1046</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nsns = 0; special_word = 0;</span></span>
<span class="tr"><span class="th" id="line1047">1047</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = 0;</span></span>
<span class="tr"><span class="th" id="line1048">1048</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = STUCK_PE;</span></span>
<span class="tr"><span class="th" id="line1049">1049</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = verb_wordnum+1;</span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-g">Parser Letter G.</h3><p><p> Parse each token in turn (calling <span class="fixed"><a href="./Parser.i6t.html#line1469">ParseToken</a></span> to do most of the work).<p></p><p> The <span class="fixed">pattern</span> gradually accumulates what has been recognised so far, so that it may be reprinted by the parser later on.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1058">1058</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m = true;</span></span>
<span class="tr"><span class="th" id="line1059">1059</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (pcount=1 : : pcount++)</span></span>
<span class="tr"><span class="th" id="line1060">1060</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_token--&gt;(pcount-1) == ENDIT_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line1061">1061</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (pcount &gt;= 2) {</span></span>
<span class="tr"><span class="th" id="line1062">1062</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ((((line_token--&gt;(pcount-2))-&gt;0) &amp; $10) ~= 0) pcount--;</span></span>
<span class="tr"><span class="th" id="line1063">1063</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AnalyseToken(line_token--&gt;(pcount-2));</span></span>
<span class="tr"><span class="th" id="line1064">1064</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (found_ttype == PREPOSITION_TT) {</span></span>
<span class="tr"><span class="th" id="line1065">1065</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = -1;</span></span>
<span class="tr"><span class="th" id="line1066">1066</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (true) {</span></span>
<span class="tr"><span class="th" id="line1067">1067</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m = NextWordStopped();</span></span>
<span class="tr"><span class="th" id="line1068">1068</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m == -1) break;</span></span>
<span class="tr"><span class="th" id="line1069">1069</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = m;</span></span>
<span class="tr"><span class="th" id="line1070">1070</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1071">1071</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (PrepositionChain(l, pcount-2) == -1) {</span></span>
<span class="tr"><span class="th" id="line1072">1072</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m = false;</span></span>
<span class="tr"><span class="th" id="line1073">1073</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1074">1074</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2)</span></span>
<span class="tr"><span class="th" id="line1075">1075</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[line rejected for not ending with correct preposition]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1076">1076</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1077">1077</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else m = true;</span></span>
<span class="tr"><span class="th" id="line1078">1078</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1079">1079</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1080">1080</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></span>
<span class="tr"><span class="th" id="line1081">1081</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1082">1082</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = verb_wordnum+1;</span></span>
<span class="tr"><span class="th" id="line1083">1083</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1084">1084</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m) for (pcount=1 : : pcount++) {</span></span>
<span class="tr"><span class="th" id="line1085">1085</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pattern--&gt;pcount = PATTERN_NULL; scope_token = 0;</span></span>
<span class="tr"><span class="th" id="line1086">1086</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1087">1087</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token = line_token--&gt;(pcount-1);</span></span>
<span class="tr"><span class="th" id="line1088">1088</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lookahead = line_token--&gt;pcount;</span></span>
<span class="tr"><span class="th" id="line1089">1089</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1090">1090</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1091">1091</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 2)</span></span>
<span class="tr"><span class="th" id="line1092">1092</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot; [line &quot;</span>, line, <span class="dstring">&quot; token &quot;</span>, pcount, <span class="dstring">&quot; word &quot;</span>, wn, <span class="dstring">&quot; : &quot;</span>, (DebugToken) token,</span></span>
<span class="tr"><span class="th" id="line1093">1093</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1094">1094</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1095">1095</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1096">1096</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (token ~= ENDIT_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line1097">1097</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_reason = PARSING_REASON;</span></span>
<span class="tr"><span class="th" id="line1098">1098</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AnalyseToken(token);</span></span>
<span class="tr"><span class="th" id="line1099">1099</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1100">1100</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = ParseToken(found_ttype, found_tdata, pcount-1, token);</span></span>
<span class="tr"><span class="th" id="line1101">1101</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ((l &gt;= GPR_NOUN) &amp;&amp; (l &lt; -1)) l = ParseToken(ELEMENTARY_TT, l + 256);</span></span>
<span class="tr"><span class="th" id="line1102">1102</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_reason = PARSING_REASON;</span></span>
<span class="tr"><span class="th" id="line1103">1103</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1104">1104</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == GPR_PREPOSITION) {</span></span>
<span class="tr"><span class="th" id="line1105">1105</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (found_ttype~=PREPOSITION_TT &amp;&amp; (found_ttype~=ELEMENTARY_TT ||</span></span>
<span class="tr"><span class="th" id="line1106">1106</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found_tdata~=TOPIC_TOKEN)) params_wanted--;</span></span>
<span class="tr"><span class="th" id="line1107">1107</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = true;</span></span>
<span class="tr"><span class="th" id="line1108">1108</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1109">1109</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line1110">1110</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l &lt; 0) l = false;</span></span>
<span class="tr"><span class="th" id="line1111">1111</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line1112">1112</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l ~= GPR_REPARSE) {</span></span>
<span class="tr"><span class="th" id="line1113">1113</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == GPR_NUMBER) {</span></span>
<span class="tr"><span class="th" id="line1114">1114</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (nsns == 0) special_number1 = parsed_number;</span></span>
<span class="tr"><span class="th" id="line1115">1115</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else special_number2 = parsed_number;</span></span>
<span class="tr"><span class="th" id="line1116">1116</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nsns++; l = 1;</span></span>
<span class="tr"><span class="th" id="line1117">1117</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1118">1118</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == GPR_MULTIPLE) l = 0;</span></span>
<span class="tr"><span class="th" id="line1119">1119</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;(parameters+INP1_PRES) = l;</span></span>
<span class="tr"><span class="th" id="line1120">1120</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters++;</span></span>
<span class="tr"><span class="th" id="line1121">1121</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pattern--&gt;pcount = l;</span></span>
<span class="tr"><span class="th" id="line1122">1122</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = true;</span></span>
<span class="tr"><span class="th" id="line1123">1123</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1124">1124</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1125">1125</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1126">1126</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) {</span></span>
<span class="tr"><span class="th" id="line1127">1127</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;  [token resulted in &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1128">1128</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == REPARSE_CODE) print <span class="dstring">&quot;re-parse request]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1129">1129</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == 0) print <span class="dstring">&quot;failure with error type &quot;</span>, etype, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1130">1130</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == 1) print <span class="dstring">&quot;success]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1131">1131</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1132">1132</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1133">1133</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1134">1134</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == REPARSE_CODE) jump <a href="./Parser.i6t.html#line563">ReParse</a>;</span></span>
<span class="tr"><span class="th" id="line1135">1135</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == false) break;</span></span>
<span class="tr"><span class="th" id="line1136">1136</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1137">1137</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line1138">1138</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1139">1139</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If the player has entered enough already but there&#39;s still</span></span></span>
<span class="tr"><span class="th" id="line1140">1140</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! text to wade through: store the pattern away so as to be able to produce</span></span></span>
<span class="tr"><span class="th" id="line1141">1141</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! a decent error message if this turns out to be the best we ever manage,</span></span></span>
<span class="tr"><span class="th" id="line1142">1142</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! and in the mean time give up on this line</span></span></span>
<span class="tr"><span class="th" id="line1143">1143</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1144">1144</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! However, if the superfluous text begins with a comma or &quot;then&quot; then</span></span></span>
<span class="tr"><span class="th" id="line1145">1145</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! take that to be the start of another instruction</span></span></span>
<span class="tr"><span class="th" id="line1146">1146</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1147">1147</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wn &lt;= num_words) {</span></span>
<span class="tr"><span class="th" id="line1148">1148</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = NextWord();</span></span>
<span class="tr"><span class="th" id="line1149">1149</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == THEN1__WD or THEN2__WD or THEN3__WD or comma_word) {</span></span>
<span class="tr"><span class="th" id="line1150">1150</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;held_back_mode = true; hb_wn = wn-1;</span></span>
<span class="tr"><span class="th" id="line1151">1151</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line1152">1152</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (m=0 : m&lt;32 : m++) pattern2--&gt;m = pattern--&gt;m;</span></span>
<span class="tr"><span class="th" id="line1153">1153</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcount2 = pcount;</span></span>
<span class="tr"><span class="th" id="line1154">1154</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = UPTO_PE;</span></span>
<span class="tr"><span class="th" id="line1155">1155</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></span>
<span class="tr"><span class="th" id="line1156">1156</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1157">1157</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1158">1158</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1159">1159</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Now, we may need to revise the multiple object because of the single one</span></span></span>
<span class="tr"><span class="th" id="line1160">1160</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! we now know (but didn&#39;t when the list was drawn up).</span></span></span>
<span class="tr"><span class="th" id="line1161">1161</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1162">1162</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parameters &gt;= 1) {</span></span>
<span class="tr"><span class="th" id="line1163">1163</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_results--&gt;INP1_PRES == 0) {</span></span>
<span class="tr"><span class="th" id="line1164">1164</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = ReviseMulti(parser_results--&gt;INP2_PRES);</span></span>
<span class="tr"><span class="th" id="line1165">1165</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l ~= 0) { etype = l; parser_results--&gt;ACTION_PRES = action_to_be; break; }</span></span>
<span class="tr"><span class="th" id="line1166">1166</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1167">1167</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1168">1168</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parameters &gt;= 2) {</span></span>
<span class="tr"><span class="th" id="line1169">1169</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_results--&gt;INP2_PRES == 0) {</span></span>
<span class="tr"><span class="th" id="line1170">1170</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = ReviseMulti(parser_results--&gt;INP1_PRES);</span></span>
<span class="tr"><span class="th" id="line1171">1171</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l ~= 0) { etype = l; break; }</span></span>
<span class="tr"><span class="th" id="line1172">1172</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line1173">1173</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = parser_results--&gt;INP1_PRES; l = parser_results--&gt;INP2_PRES;</span></span>
<span class="tr"><span class="th" id="line1174">1174</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (k &amp;&amp; l) {</span></span>
<span class="tr"><span class="th" id="line1175">1175</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((multi_context==MULTIEXCEPT_TOKEN &amp;&amp; k == l) ||</span></span>
<span class="tr"><span class="th" id="line1176">1176</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((multi_context==MULTIINSIDE_TOKEN &amp;&amp; k notin l &amp;&amp; l notin k))) {</span></span>
<span class="tr"><span class="th" id="line1177">1177</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = NOTHING_PE;</span></span>
<span class="tr"><span class="th" id="line1178">1178</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;ACTION_PRES = action_to_be; jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line1179">1179</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1180">1180</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1181">1181</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1182">1182</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1183">1183</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1184">1184</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! To trap the case of &quot;take all&quot; inferring only &quot;yourself&quot; when absolutely</span></span></span>
<span class="tr"><span class="th" id="line1185">1185</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! nothing else is in the vicinity...</span></span></span>
<span class="tr"><span class="th" id="line1186">1186</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1187">1187</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (take_all_rule == 2 &amp;&amp; parser_results--&gt;INP1_PRES == actor) {</span></span>
<span class="tr"><span class="th" id="line1188">1188</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = NOTHING_PE;</span></span>
<span class="tr"><span class="th" id="line1189">1189</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line1190">1190</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1191">1191</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1192">1192</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1193">1193</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 1) print <span class="dstring">&quot;[Line successfully parsed]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1194">1194</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1195">1195</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1196">1196</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! The line has successfully matched the text.  Declare the input error-free...</span></span></span>
<span class="tr"><span class="th" id="line1197">1197</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1198">1198</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oops_from = 0;</span></span>
<span class="tr"><span class="th" id="line1199">1199</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1200">1200</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...explain any inferences made (using the pattern)...</span></span></span>
<span class="tr"><span class="th" id="line1201">1201</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1202">1202</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (inferfrom ~= 0) {</span></span>
<span class="tr"><span class="th" id="line1203">1203</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintInferredCommand(inferfrom);</span></span>
<span class="tr"><span class="th" id="line1204">1204</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClearParagraphing(20);</span></span>
<span class="tr"><span class="th" id="line1205">1205</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1206">1206</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1207">1207</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...copy the action number, and the number of parameters...</span></span></span>
<span class="tr"><span class="th" id="line1208">1208</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1209">1209</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;ACTION_PRES = action_to_be;</span></span>
<span class="tr"><span class="th" id="line1210">1210</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;NO_INPS_PRES = parameters;</span></span>
<span class="tr"><span class="th" id="line1211">1211</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1212">1212</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...reverse first and second parameters if need be...</span></span></span>
<span class="tr"><span class="th" id="line1213">1213</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1214">1214</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (action_reversed &amp;&amp; parameters == 2) {</span></span>
<span class="tr"><span class="th" id="line1215">1215</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = parser_results--&gt;INP1_PRES;</span></span>
<span class="tr"><span class="th" id="line1216">1216</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP1_PRES = parser_results--&gt;INP2_PRES;</span></span>
<span class="tr"><span class="th" id="line1217">1217</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP2_PRES = i;</span></span>
<span class="tr"><span class="th" id="line1218">1218</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (nsns == 2) {</span></span>
<span class="tr"><span class="th" id="line1219">1219</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = special_number1; special_number1 = special_number2;</span></span>
<span class="tr"><span class="th" id="line1220">1220</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;special_number2 = i;</span></span>
<span class="tr"><span class="th" id="line1221">1221</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1222">1222</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1223">1223</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1224">1224</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...and to reset &quot;it&quot;-style objects to the first of these parameters, if</span></span></span>
<span class="tr"><span class="th" id="line1225">1225</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! there is one (and it really is an object)...</span></span></span>
<span class="tr"><span class="th" id="line1226">1226</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1227">1227</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parameters &gt; 0 &amp;&amp; parser_results--&gt;INP1_PRES &gt;= 2)</span></span>
<span class="tr"><span class="th" id="line1228">1228</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PronounNotice(parser_results--&gt;INP1_PRES);</span></span>
<span class="tr"><span class="th" id="line1229">1229</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1230">1230</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...and return from the parser altogether, having successfully matched</span></span></span>
<span class="tr"><span class="th" id="line1231">1231</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! a line.</span></span></span>
<span class="tr"><span class="th" id="line1232">1232</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1233">1233</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (held_back_mode) {</span></span>
<span class="tr"><span class="th" id="line1234">1234</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn=hb_wn;</span></span>
<span class="tr"><span class="th" id="line1235">1235</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1397">LookForMore</a>;</span></span>
<span class="tr"><span class="th" id="line1236">1236</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1237">1237</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1238">1238</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1239">1239</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span class="comment">! end of if(token ~= ENDIT_TOKEN) else</span></span></span>
<span class="tr"><span class="th" id="line1240">1240</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span class="comment">! end of for(pcount++)</span></span></span>
<span class="tr"><span class="th" id="line1241">1241</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1242">1242</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.LineFailed;</span></span>
<span class="tr"><span class="th" id="line1243">1243</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! The line has failed to match.</span></span></span>
<span class="tr"><span class="th" id="line1244">1244</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! We continue the outer &quot;for&quot; loop, trying the next line in the grammar.</span></span></span>
<span class="tr"><span class="th" id="line1245">1245</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1246">1246</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (etype &gt; best_etype) best_etype = etype;</span></span>
<span class="tr"><span class="th" id="line1247">1247</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (etype ~= ASKSCOPE_PE &amp;&amp; etype &gt; nextbest_etype) nextbest_etype = etype;</span></span>
<span class="tr"><span class="th" id="line1248">1248</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1249">1249</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...unless the line was something like &quot;take all&quot; which failed because</span></span></span>
<span class="tr"><span class="th" id="line1250">1250</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! nothing matched the &quot;all&quot;, in which case we stop and give an error now.</span></span></span>
<span class="tr"><span class="th" id="line1251">1251</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1252">1252</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (take_all_rule == 2 &amp;&amp; etype==NOTHING_PE) break;</span></span>
<span class="tr"><span class="th" id="line1253">1253</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1254">1254</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;} <span class="comment">! end of for(line++)</span></span></span>
<span class="tr"><span class="th" id="line1255">1255</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1256">1256</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! The grammar is exhausted: every line has failed to match.</span></span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-h">Parser Letter H.</h3><p><p> Cheaply parse otherwise unrecognised conversation and return.<p></p><p> (Errors are handled differently depending on who was talking. If the command was addressed to somebody else (eg, DWARF, SFGH) then it is taken as conversation which the parser has no business in disallowing.)<p></p><p> The parser used to return the fake action <span class="fixed">##NotUnderstood</span> when a command in the form PERSON, ARFLE BARFLE GLOOP is parsed, where a character is addressed but with an instruction which the parser can&#39;t understand. (If a command such as ARFLE BARFLE GLOOP is not an instruction to someone else, the parser prints an error and requires the player to type another command: thus <span class="fixed">##NotUnderstood</span> was only returned when <span class="fixed"><a href="./Output.i6t.html#line237">actor</a></span> is not the player.) And I6 had elaborate object-oriented ways to deal with this, but we won&#39;t use any of that: we simply convert to a <span class="fixed">##Answer</span> action, which communicates a snippet of words to another character, just as if the player had typed ANSWER ARFLE BARFLE GLOOP TO PERSON. For I7 purposes, the fake action <span class="fixed">##NotUnderstood</span> does not exist.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1278">1278</span><span class="td">&nbsp;&nbsp;.GiveError;</span></span>
<span class="tr"><span class="th" id="line1279">1279</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1280">1280</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;etype = best_etype;</span></span>
<span class="tr"><span class="th" id="line1281">1281</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (actor ~= player) {</span></span>
<span class="tr"><span class="th" id="line1282">1282</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (usual_grammar_after ~= 0) {</span></span>
<span class="tr"><span class="th" id="line1283">1283</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verb_wordnum = usual_grammar_after;</span></span>
<span class="tr"><span class="th" id="line1284">1284</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line618">AlmostReParse</a>;</span></span>
<span class="tr"><span class="th" id="line1285">1285</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1286">1286</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = verb_wordnum;</span></span>
<span class="tr"><span class="th" id="line1287">1287</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;special_word = NextWord();</span></span>
<span class="tr"><span class="th" id="line1288">1288</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (special_word == comma_word) {</span></span>
<span class="tr"><span class="th" id="line1289">1289</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;special_word = NextWord();</span></span>
<span class="tr"><span class="th" id="line1290">1290</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verb_wordnum++;</span></span>
<span class="tr"><span class="th" id="line1291">1291</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1292">1292</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;ACTION_PRES = ##Answer;</span></span>
<span class="tr"><span class="th" id="line1293">1293</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;NO_INPS_PRES = 2;</span></span>
<span class="tr"><span class="th" id="line1294">1294</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP1_PRES = actor;</span></span>
<span class="tr"><span class="th" id="line1295">1295</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP2_PRES = 1; special_number1 = special_word;</span></span>
<span class="tr"><span class="th" id="line1296">1296</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actor = player;</span></span>
<span class="tr"><span class="th" id="line1297">1297</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consult_from = verb_wordnum; consult_words = num_words-consult_from+1;</span></span>
<span class="tr"><span class="th" id="line1298">1298</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1299">1299</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-i">Parser Letter I.</h3><p><p> Print best possible error message.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1305">1305</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If the player was the actor (eg, in &quot;take dfghh&quot;) the error must be printed,</span></span></span>
<span class="tr"><span class="th" id="line1306">1306</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! and fresh input called for.  In three cases the oops word must be jiggled.</span></span></span>
<span class="tr"><span class="th" id="line1307">1307</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1308">1308</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((etype ofclass Routine) || (etype ofclass String)) {</span></span>
<span class="tr"><span class="th" id="line1309">1309</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ParserError(etype) ~= 0) jump <a href="./Parser.i6t.html#line554">ReType</a>;</span></span>
<span class="tr"><span class="th" id="line1310">1310</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line1311">1311</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (verb_wordnum == 0 &amp;&amp; etype == CANTSEE_PE) etype = VERB_PE;</span></span>
<span class="tr"><span class="th" id="line1312">1312</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;players_command = 100 + WordCount(); <span class="comment">! The snippet variable &quot;player&#39;s command&quot;</span></span></span>
<span class="tr"><span class="th" id="line1313">1313</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(PRINTING_A_PARSER_ERROR_ACT);</span></span>
<span class="tr"><span class="th" id="line1314">1314</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ForActivity(PRINTING_A_PARSER_ERROR_ACT)) jump <a href="./Parser.i6t.html#line1374">SkipParserError</a>;</span></span>
<span class="tr"><span class="th" id="line1315">1315</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1316">1316</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;pronoun_word = pronoun__word; pronoun_obj = pronoun__obj;</span></span>
<span class="tr"><span class="th" id="line1317">1317</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1318">1318</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == STUCK_PE) {    PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;A&#39;</span>); new_line; oops_from = 1; }</span></span>
<span class="tr"><span class="th" id="line1319">1319</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == UPTO_PE) {</span></span>
<span class="tr"><span class="th" id="line1320">1320</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (inferred_go) PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;C&#39;</span>);</span></span>
<span class="tr"><span class="th" id="line1321">1321</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;B&#39;</span>);</span></span>
<span class="tr"><span class="th" id="line1322">1322</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (m=0 : m&lt;32 : m++) pattern--&gt;m = pattern2--&gt;m;</span></span>
<span class="tr"><span class="th" id="line1323">1323</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcount = pcount2; PrintCommand(0);</span></span>
<span class="tr"><span class="th" id="line1324">1324</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;.^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1325">1325</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1326">1326</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == NUMBER_PE) {   PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;D&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1327">1327</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == CANTSEE_PE) {  PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;E&#39;</span>); new_line; oops_from=saved_oops; }</span></span>
<span class="tr"><span class="th" id="line1328">1328</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == TOOLIT_PE) {   PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;F&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1329">1329</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == NOTHELD_PE) {  PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;G&#39;</span>); new_line; oops_from=saved_oops; }</span></span>
<span class="tr"><span class="th" id="line1330">1330</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == MULTI_PE) {    PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;H&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1331">1331</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == MMULTI_PE) {   PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;I&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1332">1332</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == VAGUE_PE) {    PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;J&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1333">1333</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == ITGONE_PE) {</span></span>
<span class="tr"><span class="th" id="line1334">1334</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (pronoun_obj == NULL) { PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;J&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1335">1335</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else { PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;K&#39;</span>, noun); new_line; }</span></span>
<span class="tr"><span class="th" id="line1336">1336</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1337">1337</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == EXCEPT_PE) {   PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;L&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1338">1338</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == ANIMA_PE) {    PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;M&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1339">1339</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == VERB_PE) {     PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;N&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1340">1340</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == SCENERY_PE) {  PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;O&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1341">1341</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == JUNKAFTER_PE) {  PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;P&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1342">1342</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == TOOFEW_PE) {  PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;Q&#39;</span>, multi_had); new_line; }</span></span>
<span class="tr"><span class="th" id="line1343">1343</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == NOTHING_PE) {</span></span>
<span class="tr"><span class="th" id="line1344">1344</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_results--&gt;ACTION_PRES == ##Remove &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line1345">1345</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_results--&gt;INP2_PRES ofclass Object) {</span></span>
<span class="tr"><span class="th" id="line1346">1346</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noun = parser_results--&gt;INP2_PRES; <span class="comment">! ensure valid for messages</span></span></span>
<span class="tr"><span class="th" id="line1347">1347</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (noun has animate) { PARSER_N_ERROR_INTERNAL_RM(<span class="sstring">&#39;C&#39;</span>, noun); new_line; }</span></span>
<span class="tr"><span class="th" id="line1348">1348</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (noun hasnt container or supporter) { PARSER_N_ERROR_INTERNAL_RM(<span class="sstring">&#39;D&#39;</span>, noun); new_line; }</span></span>
<span class="tr"><span class="th" id="line1349">1349</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (noun has container &amp;&amp; noun hasnt open)  { PARSER_N_ERROR_INTERNAL_RM(<span class="sstring">&#39;E&#39;</span>, noun); new_line; }</span></span>
<span class="tr"><span class="th" id="line1350">1350</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (children(noun)==0) { PARSER_N_ERROR_INTERNAL_RM(<span class="sstring">&#39;F&#39;</span>, noun); new_line; }</span></span>
<span class="tr"><span class="th" id="line1351">1351</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else parser_results--&gt;ACTION_PRES = 0;</span></span>
<span class="tr"><span class="th" id="line1352">1352</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1353">1353</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_results--&gt;ACTION_PRES ~= ##Remove) {</span></span>
<span class="tr"><span class="th" id="line1354">1354</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (multi_wanted==100) { PARSER_N_ERROR_INTERNAL_RM(<span class="sstring">&#39;A&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1355">1355</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else                  {  PARSER_N_ERROR_INTERNAL_RM(<span class="sstring">&#39;B&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1356">1356</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1357">1357</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1358">1358</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == NOTINCONTEXT_PE) { PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;R&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1359">1359</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == ANIMAAGAIN_PE) { PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;S&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1360">1360</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == COMMABEGIN_PE) { PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;T&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1361">1361</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == MISSINGPERSON_PE) { PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;U&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1362">1362</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == ANIMALISTEN_PE) { PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;V&#39;</span>, noun); new_line; }</span></span>
<span class="tr"><span class="th" id="line1363">1363</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == TOTALK_PE) { PARSER_ERROR_INTERNAL_RM(<span class="sstring">&#39;W&#39;</span>); new_line; }</span></span>
<span class="tr"><span class="th" id="line1364">1364</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype == ASKSCOPE_PE) {</span></span>
<span class="tr"><span class="th" id="line1365">1365</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_stage = 3;</span></span>
<span class="tr"><span class="th" id="line1366">1366</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indirect(scope_error) == -1) {</span></span>
<span class="tr"><span class="th" id="line1367">1367</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_etype = nextbest_etype;</span></span>
<span class="tr"><span class="th" id="line1368">1368</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (~~((etype ofclass Routine) || (etype ofclass String)))</span></span>
<span class="tr"><span class="th" id="line1369">1369</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndActivity(PRINTING_A_PARSER_ERROR_ACT);</span></span>
<span class="tr"><span class="th" id="line1370">1370</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
<span class="tr"><span class="th" id="line1371">1371</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1372">1372</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1373">1373</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1374">1374</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.SkipParserError;</span></span>
<span class="tr"><span class="th" id="line1375">1375</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((etype ofclass Routine) || (etype ofclass String)) jump <a href="./Parser.i6t.html#line554">ReType</a>;</span></span>
<span class="tr"><span class="th" id="line1376">1376</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;say__p = 1;</span></span>
<span class="tr"><span class="th" id="line1377">1377</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;EndActivity(PRINTING_A_PARSER_ERROR_ACT);</span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-j">Parser Letter J.</h3><p><p> Retry the whole lot.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1383">1383</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! And go (almost) right back to square one...</span></span></span>
<span class="tr"><span class="th" id="line1384">1384</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1385">1385</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line554">ReType</a>;</span></span>
<span class="tr"><span class="th" id="line1386">1386</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1387">1387</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...being careful not to go all the way back, to avoid infinite repetition</span></span></span>
<span class="tr"><span class="th" id="line1388">1388</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! of a deferred command causing an error.</span></span></span>
</div><div class='text'>
<h3 id="parser-parser-letter-k">Parser Letter K.</h3><p><p> Last thing: check for THEN and further instructions(s), return.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1394">1394</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! At this point, the return value is all prepared, and we are only looking</span></span></span>
<span class="tr"><span class="th" id="line1395">1395</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! to see if there is a &quot;then&quot; followed by subsequent instruction(s).</span></span></span>
<span class="tr"><span class="th" id="line1396">1396</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1397">1397</span><span class="td">&nbsp;&nbsp;.LookForMore;</span></span>
<span class="tr"><span class="th" id="line1398">1398</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1399">1399</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (wn &gt; num_words) rtrue;</span></span>
<span class="tr"><span class="th" id="line1400">1400</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1401">1401</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = NextWord();</span></span>
<span class="tr"><span class="th" id="line1402">1402</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (i == THEN1__WD or THEN2__WD or THEN3__WD or comma_word) {</span></span>
<span class="tr"><span class="th" id="line1403">1403</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wn &gt; num_words) {</span></span>
<span class="tr"><span class="th" id="line1404">1404</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;held_back_mode = false;</span></span>
<span class="tr"><span class="th" id="line1405">1405</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1406">1406</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1407">1407</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hb_wn = wn;</span></span>
<span class="tr"><span class="th" id="line1408">1408</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;held_back_mode = true;</span></span>
<span class="tr"><span class="th" id="line1409">1409</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1410">1410</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1411">1411</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;best_etype = UPTO_PE;</span></span>
<span class="tr"><span class="th" id="line1412">1412</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1278">GiveError</a>;</span></span>
</div><div class='text'>
<h3 id="parser-end-of-parser-proper">End of Parser Proper.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1417">1417</span><span class="td">]; <span class="comment">! end of Parser__parse</span></span></span>
</div><div class='text'>
<h3 id="parser-internal-rule">Internal Rule.</h3><p><p> As a hook on which to hang responses.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1423">1423</span><span class="td">[ PARSER_ERROR_INTERNAL_R; ];</span></span>
<span class="tr"><span class="th" id="line1424">1424</span><span class="td">[ PARSER_N_ERROR_INTERNAL_R; ];</span></span>
<span class="tr"><span class="th" id="line1425">1425</span><span class="td">[ PARSER_COMMAND_INTERNAL_R; ];</span></span>
</div><div class='text'>
<h3 id="parser-parse-token">Parse Token.</h3><p><p> The main parsing routine above tried a sequence of &quot;grammar lines&quot; in turn, matching each against the text typed until one fitted. A grammar line is itself a sequence of &quot;grammar tokens&quot;. Here we have to parse the tokens.<p></p><p> <span class="fixed"><a href="./Parser.i6t.html#line1469">ParseToken(type, data)</a></span> tries the match text beginning at the current word marker <span class="fixed"><a href="./Output.i6t.html#line283">wn</a></span> against a token of the given <span class="fixed">type</span>, with the given <span class="fixed">data</span>. The optional further arguments <span class="fixed">token_n</span> and <span class="fixed">token</span> supply the token number in the current grammar line (because some tokens do depend on what has happened before or is needed later) and the address of the dictionary word which makes up the <span class="fixed">token</span>, in the case where it&#39;s a &quot;preposition&quot;.<p></p><p> The return values are: (a) <span class="fixed"><a href="./Definitions.i6t.html#line545">GPR_REPARSE</a></span> for &quot;I have rewritten the command, please re-parse from scratch&quot;; (b) <span class="fixed"><a href="./Definitions.i6t.html#line542">GPR_PREPOSITION</a></span> for &quot;token accepted with no result&quot;; (c) <em>-256 + x</em> for &quot;please parse <span class="fixed"><a href="./Parser.i6t.html#line1469">ParseToken(ELEMENTARY_TT, x)</a></span> instead&quot;; (d) 0 for &quot;token accepted, result is the multiple object list&quot;; (e) 1 for &quot;token accepted, result is the number in <span class="fixed"><a href="./Output.i6t.html#line261">parsed_number</a></span>&quot;; (f) an object number for &quot;token accepted with this object as result&quot;; (g) <em>-1</em> for &quot;token rejected&quot;.<p></p><p> Strictly speaking <span class="fixed"><a href="./Parser.i6t.html#line1469">ParseToken</a></span> is a shell routine which saves the current state on the stack, and calling <span class="fixed"><a href="./Parser.i6t.html#line1500">ParseToken__</a></span> to do the actual work.<p></p><p> Once again the routine is traditionally divided into six letters, here named under paragraphs &quot;Parse Token Letter A&quot;, and so on.<p></p><p> (A) Analyse the token; handle all tokens not involving object lists and break down others into elementary tokens (B) Begin parsing an object list (C) Parse descriptors (articles, pronouns, etc.) in the list (D) Parse an object name (E) Parse connectives (AND, BUT, etc.) and go back to (C) (F) Return the conclusion of parsing an object list<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1463">1463</span><span class="td">[ ParseTokenStopped x y;</span></span>
<span class="tr"><span class="th" id="line1464">1464</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (wn&gt;WordCount()) return GPR_FAIL;</span></span>
<span class="tr"><span class="th" id="line1465">1465</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return ParseToken(x,y);</span></span>
<span class="tr"><span class="th" id="line1466">1466</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1467">1467</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1468">1468</span><span class="td">Global parsetoken_nesting = 0;</span></span>
<span class="tr"><span class="th" id="line1469">1469</span><span class="td">[ ParseToken given_ttype given_tdata token_n token  i t rv;</span></span>
<span class="tr"><span class="th" id="line1470">1470</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parsetoken_nesting &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line1471">1471</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! save match globals</span></span></span>
<span class="tr"><span class="th" id="line1472">1472</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@push match_from; @push token_filter; @push match_length;</span></span>
<span class="tr"><span class="th" id="line1473">1473</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@push number_of_classes; @push oops_from;</span></span>
<span class="tr"><span class="th" id="line1474">1474</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0: i&lt;number_matched: i++) {</span></span>
<span class="tr"><span class="th" id="line1475">1475</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t = match_list--&gt;i; @push t;</span></span>
<span class="tr"><span class="th" id="line1476">1476</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t = match_classes--&gt;i; @push t;</span></span>
<span class="tr"><span class="th" id="line1477">1477</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t = match_scores--&gt;i; @push t;</span></span>
<span class="tr"><span class="th" id="line1478">1478</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1479">1479</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@push number_matched;</span></span>
<span class="tr"><span class="th" id="line1480">1480</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1481">1481</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1482">1482</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parsetoken_nesting++;</span></span>
<span class="tr"><span class="th" id="line1483">1483</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rv = ParseToken__(given_ttype, given_tdata, token_n, token);</span></span>
<span class="tr"><span class="th" id="line1484">1484</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parsetoken_nesting--;</span></span>
<span class="tr"><span class="th" id="line1485">1485</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1486">1486</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parsetoken_nesting &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line1487">1487</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! restore match globals</span></span></span>
<span class="tr"><span class="th" id="line1488">1488</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull number_matched;</span></span>
<span class="tr"><span class="th" id="line1489">1489</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=number_matched-1: i&gt;=0: i--) {</span></span>
<span class="tr"><span class="th" id="line1490">1490</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull t; match_scores--&gt;i = t;</span></span>
<span class="tr"><span class="th" id="line1491">1491</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull t; match_classes--&gt;i = t;</span></span>
<span class="tr"><span class="th" id="line1492">1492</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull t; match_list--&gt;i = t;</span></span>
<span class="tr"><span class="th" id="line1493">1493</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1494">1494</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull oops_from; @pull number_of_classes;</span></span>
<span class="tr"><span class="th" id="line1495">1495</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull match_length; @pull token_filter; @pull match_from;</span></span>
<span class="tr"><span class="th" id="line1496">1496</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1497">1497</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return rv;</span></span>
<span class="tr"><span class="th" id="line1498">1498</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1499">1499</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1500">1500</span><span class="td">[ ParseToken__ given_ttype given_tdata token_n token</span></span>
<span class="tr"><span class="th" id="line1501">1501</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;l o i j k and_parity single_object desc_wn many_flag</span></span>
<span class="tr"><span class="th" id="line1502">1502</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;token_allows_multiple prev_indef_wanted;</span></span>
</div><div class='text'>
<h3 id="parser-parse-token-letter-a">Parse Token Letter A.</h3><p><p> Analyse token; handle all not involving object lists, break down others.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1508">1508</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;token_filter = 0;</span></span>
<span class="tr"><span class="th" id="line1509">1509</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_inflection = name;</span></span>
<span class="tr"><span class="th" id="line1510">1510</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1511">1511</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;switch (given_ttype) {</span></span>
<span class="tr"><span class="th" id="line1512">1512</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELEMENTARY_TT:</span></span>
<span class="tr"><span class="th" id="line1513">1513</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (given_tdata) {</span></span>
<span class="tr"><span class="th" id="line1514">1514</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SPECIAL_TOKEN:</span></span>
<span class="tr"><span class="th" id="line1515">1515</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = TryNumber(wn);</span></span>
<span class="tr"><span class="th" id="line1516">1516</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;special_word = NextWord();</span></span>
<span class="tr"><span class="th" id="line1517">1517</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1518">1518</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l ~= -1000)</span></span>
<span class="tr"><span class="th" id="line1519">1519</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Read special as the number &quot;</span>, l, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1520">1520</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1521">1521</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == -1000) {</span></span>
<span class="tr"><span class="th" id="line1522">1522</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1523">1523</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Read special word at word number &quot;</span>, wn, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1524">1524</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1525">1525</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = special_word;</span></span>
<span class="tr"><span class="th" id="line1526">1526</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1527">1527</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parsed_number = l;</span></span>
<span class="tr"><span class="th" id="line1528">1528</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return GPR_NUMBER;</span></span>
<span class="tr"><span class="th" id="line1529">1529</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1530">1530</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMBER_TOKEN:</span></span>
<span class="tr"><span class="th" id="line1531">1531</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l=TryNumber(wn++);</span></span>
<span class="tr"><span class="th" id="line1532">1532</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == -1000) {</span></span>
<span class="tr"><span class="th" id="line1533">1533</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = NUMBER_PE;</span></span>
<span class="tr"><span class="th" id="line1534">1534</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return GPR_FAIL;</span></span>
<span class="tr"><span class="th" id="line1535">1535</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1536">1536</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1537">1537</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace&gt;=3) print <span class="dstring">&quot;  [Read number as &quot;</span>, l, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1538">1538</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1539">1539</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parsed_number = l;</span></span>
<span class="tr"><span class="th" id="line1540">1540</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return GPR_NUMBER;</span></span>
<span class="tr"><span class="th" id="line1541">1541</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1542">1542</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CREATURE_TOKEN:</span></span>
<span class="tr"><span class="th" id="line1543">1543</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (action_to_be == ##Answer or ##Ask or ##AskFor or ##Tell)</span></span>
<span class="tr"><span class="th" id="line1544">1544</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_reason = TALKING_REASON;</span></span>
<span class="tr"><span class="th" id="line1545">1545</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1546">1546</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TOPIC_TOKEN:</span></span>
<span class="tr"><span class="th" id="line1547">1547</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consult_from = wn;</span></span>
<span class="tr"><span class="th" id="line1548">1548</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((line_ttype--&gt;(token_n+1) ~= PREPOSITION_TT) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line1549">1549</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(line_token--&gt;(token_n+1) ~= ENDIT_TOKEN)) {</span></span>
<span class="tr"><span class="th" id="line1550">1550</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RunTimeProblem(RTP_TEXTTOKENTOOHARD);</span></span>
<span class="tr"><span class="th" id="line1551">1551</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return GPR_PREPOSITION;</span></span>
<span class="tr"><span class="th" id="line1552">1552</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1553">1553</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do o = NextWordStopped();</span></span>
<span class="tr"><span class="th" id="line1554">1554</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;until (o == -1 || PrepositionChain(o, token_n+1) ~= -1);</span></span>
<span class="tr"><span class="th" id="line1555">1555</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn--;</span></span>
<span class="tr"><span class="th" id="line1556">1556</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consult_words = wn-consult_from;</span></span>
<span class="tr"><span class="th" id="line1557">1557</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (consult_words == 0) return GPR_FAIL;</span></span>
<span class="tr"><span class="th" id="line1558">1558</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (action_to_be == ##Ask or ##Answer or ##Tell) {</span></span>
<span class="tr"><span class="th" id="line1559">1559</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o = wn; wn = consult_from; parsed_number = NextWord();</span></span>
<span class="tr"><span class="th" id="line1560">1560</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = o; return 1;</span></span>
<span class="tr"><span class="th" id="line1561">1561</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1562">1562</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o==-1 &amp;&amp; (line_ttype--&gt;(token_n+1) == PREPOSITION_TT))</span></span>
<span class="tr"><span class="th" id="line1563">1563</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return GPR_FAIL;    <span class="comment">! don&#39;t infer if required preposition is absent</span></span></span>
<span class="tr"><span class="th" id="line1564">1564</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return GPR_PREPOSITION;</span></span>
<span class="tr"><span class="th" id="line1565">1565</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1566">1566</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1567">1567</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PREPOSITION_TT:</span></span>
<span class="tr"><span class="th" id="line1568">1568</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Is it an unnecessary alternative preposition, when a previous choice</span></span></span>
<span class="tr"><span class="th" id="line1569">1569</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! has already been matched?</span></span></span>
<span class="tr"><span class="th" id="line1570">1570</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((token-&gt;0) &amp; $10) return GPR_PREPOSITION;</span></span>
<span class="tr"><span class="th" id="line1571">1571</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1572">1572</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If we&#39;ve run out of the player&#39;s input, but still have parameters to</span></span></span>
<span class="tr"><span class="th" id="line1573">1573</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! specify, we go into &quot;infer&quot; mode, remembering where we are and the</span></span></span>
<span class="tr"><span class="th" id="line1574">1574</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! preposition we are inferring...</span></span></span>
<span class="tr"><span class="th" id="line1575">1575</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1576">1576</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wn &gt; num_words) {</span></span>
<span class="tr"><span class="th" id="line1577">1577</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (inferfrom==0 &amp;&amp; parameters&lt;params_wanted) {</span></span>
<span class="tr"><span class="th" id="line1578">1578</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inferfrom = pcount; inferword = token;</span></span>
<span class="tr"><span class="th" id="line1579">1579</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pattern--&gt;pcount = REPARSE_CODE + VM_DictionaryAddressToNumber(given_tdata);</span></span>
<span class="tr"><span class="th" id="line1580">1580</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1581">1581</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1582">1582</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If we are not inferring, then the line is wrong...</span></span></span>
<span class="tr"><span class="th" id="line1583">1583</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1584">1584</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (inferfrom == 0) return -1;</span></span>
<span class="tr"><span class="th" id="line1585">1585</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1586">1586</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If not, then the line is right but we mark in the preposition...</span></span></span>
<span class="tr"><span class="th" id="line1587">1587</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1588">1588</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pattern--&gt;pcount = REPARSE_CODE + VM_DictionaryAddressToNumber(given_tdata);</span></span>
<span class="tr"><span class="th" id="line1589">1589</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return GPR_PREPOSITION;</span></span>
<span class="tr"><span class="th" id="line1590">1590</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1591">1591</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1592">1592</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o = NextWord();</span></span>
<span class="tr"><span class="th" id="line1593">1593</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1594">1594</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pattern--&gt;pcount = REPARSE_CODE + VM_DictionaryAddressToNumber(o);</span></span>
<span class="tr"><span class="th" id="line1595">1595</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1596">1596</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Whereas, if the player has typed something here, see if it is the</span></span></span>
<span class="tr"><span class="th" id="line1597">1597</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! required preposition... if it&#39;s wrong, the line must be wrong,</span></span></span>
<span class="tr"><span class="th" id="line1598">1598</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! but if it&#39;s right, the token is passed (jump to finish this token).</span></span></span>
<span class="tr"><span class="th" id="line1599">1599</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1600">1600</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == given_tdata) return GPR_PREPOSITION;</span></span>
<span class="tr"><span class="th" id="line1601">1601</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (PrepositionChain(o, token_n) ~= -1) return GPR_PREPOSITION;</span></span>
<span class="tr"><span class="th" id="line1602">1602</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -1;</span></span>
<span class="tr"><span class="th" id="line1603">1603</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1604">1604</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GPR_TT:</span></span>
<span class="tr"><span class="th" id="line1605">1605</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = indirect(given_tdata);</span></span>
<span class="tr"><span class="th" id="line1606">1606</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1607">1607</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Outside parsing routine returned &quot;</span>, l, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1608">1608</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1609">1609</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return l;</span></span>
<span class="tr"><span class="th" id="line1610">1610</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1611">1611</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SCOPE_TT:</span></span>
<span class="tr"><span class="th" id="line1612">1612</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_token = given_tdata;</span></span>
<span class="tr"><span class="th" id="line1613">1613</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_stage = 1;</span></span>
<span class="tr"><span class="th" id="line1614">1614</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1615">1615</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Scope routine called at stage 1]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1616">1616</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1617">1617</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = indirect(scope_token);</span></span>
<span class="tr"><span class="th" id="line1618">1618</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1619">1619</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Scope routine returned multiple-flag of &quot;</span>, l, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1620">1620</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1621">1621</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == 1) given_tdata = MULTI_TOKEN; else given_tdata = NOUN_TOKEN;</span></span>
<span class="tr"><span class="th" id="line1622">1622</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1623">1623</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ATTR_FILTER_TT:</span></span>
<span class="tr"><span class="th" id="line1624">1624</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_filter = 1 + given_tdata;</span></span>
<span class="tr"><span class="th" id="line1625">1625</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given_tdata = NOUN_TOKEN;</span></span>
<span class="tr"><span class="th" id="line1626">1626</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1627">1627</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROUTINE_FILTER_TT:</span></span>
<span class="tr"><span class="th" id="line1628">1628</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_filter = given_tdata;</span></span>
<span class="tr"><span class="th" id="line1629">1629</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given_tdata = NOUN_TOKEN;</span></span>
<span class="tr"><span class="th" id="line1630">1630</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1631">1631</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;} <span class="comment">! end of switch(given_ttype)</span></span></span>
<span class="tr"><span class="th" id="line1632">1632</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1633">1633</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;token = given_tdata;</span></span>
</div><div class='text'>
<h3 id="parser-parse-token-letter-b">Parse Token Letter B.</h3><p><p> Begin parsing an object list.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1639">1639</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! There are now three possible ways we can be here:</span></span></span>
<span class="tr"><span class="th" id="line1640">1640</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     parsing an elementary token other than &quot;special&quot; or &quot;number&quot;;</span></span></span>
<span class="tr"><span class="th" id="line1641">1641</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     parsing a scope token;</span></span></span>
<span class="tr"><span class="th" id="line1642">1642</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     parsing a noun-filter token (either by routine or attribute).</span></span></span>
<span class="tr"><span class="th" id="line1643">1643</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!</span></span></span>
<span class="tr"><span class="th" id="line1644">1644</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! In each case, token holds the type of elementary parse to</span></span></span>
<span class="tr"><span class="th" id="line1645">1645</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! perform in matching one or more objects, and</span></span></span>
<span class="tr"><span class="th" id="line1646">1646</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! token_filter is 0 (default), an attribute + 1 for an attribute filter</span></span></span>
<span class="tr"><span class="th" id="line1647">1647</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! or a routine address for a routine filter.</span></span></span>
<span class="tr"><span class="th" id="line1648">1648</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1649">1649</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;token_allows_multiple = false;</span></span>
<span class="tr"><span class="th" id="line1650">1650</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (token == MULTI_TOKEN or MULTIHELD_TOKEN or MULTIEXCEPT_TOKEN or MULTIINSIDE_TOKEN)</span></span>
<span class="tr"><span class="th" id="line1651">1651</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_allows_multiple = true;</span></span>
<span class="tr"><span class="th" id="line1652">1652</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1653">1653</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;many_flag = false; and_parity = true; dont_infer = false;</span></span>
</div><div class='text'>
<h3 id="parser-parse-token-letter-c">Parse Token Letter C.</h3><p><p> Parse descriptors (articles, pronouns, etc.) in the list.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1659">1659</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! We expect to find a list of objects next in what the player&#39;s typed.</span></span></span>
<span class="tr"><span class="th" id="line1660">1660</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1661">1661</span><span class="td">&nbsp;&nbsp;.ObjectList;</span></span>
<span class="tr"><span class="th" id="line1662">1662</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1663">1663</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1664">1664</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Object list from word &quot;</span>, wn, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1665">1665</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1666">1666</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1667">1667</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Take an advance look at the next word: if it&#39;s &quot;it&quot; or &quot;them&quot;, and these</span></span></span>
<span class="tr"><span class="th" id="line1668">1668</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! are unset, set the appropriate error number and give up on the line</span></span></span>
<span class="tr"><span class="th" id="line1669">1669</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (if not, these are still parsed in the usual way - it is not assumed</span></span></span>
<span class="tr"><span class="th" id="line1670">1670</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! that they still refer to something in scope)</span></span></span>
<span class="tr"><span class="th" id="line1671">1671</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1672">1672</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;o = NextWord(); wn--;</span></span>
<span class="tr"><span class="th" id="line1673">1673</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1674">1674</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;pronoun_word = NULL; pronoun_obj = NULL;</span></span>
<span class="tr"><span class="th" id="line1675">1675</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;l = PronounValue(o);</span></span>
<span class="tr"><span class="th" id="line1676">1676</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (l ~= 0) {</span></span>
<span class="tr"><span class="th" id="line1677">1677</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pronoun_word = o; pronoun_obj = l;</span></span>
<span class="tr"><span class="th" id="line1678">1678</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == NULL) {</span></span>
<span class="tr"><span class="th" id="line1679">1679</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Don&#39;t assume this is a use of an unset pronoun until the</span></span></span>
<span class="tr"><span class="th" id="line1680">1680</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! descriptors have been checked, because it might be an</span></span></span>
<span class="tr"><span class="th" id="line1681">1681</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! article (or some such) instead</span></span></span>
<span class="tr"><span class="th" id="line1682">1682</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1683">1683</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (l=1 : l&lt;=LanguageDescriptors--&gt;0 : l=l+4)</span></span>
<span class="tr"><span class="th" id="line1684">1684</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == LanguageDescriptors--&gt;l) jump <a href="./Parser.i6t.html#line1692">AssumeDescriptor</a>;</span></span>
<span class="tr"><span class="th" id="line1685">1685</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pronoun__word = pronoun_word; pronoun__obj = pronoun_obj;</span></span>
<span class="tr"><span class="th" id="line1686">1686</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = VAGUE_PE;</span></span>
<span class="tr"><span class="th" id="line1687">1687</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Stop: unset pronoun]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1688">1688</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return GPR_FAIL;</span></span>
<span class="tr"><span class="th" id="line1689">1689</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1690">1690</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1691">1691</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1692">1692</span><span class="td">&nbsp;&nbsp;.AssumeDescriptor;</span></span>
<span class="tr"><span class="th" id="line1693">1693</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1694">1694</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (o == ME1__WD or ME2__WD or ME3__WD) { pronoun_word = o; pronoun_obj = player; }</span></span>
<span class="tr"><span class="th" id="line1695">1695</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1696">1696</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;allow_plurals = true; desc_wn = wn;</span></span>
<span class="tr"><span class="th" id="line1697">1697</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1698">1698</span><span class="td">&nbsp;&nbsp;.TryAgain;</span></span>
<span class="tr"><span class="th" id="line1699">1699</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1700">1700</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! First, we parse any descriptive words (like &quot;the&quot;, &quot;five&quot; or &quot;every&quot;):</span></span></span>
<span class="tr"><span class="th" id="line1701">1701</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;l = Descriptors(token_allows_multiple);</span></span>
<span class="tr"><span class="th" id="line1702">1702</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (l ~= 0) { etype = l; return 0; }</span></span>
<span class="tr"><span class="th" id="line1703">1703</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1704">1704</span><span class="td">&nbsp;&nbsp;.TryAgain2;</span></span>
</div><div class='text'>
<h3 id="parser-parse-token-letter-d">Parse Token Letter D.</h3><p><p> Parse an object name.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1710">1710</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! This is an actual specified object, and is therefore where a typing error</span></span></span>
<span class="tr"><span class="th" id="line1711">1711</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! is most likely to occur, so we set:</span></span></span>
<span class="tr"><span class="th" id="line1712">1712</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1713">1713</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;oops_from = wn;</span></span>
<span class="tr"><span class="th" id="line1714">1714</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1715">1715</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! So, two cases.  Case 1: token not equal to &quot;held&quot; (so, no implicit takes)</span></span></span>
<span class="tr"><span class="th" id="line1716">1716</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! but we may well be dealing with multiple objects</span></span></span>
<span class="tr"><span class="th" id="line1717">1717</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1718">1718</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! In either case below we use NounDomain, giving it the token number as</span></span></span>
<span class="tr"><span class="th" id="line1719">1719</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! context, and two places to look: among the actor&#39;s possessions, and in the</span></span></span>
<span class="tr"><span class="th" id="line1720">1720</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! present location.  (Note that the order depends on which is likeliest.)</span></span></span>
<span class="tr"><span class="th" id="line1721">1721</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1722">1722</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (token ~= HELD_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line1723">1723</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line1724">1724</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1725">1725</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Calling NounDomain on location and actor]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1726">1726</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1727">1727</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = NounDomain(actors_location, actor, token);</span></span>
<span class="tr"><span class="th" id="line1728">1728</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == REPARSE_CODE) return l;                  <span class="comment">! Reparse after Q&amp;A</span></span></span>
<span class="tr"><span class="th" id="line1729">1729</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_wanted == INDEF_ALL_WANTED &amp;&amp; l == 0 &amp;&amp; number_matched == 0)</span></span>
<span class="tr"><span class="th" id="line1730">1730</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = 1;  <span class="comment">! ReviseMulti if TAKE ALL FROM empty container</span></span></span>
<span class="tr"><span class="th" id="line1731">1731</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1732">1732</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (token_allows_multiple &amp;&amp; ~~multiflag) {</span></span>
<span class="tr"><span class="th" id="line1733">1733</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (best_etype==MULTI_PE) best_etype=STUCK_PE;</span></span>
<span class="tr"><span class="th" id="line1734">1734</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiflag = true;</span></span>
<span class="tr"><span class="th" id="line1735">1735</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1736">1736</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == 0) {</span></span>
<span class="tr"><span class="th" id="line1737">1737</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_possambig) {</span></span>
<span class="tr"><span class="th" id="line1738">1738</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResetDescriptors();</span></span>
<span class="tr"><span class="th" id="line1739">1739</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = desc_wn;</span></span>
<span class="tr"><span class="th" id="line1740">1740</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1704">TryAgain2</a>;</span></span>
<span class="tr"><span class="th" id="line1741">1741</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1742">1742</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (etype == MULTI_PE &amp;&amp; multiflag) etype = STUCK_PE;</span></span>
<span class="tr"><span class="th" id="line1743">1743</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype=CantSee();</span></span>
<span class="tr"><span class="th" id="line1744">1744</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1915">FailToken</a>;</span></span>
<span class="tr"><span class="th" id="line1745">1745</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span class="comment">! Choose best error</span></span></span>
<span class="tr"><span class="th" id="line1746">1746</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1747">1747</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1748">1748</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) {</span></span>
<span class="tr"><span class="th" id="line1749">1749</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l &gt; 1) print <span class="dstring">&quot;  [ND returned &quot;</span>, (the) l, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1750">1750</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line1751">1751</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;  [ND appended to the multiple object list:^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1752">1752</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line1753">1753</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=i+1 : j&lt;=k : j++)</span></span>
<span class="tr"><span class="th" id="line1754">1754</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;  Entry &quot;</span>, j, <span class="dstring">&quot;: &quot;</span>, (The) multiple_object--&gt;j,</span></span>
<span class="tr"><span class="th" id="line1755">1755</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dstring">&quot; (&quot;</span>, multiple_object--&gt;j, <span class="dstring">&quot;)^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1756">1756</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;  List now has size &quot;</span>, k, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1757">1757</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1758">1758</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1759">1759</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1760">1760</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1761">1761</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == 1) {</span></span>
<span class="tr"><span class="th" id="line1762">1762</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (~~many_flag) many_flag = true;</span></span>
<span class="tr"><span class="th" id="line1763">1763</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {                                <span class="comment">! Merge with earlier ones</span></span></span>
<span class="tr"><span class="th" id="line1764">1764</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = multiple_object--&gt;0;            <span class="comment">! (with either parity)</span></span></span>
<span class="tr"><span class="th" id="line1765">1765</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = i;</span></span>
<span class="tr"><span class="th" id="line1766">1766</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=i+1 : j&lt;=k : j++) {</span></span>
<span class="tr"><span class="th" id="line1767">1767</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (and_parity) MultiAdd(multiple_object--&gt;j);</span></span>
<span class="tr"><span class="th" id="line1768">1768</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else            MultiSub(multiple_object--&gt;j);</span></span>
<span class="tr"><span class="th" id="line1769">1769</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1770">1770</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1771">1771</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3)</span></span>
<span class="tr"><span class="th" id="line1772">1772</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;  [Merging &quot;</span>, k-i, <span class="dstring">&quot; new objects to the &quot;</span>, i, <span class="dstring">&quot; old ones]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1773">1773</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1774">1774</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1775">1775</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1776">1776</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line1777">1777</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! A single object was indeed found</span></span></span>
<span class="tr"><span class="th" id="line1778">1778</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1779">1779</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_length == 0 &amp;&amp; indef_possambig) {</span></span>
<span class="tr"><span class="th" id="line1780">1780</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! So the answer had to be inferred from no textual data,</span></span></span>
<span class="tr"><span class="th" id="line1781">1781</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! and we know that there was an ambiguity in the descriptor</span></span></span>
<span class="tr"><span class="th" id="line1782">1782</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! stage (such as a word which could be a pronoun being</span></span></span>
<span class="tr"><span class="th" id="line1783">1783</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! parsed as an article or possessive).  It&#39;s worth having</span></span></span>
<span class="tr"><span class="th" id="line1784">1784</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! another go.</span></span></span>
<span class="tr"><span class="th" id="line1785">1785</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1786">1786</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResetDescriptors();</span></span>
<span class="tr"><span class="th" id="line1787">1787</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = desc_wn;</span></span>
<span class="tr"><span class="th" id="line1788">1788</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1704">TryAgain2</a>;</span></span>
<span class="tr"><span class="th" id="line1789">1789</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1790">1790</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1791">1791</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((token == CREATURE_TOKEN) &amp;&amp; (CreatureTest(l) == 0)) {</span></span>
<span class="tr"><span class="th" id="line1792">1792</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = ANIMA_PE;</span></span>
<span class="tr"><span class="th" id="line1793">1793</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1915">FailToken</a>;</span></span>
<span class="tr"><span class="th" id="line1794">1794</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span class="comment">!  Animation is required</span></span></span>
<span class="tr"><span class="th" id="line1795">1795</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1796">1796</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (~~many_flag) single_object = l;</span></span>
<span class="tr"><span class="th" id="line1797">1797</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line1798">1798</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (and_parity) MultiAdd(l); else MultiSub(l);</span></span>
<span class="tr"><span class="th" id="line1799">1799</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1800">1800</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Combining &quot;</span>, (the) l, <span class="dstring">&quot; with list]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1801">1801</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1802">1802</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1803">1803</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1804">1804</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1805">1805</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1806">1806</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line1807">1807</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1808">1808</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Case 2: token is &quot;held&quot; (which fortunately can&#39;t take multiple objects)</span></span></span>
<span class="tr"><span class="th" id="line1809">1809</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! and may generate an implicit take</span></span></span>
<span class="tr"><span class="th" id="line1810">1810</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1811">1811</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = NounDomain(actor,actors_location,token);       <span class="comment">! Same as above...</span></span></span>
<span class="tr"><span class="th" id="line1812">1812</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == REPARSE_CODE) return l;</span></span>
<span class="tr"><span class="th" id="line1813">1813</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == 0) {</span></span>
<span class="tr"><span class="th" id="line1814">1814</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_possambig) {</span></span>
<span class="tr"><span class="th" id="line1815">1815</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResetDescriptors();</span></span>
<span class="tr"><span class="th" id="line1816">1816</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = desc_wn;</span></span>
<span class="tr"><span class="th" id="line1817">1817</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1704">TryAgain2</a>;</span></span>
<span class="tr"><span class="th" id="line1818">1818</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1819">1819</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = CantSee(); jump <a href="./Parser.i6t.html#line1915">FailToken</a>;            <span class="comment">! Choose best error</span></span></span>
<span class="tr"><span class="th" id="line1820">1820</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1821">1821</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1822">1822</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...until it produces something not held by the actor.  Then an implicit</span></span></span>
<span class="tr"><span class="th" id="line1823">1823</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! take must be tried.  If this is already happening anyway, things are too</span></span></span>
<span class="tr"><span class="th" id="line1824">1824</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! confused and we have to give up (but saving the oops marker so as to get</span></span></span>
<span class="tr"><span class="th" id="line1825">1825</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! it on the right word afterwards).</span></span></span>
<span class="tr"><span class="th" id="line1826">1826</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! The point of this last rule is that a sequence like</span></span></span>
<span class="tr"><span class="th" id="line1827">1827</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!</span></span></span>
<span class="tr"><span class="th" id="line1828">1828</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     &gt; read newspaper</span></span></span>
<span class="tr"><span class="th" id="line1829">1829</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     (taking the newspaper first)</span></span></span>
<span class="tr"><span class="th" id="line1830">1830</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     The dwarf unexpectedly prevents you from taking the newspaper!</span></span></span>
<span class="tr"><span class="th" id="line1831">1831</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!</span></span></span>
<span class="tr"><span class="th" id="line1832">1832</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! should not be allowed to go into an infinite repeat - read becomes</span></span></span>
<span class="tr"><span class="th" id="line1833">1833</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! take then read, but take has no effect, so read becomes take then read...</span></span></span>
<span class="tr"><span class="th" id="line1834">1834</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Anyway for now all we do is record the number of the object to take.</span></span></span>
<span class="tr"><span class="th" id="line1835">1835</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1836">1836</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o = parent(l);</span></span>
<span class="tr"><span class="th" id="line1837">1837</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o ~= actor) {</span></span>
<span class="tr"><span class="th" id="line1838">1838</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1839">1839</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Allowing object &quot;</span>, (the) l, <span class="dstring">&quot; for now]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1840">1840</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1841">1841</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1842">1842</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;single_object = l;</span></span>
<span class="tr"><span class="th" id="line1843">1843</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;} <span class="comment">! end of if (token ~= HELD_TOKEN) else</span></span></span>
<span class="tr"><span class="th" id="line1844">1844</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1845">1845</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! The following moves the word marker to just past the named object...</span></span></span>
<span class="tr"><span class="th" id="line1846">1846</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line1847">1847</span><span class="td"><span class="comment">!    if (match_from ~= oops_from) print match_from, &quot; vs &quot;, oops_from, &quot;^&quot;;</span></span></span>
<span class="tr"><span class="th" id="line1848">1848</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1849">1849</span><span class="td"><span class="comment">!    wn = oops_from + match_length;</span></span></span>
<span class="tr"><span class="th" id="line1850">1850</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = match_from + match_length;</span></span>
</div><div class='text'>
<h3 id="parser-parse-token-letter-e">Parse Token Letter E.</h3><p><p> Parse connectives (AND, BUT, etc.) and go back to (C).<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1856">1856</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Object(s) specified now: is that the end of the list, or have we reached</span></span></span>
<span class="tr"><span class="th" id="line1857">1857</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! &quot;and&quot;, &quot;but&quot; and so on?  If so, create a multiple-object list if we</span></span></span>
<span class="tr"><span class="th" id="line1858">1858</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! haven&#39;t already (and are allowed to).</span></span></span>
<span class="tr"><span class="th" id="line1859">1859</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1860">1860</span><span class="td">&nbsp;&nbsp;.NextInList;</span></span>
<span class="tr"><span class="th" id="line1861">1861</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1862">1862</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;o = NextWord();</span></span>
<span class="tr"><span class="th" id="line1863">1863</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1864">1864</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (o == AND1__WD or AND2__WD or AND3__WD or BUT1__WD or BUT2__WD or BUT3__WD or comma_word) {</span></span>
<span class="tr"><span class="th" id="line1865">1865</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1866">1866</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1867">1867</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Read connective &quot;</span>, (address) o, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1868">1868</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1869">1869</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1870">1870</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (~~token_allows_multiple) {</span></span>
<span class="tr"><span class="th" id="line1871">1871</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (multiflag) jump <a href="./Parser.i6t.html#line1898">PassToken</a>; <span class="comment">! give UPTO_PE error</span></span></span>
<span class="tr"><span class="th" id="line1872">1872</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype=MULTI_PE;</span></span>
<span class="tr"><span class="th" id="line1873">1873</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1915">FailToken</a>;</span></span>
<span class="tr"><span class="th" id="line1874">1874</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1875">1875</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1876">1876</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == BUT1__WD or BUT2__WD or BUT3__WD) and_parity = 1-and_parity;</span></span>
<span class="tr"><span class="th" id="line1877">1877</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1878">1878</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (~~many_flag) {</span></span>
<span class="tr"><span class="th" id="line1879">1879</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = 1;</span></span>
<span class="tr"><span class="th" id="line1880">1880</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;1 = single_object;</span></span>
<span class="tr"><span class="th" id="line1881">1881</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;many_flag = true;</span></span>
<span class="tr"><span class="th" id="line1882">1882</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1883">1883</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Making new list from &quot;</span>, (the) single_object, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1884">1884</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line1885">1885</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1886">1886</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dont_infer = true; inferfrom=0;           <span class="comment">! Don&#39;t print (inferences)</span></span></span>
<span class="tr"><span class="th" id="line1887">1887</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1661">ObjectList</a>;                          <span class="comment">! And back around</span></span></span>
<span class="tr"><span class="th" id="line1888">1888</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1889">1889</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1890">1890</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn--;   <span class="comment">! Word marker back to first not-understood word</span></span></span>
</div><div class='text'>
<h3 id="parser-parse-token-letter-f">Parse Token Letter F.</h3><p><p> Return the conclusion of parsing an object list.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1896">1896</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Happy or unhappy endings:</span></span></span>
<span class="tr"><span class="th" id="line1897">1897</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1898">1898</span><span class="td">&nbsp;&nbsp;.PassToken;</span></span>
<span class="tr"><span class="th" id="line1899">1899</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (many_flag) {</span></span>
<span class="tr"><span class="th" id="line1900">1900</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;single_object = GPR_MULTIPLE;</span></span>
<span class="tr"><span class="th" id="line1901">1901</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multi_context = token;</span></span>
<span class="tr"><span class="th" id="line1902">1902</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1903">1903</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line1904">1904</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode == 1 &amp;&amp; indef_type &amp; PLURAL_BIT ~= 0) {</span></span>
<span class="tr"><span class="th" id="line1905">1905</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (token == MULTIEXCEPT_TOKEN or MULTIINSIDE_TOKEN) multi_context = token;</span></span>
<span class="tr"><span class="th" id="line1906">1906</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_wanted &lt; INDEF_ALL_WANTED &amp;&amp; indef_wanted &gt; 1) {</span></span>
<span class="tr"><span class="th" id="line1907">1907</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multi_had = 1; multi_wanted = indef_wanted;</span></span>
<span class="tr"><span class="th" id="line1908">1908</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = TOOFEW_PE;</span></span>
<span class="tr"><span class="th" id="line1909">1909</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1915">FailToken</a>;</span></span>
<span class="tr"><span class="th" id="line1910">1910</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1911">1911</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1912">1912</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1913">1913</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return single_object;</span></span>
<span class="tr"><span class="th" id="line1914">1914</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1915">1915</span><span class="td">&nbsp;&nbsp;.FailToken;</span></span>
<span class="tr"><span class="th" id="line1916">1916</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1917">1917</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If we were only guessing about it being a plural, try again but only</span></span></span>
<span class="tr"><span class="th" id="line1918">1918</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! allowing singulars (so that words like &quot;six&quot; are not swallowed up as</span></span></span>
<span class="tr"><span class="th" id="line1919">1919</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Descriptors)</span></span></span>
<span class="tr"><span class="th" id="line1920">1920</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1921">1921</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (allow_plurals &amp;&amp; indef_guess_p == 1) {</span></span>
<span class="tr"><span class="th" id="line1922">1922</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line1923">1923</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   [Retrying singulars after failure &quot;</span>, etype, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line1924">1924</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif;</span></span>
<span class="tr"><span class="th" id="line1925">1925</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prev_indef_wanted = indef_wanted;</span></span>
<span class="tr"><span class="th" id="line1926">1926</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow_plurals = false;</span></span>
<span class="tr"><span class="th" id="line1927">1927</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = desc_wn;</span></span>
<span class="tr"><span class="th" id="line1928">1928</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line1698">TryAgain</a>;</span></span>
<span class="tr"><span class="th" id="line1929">1929</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1930">1930</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1931">1931</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((indef_wanted &gt; 0 || prev_indef_wanted &gt; 0) &amp;&amp; (~~multiflag)) etype = MULTI_PE;</span></span>
<span class="tr"><span class="th" id="line1932">1932</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1933">1933</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return GPR_FAIL;</span></span>
<span class="tr"><span class="th" id="line1934">1934</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1935">1935</span><span class="td">]; <span class="comment">! end of ParseToken__</span></span></span>
</div><div class='text'>
<h3 id="parser-descriptors">Descriptors.</h3><p><p> In grammatical terms, a descriptor appears at the front of an English noun phrase and clarifies the quantity or specific identity of what is referred to: for instance, <strong> my</strong> mirror, <strong> the</strong> dwarf, <strong> that</strong> woman. (Numbers, as in <strong> four</strong> duets, are also descriptors in linguistics: but the I6 parser doesn&#39;t handle them that way.)<p></p><p> Slightly unfortunately, the bitmap constants used for descriptors in the I6 parser have names in the form <span class="fixed">*_BIT</span>, coinciding with the names of style bits in the list-writer: but they never occur in the same context.<p></p><p> The actual words used as descriptors are read from tables in the language definition. <span class="fixed"><a href="./Parser.i6t.html#line1969">ArticleDescriptors</a></span> uses this table to move current word marker past a run of one or more descriptors which refer to the definite or indefinite article.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1954">1954</span><span class="td">Constant OTHER_BIT  =   1;     <span class="comment">!  These will be used in Adjudicate()</span></span></span>
<span class="tr"><span class="th" id="line1955">1955</span><span class="td">Constant MY_BIT     =   2;     <span class="comment">!  to disambiguate choices</span></span></span>
<span class="tr"><span class="th" id="line1956">1956</span><span class="td">Constant THAT_BIT   =   4;</span></span>
<span class="tr"><span class="th" id="line1957">1957</span><span class="td">Constant PLURAL_BIT =   8;</span></span>
<span class="tr"><span class="th" id="line1958">1958</span><span class="td">Constant LIT_BIT    =  16;</span></span>
<span class="tr"><span class="th" id="line1959">1959</span><span class="td">Constant UNLIT_BIT  =  32;</span></span>
<span class="tr"><span class="th" id="line1960">1960</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1961">1961</span><span class="td">[ ResetDescriptors;</span></span>
<span class="tr"><span class="th" id="line1962">1962</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;indef_mode = 0; indef_type = 0; indef_wanted = 0; indef_guess_p = 0;</span></span>
<span class="tr"><span class="th" id="line1963">1963</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;indef_possambig = false;</span></span>
<span class="tr"><span class="th" id="line1964">1964</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;indef_owner = nothing;</span></span>
<span class="tr"><span class="th" id="line1965">1965</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;indef_cases = $$111111111111;</span></span>
<span class="tr"><span class="th" id="line1966">1966</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;indef_nspec_at = 0;</span></span>
<span class="tr"><span class="th" id="line1967">1967</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1968">1968</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1969">1969</span><span class="td">[ ArticleDescriptors  o x flag cto type n;</span></span>
<span class="tr"><span class="th" id="line1970">1970</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (wn &gt; num_words) return 0;</span></span>
<span class="tr"><span class="th" id="line1971">1971</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1972">1972</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (flag=true : flag :) {</span></span>
<span class="tr"><span class="th" id="line1973">1973</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o = NextWordStopped(); flag = false;</span></span>
<span class="tr"><span class="th" id="line1974">1974</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1975">1975</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (x=1 : x&lt;=LanguageDescriptors--&gt;0 : x=x+4)</span></span>
<span class="tr"><span class="th" id="line1976">1976</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == LanguageDescriptors--&gt;x) {</span></span>
<span class="tr"><span class="th" id="line1977">1977</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type = LanguageDescriptors--&gt;(x+2);</span></span>
<span class="tr"><span class="th" id="line1978">1978</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (type == DEFART_PK or INDEFART_PK) flag = true;</span></span>
<span class="tr"><span class="th" id="line1979">1979</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1980">1980</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1981">1981</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn--;</span></span>
<span class="tr"><span class="th" id="line1982">1982</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></span>
<span class="tr"><span class="th" id="line1983">1983</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-parsing-descriptors">Parsing Descriptors.</h3><p><p> The <span class="fixed"><a href="./Parser.i6t.html#line1992">Descriptors()</a></span> routine parses the descriptors at the head of a noun phrase, leaving the current word marker <span class="fixed"><a href="./Output.i6t.html#line283">wn</a></span> at the first word of the noun phrase&#39;s body. It is allowed to set up for a plural only if <span class="fixed">allow_p</span> is set; it returns a parser error number, or 0 if no error occurred.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1992">1992</span><span class="td">[ Descriptors  o x flag cto type n;</span></span>
<span class="tr"><span class="th" id="line1993">1993</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;ResetDescriptors();</span></span>
<span class="tr"><span class="th" id="line1994">1994</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (wn &gt; num_words) return 0;</span></span>
<span class="tr"><span class="th" id="line1995">1995</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1996">1996</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (flag=true : flag :) {</span></span>
<span class="tr"><span class="th" id="line1997">1997</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o = NextWordStopped(); flag = false;</span></span>
<span class="tr"><span class="th" id="line1998">1998</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1999">1999</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (x=1 : x&lt;=LanguageDescriptors--&gt;0 : x=x+4)</span></span>
<span class="tr"><span class="th" id="line2000">2000</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == LanguageDescriptors--&gt;x) {</span></span>
<span class="tr"><span class="th" id="line2001">2001</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = true;</span></span>
<span class="tr"><span class="th" id="line2002">2002</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type = LanguageDescriptors--&gt;(x+2);</span></span>
<span class="tr"><span class="th" id="line2003">2003</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (type ~= DEFART_PK) indef_mode = true;</span></span>
<span class="tr"><span class="th" id="line2004">2004</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_possambig = true;</span></span>
<span class="tr"><span class="th" id="line2005">2005</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_cases = indef_cases &amp; (LanguageDescriptors--&gt;(x+1));</span></span>
<span class="tr"><span class="th" id="line2006">2006</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2007">2007</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (type == POSSESS_PK) {</span></span>
<span class="tr"><span class="th" id="line2008">2008</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cto = LanguageDescriptors--&gt;(x+3);</span></span>
<span class="tr"><span class="th" id="line2009">2009</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (cto) {</span></span>
<span class="tr"><span class="th" id="line2010">2010</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0: indef_type = indef_type | MY_BIT;</span></span>
<span class="tr"><span class="th" id="line2011">2011</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1: indef_type = indef_type | THAT_BIT;</span></span>
<span class="tr"><span class="th" id="line2012">2012</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</span></span>
<span class="tr"><span class="th" id="line2013">2013</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_owner = PronounValue(cto);</span></span>
<span class="tr"><span class="th" id="line2014">2014</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_owner == NULL) indef_owner = InformParser;</span></span>
<span class="tr"><span class="th" id="line2015">2015</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2016">2016</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2017">2017</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2018">2018</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (type == light)  indef_type = indef_type | LIT_BIT;</span></span>
<span class="tr"><span class="th" id="line2019">2019</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (type == -light) indef_type = indef_type | UNLIT_BIT;</span></span>
<span class="tr"><span class="th" id="line2020">2020</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2021">2021</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2022">2022</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == OTHER1__WD or OTHER2__WD or OTHER3__WD) {</span></span>
<span class="tr"><span class="th" id="line2023">2023</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_mode = 1; flag = 1;</span></span>
<span class="tr"><span class="th" id="line2024">2024</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_type = indef_type | OTHER_BIT;</span></span>
<span class="tr"><span class="th" id="line2025">2025</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2026">2026</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == ALL1__WD or ALL2__WD or ALL3__WD or ALL4__WD or ALL5__WD) {</span></span>
<span class="tr"><span class="th" id="line2027">2027</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_mode = 1; flag = 1; indef_wanted = INDEF_ALL_WANTED;</span></span>
<span class="tr"><span class="th" id="line2028">2028</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (take_all_rule == 1) take_all_rule = 2;</span></span>
<span class="tr"><span class="th" id="line2029">2029</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_type = indef_type | PLURAL_BIT;</span></span>
<span class="tr"><span class="th" id="line2030">2030</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2031">2031</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allow_plurals) {</span></span>
<span class="tr"><span class="th" id="line2032">2032</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (NextWordStopped() ~= -1 or THEN1__WD) { wn--; n = TryNumber(wn-1); } else { n=0; wn--; }</span></span>
<span class="tr"><span class="th" id="line2033">2033</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (n == 1) { indef_mode = 1; flag = 1; }</span></span>
<span class="tr"><span class="th" id="line2034">2034</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (n &gt; 1) {</span></span>
<span class="tr"><span class="th" id="line2035">2035</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_guess_p = 1;</span></span>
<span class="tr"><span class="th" id="line2036">2036</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_mode = 1; flag = 1; indef_wanted = n;</span></span>
<span class="tr"><span class="th" id="line2037">2037</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_nspec_at = wn-1;</span></span>
<span class="tr"><span class="th" id="line2038">2038</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_type = indef_type | PLURAL_BIT;</span></span>
<span class="tr"><span class="th" id="line2039">2039</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2040">2040</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2041">2041</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (flag == 1 &amp;&amp; NextWordStopped() ~= OF1__WD or OF2__WD or OF3__WD or OF4__WD)</span></span>
<span class="tr"><span class="th" id="line2042">2042</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn--;  <span class="comment">! Skip &#39;of&#39; after these</span></span></span>
<span class="tr"><span class="th" id="line2043">2043</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2044">2044</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn--;</span></span>
<span class="tr"><span class="th" id="line2045">2045</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></span>
<span class="tr"><span class="th" id="line2046">2046</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line2047">2047</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2048">2048</span><span class="td">[ SafeSkipDescriptors;</span></span>
<span class="tr"><span class="th" id="line2049">2049</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@push indef_mode; @push indef_type; @push indef_wanted;</span></span>
<span class="tr"><span class="th" id="line2050">2050</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@push indef_guess_p; @push indef_possambig; @push indef_owner;</span></span>
<span class="tr"><span class="th" id="line2051">2051</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@push indef_cases; @push indef_nspec_at;</span></span>
<span class="tr"><span class="th" id="line2052">2052</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line2053">2053</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;Descriptors();</span></span>
<span class="tr"><span class="th" id="line2054">2054</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line2055">2055</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@pull indef_nspec_at; @pull indef_cases;</span></span>
<span class="tr"><span class="th" id="line2056">2056</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@pull indef_owner; @pull indef_possambig; @pull indef_guess_p;</span></span>
<span class="tr"><span class="th" id="line2057">2057</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@pull indef_wanted; @pull indef_type; @pull indef_mode;</span></span>
<span class="tr"><span class="th" id="line2058">2058</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-preposition-chain">Preposition Chain.</h3><p><p> A small utility for runs of prepositions.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2064">2064</span><span class="td">[ PrepositionChain wd index;</span></span>
<span class="tr"><span class="th" id="line2065">2065</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (line_tdata--&gt;index == wd) return wd;</span></span>
<span class="tr"><span class="th" id="line2066">2066</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((line_token--&gt;index)-&gt;0 &amp; $20 == 0) return -1;</span></span>
<span class="tr"><span class="th" id="line2067">2067</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;do {</span></span>
<span class="tr"><span class="th" id="line2068">2068</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_tdata--&gt;index == wd) return wd;</span></span>
<span class="tr"><span class="th" id="line2069">2069</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index++;</span></span>
<span class="tr"><span class="th" id="line2070">2070</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;} until ((line_token--&gt;index == ENDIT_TOKEN) || (((line_token--&gt;index)-&gt;0 &amp; $10) == 0));</span></span>
<span class="tr"><span class="th" id="line2071">2071</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return -1;</span></span>
<span class="tr"><span class="th" id="line2072">2072</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-creature">Creature.</h3><p><p> Will this object do for an I6 <span class="fixed">creature</span> token? (In I7 terms, this affects the tokens &quot;[someone]&quot;, &quot;[somebody]&quot;, &quot;[anyone]&quot; and &quot;[anybody]&quot;.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2079">2079</span><span class="td">[ CreatureTest obj;</span></span>
<span class="tr"><span class="th" id="line2080">2080</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj has animate) rtrue;</span></span>
<span class="tr"><span class="th" id="line2081">2081</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj hasnt talkable) rfalse;</span></span>
<span class="tr"><span class="th" id="line2082">2082</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (action_to_be == ##Ask or ##Answer or ##Tell or ##AskFor) rtrue;</span></span>
<span class="tr"><span class="th" id="line2083">2083</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line2084">2084</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-noun-domain">Noun Domain.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line2104">NounDomain</a></span> does the most substantial part of parsing an object name. It is given two &quot;domains&quot; &ndash; usually a location and then the actor who is looking &ndash; and a context (i.e. token type), and returns:<p></p><p> (a) 0 if no match at all could be made, (b) 1 if a multiple object was made, (c) <em>k</em> if object <em>k</em> was the one decided upon, (d) <span class="fixed"><a href="./Definitions.i6t.html#line77">REPARSE_CODE</a></span> if it asked a question of the player and consequently rewrote the player&#39;s input, so that the whole parser should start again on the rewritten input.<p></p><p> In case (c), <span class="fixed"><a href="./Parser.i6t.html#line2104">NounDomain</a></span> also sets the variable <span class="fixed"><a href="./Parser.i6t.html#line74">length_of_noun</a></span> to the number of words in the input text matched to the noun. In case (b), the multiple objects are added to <span class="fixed">multiple_object</span> by hand (not by <span class="fixed"><a href="./Parser.i6t.html#line3171">MultiAdd</a></span>, because we want to allow duplicates).<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2104">2104</span><span class="td">[ NounDomain domain1 domain2 context dont_ask</span></span>
<span class="tr"><span class="th" id="line2105">2105</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;first_word i j k l answer_words marker;</span></span>
<span class="tr"><span class="th" id="line2106">2106</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2107">2107</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) {</span></span>
<span class="tr"><span class="th" id="line2108">2108</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   [NounDomain called at word &quot;</span>, wn, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2109">2109</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2110">2110</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode) {</span></span>
<span class="tr"><span class="th" id="line2111">2111</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;seeking indefinite object: &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2112">2112</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; OTHER_BIT)  print <span class="dstring">&quot;other &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2113">2113</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; MY_BIT)     print <span class="dstring">&quot;my &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2114">2114</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; THAT_BIT)   print <span class="dstring">&quot;that &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2115">2115</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; PLURAL_BIT) print <span class="dstring">&quot;plural &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2116">2116</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; LIT_BIT)    print <span class="dstring">&quot;lit &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2117">2117</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; UNLIT_BIT)  print <span class="dstring">&quot;unlit &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2118">2118</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_owner ~= 0) print <span class="dstring">&quot;owner:&quot;</span>, (name) indef_owner;</span></span>
<span class="tr"><span class="th" id="line2119">2119</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_line;</span></span>
<span class="tr"><span class="th" id="line2120">2120</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   number wanted: &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2121">2121</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_wanted == INDEF_ALL_WANTED) print <span class="dstring">&quot;all&quot;</span>; else print indef_wanted;</span></span>
<span class="tr"><span class="th" id="line2122">2122</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_line;</span></span>
<span class="tr"><span class="th" id="line2123">2123</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   most likely GNAs of names: &quot;</span>, indef_cases, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2124">2124</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2125">2125</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else print <span class="dstring">&quot;seeking definite object^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2126">2126</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2127">2127</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2128">2128</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2129">2129</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;match_length = 0; number_matched = 0; match_from = wn;</span></span>
<span class="tr"><span class="th" id="line2130">2130</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2131">2131</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;SearchScope(domain1, domain2, context);</span></span>
<span class="tr"><span class="th" id="line2132">2132</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2133">2133</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2134">2134</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   [ND made &quot;</span>, number_matched, <span class="dstring">&quot; matches]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2135">2135</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2136">2136</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2137">2137</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = match_from+match_length;</span></span>
<span class="tr"><span class="th" id="line2138">2138</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2139">2139</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If nothing worked at all, leave with the word marker skipped past the</span></span></span>
<span class="tr"><span class="th" id="line2140">2140</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! first unmatched word...</span></span></span>
<span class="tr"><span class="th" id="line2141">2141</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2142">2142</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (number_matched == 0) { wn++; rfalse; }</span></span>
<span class="tr"><span class="th" id="line2143">2143</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2144">2144</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Suppose that there really were some words being parsed (i.e., we did</span></span></span>
<span class="tr"><span class="th" id="line2145">2145</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! not just infer).  If so, and if there was only one match, it must be</span></span></span>
<span class="tr"><span class="th" id="line2146">2146</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! right and we return it...</span></span></span>
<span class="tr"><span class="th" id="line2147">2147</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2148">2148</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (match_from &lt;= num_words) {</span></span>
<span class="tr"><span class="th" id="line2149">2149</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (number_matched == 1) {</span></span>
<span class="tr"><span class="th" id="line2150">2150</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i=match_list--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2151">2151</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return i;</span></span>
<span class="tr"><span class="th" id="line2152">2152</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2153">2153</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2154">2154</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...now suppose that there was more typing to come, i.e. suppose that</span></span></span>
<span class="tr"><span class="th" id="line2155">2155</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! the user entered something beyond this noun.  If nothing ought to follow,</span></span></span>
<span class="tr"><span class="th" id="line2156">2156</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! then there must be a mistake, (unless what does follow is just a full</span></span></span>
<span class="tr"><span class="th" id="line2157">2157</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! stop, and or comma)</span></span></span>
<span class="tr"><span class="th" id="line2158">2158</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2159">2159</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wn &lt;= num_words) {</span></span>
<span class="tr"><span class="th" id="line2160">2160</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = NextWord(); wn--;</span></span>
<span class="tr"><span class="th" id="line2161">2161</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i ~=  AND1__WD or AND2__WD or AND3__WD or comma_word</span></span>
<span class="tr"><span class="th" id="line2162">2162</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or THEN1__WD or THEN2__WD or THEN3__WD</span></span>
<span class="tr"><span class="th" id="line2163">2163</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or BUT1__WD or BUT2__WD or BUT3__WD) {</span></span>
<span class="tr"><span class="th" id="line2164">2164</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (lookahead == ENDIT_TOKEN) rfalse;</span></span>
<span class="tr"><span class="th" id="line2165">2165</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2166">2166</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2167">2167</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2168">2168</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2169">2169</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Now look for a good choice, if there&#39;s more than one choice...</span></span></span>
<span class="tr"><span class="th" id="line2170">2170</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2171">2171</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;number_of_classes = 0;</span></span>
<span class="tr"><span class="th" id="line2172">2172</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2173">2173</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (number_matched == 1) {</span></span>
<span class="tr"><span class="th" id="line2174">2174</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = match_list--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2175">2175</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode == 1 &amp;&amp; indef_type &amp; PLURAL_BIT ~= 0) {</span></span>
<span class="tr"><span class="th" id="line2176">2176</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context == MULTI_TOKEN or MULTIHELD_TOKEN or</span></span>
<span class="tr"><span class="th" id="line2177">2177</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MULTIEXCEPT_TOKEN or MULTIINSIDE_TOKEN or</span></span>
<span class="tr"><span class="th" id="line2178">2178</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOUN_TOKEN or HELD_TOKEN or CREATURE_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line2179">2179</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(DECIDING_WHETHER_ALL_INC_ACT, i);</span></span>
<span class="tr"><span class="th" id="line2180">2180</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((ForActivity(DECIDING_WHETHER_ALL_INC_ACT, i)) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line2181">2181</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(RulebookFailed())) rfalse;</span></span>
<span class="tr"><span class="th" id="line2182">2182</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndActivity(DECIDING_WHETHER_ALL_INC_ACT, i);</span></span>
<span class="tr"><span class="th" id="line2183">2183</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2184">2184</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2185">2185</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2186">2186</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (number_matched &gt; 1) {</span></span>
<span class="tr"><span class="th" id="line2187">2187</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = true;</span></span>
<span class="tr"><span class="th" id="line2188">2188</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (number_matched &gt; 1)</span></span>
<span class="tr"><span class="th" id="line2189">2189</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=0 : j&lt;number_matched-1 : j++)</span></span>
<span class="tr"><span class="th" id="line2190">2190</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (Identical(match_list--&gt;j, match_list--&gt;(j+1)) == false)</span></span>
<span class="tr"><span class="th" id="line2191">2191</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = false;</span></span>
<span class="tr"><span class="th" id="line2192">2192</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i) dont_infer = true;</span></span>
<span class="tr"><span class="th" id="line2193">2193</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = Adjudicate(context);</span></span>
<span class="tr"><span class="th" id="line2194">2194</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == -1) rfalse;</span></span>
<span class="tr"><span class="th" id="line2195">2195</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == 1) rtrue;       <span class="comment">!  Adjudicate has made a multiple</span></span></span>
<span class="tr"><span class="th" id="line2196">2196</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  object, and we pass it on</span></span></span>
<span class="tr"><span class="th" id="line2197">2197</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2198">2198</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2199">2199</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If i is non-zero here, one of two things is happening: either</span></span></span>
<span class="tr"><span class="th" id="line2200">2200</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (a) an inference has been successfully made that object i is</span></span></span>
<span class="tr"><span class="th" id="line2201">2201</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     the intended one from the user&#39;s specification, or</span></span></span>
<span class="tr"><span class="th" id="line2202">2202</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (b) the user finished typing some time ago, but we&#39;ve decided</span></span></span>
<span class="tr"><span class="th" id="line2203">2203</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     on i because it&#39;s the only possible choice.</span></span></span>
<span class="tr"><span class="th" id="line2204">2204</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! In either case we have to keep the pattern up to date,</span></span></span>
<span class="tr"><span class="th" id="line2205">2205</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! note that an inference has been made and return.</span></span></span>
<span class="tr"><span class="th" id="line2206">2206</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (Except, we don&#39;t note which of a pile of identical objects.)</span></span></span>
<span class="tr"><span class="th" id="line2207">2207</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2208">2208</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (i ~= 0) {</span></span>
<span class="tr"><span class="th" id="line2209">2209</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (dont_infer) return i;</span></span>
<span class="tr"><span class="th" id="line2210">2210</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (inferfrom == 0) inferfrom=pcount;</span></span>
<span class="tr"><span class="th" id="line2211">2211</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pattern--&gt;pcount = i;</span></span>
<span class="tr"><span class="th" id="line2212">2212</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return i;</span></span>
<span class="tr"><span class="th" id="line2213">2213</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2214">2214</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2215">2215</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (dont_ask) return match_list--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2216">2216</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2217">2217</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If we get here, there was no obvious choice of object to make.  If in</span></span></span>
<span class="tr"><span class="th" id="line2218">2218</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! fact we&#39;ve already gone past the end of the player&#39;s typing (which</span></span></span>
<span class="tr"><span class="th" id="line2219">2219</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! means the match list must contain every object in scope, regardless</span></span></span>
<span class="tr"><span class="th" id="line2220">2220</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! of its name), then it&#39;s foolish to give an enormous list to choose</span></span></span>
<span class="tr"><span class="th" id="line2221">2221</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! from - instead we go and ask a more suitable question...</span></span></span>
<span class="tr"><span class="th" id="line2222">2222</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2223">2223</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (match_from &gt; num_words) jump <a href="./Parser.i6t.html#line2362">Incomplete</a>;</span></span>
<span class="tr"><span class="th" id="line2224">2224</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2225">2225</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Now we print up the question, using the equivalence classes as worked</span></span></span>
<span class="tr"><span class="th" id="line2226">2226</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! out by Adjudicate() so as not to repeat ourselves on plural objects...</span></span></span>
<span class="tr"><span class="th" id="line2227">2227</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2228">2228</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(ASKING_WHICH_DO_YOU_MEAN_ACT);</span></span>
<span class="tr"><span class="th" id="line2229">2229</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (ForActivity(ASKING_WHICH_DO_YOU_MEAN_ACT)) jump <a href="./Parser.i6t.html#line2256">SkipWhichQuestion</a>;</span></span>
<span class="tr"><span class="th" id="line2230">2230</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;j = 1; marker = 0;</span></span>
<span class="tr"><span class="th" id="line2231">2231</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=1 : i&lt;=number_of_classes : i++) {</span></span>
<span class="tr"><span class="th" id="line2232">2232</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (((match_classes--&gt;marker) ~= i) &amp;&amp; ((match_classes--&gt;marker) ~= -i))</span></span>
<span class="tr"><span class="th" id="line2233">2233</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;marker++;</span></span>
<span class="tr"><span class="th" id="line2234">2234</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_list--&gt;marker hasnt animate) j = 0;</span></span>
<span class="tr"><span class="th" id="line2235">2235</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2236">2236</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (j) PARSER_CLARIF_INTERNAL_RM(<span class="sstring">&#39;A&#39;</span>);</span></span>
<span class="tr"><span class="th" id="line2237">2237</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else PARSER_CLARIF_INTERNAL_RM(<span class="sstring">&#39;B&#39;</span>);</span></span>
<span class="tr"><span class="th" id="line2238">2238</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2239">2239</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;j = number_of_classes; marker = 0;</span></span>
<span class="tr"><span class="th" id="line2240">2240</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=1 : i&lt;=number_of_classes : i++) {</span></span>
<span class="tr"><span class="th" id="line2241">2241</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (((match_classes--&gt;marker) ~= i) &amp;&amp; ((match_classes--&gt;marker) ~= -i)) marker++;</span></span>
<span class="tr"><span class="th" id="line2242">2242</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = match_list--&gt;marker;</span></span>
<span class="tr"><span class="th" id="line2243">2243</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2244">2244</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_classes--&gt;marker &gt; 0) print (the) k; else print (a) k;</span></span>
<span class="tr"><span class="th" id="line2245">2245</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2246">2246</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i &lt; j-1)  print <span class="dstring">&quot;, &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2247">2247</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == j-1) {</span></span>
<span class="tr"><span class="th" id="line2248">2248</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef SERIAL_COMMA;</span></span>
<span class="tr"><span class="th" id="line2249">2249</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (j ~= 2) print <span class="dstring">&quot;,&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2250">2250</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! SERIAL_COMMA</span></span></span>
<span class="tr"><span class="th" id="line2251">2251</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARSER_CLARIF_INTERNAL_RM(<span class="sstring">&#39;H&#39;</span>);</span></span>
<span class="tr"><span class="th" id="line2252">2252</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2253">2253</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2254">2254</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;?^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2255">2255</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2256">2256</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.SkipWhichQuestion; EndActivity(ASKING_WHICH_DO_YOU_MEAN_ACT);</span></span>
<span class="tr"><span class="th" id="line2257">2257</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2258">2258</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...and get an answer:</span></span></span>
<span class="tr"><span class="th" id="line2259">2259</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2260">2260</span><span class="td">&nbsp;&nbsp;.WhichOne;</span></span>
<span class="tr"><span class="th" id="line2261">2261</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line2262">2262</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=2 : i&lt;INPUT_BUFFER_LEN : i++) buffer2-&gt;i = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2263">2263</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_ZCODE</span></span></span>
<span class="tr"><span class="th" id="line2264">2264</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;answer_words=Keyboard(buffer2, parse2);</span></span>
<span class="tr"><span class="th" id="line2265">2265</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2266">2266</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Conveniently, parse2--&gt;1 is the first word in both ZCODE and GLULX.</span></span></span>
<span class="tr"><span class="th" id="line2267">2267</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;first_word = (parse2--&gt;1);</span></span>
<span class="tr"><span class="th" id="line2268">2268</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2269">2269</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Take care of &quot;all&quot;, because that does something too clever here to do</span></span></span>
<span class="tr"><span class="th" id="line2270">2270</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! later on:</span></span></span>
<span class="tr"><span class="th" id="line2271">2271</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2272">2272</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (first_word == ALL1__WD or ALL2__WD or ALL3__WD or ALL4__WD or ALL5__WD) {</span></span>
<span class="tr"><span class="th" id="line2273">2273</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context == MULTI_TOKEN or MULTIHELD_TOKEN or MULTIEXCEPT_TOKEN or MULTIINSIDE_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line2274">2274</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2275">2275</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched &amp;&amp; l+i&lt;MATCH_LIST_WORDS : i++) {</span></span>
<span class="tr"><span class="th" id="line2276">2276</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = match_list--&gt;i;</span></span>
<span class="tr"><span class="th" id="line2277">2277</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;(i+1+l) = k;</span></span>
<span class="tr"><span class="th" id="line2278">2278</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2279">2279</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = i+l;</span></span>
<span class="tr"><span class="th" id="line2280">2280</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line2281">2281</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2282">2282</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARSER_CLARIF_INTERNAL_RM(<span class="sstring">&#39;C&#39;</span>);</span></span>
<span class="tr"><span class="th" id="line2283">2283</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line2260">WhichOne</a>;</span></span>
<span class="tr"><span class="th" id="line2284">2284</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2285">2285</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2286">2286</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Look for a comma, and interpret this as a fresh conversation command</span></span></span>
<span class="tr"><span class="th" id="line2287">2287</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! if so:</span></span></span>
<span class="tr"><span class="th" id="line2288">2288</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2289">2289</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=1 : i&lt;=answer_words : i++)</span></span>
<span class="tr"><span class="th" id="line2290">2290</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (WordFrom(i, parse2) == comma_word) {</span></span>
<span class="tr"><span class="th" id="line2291">2291</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_CopyBuffer(buffer, buffer2);</span></span>
<span class="tr"><span class="th" id="line2292">2292</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line2343">RECONSTRUCT_INPUT</a>;        </span></span>
<span class="tr"><span class="th" id="line2293">2293</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2294">2294</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2295">2295</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If the first word of the reply can be interpreted as a verb, then</span></span></span>
<span class="tr"><span class="th" id="line2296">2296</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! assume that the player has ignored the question and given a new</span></span></span>
<span class="tr"><span class="th" id="line2297">2297</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! command altogether.</span></span></span>
<span class="tr"><span class="th" id="line2298">2298</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (This is one time when it&#39;s convenient that the directions are</span></span></span>
<span class="tr"><span class="th" id="line2299">2299</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! not themselves verbs - thus, &quot;north&quot; as a reply to &quot;Which, the north</span></span></span>
<span class="tr"><span class="th" id="line2300">2300</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! or south door&quot; is not treated as a fresh command but as an answer.)</span></span></span>
<span class="tr"><span class="th" id="line2301">2301</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2302">2302</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef LanguageIsVerb;</span></span>
<span class="tr"><span class="th" id="line2303">2303</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (first_word == 0) {</span></span>
<span class="tr"><span class="th" id="line2304">2304</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = wn; first_word = LanguageIsVerb(buffer2, parse2, 1); wn = j;</span></span>
<span class="tr"><span class="th" id="line2305">2305</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2306">2306</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! LanguageIsVerb</span></span></span>
<span class="tr"><span class="th" id="line2307">2307</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (first_word ~= 0) {</span></span>
<span class="tr"><span class="th" id="line2308">2308</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = first_word-&gt;#dict_par1;</span></span>
<span class="tr"><span class="th" id="line2309">2309</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((0 ~= j&amp;1) &amp;&amp; ~~LanguageVerbMayBeName(first_word)) {</span></span>
<span class="tr"><span class="th" id="line2310">2310</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_CopyBuffer(buffer, buffer2);</span></span>
<span class="tr"><span class="th" id="line2311">2311</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line2343">RECONSTRUCT_INPUT</a>;</span></span>
<span class="tr"><span class="th" id="line2312">2312</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2313">2313</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2314">2314</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2315">2315</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Now we insert the answer into the original typed command, as</span></span></span>
<span class="tr"><span class="th" id="line2316">2316</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! words additionally describing the same object</span></span></span>
<span class="tr"><span class="th" id="line2317">2317</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (eg, &gt; take red button</span></span></span>
<span class="tr"><span class="th" id="line2318">2318</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!      Which one, ...</span></span></span>
<span class="tr"><span class="th" id="line2319">2319</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!      &gt; music</span></span></span>
<span class="tr"><span class="th" id="line2320">2320</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! becomes &quot;take music red button&quot;.  The parser will thus have three</span></span></span>
<span class="tr"><span class="th" id="line2321">2321</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! words to work from next time, not two.)</span></span></span>
<span class="tr"><span class="th" id="line2322">2322</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2323">2323</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line2324">2324</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;k = WordAddress(match_from) - buffer; l=buffer2-&gt;1+1;</span></span>
<span class="tr"><span class="th" id="line2325">2325</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=buffer + buffer-&gt;0 - 1 : j&gt;=buffer+k+l : j--) j-&gt;0 = 0-&gt;(j-l);</span></span>
<span class="tr"><span class="th" id="line2326">2326</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;l : i++) buffer-&gt;(k+i) = buffer2-&gt;(2+i);</span></span>
<span class="tr"><span class="th" id="line2327">2327</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;buffer-&gt;(k+l-1) = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2328">2328</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;buffer-&gt;1 = buffer-&gt;1 + l;</span></span>
<span class="tr"><span class="th" id="line2329">2329</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (buffer-&gt;1 &gt;= (buffer-&gt;0 - 1)) buffer-&gt;1 = buffer-&gt;0;</span></span>
<span class="tr"><span class="th" id="line2330">2330</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line2331">2331</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;k = WordAddress(match_from) - buffer;</span></span>
<span class="tr"><span class="th" id="line2332">2332</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;l = (buffer2--&gt;0) + 1;</span></span>
<span class="tr"><span class="th" id="line2333">2333</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=buffer+INPUT_BUFFER_LEN-1 : j&gt;=buffer+k+l : j--) j-&gt;0 = j-&gt;(-l);</span></span>
<span class="tr"><span class="th" id="line2334">2334</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;l : i++) buffer-&gt;(k+i) = buffer2-&gt;(WORDSIZE+i);</span></span>
<span class="tr"><span class="th" id="line2335">2335</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;buffer-&gt;(k+l-1) = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2336">2336</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;buffer--&gt;0 = buffer--&gt;0 + l;</span></span>
<span class="tr"><span class="th" id="line2337">2337</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (buffer--&gt;0 &gt; (INPUT_BUFFER_LEN-WORDSIZE)) buffer--&gt;0 = (INPUT_BUFFER_LEN-WORDSIZE);</span></span>
<span class="tr"><span class="th" id="line2338">2338</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line2339">2339</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2340">2340</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Having reconstructed the input, we warn the parser accordingly</span></span></span>
<span class="tr"><span class="th" id="line2341">2341</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! and get out.</span></span></span>
<span class="tr"><span class="th" id="line2342">2342</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2343">2343</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.RECONSTRUCT_INPUT;</span></span>
<span class="tr"><span class="th" id="line2344">2344</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2345">2345</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;num_words = WordCount(); players_command = 100 + num_words;</span></span>
<span class="tr"><span class="th" id="line2346">2346</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = 1;</span></span>
<span class="tr"><span class="th" id="line2347">2347</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef LanguageToInformese;</span></span>
<span class="tr"><span class="th" id="line2348">2348</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LanguageToInformese();</span></span>
<span class="tr"><span class="th" id="line2349">2349</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Re-tokenise:</span></span></span>
<span class="tr"><span class="th" id="line2350">2350</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;VM_Tokenise(buffer,parse);</span></span>
<span class="tr"><span class="th" id="line2351">2351</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! LanguageToInformese</span></span></span>
<span class="tr"><span class="th" id="line2352">2352</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;num_words = WordCount(); players_command = 100 + num_words;</span></span>
<span class="tr"><span class="th" id="line2353">2353</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actors_location = ScopeCeiling(player);</span></span>
<span class="tr"><span class="th" id="line2354">2354</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;FollowRulebook(Activity_after_rulebooks--&gt;READING_A_COMMAND_ACT);</span></span>
<span class="tr"><span class="th" id="line2355">2355</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2356">2356</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return REPARSE_CODE;</span></span>
<span class="tr"><span class="th" id="line2357">2357</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2358">2358</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Now we come to the question asked when the input has run out</span></span></span>
<span class="tr"><span class="th" id="line2359">2359</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! and can&#39;t easily be guessed (eg, the player typed &quot;take&quot; and there</span></span></span>
<span class="tr"><span class="th" id="line2360">2360</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! were plenty of things which might have been meant).</span></span></span>
<span class="tr"><span class="th" id="line2361">2361</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2362">2362</span><span class="td">&nbsp;&nbsp;.Incomplete;</span></span>
<span class="tr"><span class="th" id="line2363">2363</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2364">2364</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (context == CREATURE_TOKEN) PARSER_CLARIF_INTERNAL_RM(<span class="sstring">&#39;D&#39;</span>, actor);</span></span>
<span class="tr"><span class="th" id="line2365">2365</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else                           PARSER_CLARIF_INTERNAL_RM(<span class="sstring">&#39;E&#39;</span>, actor);</span></span>
<span class="tr"><span class="th" id="line2366">2366</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;new_line;</span></span>
<span class="tr"><span class="th" id="line2367">2367</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2368">2368</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line2369">2369</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=2 : i&lt;INPUT_BUFFER_LEN : i++) buffer2-&gt;i=<span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2370">2370</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_ZCODE</span></span></span>
<span class="tr"><span class="th" id="line2371">2371</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;answer_words = Keyboard(buffer2, parse2);</span></span>
<span class="tr"><span class="th" id="line2372">2372</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2373">2373</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Look for a comma, and interpret this as a fresh conversation command</span></span></span>
<span class="tr"><span class="th" id="line2374">2374</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! if so:</span></span></span>
<span class="tr"><span class="th" id="line2375">2375</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2376">2376</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=1 : i&lt;=answer_words : i++)</span></span>
<span class="tr"><span class="th" id="line2377">2377</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (WordFrom(i, parse2) == comma_word) {</span></span>
<span class="tr"><span class="th" id="line2378">2378</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_CopyBuffer(buffer, buffer2);</span></span>
<span class="tr"><span class="th" id="line2379">2379</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line2343">RECONSTRUCT_INPUT</a>;</span></span>
<span class="tr"><span class="th" id="line2380">2380</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2381">2381</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2382">2382</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;first_word=(parse2--&gt;1);</span></span>
<span class="tr"><span class="th" id="line2383">2383</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef LanguageIsVerb;</span></span>
<span class="tr"><span class="th" id="line2384">2384</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (first_word==0) {</span></span>
<span class="tr"><span class="th" id="line2385">2385</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = wn; first_word=LanguageIsVerb(buffer2, parse2, 1); wn = j;</span></span>
<span class="tr"><span class="th" id="line2386">2386</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2387">2387</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! LanguageIsVerb</span></span></span>
<span class="tr"><span class="th" id="line2388">2388</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2389">2389</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Once again, if the reply looks like a command, give it to the</span></span></span>
<span class="tr"><span class="th" id="line2390">2390</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! parser to get on with and forget about the question...</span></span></span>
<span class="tr"><span class="th" id="line2391">2391</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2392">2392</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (first_word ~= 0) {</span></span>
<span class="tr"><span class="th" id="line2393">2393</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = first_word-&gt;#dict_par1;</span></span>
<span class="tr"><span class="th" id="line2394">2394</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((0 ~= j&amp;1) &amp;&amp; ~~LanguageVerbMayBeName(first_word)) {</span></span>
<span class="tr"><span class="th" id="line2395">2395</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VM_CopyBuffer(buffer, buffer2);</span></span>
<span class="tr"><span class="th" id="line2396">2396</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line2343">RECONSTRUCT_INPUT</a>;</span></span>
<span class="tr"><span class="th" id="line2397">2397</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2398">2398</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2399">2399</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2400">2400</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! ...but if we have a genuine answer, then:</span></span></span>
<span class="tr"><span class="th" id="line2401">2401</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!</span></span></span>
<span class="tr"><span class="th" id="line2402">2402</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (1) we must glue in text suitable for anything that&#39;s been inferred.</span></span></span>
<span class="tr"><span class="th" id="line2403">2403</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2404">2404</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (inferfrom ~= 0) {</span></span>
<span class="tr"><span class="th" id="line2405">2405</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=inferfrom : j&lt;pcount : j++) {</span></span>
<span class="tr"><span class="th" id="line2406">2406</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (pattern--&gt;j == PATTERN_NULL) continue;</span></span>
<span class="tr"><span class="th" id="line2407">2407</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line2408">2408</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = 2+buffer-&gt;1; (buffer-&gt;1)++; buffer-&gt;(i++) = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2409">2409</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line2410">2410</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = WORDSIZE + buffer--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2411">2411</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(buffer--&gt;0)++; buffer-&gt;(i++) = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2412">2412</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line2413">2413</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2414">2414</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2415">2415</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 5)</span></span>
<span class="tr"><span class="th" id="line2416">2416</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[Gluing in inference with pattern code &quot;</span>, pattern--&gt;j, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2417">2417</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2418">2418</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2419">2419</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Conveniently, parse2--&gt;1 is the first word in both ZCODE and GLULX.</span></span></span>
<span class="tr"><span class="th" id="line2420">2420</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2421">2421</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse2--&gt;1 = 0;</span></span>
<span class="tr"><span class="th" id="line2422">2422</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2423">2423</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! An inferred object.  Best we can do is glue in a pronoun.</span></span></span>
<span class="tr"><span class="th" id="line2424">2424</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (This is imperfect, but it&#39;s very seldom needed anyway.)</span></span></span>
<span class="tr"><span class="th" id="line2425">2425</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2426">2426</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (pattern--&gt;j &gt;= 2 &amp;&amp; pattern--&gt;j &lt; REPARSE_CODE) {</span></span>
<span class="tr"><span class="th" id="line2427">2427</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PronounNotice(pattern--&gt;j);</span></span>
<span class="tr"><span class="th" id="line2428">2428</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (k=1 : k&lt;=LanguagePronouns--&gt;0 : k=k+3)</span></span>
<span class="tr"><span class="th" id="line2429">2429</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (pattern--&gt;j == LanguagePronouns--&gt;(k+2)) {</span></span>
<span class="tr"><span class="th" id="line2430">2430</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse2--&gt;1 = LanguagePronouns--&gt;k;</span></span>
<span class="tr"><span class="th" id="line2431">2431</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2432">2432</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 5)</span></span>
<span class="tr"><span class="th" id="line2433">2433</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[Using pronoun &quot;</span>, (address) parse2--&gt;1, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2434">2434</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2435">2435</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></span>
<span class="tr"><span class="th" id="line2436">2436</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2437">2437</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2438">2438</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line2439">2439</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! An inferred preposition.</span></span></span>
<span class="tr"><span class="th" id="line2440">2440</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse2--&gt;1 = VM_NumberToDictionaryAddress(pattern--&gt;j - REPARSE_CODE);</span></span>
<span class="tr"><span class="th" id="line2441">2441</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2442">2442</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 5)</span></span>
<span class="tr"><span class="th" id="line2443">2443</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[Using preposition &quot;</span>, (address) parse2--&gt;1, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2444">2444</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2445">2445</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2446">2446</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2447">2447</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! parse2--&gt;1 now holds the dictionary address of the word to glue in.</span></span></span>
<span class="tr"><span class="th" id="line2448">2448</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2449">2449</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parse2--&gt;1 ~= 0) {</span></span>
<span class="tr"><span class="th" id="line2450">2450</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = buffer + i;</span></span>
<span class="tr"><span class="th" id="line2451">2451</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line2452">2452</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@output_stream 3 k;</span></span>
<span class="tr"><span class="th" id="line2453">2453</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print (address) parse2--&gt;1;</span></span>
<span class="tr"><span class="th" id="line2454">2454</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@output_stream -3;</span></span>
<span class="tr"><span class="th" id="line2455">2455</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = k--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2456">2456</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (l=i : l&lt;i+k : l++) buffer-&gt;l = buffer-&gt;(l+2);</span></span>
<span class="tr"><span class="th" id="line2457">2457</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = i + k; buffer-&gt;1 = i-2;</span></span>
<span class="tr"><span class="th" id="line2458">2458</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line2459">2459</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = Glulx_PrintAnyToArray(buffer+i, INPUT_BUFFER_LEN-i, parse2--&gt;1);</span></span>
<span class="tr"><span class="th" id="line2460">2460</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = i + k; buffer--&gt;0 = i - WORDSIZE;</span></span>
<span class="tr"><span class="th" id="line2461">2461</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line2462">2462</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2463">2463</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2464">2464</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2465">2465</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2466">2466</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (2) we must glue the newly-typed text onto the end.</span></span></span>
<span class="tr"><span class="th" id="line2467">2467</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2468">2468</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line2469">2469</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = 2+buffer-&gt;1; (buffer-&gt;1)++; buffer-&gt;(i++) = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2470">2470</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=0 : j&lt;buffer2-&gt;1 : i++,j++) {</span></span>
<span class="tr"><span class="th" id="line2471">2471</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer-&gt;i = buffer2-&gt;(j+2);</span></span>
<span class="tr"><span class="th" id="line2472">2472</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(buffer-&gt;1)++;</span></span>
<span class="tr"><span class="th" id="line2473">2473</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (buffer-&gt;1 == INPUT_BUFFER_LEN) break;</span></span>
<span class="tr"><span class="th" id="line2474">2474</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2475">2475</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line2476">2476</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = WORDSIZE + buffer--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2477">2477</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;(buffer--&gt;0)++; buffer-&gt;(i++) = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2478">2478</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=0 : j&lt;buffer2--&gt;0 : i++,j++) {</span></span>
<span class="tr"><span class="th" id="line2479">2479</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer-&gt;i = buffer2-&gt;(j+WORDSIZE);</span></span>
<span class="tr"><span class="th" id="line2480">2480</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(buffer--&gt;0)++;</span></span>
<span class="tr"><span class="th" id="line2481">2481</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (buffer--&gt;0 == INPUT_BUFFER_LEN) break;</span></span>
<span class="tr"><span class="th" id="line2482">2482</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2483">2483</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line2484">2484</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2485">2485</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (3) we fill up the buffer with spaces, which is unnecessary, but may</span></span></span>
<span class="tr"><span class="th" id="line2486">2486</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     help incorrectly-written interpreters to cope.</span></span></span>
<span class="tr"><span class="th" id="line2487">2487</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2488">2488</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line2489">2489</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (: i&lt;INPUT_BUFFER_LEN : i++) buffer-&gt;i = <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line2490">2490</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_ZCODE</span></span></span>
<span class="tr"><span class="th" id="line2491">2491</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2492">2492</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line2343">RECONSTRUCT_INPUT</a>;</span></span>
<span class="tr"><span class="th" id="line2493">2493</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2494">2494</span><span class="td">]; <span class="comment">! end of NounDomain</span></span></span>
<span class="tr"><span class="th" id="line2495">2495</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2496">2496</span><span class="td">[ PARSER_CLARIF_INTERNAL_R; ];</span></span>
</div><div class='text'>
<h3 id="parser-adjudicate">Adjudicate.</h3><p><p> The <span class="fixed"><a href="./Parser.i6t.html#line2521">Adjudicate</a></span> routine tries to see if there is an obvious choice, when faced with a list of objects (the <span class="fixed">match_list</span>) each of which matches the player&#39;s specification equally well. To do this it makes use of the <span class="fixed">context</span> (the token type being worked on).<p></p><p> It counts up the number of obvious choices for the given context &ndash; all to do with where a candidate is, except for 6 (<span class="fixed">animate</span>) which is to do with whether it is animate or not &ndash; and then:<p></p><p> (a) if only one obvious choice is found, that is returned; (b) if we are in indefinite mode (don&#39;t care which) one of the obvious choices is returned, or if there is no obvious choice then an unobvious one is made; (c) at this stage, we work out whether the objects are distinguishable from each other or not: if they are all indistinguishable from each other, then choose one, it doesn&#39;t matter which; (d) otherwise, 0 (meaning, unable to decide) is returned (but remember that the equivalence classes we&#39;ve just worked out will be needed by other routines to clear up this mess, so we can&#39;t economise on working them out).<p></p><p> <span class="fixed"><a href="./Parser.i6t.html#line2521">Adjudicate</a></span> returns <em>-1</em> if an error occurred.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2521">2521</span><span class="td">[ Adjudicate context i j k good_ones last n ultimate flag offset;</span></span>
<span class="tr"><span class="th" id="line2522">2522</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2523">2523</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) {</span></span>
<span class="tr"><span class="th" id="line2524">2524</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   [Adjudicating match list of size &quot;</span>, number_matched,</span></span>
<span class="tr"><span class="th" id="line2525">2525</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dstring">&quot; in context &quot;</span>, context, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2526">2526</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2527">2527</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode) {</span></span>
<span class="tr"><span class="th" id="line2528">2528</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;indefinite type: &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2529">2529</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; OTHER_BIT)  print <span class="dstring">&quot;other &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2530">2530</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; MY_BIT)     print <span class="dstring">&quot;my &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2531">2531</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; THAT_BIT)   print <span class="dstring">&quot;that &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2532">2532</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; PLURAL_BIT) print <span class="dstring">&quot;plural &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2533">2533</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; LIT_BIT)    print <span class="dstring">&quot;lit &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2534">2534</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; UNLIT_BIT)  print <span class="dstring">&quot;unlit &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2535">2535</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_owner ~= 0) print <span class="dstring">&quot;owner:&quot;</span>, (name) indef_owner;</span></span>
<span class="tr"><span class="th" id="line2536">2536</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_line;</span></span>
<span class="tr"><span class="th" id="line2537">2537</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   number wanted: &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2538">2538</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_wanted == INDEF_ALL_WANTED) print <span class="dstring">&quot;all&quot;</span>; else print indef_wanted;</span></span>
<span class="tr"><span class="th" id="line2539">2539</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_line;</span></span>
<span class="tr"><span class="th" id="line2540">2540</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   most likely GNAs of names: &quot;</span>, indef_cases, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2541">2541</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2542">2542</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else print <span class="dstring">&quot;definite object^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2543">2543</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2544">2544</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2545">2545</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2546">2546</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;j = number_matched-1; good_ones = 0; last = match_list--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2547">2547</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;=j : i++) {</span></span>
<span class="tr"><span class="th" id="line2548">2548</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n = match_list--&gt;i;</span></span>
<span class="tr"><span class="th" id="line2549">2549</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_scores--&gt;i = good_ones;</span></span>
<span class="tr"><span class="th" id="line2550">2550</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ultimate = ScopeCeiling(n);</span></span>
<span class="tr"><span class="th" id="line2551">2551</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2552">2552</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context==HELD_TOKEN &amp;&amp; parent(n)==actor)</span></span>
<span class="tr"><span class="th" id="line2553">2553</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   good_ones++; last=n; }</span></span>
<span class="tr"><span class="th" id="line2554">2554</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context==MULTI_TOKEN &amp;&amp; ultimate==ScopeCeiling(actor)</span></span>
<span class="tr"><span class="th" id="line2555">2555</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; n~=actor &amp;&amp; n hasnt concealed &amp;&amp; n hasnt scenery) </span></span>
<span class="tr"><span class="th" id="line2556">2556</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   good_ones++; last=n; }</span></span>
<span class="tr"><span class="th" id="line2557">2557</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context==MULTIHELD_TOKEN &amp;&amp; parent(n)==actor)</span></span>
<span class="tr"><span class="th" id="line2558">2558</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   good_ones++; last=n; }</span></span>
<span class="tr"><span class="th" id="line2559">2559</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2560">2560</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context==MULTIEXCEPT_TOKEN or MULTIINSIDE_TOKEN)</span></span>
<span class="tr"><span class="th" id="line2561">2561</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   if (advance_warning==-1)</span></span>
<span class="tr"><span class="th" id="line2562">2562</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   if (context==MULTIEXCEPT_TOKEN)</span></span>
<span class="tr"><span class="th" id="line2563">2563</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   good_ones++; last=n;</span></span>
<span class="tr"><span class="th" id="line2564">2564</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2565">2565</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context==MULTIINSIDE_TOKEN)</span></span>
<span class="tr"><span class="th" id="line2566">2566</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   if (parent(n)~=actor) { good_ones++; last=n; }</span></span>
<span class="tr"><span class="th" id="line2567">2567</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2568">2568</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2569">2569</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line2570">2570</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   if (context==MULTIEXCEPT_TOKEN &amp;&amp; n~=advance_warning)</span></span>
<span class="tr"><span class="th" id="line2571">2571</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   good_ones++; last=n; }</span></span>
<span class="tr"><span class="th" id="line2572">2572</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context==MULTIINSIDE_TOKEN &amp;&amp; n in advance_warning)</span></span>
<span class="tr"><span class="th" id="line2573">2573</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   good_ones++; last=n; }</span></span>
<span class="tr"><span class="th" id="line2574">2574</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2575">2575</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2576">2576</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context==CREATURE_TOKEN &amp;&amp; CreatureTest(n)==1)</span></span>
<span class="tr"><span class="th" id="line2577">2577</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{   good_ones++; last=n; }</span></span>
<span class="tr"><span class="th" id="line2578">2578</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line2579">2579</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_scores--&gt;i = 1000*(good_ones - match_scores--&gt;i);</span></span>
<span class="tr"><span class="th" id="line2580">2580</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2581">2581</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (good_ones == 1) {</span></span>
<span class="tr"><span class="th" id="line2582">2582</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode == 1 &amp;&amp; indef_type &amp; PLURAL_BIT ~= 0 &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line2583">2583</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context == MULTI_TOKEN or MULTIHELD_TOKEN or</span></span>
<span class="tr"><span class="th" id="line2584">2584</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MULTIEXCEPT_TOKEN or MULTIINSIDE_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line2585">2585</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(DECIDING_WHETHER_ALL_INC_ACT, last);</span></span>
<span class="tr"><span class="th" id="line2586">2586</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((ForActivity(DECIDING_WHETHER_ALL_INC_ACT, last)) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line2587">2587</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(RulebookFailed())) good_ones = 0;</span></span>
<span class="tr"><span class="th" id="line2588">2588</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndActivity(DECIDING_WHETHER_ALL_INC_ACT, last);</span></span>
<span class="tr"><span class="th" id="line2589">2589</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (good_ones == 1) return last;</span></span>
<span class="tr"><span class="th" id="line2590">2590</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line2591">2591</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return last;</span></span>
<span class="tr"><span class="th" id="line2592">2592</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2593">2593</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2594">2594</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2595">2595</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! If there is ambiguity about what was typed, but it definitely wasn&#39;t</span></span></span>
<span class="tr"><span class="th" id="line2596">2596</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! animate as required, then return anything; higher up in the parser</span></span></span>
<span class="tr"><span class="th" id="line2597">2597</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! a suitable error will be given.  (This prevents a question being asked.)</span></span></span>
<span class="tr"><span class="th" id="line2598">2598</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2599">2599</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (context == CREATURE_TOKEN &amp;&amp; good_ones == 0) return match_list--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2600">2600</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2601">2601</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode == 0) indef_type=0;</span></span>
<span class="tr"><span class="th" id="line2602">2602</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2603">2603</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;ScoreMatchL(context);</span></span>
<span class="tr"><span class="th" id="line2604">2604</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (number_matched == 0) return -1;</span></span>
<span class="tr"><span class="th" id="line2605">2605</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2606">2606</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode == 0) {</span></span>
<span class="tr"><span class="th" id="line2607">2607</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  Is there now a single highest-scoring object?</span></span></span>
<span class="tr"><span class="th" id="line2608">2608</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = SingleBestGuess();</span></span>
<span class="tr"><span class="th" id="line2609">2609</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i &gt;= 0) {</span></span>
<span class="tr"><span class="th" id="line2610">2610</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2611">2611</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2612">2612</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   Single best-scoring object returned.]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2613">2613</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2614">2614</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return i;</span></span>
<span class="tr"><span class="th" id="line2615">2615</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2616">2616</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2617">2617</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2618">2618</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode == 1 &amp;&amp; indef_type &amp; PLURAL_BIT ~= 0) {</span></span>
<span class="tr"><span class="th" id="line2619">2619</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context ~= MULTI_TOKEN or MULTIHELD_TOKEN or MULTIEXCEPT_TOKEN</span></span>
<span class="tr"><span class="th" id="line2620">2620</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or MULTIINSIDE_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line2621">2621</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = MULTI_PE;</span></span>
<span class="tr"><span class="th" id="line2622">2622</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -1;</span></span>
<span class="tr"><span class="th" id="line2623">2623</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2624">2624</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = 0; offset = multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2625">2625</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=BestGuess(): j~=-1 &amp;&amp; i&lt;indef_wanted &amp;&amp; i+offset&lt;MATCH_LIST_WORDS-1:</span></span>
<span class="tr"><span class="th" id="line2626">2626</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j=BestGuess()) {</span></span>
<span class="tr"><span class="th" id="line2627">2627</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 0;</span></span>
<span class="tr"><span class="th" id="line2628">2628</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(DECIDING_WHETHER_ALL_INC_ACT, j);</span></span>
<span class="tr"><span class="th" id="line2629">2629</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((ForActivity(DECIDING_WHETHER_ALL_INC_ACT, j)) == 0) {</span></span>
<span class="tr"><span class="th" id="line2630">2630</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (j hasnt concealed &amp;&amp; j hasnt worn) flag = 1;</span></span>
<span class="tr"><span class="th" id="line2631">2631</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (context == MULTIHELD_TOKEN or MULTIEXCEPT_TOKEN &amp;&amp; parent(j) ~= actor)</span></span>
<span class="tr"><span class="th" id="line2632">2632</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 0;</span></span>
<span class="tr"><span class="th" id="line2633">2633</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2634">2634</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (action_to_be == ##Take or ##Remove &amp;&amp; parent(j) == actor)</span></span>
<span class="tr"><span class="th" id="line2635">2635</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 0;</span></span>
<span class="tr"><span class="th" id="line2636">2636</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2637">2637</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = ChooseObjects(j, flag);</span></span>
<span class="tr"><span class="th" id="line2638">2638</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2639">2639</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (k == 1)</span></span>
<span class="tr"><span class="th" id="line2640">2640</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 1;</span></span>
<span class="tr"><span class="th" id="line2641">2641</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line2642">2642</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (k == 2) flag = 0;</span></span>
<span class="tr"><span class="th" id="line2643">2643</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2644">2644</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line2645">2645</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 0; if (RulebookSucceeded()) flag = 1;</span></span>
<span class="tr"><span class="th" id="line2646">2646</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2647">2647</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndActivity(DECIDING_WHETHER_ALL_INC_ACT, j);</span></span>
<span class="tr"><span class="th" id="line2648">2648</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (flag == 1) {</span></span>
<span class="tr"><span class="th" id="line2649">2649</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i++; multiple_object--&gt;(i+offset) = j;</span></span>
<span class="tr"><span class="th" id="line2650">2650</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2651">2651</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   Accepting it^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2652">2652</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2653">2653</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2654">2654</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line2655">2655</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = i;</span></span>
<span class="tr"><span class="th" id="line2656">2656</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2657">2657</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   Rejecting it^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2658">2658</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2659">2659</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2660">2660</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2661">2661</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i &lt; indef_wanted &amp;&amp; indef_wanted &lt; INDEF_ALL_WANTED) {</span></span>
<span class="tr"><span class="th" id="line2662">2662</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etype = TOOFEW_PE; multi_wanted = indef_wanted;</span></span>
<span class="tr"><span class="th" id="line2663">2663</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;Too few found^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2664">2664</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multi_had=i;</span></span>
<span class="tr"><span class="th" id="line2665">2665</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -1;</span></span>
<span class="tr"><span class="th" id="line2666">2666</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2667">2667</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = i+offset;</span></span>
<span class="tr"><span class="th" id="line2668">2668</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multi_context = context;</span></span>
<span class="tr"><span class="th" id="line2669">2669</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2670">2670</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4)</span></span>
<span class="tr"><span class="th" id="line2671">2671</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   Made multiple object of size &quot;</span>, i, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2672">2672</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2673">2673</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</span></span>
<span class="tr"><span class="th" id="line2674">2674</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2675">2675</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2676">2676</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++) match_classes--&gt;i = 0;</span></span>
<span class="tr"><span class="th" id="line2677">2677</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2678">2678</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;n = 1;</span></span>
<span class="tr"><span class="th" id="line2679">2679</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++)</span></span>
<span class="tr"><span class="th" id="line2680">2680</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_classes--&gt;i == 0) {</span></span>
<span class="tr"><span class="th" id="line2681">2681</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_classes--&gt;i = n++; flag = 0;</span></span>
<span class="tr"><span class="th" id="line2682">2682</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=i+1 : j&lt;number_matched : j++)</span></span>
<span class="tr"><span class="th" id="line2683">2683</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_classes--&gt;j == 0 &amp;&amp; Identical(match_list--&gt;i, match_list--&gt;j) == 1) {</span></span>
<span class="tr"><span class="th" id="line2684">2684</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag=1;</span></span>
<span class="tr"><span class="th" id="line2685">2685</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_classes--&gt;j = match_classes--&gt;i;</span></span>
<span class="tr"><span class="th" id="line2686">2686</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2687">2687</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (flag == 1) match_classes--&gt;i = 1-n;</span></span>
<span class="tr"><span class="th" id="line2688">2688</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2689">2689</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n--; number_of_classes = n;</span></span>
<span class="tr"><span class="th" id="line2690">2690</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2691">2691</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2692">2692</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) {</span></span>
<span class="tr"><span class="th" id="line2693">2693</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   Grouped into &quot;</span>, n, <span class="dstring">&quot; possibilities by name:^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2694">2694</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++)</span></span>
<span class="tr"><span class="th" id="line2695">2695</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_classes--&gt;i &gt; 0)</span></span>
<span class="tr"><span class="th" id="line2696">2696</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   &quot;</span>, (The) match_list--&gt;i, <span class="dstring">&quot; (&quot;</span>, match_list--&gt;i, <span class="dstring">&quot;)  ---  group &quot;</span>,</span></span>
<span class="tr"><span class="th" id="line2697">2697</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_classes--&gt;i, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2698">2698</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2699">2699</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2700">2700</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2701">2701</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode == 0) {</span></span>
<span class="tr"><span class="th" id="line2702">2702</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (n &gt; 1) {</span></span>
<span class="tr"><span class="th" id="line2703">2703</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = -1;</span></span>
<span class="tr"><span class="th" id="line2704">2704</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++) {</span></span>
<span class="tr"><span class="th" id="line2705">2705</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_scores--&gt;i &gt; k) {</span></span>
<span class="tr"><span class="th" id="line2706">2706</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = match_scores--&gt;i;</span></span>
<span class="tr"><span class="th" id="line2707">2707</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = match_classes--&gt;i; j = j*j;</span></span>
<span class="tr"><span class="th" id="line2708">2708</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 0;</span></span>
<span class="tr"><span class="th" id="line2709">2709</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2710">2710</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line2711">2711</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_scores--&gt;i == k) {</span></span>
<span class="tr"><span class="th" id="line2712">2712</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((match_classes--&gt;i) * (match_classes--&gt;i) ~= j)</span></span>
<span class="tr"><span class="th" id="line2713">2713</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 1;</span></span>
<span class="tr"><span class="th" id="line2714">2714</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2715">2715</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2716">2716</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2717">2717</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (flag) {</span></span>
<span class="tr"><span class="th" id="line2718">2718</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2719">2719</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   Unable to choose best group, so ask player.]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2720">2720</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2721">2721</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></span>
<span class="tr"><span class="th" id="line2722">2722</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2723">2723</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2724">2724</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   Best choices are all from the same group.^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2725">2725</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2726">2726</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2727">2727</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2728">2728</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2729">2729</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  When the player is really vague, or there&#39;s a single collection of</span></span></span>
<span class="tr"><span class="th" id="line2730">2730</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  indistinguishable objects to choose from, choose the one the player</span></span></span>
<span class="tr"><span class="th" id="line2731">2731</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  most recently acquired, or if the player has none of them, then</span></span></span>
<span class="tr"><span class="th" id="line2732">2732</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  the one most recently put where it is.</span></span></span>
<span class="tr"><span class="th" id="line2733">2733</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2734">2734</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (n == 1) dont_infer = true;</span></span>
<span class="tr"><span class="th" id="line2735">2735</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return BestGuess();</span></span>
<span class="tr"><span class="th" id="line2736">2736</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2737">2737</span><span class="td">]; <span class="comment">! Adjudicate</span></span></span>
</div><div class='text'>
<h3 id="parser-revisemulti">ReviseMulti.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line2746">ReviseMulti</a></span> revises the multiple object which already exists, in the light of information which has come along since then (i.e., the second parameter). It returns a parser error number, or else 0 if all is well. This only ever throws things out, never adds new ones.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2746">2746</span><span class="td">[ ReviseMulti second_p  i low;</span></span>
<span class="tr"><span class="th" id="line2747">2747</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2748">2748</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4)</span></span>
<span class="tr"><span class="th" id="line2749">2749</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   Revising multiple object list of size &quot;</span>, multiple_object--&gt;0,</span></span>
<span class="tr"><span class="th" id="line2750">2750</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dstring">&quot; with 2nd &quot;</span>, (name) second_p, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2751">2751</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2752">2752</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2753">2753</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (multi_context == MULTIEXCEPT_TOKEN or MULTIINSIDE_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line2754">2754</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=1,low=0 : i&lt;=multiple_object--&gt;0 : i++) {</span></span>
<span class="tr"><span class="th" id="line2755">2755</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( (multi_context==MULTIEXCEPT_TOKEN &amp;&amp; multiple_object--&gt;i ~= second_p) ||</span></span>
<span class="tr"><span class="th" id="line2756">2756</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(multi_context==MULTIINSIDE_TOKEN &amp;&amp; multiple_object--&gt;i in second_p)) {</span></span>
<span class="tr"><span class="th" id="line2757">2757</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low++;</span></span>
<span class="tr"><span class="th" id="line2758">2758</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;low = multiple_object--&gt;i;</span></span>
<span class="tr"><span class="th" id="line2759">2759</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2760">2760</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2761">2761</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = low;</span></span>
<span class="tr"><span class="th" id="line2762">2762</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2763">2763</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2764">2764</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (multi_context == MULTI_TOKEN &amp;&amp; action_to_be == ##Take) {</span></span>
<span class="tr"><span class="th" id="line2765">2765</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2766">2766</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   Token 2 plural case: number with actor &quot;</span>, low, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2767">2767</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2768">2768</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (take_all_rule == 2) {</span></span>
<span class="tr"><span class="th" id="line2769">2769</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=1,low=0 : i&lt;=multiple_object--&gt;0 : i++) {</span></span>
<span class="tr"><span class="th" id="line2770">2770</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ScopeCeiling(multiple_object--&gt;i) == ScopeCeiling(actor)) {</span></span>
<span class="tr"><span class="th" id="line2771">2771</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;low++;</span></span>
<span class="tr"><span class="th" id="line2772">2772</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;low = multiple_object--&gt;i;</span></span>
<span class="tr"><span class="th" id="line2773">2773</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2774">2774</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2775">2775</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = low;</span></span>
<span class="tr"><span class="th" id="line2776">2776</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2777">2777</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2778">2778</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2779">2779</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line2780">2780</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2781">2781</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   Done: new size &quot;</span>, i, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2782">2782</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2783">2783</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (i == 0) return NOTHING_PE;</span></span>
<span class="tr"><span class="th" id="line2784">2784</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></span>
<span class="tr"><span class="th" id="line2785">2785</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-match-list">Match List.</h3><p><p> The match list is an array, <span class="fixed">match_list--&gt;</span>, which holds the current best guesses at what object(s) a portion of the command refers to. The global <span class="fixed"><a href="./Parser.i6t.html#line120">number_matched</a></span> is set to the current length of the <span class="fixed">match_list</span>.<p></p><p> When the parser sees a possible match of object <span class="fixed">obj</span> at quality level <span class="fixed">q</span>, it calls <span class="fixed"><a href="./Parser.i6t.html#line2810">MakeMatch(obj, q)</a></span>. If this is the best quality match so far, then we wipe out all the previous matches and start a new list with this one. If it&#39;s only as good as the best so far, we add it to the list (provided we haven&#39;t run out of space, and provided it isn&#39;t in the list already). If it&#39;s worse, we ignore it altogether.<p></p><p> I6 tokens in the form <span class="fixed">noun=Filter</span> or <span class="fixed">Attribute</span> are &quot;noun filter tokens&quot;, and mean that the match list should be filtered to accept only nouns which are acceptable to the given routine, or have the given attribute. Such a token is in force if <span class="fixed"><a href="./Parser.i6t.html#line72">token_filter</a></span> is used. (I7 makes no use of this in the attribute case, which is deprecated nowadays.)<p></p><p> Quality is essentially the number of words in the command referring to the object: the idea is that &quot;red panic button&quot; is better than &quot;red button&quot; or &quot;panic&quot;.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2810">2810</span><span class="td">[ MakeMatch obj quality i;</span></span>
<span class="tr"><span class="th" id="line2811">2811</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2812">2812</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 6) print <span class="dstring">&quot;    Match with quality &quot;</span>,quality,<span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2813">2813</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2814">2814</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (token_filter ~= 0 &amp;&amp; ConsultNounFilterToken(obj) == 0) {</span></span>
<span class="tr"><span class="th" id="line2815">2815</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2816">2816</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 6) print <span class="dstring">&quot;    Match filtered out: token filter &quot;</span>, token_filter, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2817">2817</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2818">2818</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line2819">2819</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2820">2820</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (quality &lt; match_length) rtrue;</span></span>
<span class="tr"><span class="th" id="line2821">2821</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (quality &gt; match_length) { match_length = quality; number_matched = 0; }</span></span>
<span class="tr"><span class="th" id="line2822">2822</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line2823">2823</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (number_matched &gt;= MATCH_LIST_WORDS) rtrue;</span></span>
<span class="tr"><span class="th" id="line2824">2824</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++)</span></span>
<span class="tr"><span class="th" id="line2825">2825</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_list--&gt;i == obj) rtrue;</span></span>
<span class="tr"><span class="th" id="line2826">2826</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2827">2827</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;match_list--&gt;number_matched++ = obj;</span></span>
<span class="tr"><span class="th" id="line2828">2828</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2829">2829</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 6) print <span class="dstring">&quot;    Match added to list^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2830">2830</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2831">2831</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line2832">2832</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2833">2833</span><span class="td">[ ConsultNounFilterToken obj sn rv;</span></span>
<span class="tr"><span class="th" id="line2834">2834</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (token_filter ofclass Routine) {</span></span>
<span class="tr"><span class="th" id="line2835">2835</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sn = noun;</span></span>
<span class="tr"><span class="th" id="line2836">2836</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noun = obj;</span></span>
<span class="tr"><span class="th" id="line2837">2837</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv = indirect(token_filter);</span></span>
<span class="tr"><span class="th" id="line2838">2838</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noun = sn;</span></span>
<span class="tr"><span class="th" id="line2839">2839</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return rv;</span></span>
<span class="tr"><span class="th" id="line2840">2840</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2841">2841</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj has (token_filter-1)) rtrue;</span></span>
<span class="tr"><span class="th" id="line2842">2842</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line2843">2843</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-scorematchl">ScoreMatchL.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line2865">ScoreMatchL</a></span> scores the match list for quality in terms of what the player has vaguely asked for. Points are awarded for conforming with requirements like &quot;my&quot;, and so on. Remove from the match list any entries which fail the basic requirements of the descriptors. (The scoring system used to evaluate the possibilities is discussed in detail in the DM4.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2853">2853</span><span class="td">Constant SCORE__CHOOSEOBJ = 1000;</span></span>
<span class="tr"><span class="th" id="line2854">2854</span><span class="td">Constant SCORE__IFGOOD = 500;</span></span>
<span class="tr"><span class="th" id="line2855">2855</span><span class="td">Constant SCORE__UNCONCEALED = 100;</span></span>
<span class="tr"><span class="th" id="line2856">2856</span><span class="td">Constant SCORE__BESTLOC = 60;</span></span>
<span class="tr"><span class="th" id="line2857">2857</span><span class="td">Constant SCORE__NEXTBESTLOC = 40;</span></span>
<span class="tr"><span class="th" id="line2858">2858</span><span class="td">Constant SCORE__NOTCOMPASS = 20;</span></span>
<span class="tr"><span class="th" id="line2859">2859</span><span class="td">Constant SCORE__NOTSCENERY = 10;</span></span>
<span class="tr"><span class="th" id="line2860">2860</span><span class="td">Constant SCORE__NOTACTOR = 5;</span></span>
<span class="tr"><span class="th" id="line2861">2861</span><span class="td">Constant SCORE__GNA = 1;</span></span>
<span class="tr"><span class="th" id="line2862">2862</span><span class="td">Constant SCORE__DIVISOR = 20;</span></span>
<span class="tr"><span class="th" id="line2863">2863</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2864">2864</span><span class="td">Constant PREFER_HELD;</span></span>
<span class="tr"><span class="th" id="line2865">2865</span><span class="td">[ ScoreMatchL context its_owner its_score obj i j threshold met a_s l_s;</span></span>
<span class="tr"><span class="th" id="line2866">2866</span><span class="td"><span class="comment">!   if (indef_type &amp; OTHER_BIT ~= 0) threshold++;</span></span></span>
<span class="tr"><span class="th" id="line2867">2867</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; MY_BIT ~= 0)    threshold++;</span></span>
<span class="tr"><span class="th" id="line2868">2868</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; THAT_BIT ~= 0)  threshold++;</span></span>
<span class="tr"><span class="th" id="line2869">2869</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; LIT_BIT ~= 0)   threshold++;</span></span>
<span class="tr"><span class="th" id="line2870">2870</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; UNLIT_BIT ~= 0) threshold++;</span></span>
<span class="tr"><span class="th" id="line2871">2871</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (indef_owner ~= nothing)      threshold++;</span></span>
<span class="tr"><span class="th" id="line2872">2872</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2873">2873</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2874">2874</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;   Scoring match list: indef mode &quot;</span>, indef_mode, <span class="dstring">&quot; type &quot;</span>,</span></span>
<span class="tr"><span class="th" id="line2875">2875</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_type, <span class="dstring">&quot;, satisfying &quot;</span>, threshold, <span class="dstring">&quot; requirements:^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2876">2876</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2877">2877</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2878">2878</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#ifdef PREFER_HELD;</span></span>
<span class="tr"><span class="th" id="line2879">2879</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;a_s = SCORE__BESTLOC; l_s = SCORE__NEXTBESTLOC;</span></span>
<span class="tr"><span class="th" id="line2880">2880</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (action_to_be == ##Take or ##Remove) {</span></span>
<span class="tr"><span class="th" id="line2881">2881</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a_s = SCORE__NEXTBESTLOC; l_s = SCORE__BESTLOC;</span></span>
<span class="tr"><span class="th" id="line2882">2882</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2883">2883</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;context = context;  <span class="comment">! silence warning</span></span></span>
<span class="tr"><span class="th" id="line2884">2884</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#ifnot;</span></span>
<span class="tr"><span class="th" id="line2885">2885</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;a_s = SCORE__NEXTBESTLOC; l_s = SCORE__BESTLOC;</span></span>
<span class="tr"><span class="th" id="line2886">2886</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (context == HELD_TOKEN or MULTIHELD_TOKEN or MULTIEXCEPT_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line2887">2887</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a_s = SCORE__BESTLOC; l_s = SCORE__NEXTBESTLOC;</span></span>
<span class="tr"><span class="th" id="line2888">2888</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2889">2889</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#endif; <span class="comment">! PREFER_HELD</span></span></span>
<span class="tr"><span class="th" id="line2890">2890</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2891">2891</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++) {</span></span>
<span class="tr"><span class="th" id="line2892">2892</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj = match_list--&gt;i; its_owner = parent(obj); its_score=0; met=0;</span></span>
<span class="tr"><span class="th" id="line2893">2893</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2894">2894</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!      if (indef_type &amp; OTHER_BIT ~= 0</span></span></span>
<span class="tr"><span class="th" id="line2895">2895</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!          &amp;&amp;  obj ~= itobj or himobj or herobj) met++;</span></span></span>
<span class="tr"><span class="th" id="line2896">2896</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; MY_BIT ~= 0 &amp;&amp; its_owner == actor) met++;</span></span>
<span class="tr"><span class="th" id="line2897">2897</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; THAT_BIT ~= 0 &amp;&amp; its_owner == actors_location) met++;</span></span>
<span class="tr"><span class="th" id="line2898">2898</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; LIT_BIT ~= 0 &amp;&amp; obj has light) met++;</span></span>
<span class="tr"><span class="th" id="line2899">2899</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_type &amp; UNLIT_BIT ~= 0 &amp;&amp; obj hasnt light) met++;</span></span>
<span class="tr"><span class="th" id="line2900">2900</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_owner ~= 0 &amp;&amp; its_owner == indef_owner) met++;</span></span>
<span class="tr"><span class="th" id="line2901">2901</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2902">2902</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (met &lt; threshold) {</span></span>
<span class="tr"><span class="th" id="line2903">2903</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2904">2904</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4)</span></span>
<span class="tr"><span class="th" id="line2905">2905</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;   &quot;</span>, (The) match_list--&gt;i, <span class="dstring">&quot; (&quot;</span>, match_list--&gt;i, <span class="dstring">&quot;) in &quot;</span>,</span></span>
<span class="tr"><span class="th" id="line2906">2906</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(the) its_owner, <span class="dstring">&quot; is rejected (doesnt match descriptors)^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2907">2907</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2908">2908</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_list--&gt;i = -1;</span></span>
<span class="tr"><span class="th" id="line2909">2909</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2910">2910</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line2911">2911</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;its_score = 0;</span></span>
<span class="tr"><span class="th" id="line2912">2912</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (obj hasnt concealed) its_score = SCORE__UNCONCEALED;</span></span>
<span class="tr"><span class="th" id="line2913">2913</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2914">2914</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (its_owner == actor) its_score = its_score + a_s;</span></span>
<span class="tr"><span class="th" id="line2915">2915</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line2916">2916</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (its_owner == actors_location) its_score = its_score + l_s;</span></span>
<span class="tr"><span class="th" id="line2917">2917</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line2918">2918</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (its_owner ~= compass) its_score = its_score + SCORE__NOTCOMPASS;</span></span>
<span class="tr"><span class="th" id="line2919">2919</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2920">2920</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;its_score = its_score + SCORE__CHOOSEOBJ * ChooseObjects(obj, 2);</span></span>
<span class="tr"><span class="th" id="line2921">2921</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2922">2922</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (obj hasnt scenery) its_score = its_score + SCORE__NOTSCENERY;</span></span>
<span class="tr"><span class="th" id="line2923">2923</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (obj ~= actor) its_score = its_score + SCORE__NOTACTOR;</span></span>
<span class="tr"><span class="th" id="line2924">2924</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2925">2925</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!   A small bonus for having the correct GNA,</span></span></span>
<span class="tr"><span class="th" id="line2926">2926</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!   for sorting out ambiguous articles and the like.</span></span></span>
<span class="tr"><span class="th" id="line2927">2927</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2928">2928</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_cases &amp; (PowersOfTwo_TB--&gt;(GetGNAOfObject(obj))))</span></span>
<span class="tr"><span class="th" id="line2929">2929</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;its_score = its_score + SCORE__GNA;</span></span>
<span class="tr"><span class="th" id="line2930">2930</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2931">2931</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_scores--&gt;i = match_scores--&gt;i + its_score;</span></span>
<span class="tr"><span class="th" id="line2932">2932</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2933">2933</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4) print <span class="dstring">&quot;     &quot;</span>, (The) match_list--&gt;i, <span class="dstring">&quot; (&quot;</span>, match_list--&gt;i,</span></span>
<span class="tr"><span class="th" id="line2934">2934</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dstring">&quot;) in &quot;</span>, (the) its_owner, <span class="dstring">&quot; : &quot;</span>, match_scores--&gt;i, <span class="dstring">&quot; points^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2935">2935</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2936">2936</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2937">2937</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2938">2938</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line2939">2939</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++) {</span></span>
<span class="tr"><span class="th" id="line2940">2940</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (match_list--&gt;i == -1) {</span></span>
<span class="tr"><span class="th" id="line2941">2941</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == number_matched-1) { number_matched--; break; }</span></span>
<span class="tr"><span class="th" id="line2942">2942</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=i : j&lt;number_matched-1 : j++) {</span></span>
<span class="tr"><span class="th" id="line2943">2943</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_list--&gt;j = match_list--&gt;(j+1);</span></span>
<span class="tr"><span class="th" id="line2944">2944</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_scores--&gt;j = match_scores--&gt;(j+1);</span></span>
<span class="tr"><span class="th" id="line2945">2945</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2946">2946</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;number_matched--;</span></span>
<span class="tr"><span class="th" id="line2947">2947</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2948">2948</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2949">2949</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-bestguess">BestGuess.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line2958">BestGuess</a></span> makes the best guess it can out of the match list, assuming that everything in the match list is textually as good as everything else; however it ignores items marked as <em>-1</em>, and so marks anything it chooses. It returns <em>-1</em> if there are no possible choices.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2958">2958</span><span class="td">[ BestGuess  earliest its_score best i;</span></span>
<span class="tr"><span class="th" id="line2959">2959</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;earliest = 0; best = -1;</span></span>
<span class="tr"><span class="th" id="line2960">2960</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++) {</span></span>
<span class="tr"><span class="th" id="line2961">2961</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (match_list--&gt;i &gt;= 0) {</span></span>
<span class="tr"><span class="th" id="line2962">2962</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;its_score = match_scores--&gt;i;</span></span>
<span class="tr"><span class="th" id="line2963">2963</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (its_score &gt; best) { best = its_score; earliest = i; }</span></span>
<span class="tr"><span class="th" id="line2964">2964</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2965">2965</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2966">2966</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line2967">2967</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 4)</span></span>
<span class="tr"><span class="th" id="line2968">2968</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (best &lt; 0) print <span class="dstring">&quot;   Best guess ran out of choices^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2969">2969</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else print <span class="dstring">&quot;   Best guess &quot;</span>, (the) match_list--&gt;earliest,</span></span>
<span class="tr"><span class="th" id="line2970">2970</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dstring">&quot; (&quot;</span>, match_list--&gt;earliest, <span class="dstring">&quot;)^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line2971">2971</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line2972">2972</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (best &lt; 0) return -1;</span></span>
<span class="tr"><span class="th" id="line2973">2973</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = match_list--&gt;earliest;</span></span>
<span class="tr"><span class="th" id="line2974">2974</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;match_list--&gt;earliest = -1;</span></span>
<span class="tr"><span class="th" id="line2975">2975</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return i;</span></span>
<span class="tr"><span class="th" id="line2976">2976</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-singlebestguess">SingleBestGuess.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line2983">SingleBestGuess</a></span> returns the highest-scoring object in the match list if it is the clear winner, or returns <em>-1</em> if there is no clear winner.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line2983">2983</span><span class="td">[ SingleBestGuess  earliest its_score best i;</span></span>
<span class="tr"><span class="th" id="line2984">2984</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;earliest = -1; best = -1000;</span></span>
<span class="tr"><span class="th" id="line2985">2985</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;number_matched : i++) {</span></span>
<span class="tr"><span class="th" id="line2986">2986</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;its_score = match_scores--&gt;i;</span></span>
<span class="tr"><span class="th" id="line2987">2987</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (its_score == best) earliest = -1;</span></span>
<span class="tr"><span class="th" id="line2988">2988</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (its_score &gt; best) { best = its_score; earliest = match_list--&gt;i; }</span></span>
<span class="tr"><span class="th" id="line2989">2989</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line2990">2990</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return earliest;</span></span>
<span class="tr"><span class="th" id="line2991">2991</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-identical">Identical.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line3002">Identical</a></span> decides whether or not two objects can be distinguished from each other by anything the player can type. If not, it returns <span class="fixed">true</span>. (This routine is critical to the handling of plurals, and the list-writer requires it to be an equivalence relation between objects: but it is, because it is equivalent to <em>O<sub>1</sub> ~ O<sub>2</sub></em> if and only if <em>f(O<sub>1</sub>) = f(O<sub>2</sub>)</em> for some function <em>f</em>.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3002">3002</span><span class="td">[ Identical o1 o2 p1 p2 n1 n2 i j flag;</span></span>
<span class="tr"><span class="th" id="line3003">3003</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (o1 == o2) rtrue;  <span class="comment">! This should never happen, but to be on the safe side</span></span></span>
<span class="tr"><span class="th" id="line3004">3004</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (o1 == 0 || o2 == 0) rfalse;  <span class="comment">! Similarly</span></span></span>
<span class="tr"><span class="th" id="line3005">3005</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (o1 ofclass K3_direction || o2 ofclass K3_direction) rfalse; <span class="comment">! Saves time</span></span></span>
<span class="tr"><span class="th" id="line3006">3006</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3007">3007</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  What complicates things is that o1 or o2 might have a parsing routine,</span></span></span>
<span class="tr"><span class="th" id="line3008">3008</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  so the parser can&#39;t know from here whether they are or aren&#39;t the same.</span></span></span>
<span class="tr"><span class="th" id="line3009">3009</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  If they have different parsing routines, we simply assume they&#39;re</span></span></span>
<span class="tr"><span class="th" id="line3010">3010</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  different.  If they have the same routine (which they probably got from</span></span></span>
<span class="tr"><span class="th" id="line3011">3011</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  a class definition) then the decision process is as follows:</span></span></span>
<span class="tr"><span class="th" id="line3012">3012</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!</span></span></span>
<span class="tr"><span class="th" id="line3013">3013</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!     the routine is called (with self being o1, not that it matters)</span></span></span>
<span class="tr"><span class="th" id="line3014">3014</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!       with noun and second being set to o1 and o2, and action being set</span></span></span>
<span class="tr"><span class="th" id="line3015">3015</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!       to the fake action TheSame.  If it returns -1, they are found</span></span></span>
<span class="tr"><span class="th" id="line3016">3016</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!       identical; if -2, different; and if &gt;=0, then the usual method</span></span></span>
<span class="tr"><span class="th" id="line3017">3017</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!       is used instead.</span></span></span>
<span class="tr"><span class="th" id="line3018">3018</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3019">3019</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (o1.parse_name ~= 0 || o2.parse_name ~= 0) {</span></span>
<span class="tr"><span class="th" id="line3020">3020</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o1.parse_name ~= o2.parse_name) rfalse;</span></span>
<span class="tr"><span class="th" id="line3021">3021</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_action = ##TheSame; parser_one = o1; parser_two = o2;</span></span>
<span class="tr"><span class="th" id="line3022">3022</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = wn; i = RunRoutines(o1,parse_name); wn = j;</span></span>
<span class="tr"><span class="th" id="line3023">3023</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == -1) rtrue;</span></span>
<span class="tr"><span class="th" id="line3024">3024</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == -2) rfalse;</span></span>
<span class="tr"><span class="th" id="line3025">3025</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3026">3026</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3027">3027</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  This is the default algorithm: do they have the same words in their</span></span></span>
<span class="tr"><span class="th" id="line3028">3028</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  &quot;name&quot; (i.e. property no. 1) properties.  (Note that the following allows</span></span></span>
<span class="tr"><span class="th" id="line3029">3029</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  for repeated words and words in different orders.)</span></span></span>
<span class="tr"><span class="th" id="line3030">3030</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3031">3031</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;p1 = o1.&amp;1; n1 = (o1.#1)/WORDSIZE;</span></span>
<span class="tr"><span class="th" id="line3032">3032</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;p2 = o2.&amp;1; n2 = (o2.#1)/WORDSIZE;</span></span>
<span class="tr"><span class="th" id="line3033">3033</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3034">3034</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  for (i=0 : i&lt;n1 : i++) { print (address) p1--&gt;i, &quot; &quot;; } new_line;</span></span></span>
<span class="tr"><span class="th" id="line3035">3035</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  for (i=0 : i&lt;n2 : i++) { print (address) p2--&gt;i, &quot; &quot;; } new_line;</span></span></span>
<span class="tr"><span class="th" id="line3036">3036</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3037">3037</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;n1 : i++) {</span></span>
<span class="tr"><span class="th" id="line3038">3038</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 0;</span></span>
<span class="tr"><span class="th" id="line3039">3039</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (j=0 : j&lt;n2 : j++)</span></span>
<span class="tr"><span class="th" id="line3040">3040</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (p1--&gt;i == p2--&gt;j) flag = 1;</span></span>
<span class="tr"><span class="th" id="line3041">3041</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (flag == 0) rfalse;</span></span>
<span class="tr"><span class="th" id="line3042">3042</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3043">3043</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3044">3044</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=0 : j&lt;n2 : j++) {</span></span>
<span class="tr"><span class="th" id="line3045">3045</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flag = 0;</span></span>
<span class="tr"><span class="th" id="line3046">3046</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : i&lt;n1 : i++)</span></span>
<span class="tr"><span class="th" id="line3047">3047</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (p1--&gt;i == p2--&gt;j) flag = 1;</span></span>
<span class="tr"><span class="th" id="line3048">3048</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (flag == 0) rfalse;</span></span>
<span class="tr"><span class="th" id="line3049">3049</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3050">3050</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3051">3051</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">!  print &quot;Which are identical!^&quot;;</span></span></span>
<span class="tr"><span class="th" id="line3052">3052</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line3053">3053</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-print-command">Print Command.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line3091">PrintCommand</a></span> reconstructs the command as it presently reads, from the pattern which has been built up.<p></p><p> If <span class="fixed">from</span> is 0, it starts with the verb: then it goes through the pattern.<p></p><p> The other parameter is <span class="fixed">emptyf</span> &ndash; a flag: if 0, it goes up to <span class="fixed"><a href="./Parser.i6t.html#line35">pcount</a></span>: if 1, it goes up to <span class="fixed"><a href="./Parser.i6t.html#line35">pcount</a></span>-1.<p></p><p> Note that verbs and prepositions are printed out of the dictionary: and that since the dictionary may only preserve the first six characters of a word (in a V3 game), we have to hand-code the longer words needed. At present, I7 doesn&#39;t do this, but it probably should.<p></p><p> (Recall that pattern entries are 0 for &quot;multiple object&quot;, 1 for &quot;special word&quot;, 2 to <span class="fixed">REPARSE_CODE-1</span> are object numbers and <span class="fixed">REPARSE_CODE+n</span> means the preposition <span class="fixed">n</span>.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3074">3074</span><span class="td">[ PrintInferredCommand from singleton_noun;</span></span>
<span class="tr"><span class="th" id="line3075">3075</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;singleton_noun = FALSE;</span></span>
<span class="tr"><span class="th" id="line3076">3076</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((from ~= 0) &amp;&amp; (from == pcount-1) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line3077">3077</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pattern--&gt;from &gt; 1) &amp;&amp; (pattern--&gt;from &lt; REPARSE_CODE))</span></span>
<span class="tr"><span class="th" id="line3078">3078</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;singleton_noun = TRUE;</span></span>
<span class="tr"><span class="th" id="line3079">3079</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3080">3080</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (singleton_noun) {</span></span>
<span class="tr"><span class="th" id="line3081">3081</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(CLARIFYING_PARSERS_CHOICE_ACT, pattern--&gt;from);</span></span>
<span class="tr"><span class="th" id="line3082">3082</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ForActivity(CLARIFYING_PARSERS_CHOICE_ACT, pattern--&gt;from) == 0) {</span></span>
<span class="tr"><span class="th" id="line3083">3083</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;(&quot;</span>; PrintCommand(from); print <span class="dstring">&quot;)^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3084">3084</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3085">3085</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndActivity(CLARIFYING_PARSERS_CHOICE_ACT, pattern--&gt;from);</span></span>
<span class="tr"><span class="th" id="line3086">3086</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line3087">3087</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;(&quot;</span>; PrintCommand(from); print <span class="dstring">&quot;)^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3088">3088</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3089">3089</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3090">3090</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3091">3091</span><span class="td">[ PrintCommand from i k spacing_flag;</span></span>
<span class="tr"><span class="th" id="line3092">3092</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (from == 0) {</span></span>
<span class="tr"><span class="th" id="line3093">3093</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = verb_word;</span></span>
<span class="tr"><span class="th" id="line3094">3094</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LanguageVerb(i) == 0)</span></span>
<span class="tr"><span class="th" id="line3095">3095</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (PrintVerb(i) == 0) print (address) i;</span></span>
<span class="tr"><span class="th" id="line3096">3096</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from++; spacing_flag = true;</span></span>
<span class="tr"><span class="th" id="line3097">3097</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3098">3098</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (k=from : k&lt;pcount : k++) {</span></span>
<span class="tr"><span class="th" id="line3099">3099</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = pattern--&gt;k;</span></span>
<span class="tr"><span class="th" id="line3100">3100</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == PATTERN_NULL) continue;</span></span>
<span class="tr"><span class="th" id="line3101">3101</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (spacing_flag) print (char) <span class="sstring">&#39; &#39;</span>;</span></span>
<span class="tr"><span class="th" id="line3102">3102</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == 0) { PARSER_CLARIF_INTERNAL_RM(<span class="sstring">&#39;F&#39;</span>); jump <a href="./Parser.i6t.html#line3111">TokenPrinted</a>; }</span></span>
<span class="tr"><span class="th" id="line3103">3103</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == 1) { PARSER_CLARIF_INTERNAL_RM(<span class="sstring">&#39;G&#39;</span>); jump <a href="./Parser.i6t.html#line3111">TokenPrinted</a>; }</span></span>
<span class="tr"><span class="th" id="line3104">3104</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i &gt;= REPARSE_CODE)</span></span>
<span class="tr"><span class="th" id="line3105">3105</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print (address) VM_NumberToDictionaryAddress(i-REPARSE_CODE);</span></span>
<span class="tr"><span class="th" id="line3106">3106</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line3107">3107</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i ofclass K3_direction)</span></span>
<span class="tr"><span class="th" id="line3108">3108</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print (LanguageDirection) i; <span class="comment">! the direction name as adverb</span></span></span>
<span class="tr"><span class="th" id="line3109">3109</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line3110">3110</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print (the) i;</span></span>
<span class="tr"><span class="th" id="line3111">3111</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.TokenPrinted;</span></span>
<span class="tr"><span class="th" id="line3112">3112</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spacing_flag = true;</span></span>
<span class="tr"><span class="th" id="line3113">3113</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3114">3114</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-cantsee">CantSee.</h3><p><p> The <span class="fixed"><a href="./Parser.i6t.html#line3131">CantSee</a></span> routine returns a good error number for the situation where the last word looked at didn&#39;t seem to refer to any object in context.<p></p><p> The idea is that: if the actor is in a location (but not inside something like, for instance, a tank which is in that location) then an attempt to refer to one of the words listed as meaningful-but-irrelevant there will cause &quot;you don&#39;t need to refer to that in this game&quot; rather than &quot;no such thing&quot; or &quot;what&#39;s `it&#39;?&quot;.<p></p><p> (The advantage of not having looked at &quot;irrelevant&quot; local nouns until now is that it stops them from clogging up the ambiguity-resolving process. Thus game objects always triumph over scenery.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3131">3131</span><span class="td">[ CantSee  i w e;</span></span>
<span class="tr"><span class="th" id="line3132">3132</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;saved_oops=oops_from;</span></span>
<span class="tr"><span class="th" id="line3133">3133</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3134">3134</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (scope_token ~= 0) {</span></span>
<span class="tr"><span class="th" id="line3135">3135</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_error = scope_token; return ASKSCOPE_PE;</span></span>
<span class="tr"><span class="th" id="line3136">3136</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3137">3137</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3138">3138</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn--; w = NextWord();</span></span>
<span class="tr"><span class="th" id="line3139">3139</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;e = CANTSEE_PE;</span></span>
<span class="tr"><span class="th" id="line3140">3140</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (w == pronoun_word) {</span></span>
<span class="tr"><span class="th" id="line3141">3141</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w = NextWordStopped(); wn--;</span></span>
<span class="tr"><span class="th" id="line3142">3142</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((w == -1) || (line_token--&gt;(pcount) ~= ENDIT_TOKEN)) {</span></span>
<span class="tr"><span class="th" id="line3143">3143</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (pcount &gt; 0) AnalyseToken(line_token--&gt;(pcount-1));</span></span>
<span class="tr"><span class="th" id="line3144">3144</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((pcount &gt; 0) &amp;&amp; (found_ttype == ROUTINE_FILTER_TT or ATTR_FILTER_TT))</span></span>
<span class="tr"><span class="th" id="line3145">3145</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e = NOTINCONTEXT_PE;</span></span>
<span class="tr"><span class="th" id="line3146">3146</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line3147">3147</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pronoun__word = pronoun_word; pronoun__obj = pronoun_obj;</span></span>
<span class="tr"><span class="th" id="line3148">3148</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e = ITGONE_PE;</span></span>
<span class="tr"><span class="th" id="line3149">3149</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3150">3150</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3151">3151</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3152">3152</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line3153">3153</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (etype &gt; e) return etype;</span></span>
<span class="tr"><span class="th" id="line3154">3154</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return e;</span></span>
<span class="tr"><span class="th" id="line3155">3155</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-multiple-object-list">Multiple Object List.</h3><p><p> The <span class="fixed"><a href="./Parser.i6t.html#line3171">MultiAdd</a></span> routine adds object <span class="fixed">o</span> to the multiple-object-list. This is only allowed to hold <span class="fixed">MATCH_LIST_WORDS</span> minus one objects at most, at which point it ignores any new entries (and sets a global flag so that a warning may later be printed if need be).<p></p><p> The <span class="fixed"><a href="./Parser.i6t.html#line3181">MultiSub</a></span> routine deletes object <span class="fixed">o</span> from the multiple-object-list. It returns 0 if the object was there in the first place, and 9 (because this is the appropriate error number in <span class="fixed">Parser</span>) if it wasn&#39;t.<p></p><p> The <span class="fixed"><a href="./Parser.i6t.html#line3192">MultiFilter</a></span> routine goes through the multiple-object-list and throws out anything without the given attribute <span class="fixed">attr</span> set.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3171">3171</span><span class="td">[ MultiAdd o i j;</span></span>
<span class="tr"><span class="th" id="line3172">3172</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line3173">3173</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (i == MATCH_LIST_WORDS-1) { toomany_flag = 1; rtrue; }</span></span>
<span class="tr"><span class="th" id="line3174">3174</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=1 : j&lt;=i : j++)</span></span>
<span class="tr"><span class="th" id="line3175">3175</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == multiple_object--&gt;j) rtrue;</span></span>
<span class="tr"><span class="th" id="line3176">3176</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i++;</span></span>
<span class="tr"><span class="th" id="line3177">3177</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;i = o;</span></span>
<span class="tr"><span class="th" id="line3178">3178</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = i;</span></span>
<span class="tr"><span class="th" id="line3179">3179</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3180">3180</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3181">3181</span><span class="td">[ MultiSub o i j k;</span></span>
<span class="tr"><span class="th" id="line3182">3182</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line3183">3183</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=1 : j&lt;=i : j++)</span></span>
<span class="tr"><span class="th" id="line3184">3184</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == multiple_object--&gt;j) {</span></span>
<span class="tr"><span class="th" id="line3185">3185</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (k=j : k&lt;=i : k++) multiple_object--&gt;k = multiple_object--&gt;(k+1);</span></span>
<span class="tr"><span class="th" id="line3186">3186</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiple_object--&gt;0 = --i;</span></span>
<span class="tr"><span class="th" id="line3187">3187</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></span>
<span class="tr"><span class="th" id="line3188">3188</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3189">3189</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return VAGUE_PE;</span></span>
<span class="tr"><span class="th" id="line3190">3190</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3191">3191</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3192">3192</span><span class="td">[ MultiFilter attr  i j o;</span></span>
<span class="tr"><span class="th" id="line3193">3193</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.MFiltl;</span></span>
<span class="tr"><span class="th" id="line3194">3194</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line3195">3195</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=1 : j&lt;=i : j++) {</span></span>
<span class="tr"><span class="th" id="line3196">3196</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o = multiple_object--&gt;j;</span></span>
<span class="tr"><span class="th" id="line3197">3197</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o hasnt attr) { MultiSub(o); jump Mfiltl; }</span></span>
<span class="tr"><span class="th" id="line3198">3198</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3199">3199</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-scope">Scope.</h3><p><p> The scope of an actor is the set of objects which he can refer to in typed commands, which is normally the same as the set of visible objects; but this can be modified. This is how I7 handles tokens like &quot;[any room]&quot;.<p></p><p> Scope determination is done by calling <span class="fixed"><a href="./Parser.i6t.html#line3332">SearchScope</a></span> to iterate through the objects in scope, and &quot;visit&quot; each one: which means, carry out some task for each as we get there. The task depends on the current value of <span class="fixed"><a href="./Output.i6t.html#line289">scope_reason</a></span>, which is <span class="fixed"><a href="./Definitions.i6t.html#line493">PARSING_REASON</a></span> when the parser is matching command text against object names.<p></p><p> The scope machinery is built on a number of levels, each making use only of lower levels: (0) Either <span class="fixed"><a href="./Parser.i6t.html#line2104">NounDomain</a></span>, <span class="fixed"><a href="./Parser.i6t.html#line3270">TestScope</a></span> or <span class="fixed"><a href="./Parser.i6t.html#line3281">LoopOverScope</a></span> makes one or more calls to <span class="fixed"><a href="./Parser.i6t.html#line3332">SearchScope</a></span> (on level 1). The point of making multiple calls is to influence the order in which items in scope are visited, which improves the quality of &quot;take all&quot;-style multiple object lists, for instance. (1) <span class="fixed"><a href="./Parser.i6t.html#line3332">SearchScope</a></span> searches for the objects in scope which are within first one domain, and then another: for instance, first within the current room but not within the current actor, and then within the current actor. It can be called either from level 0, or externally from the choose-objects machinery, but is not recursive. It works within the context of a given token in the parser (when called for <span class="fixed"><a href="./Definitions.i6t.html#line493">PARSING_REASON</a></span>) and in particular the <span class="fixed">multiinside</span> token, and also handles testing commands, scope tokens, scope in darkness, and intervention by the I7 &quot;deciding the scope of&quot; activity. Most of its actual searches are delegated to <span class="fixed"><a href="./Parser.i6t.html#line3387">ScopeWithin</a></span> (level 2), but it also uses <span class="fixed"><a href="./Parser.i6t.html#line3415">DoScopeActionAndRecurse</a></span> (level 3) and <span class="fixed"><a href="./Parser.i6t.html#line3471">DoScopeAction</a></span> (level 4) as necessary. (2) <span class="fixed"><a href="./Parser.i6t.html#line3387">ScopeWithin</a></span> iterates through the objects in scope which are within one supplied domain, but not within another. It can be called either from level 1, or independently from rules in the &quot;deciding the scope of&quot; activity via the I7 &quot;place the contents of X in scope&quot; phrase. It calls <span class="fixed"><a href="./Parser.i6t.html#line3415">DoScopeActionAndRecurse</a></span> (level 3) on any unconcealed objects it finds. (3) <span class="fixed"><a href="./Parser.i6t.html#line3415">DoScopeActionAndRecurse</a></span> visits a given object by calling down to <span class="fixed"><a href="./Parser.i6t.html#line3471">DoScopeAction</a></span> (level 4), and recurses to all unconcealed object-tree contents and component parts of the object. The I7 phrase &quot;place X in scope&quot; uses this routine. (4) <span class="fixed"><a href="./Parser.i6t.html#line3471">DoScopeAction</a></span> simply visits a single object, taking whatever action is needed there &ndash; which will depend on the <span class="fixed"><a href="./Output.i6t.html#line289">scope_reason</a></span>. The only use made by the parser of <span class="fixed"><a href="./Parser.i6t.html#line3542">TryGivenObject</a></span>, which tries to match command text against the name of a given object, is from here. The I7 phrase &quot;place X in scope, but not its contents&quot; uses this routine.<p></p><p> Two routines are provided for code external to the parser to modify the scope. They should be called only during scope deliberations &ndash; i.e., in <span class="fixed">scope=...</span> tokens or in rules for the &quot;deciding the scope of&quot; activity. (At present, <span class="fixed"><a href="./Parser.i6t.html#line3260">AddToScope</a></span> is not used in I7 at all.) Note that this I7 form of <span class="fixed"><a href="./Parser.i6t.html#line3253">PlaceInScope</a></span> has a slightly different specification to its I6 library counterpart of the same name: it can place a room in scope. (In I6, room names were not normally parsed.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3253">3253</span><span class="td">[ PlaceInScope O opts ws; <span class="comment">! If opts is set, do not place contents in scope</span></span></span>
<span class="tr"><span class="th" id="line3254">3254</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;ws = wn; wn = match_from;</span></span>
<span class="tr"><span class="th" id="line3255">3255</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (opts == false) DoScopeActionAndRecurse(O);</span></span>
<span class="tr"><span class="th" id="line3256">3256</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else DoScopeAction(O);</span></span>
<span class="tr"><span class="th" id="line3257">3257</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = ws; return;</span></span>
<span class="tr"><span class="th" id="line3258">3258</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3259">3259</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3260">3260</span><span class="td">[ AddToScope obj;</span></span>
<span class="tr"><span class="th" id="line3261">3261</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (ats_flag &gt;= 2) DoScopeActionAndRecurse(obj, 0, ats_flag-2);</span></span>
<span class="tr"><span class="th" id="line3262">3262</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (ats_flag == 1) { if (HasLightSource(obj)==1) ats_hls = 1; }</span></span>
<span class="tr"><span class="th" id="line3263">3263</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-scope-level-0">Scope Level 0.</h3><p><p> The two ways of starting up the scope machinery other than via the parser code above.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3270">3270</span><span class="td">[ TestScope obj act a al sr x y;</span></span>
<span class="tr"><span class="th" id="line3271">3271</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;x = parser_one; y = parser_two;</span></span>
<span class="tr"><span class="th" id="line3272">3272</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_one = obj; parser_two = 0; a = actor; al = actors_location;</span></span>
<span class="tr"><span class="th" id="line3273">3273</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;sr = scope_reason; scope_reason = TESTSCOPE_REASON;</span></span>
<span class="tr"><span class="th" id="line3274">3274</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (act == 0) actor = player; else actor = act;</span></span>
<span class="tr"><span class="th" id="line3275">3275</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actors_location = ScopeCeiling(actor);</span></span>
<span class="tr"><span class="th" id="line3276">3276</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;SearchScope(actors_location, actor, 0); scope_reason = sr; actor = a;</span></span>
<span class="tr"><span class="th" id="line3277">3277</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actors_location = al; parser_one = x; x = parser_two; parser_two = y;</span></span>
<span class="tr"><span class="th" id="line3278">3278</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return x;</span></span>
<span class="tr"><span class="th" id="line3279">3279</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3280">3280</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3281">3281</span><span class="td">[ LoopOverScope routine act x y a al;</span></span>
<span class="tr"><span class="th" id="line3282">3282</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;x = parser_one; y = scope_reason; a = actor; al = actors_location;</span></span>
<span class="tr"><span class="th" id="line3283">3283</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_one = routine;</span></span>
<span class="tr"><span class="th" id="line3284">3284</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (act == 0) actor = player; else actor = act;</span></span>
<span class="tr"><span class="th" id="line3285">3285</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;actors_location = ScopeCeiling(actor);</span></span>
<span class="tr"><span class="th" id="line3286">3286</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;scope_reason = LOOPOVERSCOPE_REASON;</span></span>
<span class="tr"><span class="th" id="line3287">3287</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;SearchScope(actors_location, actor, 0);</span></span>
<span class="tr"><span class="th" id="line3288">3288</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_one = x; scope_reason = y; actor = a; actors_location = al;</span></span>
<span class="tr"><span class="th" id="line3289">3289</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-searchscope">SearchScope.</h3><p><p> Level 1. The method is: (a) If the context is a <span class="fixed">scope=...</span> token, then the search is delegated to &quot;stage 2&quot; of the scope routine. This was the old I6 way to override the searching behaviour: while users probably won&#39;t be using it any more, the template does, in order to give testing commands universal scope which is exempt from the activity below; and the NI compiler creates <span class="fixed">scope=...</span> tokens to handle Understand grammar such as &quot;[any room]&quot;. So the feature remains very much still in use. (b) The &quot;deciding the scope of&quot; activity is given the chance to intervene. This is the I7 way to override the searching behaviour, and is the one taken by users. (c) And otherwise: (-1) The I6 <span class="fixed">multiinside</span> token, used as the first noun of its grammar line, has as its scope all of the objects which are inside or on top of the <strong> second</strong> noun of the grammar line. This provides a neat scope for the ALL in a command like GET ALL FROM CUPBOARD, where the player clearly does not intend ALL to refer to the cupboard itself, for instance. The difficulty is that we don&#39;t yet know what the second object is, if we are parsing left to right. But the parser code above has taken care of all of that, and the <span class="fixed"><a href="./Output.i6t.html#line293">advance_warning</a></span> global is set to the object number of the second noun, or to <em>-1</em> if that is not yet known. Note that we check that the contents are visible before adding them to scope, because otherwise an unscrupulous player could use such a command to detect the contents of an opaque locked box. If this rule applies, we skip (c.2), (c.3) and (c.4). (-2) For all other tokens except <span class="fixed">creature</span>, searching scope for the room holding the current actor always catches the compass directions unless a definite article has already been typed. (Thus OPEN THE EAST would match an object called &quot;east door&quot;, but not the compass direction &quot;east&quot;.) (-3) The contents of <span class="fixed">domain1</span> which are not contents of <span class="fixed">domain2</span> are placed in scope, and so are any component parts of <span class="fixed">domain1</span>. If <span class="fixed">domain1</span> is a container or supporter, it is placed in scope itself. (-4) The contents and component parts of <span class="fixed">domain2</span> are placed in scope. If <span class="fixed">domain2</span> is a container or supporter, it is placed in scope itself. (-5) In darkness, the actor and his component parts are in scope. If the actor is inside or on top of something, then that thing is also in scope. (This avoids a situation where the player gets into an opaque box, then pulls it closed from the inside, plunging himself into darkness, then types OPEN BOX only to be told that he can&#39;t see any such thing.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3332">3332</span><span class="td">[ SearchScope domain1 domain2 context i;</span></span>
<span class="tr"><span class="th" id="line3333">3333</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (domain1 == 0) return;</span></span>
<span class="tr"><span class="th" id="line3334">3334</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (a)</span></span></span>
<span class="tr"><span class="th" id="line3335">3335</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (scope_token) {</span></span>
<span class="tr"><span class="th" id="line3336">3336</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scope_stage = 2;</span></span>
<span class="tr"><span class="th" id="line3337">3337</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line3338">3338</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 3) print <span class="dstring">&quot;  [Scope routine called at stage 2]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3339">3339</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif;</span></span>
<span class="tr"><span class="th" id="line3340">3340</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indirect(scope_token) ~= 0) rtrue;</span></span>
<span class="tr"><span class="th" id="line3341">3341</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3342">3342</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (b)</span></span></span>
<span class="tr"><span class="th" id="line3343">3343</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BeginActivity(DECIDING_SCOPE_ACT, actor);</span></span>
<span class="tr"><span class="th" id="line3344">3344</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (ForActivity(DECIDING_SCOPE_ACT, actor) == false) {</span></span>
<span class="tr"><span class="th" id="line3345">3345</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (c.1)</span></span></span>
<span class="tr"><span class="th" id="line3346">3346</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((scope_reason == PARSING_REASON) &amp;&amp; (context == MULTIINSIDE_TOKEN) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line3347">3347</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(advance_warning ~= -1)) {</span></span>
<span class="tr"><span class="th" id="line3348">3348</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (IsSeeThrough(advance_warning) == 1)</span></span>
<span class="tr"><span class="th" id="line3349">3349</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ScopeWithin(advance_warning, 0, context);</span></span>
<span class="tr"><span class="th" id="line3350">3350</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line3351">3351</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (c.2)</span></span></span>
<span class="tr"><span class="th" id="line3352">3352</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((scope_reason == PARSING_REASON) &amp;&amp; (context ~= CREATURE_TOKEN) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line3353">3353</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(indef_mode == 0) &amp;&amp; (domain1 == actors_location))</span></span>
<span class="tr"><span class="th" id="line3354">3354</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ScopeWithin(compass);</span></span>
<span class="tr"><span class="th" id="line3355">3355</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (c.3)</span></span></span>
<span class="tr"><span class="th" id="line3356">3356</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (domain1 has supporter or container) DoScopeAction(domain1);</span></span>
<span class="tr"><span class="th" id="line3357">3357</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ScopeWithin(domain1, domain2, context);</span></span>
<span class="tr"><span class="th" id="line3358">3358</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (c.4)</span></span></span>
<span class="tr"><span class="th" id="line3359">3359</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (domain2) {</span></span>
<span class="tr"><span class="th" id="line3360">3360</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (domain2 has supporter or container) DoScopeAction(domain2);</span></span>
<span class="tr"><span class="th" id="line3361">3361</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ScopeWithin(domain2, 0, context);</span></span>
<span class="tr"><span class="th" id="line3362">3362</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3363">3363</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3364">3364</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (c.5)</span></span></span>
<span class="tr"><span class="th" id="line3365">3365</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (thedark == domain1 or domain2) {</span></span>
<span class="tr"><span class="th" id="line3366">3366</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoScopeActionAndRecurse(actor, actor, context);</span></span>
<span class="tr"><span class="th" id="line3367">3367</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parent(actor) has supporter or container)</span></span>
<span class="tr"><span class="th" id="line3368">3368</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoScopeActionAndRecurse(parent(actor), parent(actor), context);</span></span>
<span class="tr"><span class="th" id="line3369">3369</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3370">3370</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3371">3371</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;EndActivity(DECIDING_SCOPE_ACT, actor);</span></span>
<span class="tr"><span class="th" id="line3372">3372</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-scopewithin">ScopeWithin.</h3><p><p> Level 2. <span class="fixed"><a href="./Parser.i6t.html#line3387">ScopeWithin</a></span> puts objects visible from within the <span class="fixed">domain</span> into scope. An item belonging to the <span class="fixed">domain</span> is placed in scope unless it is being concealed by the <span class="fixed">domain</span>: and even then, if the <span class="fixed">domain</span> is the current actor. Suppose Zorro conceals a book beneath his cloak: then the book is not in scope to his lady friend The Black Whip, but it is in scope to Zorro himself. (Thus an actor is not allowed to conceal anything from himself.)<p></p><p> Note that the <span class="fixed">domain</span> object itself, and its component parts if any, are not placed in scope by this routine, though nothing prevents some other code doing so.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3387">3387</span><span class="td">[ ScopeWithin domain nosearch context obj next_obj;</span></span>
<span class="tr"><span class="th" id="line3388">3388</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (domain == 0) rtrue;</span></span>
<span class="tr"><span class="th" id="line3389">3389</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3390">3390</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Look through the objects in the domain, avoiding &quot;objectloop&quot; in case</span></span></span>
<span class="tr"><span class="th" id="line3391">3391</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! movements occur.</span></span></span>
<span class="tr"><span class="th" id="line3392">3392</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;obj = child(domain);</span></span>
<span class="tr"><span class="th" id="line3393">3393</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;while (obj) {</span></span>
<span class="tr"><span class="th" id="line3394">3394</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_obj = sibling(obj);</span></span>
<span class="tr"><span class="th" id="line3395">3395</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((domain == actor) || (TestConcealment(domain, obj) == false))</span></span>
<span class="tr"><span class="th" id="line3396">3396</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoScopeActionAndRecurse(obj, nosearch, context);</span></span>
<span class="tr"><span class="th" id="line3397">3397</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj = next_obj;</span></span>
<span class="tr"><span class="th" id="line3398">3398</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3399">3399</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-doscopeactionandrecurse">DoScopeActionAndRecurse.</h3><p><p> Level 3. In all cases, the <span class="fixed">domain</span> itself is visited. There are then three possible forms of recursion: (a) To unconcealed objects which are inside, on top of, carried or worn by the <span class="fixed">domain</span>: this is called &quot;searching&quot; in traditional I6 language and is suppressed if <span class="fixed">domain</span> is the special value <span class="fixed">nosearch</span>. (b) To unconcealed component parts of the <span class="fixed">domain</span>. (c) To any other objects listed in the <span class="fixed">add_to_scope</span> property array, or supplied by the <span class="fixed">add_to_scope</span> property routine, if it has one. (I7 does not usually use <span class="fixed">add_to_scope</span>, but it remains a useful hook in the parser, so it retains its old I6 library interpretation.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3415">3415</span><span class="td">[ DoScopeActionAndRecurse domain nosearch context i ad n obj next_obj;</span></span>
<span class="tr"><span class="th" id="line3416">3416</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;DoScopeAction(domain);</span></span>
<span class="tr"><span class="th" id="line3417">3417</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3418">3418</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (a)</span></span></span>
<span class="tr"><span class="th" id="line3419">3419</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((domain ~= nosearch) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line3420">3420</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((domain ofclass K1_room or K8_person) || (IsSeeThrough(domain) == 1))) {</span></span>
<span class="tr"><span class="th" id="line3421">3421</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj = child(domain);</span></span>
<span class="tr"><span class="th" id="line3422">3422</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (obj) {</span></span>
<span class="tr"><span class="th" id="line3423">3423</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_obj = sibling(obj);</span></span>
<span class="tr"><span class="th" id="line3424">3424</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((domain == actor) || (TestConcealment(domain, obj) == false))</span></span>
<span class="tr"><span class="th" id="line3425">3425</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoScopeActionAndRecurse(obj, nosearch, context);</span></span>
<span class="tr"><span class="th" id="line3426">3426</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj = next_obj;</span></span>
<span class="tr"><span class="th" id="line3427">3427</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3428">3428</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3429">3429</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3430">3430</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (b)</span></span></span>
<span class="tr"><span class="th" id="line3431">3431</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (domain provides component_child) {</span></span>
<span class="tr"><span class="th" id="line3432">3432</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj = domain.component_child;</span></span>
<span class="tr"><span class="th" id="line3433">3433</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (obj) {</span></span>
<span class="tr"><span class="th" id="line3434">3434</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_obj = obj.component_sibling;</span></span>
<span class="tr"><span class="th" id="line3435">3435</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((domain == actor) || (TestConcealment(domain, obj) == false))</span></span>
<span class="tr"><span class="th" id="line3436">3436</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoScopeActionAndRecurse(obj, 0, context);</span></span>
<span class="tr"><span class="th" id="line3437">3437</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj = next_obj;</span></span>
<span class="tr"><span class="th" id="line3438">3438</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3439">3439</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3440">3440</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3441">3441</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! (c)</span></span></span>
<span class="tr"><span class="th" id="line3442">3442</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;ad = domain.&amp;add_to_scope;</span></span>
<span class="tr"><span class="th" id="line3443">3443</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (ad ~= 0) {</span></span>
<span class="tr"><span class="th" id="line3444">3444</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Test if the property value is not an object.</span></span></span>
<span class="tr"><span class="th" id="line3445">3445</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line3446">3446</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = (UnsignedCompare(ad--&gt;0, top_object) &gt; 0);</span></span>
<span class="tr"><span class="th" id="line3447">3447</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line3448">3448</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = (((ad--&gt;0)-&gt;0) ~= $70);</span></span>
<span class="tr"><span class="th" id="line3449">3449</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line3450">3450</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3451">3451</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i) {</span></span>
<span class="tr"><span class="th" id="line3452">3452</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ats_flag = 2+context;</span></span>
<span class="tr"><span class="th" id="line3453">3453</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RunRoutines(domain, add_to_scope);</span></span>
<span class="tr"><span class="th" id="line3454">3454</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ats_flag = 0;</span></span>
<span class="tr"><span class="th" id="line3455">3455</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3456">3456</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line3457">3457</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n = domain.#add_to_scope;</span></span>
<span class="tr"><span class="th" id="line3458">3458</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0 : (WORDSIZE*i)&lt;n : i++)</span></span>
<span class="tr"><span class="th" id="line3459">3459</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ad--&gt;i)</span></span>
<span class="tr"><span class="th" id="line3460">3460</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DoScopeActionAndRecurse(ad--&gt;i, 0, context);</span></span>
<span class="tr"><span class="th" id="line3461">3461</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3462">3462</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3463">3463</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-doscopeaction">DoScopeAction.</h3><p><p> Level 4. This is where we take whatever action is to be performed as the &quot;visit&quot; to each scoped object, and it&#39;s the bottom at last of the scope mechanism.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3471">3471</span><span class="td">[ DoScopeAction item;</span></span>
<span class="tr"><span class="th" id="line3472">3472</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3473">3473</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line3474">3474</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 6)</span></span>
<span class="tr"><span class="th" id="line3475">3475</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[DSA on &quot;</span>, (the) item, <span class="dstring">&quot; with reason = &quot;</span>, scope_reason,</span></span>
<span class="tr"><span class="th" id="line3476">3476</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dstring">&quot; p1 = &quot;</span>, parser_one, <span class="dstring">&quot; p2 = &quot;</span>, parser_two, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3477">3477</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line3478">3478</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3479">3479</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@push parser_one; @push scope_reason;</span></span>
<span class="tr"><span class="th" id="line3480">3480</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3481">3481</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;switch(scope_reason) {</span></span>
<span class="tr"><span class="th" id="line3482">3482</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TESTSCOPE_REASON: if (item == parser_one) parser_two = 1;</span></span>
<span class="tr"><span class="th" id="line3483">3483</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOOPOVERSCOPE_REASON: if (parser_one ofclass Routine) indirect(parser_one, item);</span></span>
<span class="tr"><span class="th" id="line3484">3484</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARSING_REASON, TALKING_REASON: MatchTextAgainstObject(item);</span></span>
<span class="tr"><span class="th" id="line3485">3485</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3486">3486</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3487">3487</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@pull scope_reason; @pull parser_one;</span></span>
<span class="tr"><span class="th" id="line3488">3488</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-parsing-object-names">Parsing Object Names.</h3><p><p> We now reach the final major block of code in the parser: the part which tries to match a given object&#39;s name(s) against the text at word position <span class="fixed"><a href="./Parser.i6t.html#line123">match_from</a></span> in the player&#39;s command, and calls <span class="fixed"><a href="./Parser.i6t.html#line2810">MakeMatch</a></span> if it succeeds. There are basically four possibilities: ME, a pronoun such as IT, a name which doesn&#39;t begin misleadingly with a number, and a name which does. In the latter two cases, we pass the job down to <span class="fixed"><a href="./Parser.i6t.html#line3542">TryGivenObject</a></span>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3499">3499</span><span class="td">[ MatchTextAgainstObject item i;</span></span>
<span class="tr"><span class="th" id="line3500">3500</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (token_filter ~= 0 &amp;&amp; ConsultNounFilterToken(item) == 0) return;</span></span>
<span class="tr"><span class="th" id="line3501">3501</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3502">3502</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (match_from &lt;= num_words) { <span class="comment">! If there&#39;s any text to match, that is</span></span></span>
<span class="tr"><span class="th" id="line3503">3503</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = match_from;</span></span>
<span class="tr"><span class="th" id="line3504">3504</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = NounWord();</span></span>
<span class="tr"><span class="th" id="line3505">3505</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((i == 1) &amp;&amp; (player == item)) MakeMatch(item, 1); <span class="comment">! &quot;me&quot;</span></span></span>
<span class="tr"><span class="th" id="line3506">3506</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((i &gt;= 2) &amp;&amp; (i &lt; 128) &amp;&amp; (LanguagePronouns--&gt;i == item)) MakeMatch(item, 1);</span></span>
<span class="tr"><span class="th" id="line3507">3507</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3508">3508</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3509">3509</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Construing the current word as the start of a noun, can it refer to the</span></span></span>
<span class="tr"><span class="th" id="line3510">3510</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! object?</span></span></span>
<span class="tr"><span class="th" id="line3511">3511</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3512">3512</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = match_from;</span></span>
<span class="tr"><span class="th" id="line3513">3513</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (TryGivenObject(item) &gt; 0)</span></span>
<span class="tr"><span class="th" id="line3514">3514</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_nspec_at &gt; 0 &amp;&amp; match_from ~= indef_nspec_at) {</span></span>
<span class="tr"><span class="th" id="line3515">3515</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! This case arises if the player has typed a number in</span></span></span>
<span class="tr"><span class="th" id="line3516">3516</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! which is hypothetically an indefinite descriptor:</span></span></span>
<span class="tr"><span class="th" id="line3517">3517</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! e.g. &quot;take two clubs&quot;.  We have just checked the object</span></span></span>
<span class="tr"><span class="th" id="line3518">3518</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! against the word &quot;clubs&quot;, in the hope of eventually finding</span></span></span>
<span class="tr"><span class="th" id="line3519">3519</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! two such objects.  But we also backtrack and check it</span></span></span>
<span class="tr"><span class="th" id="line3520">3520</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! against the words &quot;two clubs&quot;, in case it turns out to</span></span></span>
<span class="tr"><span class="th" id="line3521">3521</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! be the 2 of Clubs from a pack of cards, say.  If it does</span></span></span>
<span class="tr"><span class="th" id="line3522">3522</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! match against &quot;two clubs&quot;, we tear up our original</span></span></span>
<span class="tr"><span class="th" id="line3523">3523</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! assumption about the meaning of &quot;two&quot; and lapse back into</span></span></span>
<span class="tr"><span class="th" id="line3524">3524</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! definite mode.</span></span></span>
<span class="tr"><span class="th" id="line3525">3525</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3526">3526</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = indef_nspec_at;</span></span>
<span class="tr"><span class="th" id="line3527">3527</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (TryGivenObject(item) &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line3528">3528</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_from = indef_nspec_at;</span></span>
<span class="tr"><span class="th" id="line3529">3529</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResetDescriptors();</span></span>
<span class="tr"><span class="th" id="line3530">3530</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3531">3531</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = match_from;</span></span>
<span class="tr"><span class="th" id="line3532">3532</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3533">3533</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-trygivenobject">TryGivenObject.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line3542">TryGivenObject</a></span> tries to match as many words as possible in what has been typed to the given object, <span class="fixed">obj</span>. If it manages any words matched at all, it calls <span class="fixed"><a href="./Parser.i6t.html#line2810">MakeMatch</a></span> to say so, then returns the number of words (or 1 if it was a match because of inadequate input).<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3542">3542</span><span class="td">[ TryGivenObject obj nomatch threshold k w j;</span></span>
<span class="tr"><span class="th" id="line3543">3543</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line3544">3544</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 5) print <span class="dstring">&quot;    Trying &quot;</span>, (the) obj, <span class="dstring">&quot; (&quot;</span>, obj, <span class="dstring">&quot;) at word &quot;</span>, wn, <span class="dstring">&quot;^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3545">3545</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line3546">3546</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3547">3547</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (nomatch &amp;&amp; obj == 0) return 0;</span></span>
<span class="tr"><span class="th" id="line3548">3548</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3549">3549</span><span class="td"><span class="comment">! if (nomatch) print &quot;*** TryGivenObject *** on &quot;, (the) obj, &quot; at wn = &quot;, wn, &quot;^&quot;;</span></span></span>
<span class="tr"><span class="th" id="line3550">3550</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3551">3551</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;dict_flags_of_noun = 0;</span></span>
<span class="tr"><span class="th" id="line3552">3552</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3553">3553</span><span class="td"><span class="comment">!  If input has run out then always match, with only quality 0 (this saves</span></span></span>
<span class="tr"><span class="th" id="line3554">3554</span><span class="td"><span class="comment">!  time).</span></span></span>
<span class="tr"><span class="th" id="line3555">3555</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3556">3556</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (wn &gt; num_words) {</span></span>
<span class="tr"><span class="th" id="line3557">3557</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (nomatch) return 0;</span></span>
<span class="tr"><span class="th" id="line3558">3558</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode ~= 0)</span></span>
<span class="tr"><span class="th" id="line3559">3559</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dict_flags_of_noun = $$01110000;  <span class="comment">! Reject &quot;plural&quot; bit</span></span></span>
<span class="tr"><span class="th" id="line3560">3560</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MakeMatch(obj,0);</span></span>
<span class="tr"><span class="th" id="line3561">3561</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line3562">3562</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 5) print <span class="dstring">&quot;    Matched (0)^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3563">3563</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line3564">3564</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</span></span>
<span class="tr"><span class="th" id="line3565">3565</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3566">3566</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3567">3567</span><span class="td"><span class="comment">!  Ask the object to parse itself if necessary, sitting up and taking notice</span></span></span>
<span class="tr"><span class="th" id="line3568">3568</span><span class="td"><span class="comment">!  if it says the plural was used:</span></span></span>
<span class="tr"><span class="th" id="line3569">3569</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3570">3570</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj.parse_name~=0) {</span></span>
<span class="tr"><span class="th" id="line3571">3571</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_action = NULL; j=wn;</span></span>
<span class="tr"><span class="th" id="line3572">3572</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = RunRoutines(obj,parse_name);</span></span>
<span class="tr"><span class="th" id="line3573">3573</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (k &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line3574">3574</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn=j+k;</span></span>
<span class="tr"><span class="th" id="line3575">3575</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3576">3576</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.MMbyPN;</span></span>
<span class="tr"><span class="th" id="line3577">3577</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3578">3578</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_action == ##PluralFound)</span></span>
<span class="tr"><span class="th" id="line3579">3579</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dict_flags_of_noun = dict_flags_of_noun | 4;</span></span>
<span class="tr"><span class="th" id="line3580">3580</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3581">3581</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (dict_flags_of_noun &amp; 4) {</span></span>
<span class="tr"><span class="th" id="line3582">3582</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (~~allow_plurals) k = 0;</span></span>
<span class="tr"><span class="th" id="line3583">3583</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></span>
<span class="tr"><span class="th" id="line3584">3584</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode == 0) {</span></span>
<span class="tr"><span class="th" id="line3585">3585</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_mode = 1; indef_type = 0; indef_wanted = 0;</span></span>
<span class="tr"><span class="th" id="line3586">3586</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3587">3587</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indef_type = indef_type | PLURAL_BIT;</span></span>
<span class="tr"><span class="th" id="line3588">3588</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_wanted == 0) indef_wanted = INDEF_ALL_WANTED;</span></span>
<span class="tr"><span class="th" id="line3589">3589</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3590">3590</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3591">3591</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3592">3592</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef DEBUG;</span></span>
<span class="tr"><span class="th" id="line3593">3593</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser_trace &gt;= 5) print <span class="dstring">&quot;    Matched (&quot;</span>, k, <span class="dstring">&quot;)^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3594">3594</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! DEBUG</span></span></span>
<span class="tr"><span class="th" id="line3595">3595</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (nomatch == false) MakeMatch(obj,k);</span></span>
<span class="tr"><span class="th" id="line3596">3596</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return k;</span></span>
<span class="tr"><span class="th" id="line3597">3597</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3598">3598</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (k == 0) jump <a href="./Parser.i6t.html#line3613">NoWordsMatch</a>;</span></span>
<span class="tr"><span class="th" id="line3599">3599</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3600">3600</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3601">3601</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! The default algorithm is simply to count up how many words pass the</span></span></span>
<span class="tr"><span class="th" id="line3602">3602</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! Refers test:</span></span></span>
<span class="tr"><span class="th" id="line3603">3603</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3604">3604</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;parser_action = NULL;</span></span>
<span class="tr"><span class="th" id="line3605">3605</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3606">3606</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;w = NounWord();</span></span>
<span class="tr"><span class="th" id="line3607">3607</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3608">3608</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (w == 1 &amp;&amp; player == obj) { k=1; jump <a href="./Parser.i6t.html#line3576">MMbyPN</a>; }</span></span>
<span class="tr"><span class="th" id="line3609">3609</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3610">3610</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (w &gt;= 2 &amp;&amp; w &lt; 128 &amp;&amp; (LanguagePronouns--&gt;w == obj)) { k = 1; jump <a href="./Parser.i6t.html#line3576">MMbyPN</a>; }</span></span>
<span class="tr"><span class="th" id="line3611">3611</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3612">3612</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (Refers(obj, wn-1) == 0) {</span></span>
<span class="tr"><span class="th" id="line3613">3613</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.NoWordsMatch;</span></span>
<span class="tr"><span class="th" id="line3614">3614</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (indef_mode ~= 0) { k = 0; parser_action = NULL; jump <a href="./Parser.i6t.html#line3576">MMbyPN</a>; }</span></span>
<span class="tr"><span class="th" id="line3615">3615</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line3616">3616</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3617">3617</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3618">3618</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;threshold = 1;</span></span>
<span class="tr"><span class="th" id="line3619">3619</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;dict_flags_of_noun = (w-&gt;#dict_par1) &amp; $$01110100;</span></span>
<span class="tr"><span class="th" id="line3620">3620</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;w = NextWord();</span></span>
<span class="tr"><span class="th" id="line3621">3621</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;while (Refers(obj, wn-1)) {</span></span>
<span class="tr"><span class="th" id="line3622">3622</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threshold++;</span></span>
<span class="tr"><span class="th" id="line3623">3623</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (w)</span></span>
<span class="tr"><span class="th" id="line3624">3624</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dict_flags_of_noun = dict_flags_of_noun | ((w-&gt;#dict_par1) &amp; $$01110100);</span></span>
<span class="tr"><span class="th" id="line3625">3625</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w = NextWord();</span></span>
<span class="tr"><span class="th" id="line3626">3626</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3627">3627</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3628">3628</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;k = threshold;</span></span>
<span class="tr"><span class="th" id="line3629">3629</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line3576">MMbyPN</a>;</span></span>
<span class="tr"><span class="th" id="line3630">3630</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-refers">Refers.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line3639">Refers</a></span> works out whether the word at number wnum can refer to the object <span class="fixed">obj</span>, returning true or false. The standard method is to see if the word is listed under the <span class="fixed">name</span> property for the object, but this is more complex in languages other than English.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3639">3639</span><span class="td">[ Refers obj wnum   wd k l m;</span></span>
<span class="tr"><span class="th" id="line3640">3640</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj == 0) rfalse;</span></span>
<span class="tr"><span class="th" id="line3641">3641</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3642">3642</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef LanguageRefers;</span></span>
<span class="tr"><span class="th" id="line3643">3643</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;k = LanguageRefers(obj,wnum); if (k &gt;= 0) return k;</span></span>
<span class="tr"><span class="th" id="line3644">3644</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! LanguageRefers</span></span></span>
<span class="tr"><span class="th" id="line3645">3645</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3646">3646</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;k = wn; wn = wnum; wd = NextWordStopped(); wn = k;</span></span>
<span class="tr"><span class="th" id="line3647">3647</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3648">3648</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (parser_inflection &gt;= 256) {</span></span>
<span class="tr"><span class="th" id="line3649">3649</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k = indirect(parser_inflection, obj, wd);</span></span>
<span class="tr"><span class="th" id="line3650">3650</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (k &gt;= 0) return k;</span></span>
<span class="tr"><span class="th" id="line3651">3651</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m = -k;</span></span>
<span class="tr"><span class="th" id="line3652">3652</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3653">3653</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line3654">3654</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m = parser_inflection;</span></span>
<span class="tr"><span class="th" id="line3655">3655</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;k = obj.&amp;m; l = (obj.#m)/WORDSIZE-1;</span></span>
<span class="tr"><span class="th" id="line3656">3656</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (m=0 : m&lt;=l : m++)</span></span>
<span class="tr"><span class="th" id="line3657">3657</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wd == k--&gt;m) rtrue;</span></span>
<span class="tr"><span class="th" id="line3658">3658</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line3659">3659</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3660">3660</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3661">3661</span><span class="td">[ WordInProperty wd obj prop k l m;</span></span>
<span class="tr"><span class="th" id="line3662">3662</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;k = obj.&amp;prop; l = (obj.#prop)/WORDSIZE-1;</span></span>
<span class="tr"><span class="th" id="line3663">3663</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (m=0 : m&lt;=l : m++)</span></span>
<span class="tr"><span class="th" id="line3664">3664</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (wd == k--&gt;m) rtrue;</span></span>
<span class="tr"><span class="th" id="line3665">3665</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line3666">3666</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-nounword">NounWord.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line3678">NounWord</a></span> (which takes no arguments) returns: (a) 0 if the next word is not in the dictionary or is but does not carry the &quot;noun&quot; bit in its dictionary entry, (b) 1 if it is a word meaning &quot;me&quot;, (c) the index in the pronoun table (plus 2) of the value field of a pronoun, if it is a pronoun, (d) the address in the dictionary if it is a recognised noun.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3678">3678</span><span class="td">[ NounWord i j s;</span></span>
<span class="tr"><span class="th" id="line3679">3679</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = NextWord();</span></span>
<span class="tr"><span class="th" id="line3680">3680</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (i == 0) rfalse;</span></span>
<span class="tr"><span class="th" id="line3681">3681</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (i == ME1__WD or ME2__WD or ME3__WD) return 1;</span></span>
<span class="tr"><span class="th" id="line3682">3682</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;s = LanguagePronouns--&gt;0;</span></span>
<span class="tr"><span class="th" id="line3683">3683</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (j=1 : j&lt;=s : j=j+3)</span></span>
<span class="tr"><span class="th" id="line3684">3684</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == LanguagePronouns--&gt;j)</span></span>
<span class="tr"><span class="th" id="line3685">3685</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return j+2;</span></span>
<span class="tr"><span class="th" id="line3686">3686</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if ((i-&gt;#dict_par1)&amp;128 == 0) rfalse;</span></span>
<span class="tr"><span class="th" id="line3687">3687</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return i;</span></span>
<span class="tr"><span class="th" id="line3688">3688</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-trynumber">TryNumber.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line3705">TryNumber</a></span> takes word number <span class="fixed">wordnum</span> and tries to parse it as an (unsigned) decimal number or the name of a small number, returning<p></p><p> (a) <em>-1000</em> if it is not a number (b) the number, if it has between 1 and 4 digits (c) 10000 if it has 5 or more digits.<p></p><p> (The danger of allowing 5 digits is that Z-machine integers are only 16 bits long, and anyway this routine isn&#39;t meant to be perfect: it only really needs to be good enough to handle numeric descriptors such as those in TAKE 31 COINS or DROP FOUR DAGGERS. In particular, it is not the way I7 &quot;[number]&quot; tokens are parsed.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3705">3705</span><span class="td">[ TryNumber wordnum   i j c num len mul tot d digit;</span></span>
<span class="tr"><span class="th" id="line3706">3706</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = wn; wn = wordnum; j = NextWord(); wn = i;</span></span>
<span class="tr"><span class="th" id="line3707">3707</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;j = NumberWord(j); <span class="comment">! Test for verbal forms ONE to THIRTY</span></span></span>
<span class="tr"><span class="th" id="line3708">3708</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (j &gt;= 1) return j;</span></span>
<span class="tr"><span class="th" id="line3709">3709</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3710">3710</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line3711">3711</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = wordnum*4+1; j = parse-&gt;i; num = j+buffer; len = parse-&gt;(i-1);</span></span>
<span class="tr"><span class="th" id="line3712">3712</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX</span></span></span>
<span class="tr"><span class="th" id="line3713">3713</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i = wordnum*3; j = parse--&gt;i; num = j+buffer; len = parse--&gt;(i-1);</span></span>
<span class="tr"><span class="th" id="line3714">3714</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line3715">3715</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3716">3716</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (len &gt;= 4) mul=1000;</span></span>
<span class="tr"><span class="th" id="line3717">3717</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (len == 3) mul=100;</span></span>
<span class="tr"><span class="th" id="line3718">3718</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (len == 2) mul=10;</span></span>
<span class="tr"><span class="th" id="line3719">3719</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (len == 1) mul=1;</span></span>
<span class="tr"><span class="th" id="line3720">3720</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3721">3721</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tot = 0; c = 0; len = len-1;</span></span>
<span class="tr"><span class="th" id="line3722">3722</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3723">3723</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (c=0 : c&lt;=len : c++) {</span></span>
<span class="tr"><span class="th" id="line3724">3724</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digit=num-&gt;c;</span></span>
<span class="tr"><span class="th" id="line3725">3725</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;0&#39;</span>) { d = 0; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3726">3726</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;1&#39;</span>) { d = 1; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3727">3727</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;2&#39;</span>) { d = 2; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3728">3728</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;3&#39;</span>) { d = 3; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3729">3729</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;4&#39;</span>) { d = 4; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3730">3730</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;5&#39;</span>) { d = 5; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3731">3731</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;6&#39;</span>) { d = 6; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3732">3732</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;7&#39;</span>) { d = 7; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3733">3733</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;8&#39;</span>) { d = 8; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3734">3734</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (digit == <span class="sstring">&#39;9&#39;</span>) { d = 9; jump <a href="./Parser.i6t.html#line3736">digok</a>; }</span></span>
<span class="tr"><span class="th" id="line3735">3735</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -1000;</span></span>
<span class="tr"><span class="th" id="line3736">3736</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.digok;</span></span>
<span class="tr"><span class="th" id="line3737">3737</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tot = tot+mul*d; mul = mul/10;</span></span>
<span class="tr"><span class="th" id="line3738">3738</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3739">3739</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (len &gt; 3) tot=10000;</span></span>
<span class="tr"><span class="th" id="line3740">3740</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return tot;</span></span>
<span class="tr"><span class="th" id="line3741">3741</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-gender">Gender.</h3><p><p> <span class="fixed"><a href="./Parser.i6t.html#line3752">GetGender</a></span> returns 0 if the given animate object is female, and 1 if male, and is abstracted as a routine in case something more elaborate is ever needed.<p></p><p> For GNAs &ndash; gender/noun/animation combinations &ndash; see the <strong> Inform Designer&#39;s Manual</strong>, 4th edition.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3752">3752</span><span class="td">[ GetGender person;</span></span>
<span class="tr"><span class="th" id="line3753">3753</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (person hasnt female) rtrue;</span></span>
<span class="tr"><span class="th" id="line3754">3754</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line3755">3755</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3756">3756</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3757">3757</span><span class="td">[ GetGNAOfObject obj case gender;</span></span>
<span class="tr"><span class="th" id="line3758">3758</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj hasnt animate) case = 6;</span></span>
<span class="tr"><span class="th" id="line3759">3759</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj has male) gender = male;</span></span>
<span class="tr"><span class="th" id="line3760">3760</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj has female) gender = female;</span></span>
<span class="tr"><span class="th" id="line3761">3761</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj has neuter) gender = neuter;</span></span>
<span class="tr"><span class="th" id="line3762">3762</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (gender == 0) {</span></span>
<span class="tr"><span class="th" id="line3763">3763</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (case == 0) gender = LanguageAnimateGender;</span></span>
<span class="tr"><span class="th" id="line3764">3764</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else gender = LanguageInanimateGender;</span></span>
<span class="tr"><span class="th" id="line3765">3765</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3766">3766</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (gender == female)   case = case + 1;</span></span>
<span class="tr"><span class="th" id="line3767">3767</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (gender == neuter)   case = case + 2;</span></span>
<span class="tr"><span class="th" id="line3768">3768</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj has pluralname) case = case + 3;</span></span>
<span class="tr"><span class="th" id="line3769">3769</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return case;</span></span>
<span class="tr"><span class="th" id="line3770">3770</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-noticing-plurals">Noticing Plurals.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3775">3775</span><span class="td">[ DetectPluralWord at n i w swn outcome;</span></span>
<span class="tr"><span class="th" id="line3776">3776</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;swn = wn; wn = at;</span></span>
<span class="tr"><span class="th" id="line3777">3777</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0:i&lt;n:i++) {</span></span>
<span class="tr"><span class="th" id="line3778">3778</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w = NextWordStopped();</span></span>
<span class="tr"><span class="th" id="line3779">3779</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (w == 0 or THEN1__WD or COMMA_WORD or -1) break;</span></span>
<span class="tr"><span class="th" id="line3780">3780</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((w-&gt;#dict_par1) &amp; $$00000100) {</span></span>
<span class="tr"><span class="th" id="line3781">3781</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser_action = ##PluralFound;</span></span>
<span class="tr"><span class="th" id="line3782">3782</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outcome = true;</span></span>
<span class="tr"><span class="th" id="line3783">3783</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3784">3784</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3785">3785</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = swn;</span></span>
<span class="tr"><span class="th" id="line3786">3786</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return outcome;</span></span>
<span class="tr"><span class="th" id="line3787">3787</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-pronoun-handling">Pronoun Handling.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3792">3792</span><span class="td">[ SetPronoun dword value x;</span></span>
<span class="tr"><span class="th" id="line3793">3793</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (x=1 : x&lt;=LanguagePronouns--&gt;0 : x=x+3)</span></span>
<span class="tr"><span class="th" id="line3794">3794</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LanguagePronouns--&gt;x == dword) {</span></span>
<span class="tr"><span class="th" id="line3795">3795</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LanguagePronouns--&gt;(x+2) = value; return;</span></span>
<span class="tr"><span class="th" id="line3796">3796</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3797">3797</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RunTimeError(14);</span></span>
<span class="tr"><span class="th" id="line3798">3798</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3799">3799</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3800">3800</span><span class="td">[ PronounValue dword x;</span></span>
<span class="tr"><span class="th" id="line3801">3801</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (x=1 : x&lt;=LanguagePronouns--&gt;0 : x=x+3)</span></span>
<span class="tr"><span class="th" id="line3802">3802</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LanguagePronouns--&gt;x == dword)</span></span>
<span class="tr"><span class="th" id="line3803">3803</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LanguagePronouns--&gt;(x+2);</span></span>
<span class="tr"><span class="th" id="line3804">3804</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></span>
<span class="tr"><span class="th" id="line3805">3805</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3806">3806</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3807">3807</span><span class="td">[ ResetVagueWords obj; PronounNotice(obj); ];</span></span>
<span class="tr"><span class="th" id="line3808">3808</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3809">3809</span><span class="td">[ PronounNotice obj x bm g;</span></span>
<span class="tr"><span class="th" id="line3810">3810</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (obj == player) return;</span></span>
<span class="tr"><span class="th" id="line3811">3811</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3812">3812</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;g = (GetGNAOfObject(obj));</span></span>
<span class="tr"><span class="th" id="line3813">3813</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3814">3814</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;bm = PowersOfTwo_TB--&gt;g;</span></span>
<span class="tr"><span class="th" id="line3815">3815</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (x=1 : x&lt;=LanguagePronouns--&gt;0 : x=x+3)</span></span>
<span class="tr"><span class="th" id="line3816">3816</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (bm &amp; (LanguagePronouns--&gt;(x+1)) ~= 0)</span></span>
<span class="tr"><span class="th" id="line3817">3817</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LanguagePronouns--&gt;(x+2) = obj;</span></span>
<span class="tr"><span class="th" id="line3818">3818</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3819">3819</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (((g % 6) &lt; 3) &amp;&amp; (obj has ambigpluralname)) {</span></span>
<span class="tr"><span class="th" id="line3820">3820</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g = g + 3;</span></span>
<span class="tr"><span class="th" id="line3821">3821</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bm = PowersOfTwo_TB--&gt;g;</span></span>
<span class="tr"><span class="th" id="line3822">3822</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (x=1 : x&lt;=LanguagePronouns--&gt;0 : x=x+3)</span></span>
<span class="tr"><span class="th" id="line3823">3823</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (bm &amp; (LanguagePronouns--&gt;(x+1)) ~= 0)</span></span>
<span class="tr"><span class="th" id="line3824">3824</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LanguagePronouns--&gt;(x+2) = obj;</span></span>
<span class="tr"><span class="th" id="line3825">3825</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3826">3826</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3827">3827</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3828">3828</span><span class="td">[ PronounNoticeHeldObjects x;</span></span>
<span class="tr"><span class="th" id="line3829">3829</span><span class="td">#IFNDEF MANUAL_PRONOUNS;</span></span>
<span class="tr"><span class="th" id="line3830">3830</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;objectloop(x in player) PronounNotice(x);</span></span>
<span class="tr"><span class="th" id="line3831">3831</span><span class="td">#ENDIF;</span></span>
<span class="tr"><span class="th" id="line3832">3832</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;x = 0; <span class="comment">! To prevent a &quot;not used&quot; error</span></span></span>
<span class="tr"><span class="th" id="line3833">3833</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line3834">3834</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-yesno-questions">Yes/No Questions.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3839">3839</span><span class="td">[ YesOrNo i j;</span></span>
<span class="tr"><span class="th" id="line3840">3840</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (::) {</span></span>
<span class="tr"><span class="th" id="line3841">3841</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line3842">3842</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (location == nothing || parent(player) == nothing) read buffer2 parse2;</span></span>
<span class="tr"><span class="th" id="line3843">3843</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else read buffer2 parse2 DrawStatusLine;</span></span>
<span class="tr"><span class="th" id="line3844">3844</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = parse2-&gt;1;</span></span>
<span class="tr"><span class="th" id="line3845">3845</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Ifnot; <span class="comment">! TARGET_GLULX;</span></span></span>
<span class="tr"><span class="th" id="line3846">3846</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (location ~= nothing &amp;&amp; parent(player) ~= nothing) DrawStatusLine();</span></span>
<span class="tr"><span class="th" id="line3847">3847</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KeyboardPrimitive(buffer2, parse2);</span></span>
<span class="tr"><span class="th" id="line3848">3848</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = parse2--&gt;0;</span></span>
<span class="tr"><span class="th" id="line3849">3849</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Endif; <span class="comment">! TARGET_</span></span></span>
<span class="tr"><span class="th" id="line3850">3850</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (j) { <span class="comment">! at least one word entered</span></span></span>
<span class="tr"><span class="th" id="line3851">3851</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = parse2--&gt;1;</span></span>
<span class="tr"><span class="th" id="line3852">3852</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == YES1__WD or YES2__WD or YES3__WD) rtrue;</span></span>
<span class="tr"><span class="th" id="line3853">3853</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == NO1__WD or NO2__WD or NO3__WD) rfalse;</span></span>
<span class="tr"><span class="th" id="line3854">3854</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3855">3855</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;YES_OR_NO_QUESTION_INTERNAL_RM(<span class="sstring">&#39;A&#39;</span>); print <span class="dstring">&quot;&gt; &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3856">3856</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3857">3857</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3858">3858</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3859">3859</span><span class="td">[ YES_OR_NO_QUESTION_INTERNAL_R; ];</span></span>
</div><div class='text'>
<h3 id="parser-number-words">Number Words.</h3><p><p> Not much of a parsing routine: we look through an array of pairs of number words (single words) and their numeric equivalents.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3866">3866</span><span class="td">[ NumberWord o i n;</span></span>
<span class="tr"><span class="th" id="line3867">3867</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;n = LanguageNumbers--&gt;0;</span></span>
<span class="tr"><span class="th" id="line3868">3868</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=1 : i&lt;=n : i=i+2)</span></span>
<span class="tr"><span class="th" id="line3869">3869</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o == LanguageNumbers--&gt;i) return LanguageNumbers--&gt;(i+1);</span></span>
<span class="tr"><span class="th" id="line3870">3870</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></span>
<span class="tr"><span class="th" id="line3871">3871</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-choose-objects">Choose Objects.</h3><p><p> This material, the final body of code in the parser, is an I7 addition. The I6 parser leaves it to the user to provide a <span class="fixed"><a href="./Parser.i6t.html#line3917">ChooseObjects</a></span> routine to decide between possibilities when the situation is ambiguous. For I7 use, we provide a <span class="fixed"><a href="./Parser.i6t.html#line3917">ChooseObjects</a></span> which essentially runs the &quot;does the player mean&quot; rulebook to decide, though this is not obvious from the code below because it is hidden in the <span class="fixed">CheckDPMR</span> routine &ndash; which is defined in the Standard Rules, not here.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line3883">3883</span><span class="td"><span class="comment">!Constant COBJ_DEBUG;</span></span></span>
<span class="tr"><span class="th" id="line3884">3884</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3885">3885</span><span class="td"><span class="comment">! the highest value returned by CheckDPMR (see the Standard Rules)</span></span></span>
<span class="tr"><span class="th" id="line3886">3886</span><span class="td">Constant HIGHEST_DPMR_SCORE = 4;</span></span>
<span class="tr"><span class="th" id="line3887">3887</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3888">3888</span><span class="td">Array alt_match_list --&gt; (MATCH_LIST_WORDS+1);</span></span>
<span class="tr"><span class="th" id="line3889">3889</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3890">3890</span><span class="td">#ifdef TARGET_GLULX;</span></span>
<span class="tr"><span class="th" id="line3891">3891</span><span class="td">[ COBJ__Copy words from to  i;</span></span>
<span class="tr"><span class="th" id="line3892">3892</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=0: i&lt;words: i++)</span></span>
<span class="tr"><span class="th" id="line3893">3893</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to--&gt;i = from--&gt;i;</span></span>
<span class="tr"><span class="th" id="line3894">3894</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3895">3895</span><span class="td">#ifnot;</span></span>
<span class="tr"><span class="th" id="line3896">3896</span><span class="td">[ COBJ__Copy words from to  bytes;</span></span>
<span class="tr"><span class="th" id="line3897">3897</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;bytes = words * 2;</span></span>
<span class="tr"><span class="th" id="line3898">3898</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@copy_table from to bytes;</span></span>
<span class="tr"><span class="th" id="line3899">3899</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3900">3900</span><span class="td">#endif;</span></span>
<span class="tr"><span class="th" id="line3901">3901</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3902">3902</span><span class="td"><span class="comment">! swap alt_match_list with match_list/number_matched</span></span></span>
<span class="tr"><span class="th" id="line3903">3903</span><span class="td">[ COBJ__SwapMatches i x;</span></span>
<span class="tr"><span class="th" id="line3904">3904</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! swap the counts</span></span></span>
<span class="tr"><span class="th" id="line3905">3905</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;x = number_matched;</span></span>
<span class="tr"><span class="th" id="line3906">3906</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;number_matched = alt_match_list--&gt;0;</span></span>
<span class="tr"><span class="th" id="line3907">3907</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;alt_match_list--&gt;0 = x;</span></span>
<span class="tr"><span class="th" id="line3908">3908</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! swap the values</span></span></span>
<span class="tr"><span class="th" id="line3909">3909</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (x &lt; number_matched) x = number_matched;</span></span>
<span class="tr"><span class="th" id="line3910">3910</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for (i=x: i&gt;0: i--) {</span></span>
<span class="tr"><span class="th" id="line3911">3911</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x = match_list--&gt;(i-1);</span></span>
<span class="tr"><span class="th" id="line3912">3912</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_list--&gt;(i-1) = alt_match_list--&gt;i;</span></span>
<span class="tr"><span class="th" id="line3913">3913</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alt_match_list--&gt;i = x;</span></span>
<span class="tr"><span class="th" id="line3914">3914</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3915">3915</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line3916">3916</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3917">3917</span><span class="td">[ ChooseObjects obj code  l i swn spcount;</span></span>
<span class="tr"><span class="th" id="line3918">3918</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (code&lt;2) rfalse;</span></span>
<span class="tr"><span class="th" id="line3919">3919</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3920">3920</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (cobj_flag == 1) {</span></span>
<span class="tr"><span class="th" id="line3921">3921</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.CodeOne;</span></span>
<span class="tr"><span class="th" id="line3922">3922</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parameters &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line3923">3923</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef COBJ_DEBUG;</span></span>
<span class="tr"><span class="th" id="line3924">3924</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[scoring &quot;</span>, (the) obj, <span class="dstring">&quot; (second)]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3925">3925</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line3926">3926</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ScoreDabCombo(parser_results--&gt;INP1_PRES, obj);</span></span>
<span class="tr"><span class="th" id="line3927">3927</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line3928">3928</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef COBJ_DEBUG;</span></span>
<span class="tr"><span class="th" id="line3929">3929</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[scoring &quot;</span>, (the) obj, <span class="dstring">&quot; (first) in &quot;</span>,</span></span>
<span class="tr"><span class="th" id="line3930">3930</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alt_match_list--&gt;0, <span class="dstring">&quot; combinations]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3931">3931</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line3932">3932</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = 0;</span></span>
<span class="tr"><span class="th" id="line3933">3933</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=1: i&lt;=alt_match_list--&gt;0: i++) {</span></span>
<span class="tr"><span class="th" id="line3934">3934</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spcount = ScoreDabCombo(obj, alt_match_list--&gt;i);</span></span>
<span class="tr"><span class="th" id="line3935">3935</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (spcount == HIGHEST_DPMR_SCORE) {</span></span>
<span class="tr"><span class="th" id="line3936">3936</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef COBJ_DEBUG;</span></span>
<span class="tr"><span class="th" id="line3937">3937</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[scored &quot;</span>, spcount, <span class="dstring">&quot; - best possible]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3938">3938</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line3939">3939</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return spcount;</span></span>
<span class="tr"><span class="th" id="line3940">3940</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3941">3941</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (spcount&gt;l) l = spcount;</span></span>
<span class="tr"><span class="th" id="line3942">3942</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3943">3943</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return l;</span></span>
<span class="tr"><span class="th" id="line3944">3944</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3945">3945</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3946">3946</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (cobj_flag == 2) {</span></span>
<span class="tr"><span class="th" id="line3947">3947</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.CodeTwo;</span></span>
<span class="tr"><span class="th" id="line3948">3948</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef COBJ_DEBUG;</span></span>
<span class="tr"><span class="th" id="line3949">3949</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[scoring &quot;</span>, (the) obj, <span class="dstring">&quot; (simple); parameters = &quot;</span>, parameters,</span></span>
<span class="tr"><span class="th" id="line3950">3950</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="dstring">&quot; aw = &quot;</span>, advance_warning, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3951">3951</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line3952">3952</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@push action_to_be;</span></span>
<span class="tr"><span class="th" id="line3953">3953</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parameters==0) {</span></span>
<span class="tr"><span class="th" id="line3954">3954</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (advance_warning &gt; 0)</span></span>
<span class="tr"><span class="th" id="line3955">3955</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = ScoreDabCombo(obj, advance_warning);</span></span>
<span class="tr"><span class="th" id="line3956">3956</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line3957">3957</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = ScoreDabCombo(obj, 0);</span></span>
<span class="tr"><span class="th" id="line3958">3958</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></span>
<span class="tr"><span class="th" id="line3959">3959</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = ScoreDabCombo(parser_results--&gt;INP1_PRES, obj);</span></span>
<span class="tr"><span class="th" id="line3960">3960</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3961">3961</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull action_to_be;</span></span>
<span class="tr"><span class="th" id="line3962">3962</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return l;</span></span>
<span class="tr"><span class="th" id="line3963">3963</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3964">3964</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line3965">3965</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#ifdef COBJ_DEBUG;</span></span>
<span class="tr"><span class="th" id="line3966">3966</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[choosing a cobj strategy: &quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3967">3967</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line3968">3968</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;swn = wn;</span></span>
<span class="tr"><span class="th" id="line3969">3969</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;spcount = pcount;</span></span>
<span class="tr"><span class="th" id="line3970">3970</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;while (line_ttype--&gt;pcount == PREPOSITION_TT) pcount++;</span></span>
<span class="tr"><span class="th" id="line3971">3971</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (line_ttype--&gt;pcount == ELEMENTARY_TT) {</span></span>
<span class="tr"><span class="th" id="line3972">3972</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (line_tdata--&gt;pcount == TOPIC_TOKEN) {</span></span>
<span class="tr"><span class="th" id="line3973">3973</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcount = spcount;</span></span>
<span class="tr"><span class="th" id="line3974">3974</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line3947">CodeTwo</a>;</span></span>
<span class="tr"><span class="th" id="line3975">3975</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line3976">3976</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (wn &lt;= num_words) {</span></span>
<span class="tr"><span class="th" id="line3977">3977</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l = NextWordStopped(); wn--;</span></span>
<span class="tr"><span class="th" id="line3978">3978</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == THEN1__WD) break;</span></span>
<span class="tr"><span class="th" id="line3979">3979</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( (l ~= -1 or 0) &amp;&amp; (l-&gt;#dict_par1) &amp;8 ) { wn++; continue; }    <span class="comment">! if preposition</span></span></span>
<span class="tr"><span class="th" id="line3980">3980</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (l == ALL1__WD or ALL2__WD or ALL3__WD or ALL4__WD or ALL5__WD) { wn++; continue; }</span></span>
<span class="tr"><span class="th" id="line3981">3981</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SafeSkipDescriptors();</span></span>
<span class="tr"><span class="th" id="line3982">3982</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! save the current match state</span></span></span>
<span class="tr"><span class="th" id="line3983">3983</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@push match_length; @push token_filter; @push match_from;</span></span>
<span class="tr"><span class="th" id="line3984">3984</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alt_match_list--&gt;0 = number_matched;</span></span>
<span class="tr"><span class="th" id="line3985">3985</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COBJ__Copy(number_matched, match_list, alt_match_list+WORDSIZE);</span></span>
<span class="tr"><span class="th" id="line3986">3986</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! now get all the matches for the second noun</span></span></span>
<span class="tr"><span class="th" id="line3987">3987</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_length = 0; number_matched = 0; match_from = wn;</span></span>
<span class="tr"><span class="th" id="line3988">3988</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_filter = 0;</span></span>
<span class="tr"><span class="th" id="line3989">3989</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SearchScope(actor, actors_location, line_tdata--&gt;pcount);</span></span>
<span class="tr"><span class="th" id="line3990">3990</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ifdef COBJ_DEBUG;</span></span>
<span class="tr"><span class="th" id="line3991">3991</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print number_matched, <span class="dstring">&quot; possible second nouns]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line3992">3992</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line3993">3993</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wn = swn;</span></span>
<span class="tr"><span class="th" id="line3994">3994</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cobj_flag = 1;</span></span>
<span class="tr"><span class="th" id="line3995">3995</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">! restore match variables</span></span></span>
<span class="tr"><span class="th" id="line3996">3996</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COBJ__SwapMatches();</span></span>
<span class="tr"><span class="th" id="line3997">3997</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pull match_from; @pull token_filter; @pull match_length;</span></span>
<span class="tr"><span class="th" id="line3998">3998</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcount = spcount;</span></span>
<span class="tr"><span class="th" id="line3999">3999</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line3921">CodeOne</a>;</span></span>
<span class="tr"><span class="th" id="line4000">4000</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line4001">4001</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line4002">4002</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;pcount = spcount;</span></span>
<span class="tr"><span class="th" id="line4003">4003</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;wn = swn;    </span></span>
<span class="tr"><span class="th" id="line4004">4004</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line4005">4005</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#ifdef COBJ_DEBUG;</span></span>
<span class="tr"><span class="th" id="line4006">4006</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;nothing interesting]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line4007">4007</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line4008">4008</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;cobj_flag = 2;</span></span>
<span class="tr"><span class="th" id="line4009">4009</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump <a href="./Parser.i6t.html#line3947">CodeTwo</a>;</span></span>
<span class="tr"><span class="th" id="line4010">4010</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line4011">4011</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line4012">4012</span><span class="td">[ ScoreDabCombo a b  result;</span></span>
<span class="tr"><span class="th" id="line4013">4013</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@push action; @push act_requester; @push noun; @push second;</span></span>
<span class="tr"><span class="th" id="line4014">4014</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;action = action_to_be;</span></span>
<span class="tr"><span class="th" id="line4015">4015</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;act_requester = player;</span></span>
<span class="tr"><span class="th" id="line4016">4016</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if (action_reversed) { noun = b; second = a; }</span></span>
<span class="tr"><span class="th" id="line4017">4017</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else { noun = a; second = b; }</span></span>
<span class="tr"><span class="th" id="line4018">4018</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;result = CheckDPMR();</span></span>
<span class="tr"><span class="th" id="line4019">4019</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;@pull second; @pull noun; @pull act_requester; @pull action;</span></span>
<span class="tr"><span class="th" id="line4020">4020</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#ifdef COBJ_DEBUG;</span></span>
<span class="tr"><span class="th" id="line4021">4021</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print <span class="dstring">&quot;[&quot;</span>, (the) a, <span class="dstring">&quot; / &quot;</span>, (the) b, <span class="dstring">&quot; =&gt; &quot;</span>, result, <span class="dstring">&quot;]^&quot;</span>;</span></span>
<span class="tr"><span class="th" id="line4022">4022</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line4023">4023</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return result;</span></span>
<span class="tr"><span class="th" id="line4024">4024</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="parser-default-topic">Default Topic.</h3><p><p> A default value for the I7 sort-of-kind &quot;topic&quot;, which never matches.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line4030">4030</span><span class="td">[ DefaultTopic; return GPR_FAIL; ];</span></span>
<span class="tr"><span class="th" id="line4031">4031</span><span class="td"></span></span>
</div><footer><p><em>From I6T lib 6/12N &copy; Graham Nelson and published under the <a href="https://github.com/zedlopez/standard_rules/blob/main/LICENSE.md">Artistic License 2.0</a>. Distributed with <a href="http://inform7.com/">Inform 7 6M62</a>.</em></p></footer></body></html>
