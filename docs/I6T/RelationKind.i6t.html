<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head><title>RelationKind</title>
  <style>
span.th, span.td { display: table-cell; }
span.td { padding-left: 2rem; }
span.th { width:4rem; text-align: right; }
span.tr { display: table-row;     counter-increment: linenum; }
span.line_no::before {
    content: counter(linenum);
    text-align: right;
    display: block;
    font-family: monospace;
    font-weight: normal;
}
h1 { margin: 0; }
.fixed { font-family: monospace }
.em { font-style: italic; }
.center { text-align: center; }
    body { font-family: sans-serif; margin: 1.5rem 0 0 3rem; background-color: #fafaf0; width: 80rem; }
    .pre { font-family: monospace; margin: auto; width: 80rem; }
#front_matter,.text { width: 50rem; }
.text { border-bottom: .5px solid black; border-top: .5px solid black; margin-top: 1rem;
padding-bottom: 1rem; margin-bottom: 2rem; }
/*.subtitle { font-weight: bold; font-size: 1.2rem; }*/
    </style>
</head>
<body>
<header>
<h1>I6 Template Layer</h1>
<div class="subtitle"><a href="http://inform7.com/">Inform 7 6M62</a> &bull; <a href="./index.html">Index</a> &bull; <a href="./Introduction.i6t.html">Introduction</a></div><hr></header>
<div id="front_matter">
<h2><a href="./RelationKind.i6t">RelationKind.i6t</a></h2><h3 id="#relationkind-block-format">Block Format.</h3><p><p> Inform uses a rich variety of relations, with many different data representations, but we aim to hide that complexity from the user. At run-time, a relation is represented by a block value. The short block of this BV is simply a pointer to a long block. This always begins with at least six words of metadata, but actual data sometimes follows on, and sometimes doesn&#39;t: and its format is something the customer needn&#39;t know about.<p></p><p> The low-level routines in <a href="./Relations.i6t.html">Relations.i6t</a> access this metadata by direct use of <span class="fixed">--&gt;</span>, for speed, and they use the offset constants <span class="fixed"><a href="./Relations.i6t.html#line12">RR_NAME</a></span> and so on; but we will use the <span class="fixed"><a href="./BlockValues.i6t.html#line250">BlkValueRead</a></span> and <span class="fixed"><a href="./BlockValues.i6t.html#line284">BlkValueWrite</a></span> routines in this section, which need offsets in the form <span class="fixed"><a href="./RelationKind.i6t.html#line22">RRV_NAME</a></span>. (The discrepancy of 5 is to allow for the five-word block header.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line22">22</span><span class="td">Constant&nbsp;RRV_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RR_NAME-5;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;Packed&nbsp;string,&nbsp;e.g.&nbsp;&quot;containment&nbsp;relation&quot;</span></span>
<span class="tr"><span class="th" id="line23">23</span><span class="td">Constant&nbsp;RRV_PERMISSIONS&nbsp;RR_PERMISSIONS-5;&nbsp;!&nbsp;A&nbsp;bitmap&nbsp;of&nbsp;what&nbsp;operations&nbsp;this&nbsp;supports</span></span>
<span class="tr"><span class="th" id="line24">24</span><span class="td">Constant&nbsp;RRV_STORAGE&nbsp;&nbsp;RR_STORAGE-5;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;Data&nbsp;location,&nbsp;depending&nbsp;on&nbsp;format</span></span>
<span class="tr"><span class="th" id="line25">25</span><span class="td">Constant&nbsp;RRV_KIND&nbsp;&nbsp;&nbsp;RR_KIND-5;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;Strong&nbsp;kind&nbsp;ID&nbsp;of&nbsp;the&nbsp;relation</span></span>
<span class="tr"><span class="th" id="line26">26</span><span class="td">Constant&nbsp;RRV_HANDLER&nbsp;&nbsp;RR_HANDLER-5;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;Routine&nbsp;to&nbsp;perform&nbsp;operations&nbsp;on&nbsp;this</span></span>
<span class="tr"><span class="th" id="line27">27</span><span class="td">Constant&nbsp;RRV_DESCRIPTION&nbsp;RR_DESCRIPTION-5;&nbsp;!&nbsp;Packed&nbsp;string,&nbsp;e.g.&nbsp;&quot;contains&quot;</span></span>
<span class="tr"><span class="th" id="line28">28</span><span class="td">Constant&nbsp;RRV_USED&nbsp;&nbsp;&nbsp;6;</span></span>
<span class="tr"><span class="th" id="line29">29</span><span class="td">Constant&nbsp;RRV_FILLED&nbsp;&nbsp;&nbsp;7;</span></span>
<span class="tr"><span class="th" id="line30">30</span><span class="td">Constant&nbsp;RRV_DATA_BASE&nbsp;&nbsp;8;</span></span>
</div><div class='text'>
<h3 id="#relationkind-kov-support">KOV Support.</h3><p><p> See the <a href="./BlockValues.i6t.html">BlockValues.i6t</a> segment for the specification of the following routines.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line37">37</span><span class="td">[&nbsp;RELATION_TY_Support&nbsp;task&nbsp;arg1&nbsp;arg2&nbsp;arg3;</span></span>
<span class="tr"><span class="th" id="line38">38</span><span class="td">&nbsp;switch(task)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line39">39</span><span class="td">&nbsp;&nbsp;CREATE_KOVS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;RELATION_TY_Create(arg1,&nbsp;0,&nbsp;arg2);</span></span>
<span class="tr"><span class="th" id="line40">40</span><span class="td">&nbsp;&nbsp;DESTROY_KOVS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATION_TY_Destroy(arg1);</span></span>
<span class="tr"><span class="th" id="line41">41</span><span class="td">&nbsp;&nbsp;MAKEMUTABLE_KOVS:&nbsp;return&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line42">42</span><span class="td">&nbsp;&nbsp;COPYQUICK_KOVS:&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line43">43</span><span class="td">&nbsp;&nbsp;COPYSB_KOVS:&nbsp;&nbsp;&nbsp;BlkValueCopySB1(arg1,&nbsp;arg2);</span></span>
<span class="tr"><span class="th" id="line44">44</span><span class="td">&nbsp;&nbsp;KINDDATA_KOVS:&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line45">45</span><span class="td">&nbsp;&nbsp;EXTENT_KOVS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1;</span></span>
<span class="tr"><span class="th" id="line46">46</span><span class="td">&nbsp;&nbsp;COPY_KOVS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATION_TY_Copy(arg1,&nbsp;arg2);</span></span>
<span class="tr"><span class="th" id="line47">47</span><span class="td">&nbsp;&nbsp;COMPARE_KOVS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;RELATION_TY_Compare(arg1,&nbsp;arg2);</span></span>
<span class="tr"><span class="th" id="line48">48</span><span class="td">&nbsp;&nbsp;HASH_KOVS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;arg1;</span></span>
<span class="tr"><span class="th" id="line49">49</span><span class="td">&nbsp;&nbsp;DEBUG_KOVS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;&nbsp;=&nbsp;&quot;,&nbsp;(RELATION_TY_Say)&nbsp;arg1;</span></span>
<span class="tr"><span class="th" id="line50">50</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line51">51</span><span class="td">&nbsp;!&nbsp;We&nbsp;choose&nbsp;not&nbsp;to&nbsp;respond&nbsp;to:&nbsp;CAST_KOVS,&nbsp;COPYKIND_KOVS,&nbsp;READ_FILE_KOVS,&nbsp;WRITE_FILE_KOVS</span></span>
<span class="tr"><span class="th" id="line52">52</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line53">53</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-other-definitions">Other Definitions.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line58">58</span><span class="td">!&nbsp;valencies</span></span>
<span class="tr"><span class="th" id="line59">59</span><span class="td">Constant&nbsp;RRVAL_V_TO_V&nbsp;&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line60">60</span><span class="td">Constant&nbsp;RRVAL_V_TO_O&nbsp;&nbsp;RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line61">61</span><span class="td">Constant&nbsp;RRVAL_O_TO_V&nbsp;&nbsp;RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line62">62</span><span class="td">Constant&nbsp;RRVAL_O_TO_O&nbsp;&nbsp;RELS_X_UNIQUE+RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line63">63</span><span class="td">Constant&nbsp;RRVAL_EQUIV&nbsp;&nbsp;RELS_EQUIVALENCE+RELS_SYMMETRIC;</span></span>
<span class="tr"><span class="th" id="line64">64</span><span class="td">Constant&nbsp;RRVAL_SYM_V_TO_V&nbsp;RELS_SYMMETRIC;</span></span>
<span class="tr"><span class="th" id="line65">65</span><span class="td">Constant&nbsp;RRVAL_SYM_O_TO_O&nbsp;RELS_SYMMETRIC+RELS_X_UNIQUE+RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line66">66</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line67">67</span><span class="td">!&nbsp;dictionary&nbsp;entry&nbsp;flags</span></span>
<span class="tr"><span class="th" id="line68">68</span><span class="td">Constant&nbsp;RRF_USED&nbsp;&nbsp;$0001;&nbsp;!&nbsp;entry&nbsp;contains&nbsp;a&nbsp;value</span></span>
<span class="tr"><span class="th" id="line69">69</span><span class="td">Constant&nbsp;RRF_DELETED&nbsp;$0002;&nbsp;!&nbsp;entry&nbsp;used&nbsp;to&nbsp;contain&nbsp;a&nbsp;value</span></span>
<span class="tr"><span class="th" id="line70">70</span><span class="td">Constant&nbsp;RRF_SINGLE&nbsp;&nbsp;$0004;&nbsp;!&nbsp;entry&#39;s&nbsp;Y&nbsp;is&nbsp;a&nbsp;value,&nbsp;not&nbsp;a&nbsp;list</span></span>
<span class="tr"><span class="th" id="line71">71</span><span class="td">Constant&nbsp;RRF_HASX&nbsp;&nbsp;$0010;&nbsp;!&nbsp;2-in-1&nbsp;entry&nbsp;contains&nbsp;a&nbsp;corresponding&nbsp;key</span></span>
<span class="tr"><span class="th" id="line72">72</span><span class="td">Constant&nbsp;RRF_HASY&nbsp;&nbsp;$0020;&nbsp;!&nbsp;2-in-1&nbsp;entry&nbsp;contains&nbsp;a&nbsp;corresponding&nbsp;value</span></span>
<span class="tr"><span class="th" id="line73">73</span><span class="td">Constant&nbsp;RRF_ENTKEYX&nbsp;$0040;&nbsp;!&nbsp;2-in-1&nbsp;entry&nbsp;key&nbsp;is&nbsp;left&nbsp;side&nbsp;KOV</span></span>
<span class="tr"><span class="th" id="line74">74</span><span class="td">Constant&nbsp;RRF_ENTKEYY&nbsp;$0080;&nbsp;!&nbsp;2-in-1&nbsp;entry&nbsp;key&nbsp;is&nbsp;right&nbsp;side&nbsp;KOV</span></span>
<span class="tr"><span class="th" id="line75">75</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line76">76</span><span class="td">!&nbsp;permission/task&nbsp;constants&nbsp;(those&nbsp;commented&nbsp;out&nbsp;here&nbsp;are&nbsp;generated&nbsp;by&nbsp;I7)</span></span>
<span class="tr"><span class="th" id="line77">77</span><span class="td">!Constant&nbsp;RELS_SYMMETRIC&nbsp;$8000;</span></span>
<span class="tr"><span class="th" id="line78">78</span><span class="td">!Constant&nbsp;RELS_EQUIVALENCE&nbsp;$4000;</span></span>
<span class="tr"><span class="th" id="line79">79</span><span class="td">!Constant&nbsp;RELS_X_UNIQUE&nbsp;$2000;</span></span>
<span class="tr"><span class="th" id="line80">80</span><span class="td">!Constant&nbsp;RELS_Y_UNIQUE&nbsp;$1000;</span></span>
<span class="tr"><span class="th" id="line81">81</span><span class="td">!Constant&nbsp;RELS_TEST&nbsp;$0800;</span></span>
<span class="tr"><span class="th" id="line82">82</span><span class="td">!Constant&nbsp;RELS_ASSERT_TRUE&nbsp;$0400;</span></span>
<span class="tr"><span class="th" id="line83">83</span><span class="td">!Constant&nbsp;RELS_ASSERT_FALSE&nbsp;$0200;</span></span>
<span class="tr"><span class="th" id="line84">84</span><span class="td">!Constant&nbsp;RELS_SHOW&nbsp;$0100;</span></span>
<span class="tr"><span class="th" id="line85">85</span><span class="td">!Constant&nbsp;RELS_ROUTE_FIND&nbsp;$0080;</span></span>
<span class="tr"><span class="th" id="line86">86</span><span class="td">!Constant&nbsp;RELS_ROUTE_FIND_COUNT&nbsp;$0040;</span></span>
<span class="tr"><span class="th" id="line87">87</span><span class="td">Constant&nbsp;RELS_COPY&nbsp;$0020;</span></span>
<span class="tr"><span class="th" id="line88">88</span><span class="td">Constant&nbsp;RELS_DESTROY&nbsp;$0010;</span></span>
<span class="tr"><span class="th" id="line89">89</span><span class="td">!Constant&nbsp;RELS_LOOKUP_ANY&nbsp;$0008;</span></span>
<span class="tr"><span class="th" id="line90">90</span><span class="td">!Constant&nbsp;RELS_LOOKUP_ALL_X&nbsp;$0004;</span></span>
<span class="tr"><span class="th" id="line91">91</span><span class="td">!Constant&nbsp;RELS_LOOKUP_ALL_Y&nbsp;$0002;</span></span>
<span class="tr"><span class="th" id="line92">92</span><span class="td">!Constant&nbsp;RELS_LIST&nbsp;$0001;</span></span>
<span class="tr"><span class="th" id="line93">93</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line94">94</span><span class="td">Constant&nbsp;RELS_EMPTY&nbsp;$0003;</span></span>
<span class="tr"><span class="th" id="line95">95</span><span class="td">Constant&nbsp;RELS_SET_VALENCY&nbsp;$0005;</span></span>
<span class="tr"><span class="th" id="line96">96</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line97">97</span><span class="td">!&nbsp;RELS_LOOKUP_ANY&nbsp;mode&nbsp;selection&nbsp;constants</span></span>
<span class="tr"><span class="th" id="line98">98</span><span class="td">Constant&nbsp;RLANY_GET_X&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line99">99</span><span class="td">Constant&nbsp;RLANY_GET_Y&nbsp;2;</span></span>
<span class="tr"><span class="th" id="line100">100</span><span class="td">Constant&nbsp;RLANY_CAN_GET_X&nbsp;3;</span></span>
<span class="tr"><span class="th" id="line101">101</span><span class="td">Constant&nbsp;RLANY_CAN_GET_Y&nbsp;4;</span></span>
<span class="tr"><span class="th" id="line102">102</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line103">103</span><span class="td">!&nbsp;RELS_LIST&nbsp;mode&nbsp;selection&nbsp;constant</span></span>
<span class="tr"><span class="th" id="line104">104</span><span class="td">Constant&nbsp;RLIST_ALL_X&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line105">105</span><span class="td">Constant&nbsp;RLIST_ALL_Y&nbsp;2;</span></span>
<span class="tr"><span class="th" id="line106">106</span><span class="td">Constant&nbsp;RLIST_ALL_PAIRS&nbsp;3;</span></span>
</div><div class='text'>
<h3 id="#relationkind-tunable-parameters">Tunable Parameters.</h3><p><p> These constants affect the performance characteristics of the dictionary structures used for relations on the heap. Changing their values may alter the balance between memory consumption and running time.<p></p><p> <span class="fixed"><a href="./RelationKind.i6t.html#line117">RRP_MIN_SIZE</a></span>, <span class="fixed"><a href="./RelationKind.i6t.html#line119">RRP_RESIZE_SMALL</a></span>, and <span class="fixed"><a href="./RelationKind.i6t.html#line120">RRP_RESIZE_LARGE</a></span> must all be powers of two.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line117">117</span><span class="td">Constant&nbsp;RRP_MIN_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8;&nbsp;&nbsp;&nbsp;!&nbsp;minimum&nbsp;number&nbsp;of&nbsp;entries&nbsp;(DO&nbsp;NOT&nbsp;CHANGE)</span></span>
<span class="tr"><span class="th" id="line118">118</span><span class="td">Constant&nbsp;RRP_PERTURB_SHIFT&nbsp;5;&nbsp;&nbsp;&nbsp;!&nbsp;affects&nbsp;the&nbsp;probe&nbsp;sequence</span></span>
<span class="tr"><span class="th" id="line119">119</span><span class="td">Constant&nbsp;RRP_RESIZE_SMALL&nbsp;&nbsp;4;&nbsp;&nbsp;&nbsp;!&nbsp;resize&nbsp;factor&nbsp;for&nbsp;small&nbsp;tables</span></span>
<span class="tr"><span class="th" id="line120">120</span><span class="td">Constant&nbsp;RRP_RESIZE_LARGE&nbsp;&nbsp;2;&nbsp;&nbsp;&nbsp;!&nbsp;resize&nbsp;factor&nbsp;for&nbsp;large&nbsp;tables</span></span>
<span class="tr"><span class="th" id="line121">121</span><span class="td">Constant&nbsp;RRP_LARGE_IS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;256;&nbsp;!&nbsp;how&nbsp;many&nbsp;entries&nbsp;make&nbsp;a&nbsp;table&nbsp;&quot;large&quot;?</span></span>
<span class="tr"><span class="th" id="line122">122</span><span class="td">Constant&nbsp;RRP_CROWDED_IS&nbsp;&nbsp;&nbsp;&nbsp;2;&nbsp;&nbsp;&nbsp;!&nbsp;when&nbsp;filled&nbsp;entries&nbsp;outnumber&nbsp;unfilled&nbsp;by&nbsp;_&nbsp;to&nbsp;1</span></span>
</div><div class='text'>
<h3 id="#relationkind-abstract-relations">Abstract Relations.</h3><p><p> As the following shows, we can abstractly use a relation &ndash; that is, we can use a relation whose identity we know little about &ndash; by calling its handler routine <span class="fixed">R</span> in the form <span class="fixed">R</span>.<p></p><p> The task should be one of: <span class="fixed">RELS_TEST</span>, <span class="fixed">RELS_ASSERT_TRUE</span>, <span class="fixed">RELS_ASSERT_FALSE</span>, <span class="fixed">RELS_SHOW</span>, <span class="fixed">RELS_ROUTE_FIND</span>, <span class="fixed">RELS_ROUTE_FIND_COUNT</span>, <span class="fixed"><a href="./RelationKind.i6t.html#line87">RELS_COPY</a></span>, <span class="fixed"><a href="./RelationKind.i6t.html#line88">RELS_DESTROY</a></span>, <span class="fixed">RELS_LOOKUP_ANY</span>, <span class="fixed">RELS_LOOKUP_ALL_X</span>, <span class="fixed">RELS_LOOKUP_ALL_Y</span>, <span class="fixed">RELS_LIST</span>, or <span class="fixed"><a href="./RelationKind.i6t.html#line94">RELS_EMPTY</a></span>.<p></p><p> <span class="fixed">RELS_SHOW</span> produces output for the SHOWME testing command. <span class="fixed">RELS_ROUTE_FIND</span> finds the next step in a route from <span class="fixed">X</span> to <span class="fixed">Y</span>, and <span class="fixed">RELS_ROUTE_FIND_COUNT</span> counts the shortest number of steps or returns <em>-1</em> if no route exists. <span class="fixed"><a href="./RelationKind.i6t.html#line87">RELS_COPY</a></span> makes a deep copy of the relation by replacing all block values with duplicates, and <span class="fixed"><a href="./RelationKind.i6t.html#line88">RELS_DESTROY</a></span> frees all block values. <span class="fixed">RELS_LOOKUP_ANY</span> finds any one of the <span class="fixed">X</span> values related to a given <span class="fixed">Y</span>, or vice versa, or checks whether such an <span class="fixed">X</span> or <span class="fixed">Y</span> value exists. <span class="fixed">RELS_LOOKUP_ALL_X</span> and <span class="fixed">RELS_LOOKUP_ALL_Y</span> produce a list of all the <span class="fixed">X</span> values related to a given <span class="fixed">Y</span>, or vice versa. <span class="fixed">RELS_LIST</span> produces a list of all <span class="fixed">X</span> values for which a corresponding <span class="fixed">Y</span> exists, or vice versa, or a list of all <span class="fixed">(X,Y)</span> pairs for which <span class="fixed">X</span> is related to <span class="fixed">Y</span>. <span class="fixed"><a href="./RelationKind.i6t.html#line94">RELS_EMPTY</a></span> either makes the relation empty (if <span class="fixed">X</span> is 1) or non-empty (if <span class="fixed">X</span> is 0) or makes no change (if <span class="fixed">X</span> is negative), and in any case returns true or false indicating whether the relation is now empty.<p></p><p> Because not every relation supports all of these operations, the &quot;permissions&quot; word in the block is always a bitmap which is a sum of those operations it does offer.<p></p><p> At present, these permissions are not checked as rigorously as they should be (they&#39;re correctly set, but not much monitored).<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line157">157</span><span class="td">[&nbsp;RelationTest&nbsp;relation&nbsp;task&nbsp;X&nbsp;Y&nbsp;&nbsp;handler&nbsp;rv;</span></span>
<span class="tr"><span class="th" id="line158">158</span><span class="td">&nbsp;handler&nbsp;=&nbsp;RlnGetF(relation,&nbsp;RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line159">159</span><span class="td">&nbsp;return&nbsp;handler(relation,&nbsp;task,&nbsp;X,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line160">160</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line161">161</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line162">162</span><span class="td">[&nbsp;RlnGetF&nbsp;rel&nbsp;fld&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line163">163</span><span class="td">&nbsp;rel&nbsp;=&nbsp;BlkValueGetLongBlock(rel);</span></span>
<span class="tr"><span class="th" id="line164">164</span><span class="td">&nbsp;return&nbsp;rel--&gt;fld;</span></span>
<span class="tr"><span class="th" id="line165">165</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line166">166</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line167">167</span><span class="td">[&nbsp;RlnSetF&nbsp;rel&nbsp;fld&nbsp;v;</span></span>
<span class="tr"><span class="th" id="line168">168</span><span class="td">&nbsp;rel&nbsp;=&nbsp;BlkValueGetLongBlock(rel);</span></span>
<span class="tr"><span class="th" id="line169">169</span><span class="td">&nbsp;rel--&gt;fld&nbsp;=&nbsp;v;</span></span>
<span class="tr"><span class="th" id="line170">170</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-empty-relations">Empty Relations.</h3><p><p> The absolute minimum relation is one which can only be tested, and which is always empty, that is, where no two values are ever related to each other. The necessary handler routine is <span class="fixed"><a href="./RelationKind.i6t.html#line178">EmptyRelationHandler</a></span>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line178">178</span><span class="td">[&nbsp;EmptyRelationHandler&nbsp;relation&nbsp;task&nbsp;X&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line179">179</span><span class="td">&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_EMPTY)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line180">180</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line181">181</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-creation">Creation.</h3><p><p> Something we have to be careful about is what we mean by copying, or indeed creating, a relation. For example, if we write<p></p><p> &gt;&gt; let Q be a relation of objects to objects; &gt;&gt; let Q be the containment relation;<p></p><p> ...we aren&#39;t literally asking for Q to be a duplicate copy of containment, which can then independently evolve &ndash; we mean in some sense that Q is a pointer to the one and only containment relation. On the other hand, if we write<p></p><p> &gt;&gt; let Q be a relation of numbers to numbers; &gt;&gt; make Q relate 3 to 7;<p></p><p> then the second line clearly expects Q to be its own relation, newly created.<p></p><p> We cope with this at creation time. If we&#39;re invited to create a copy of an existing relation, we look to see if it is empty &ndash; which we detect by its use of the <span class="fixed"><a href="./RelationKind.i6t.html#line178">EmptyRelationHandler</a></span> handler. The empty relations are exactly those used as default values for the relation kinds; thus that&#39;s what will happen when Q is created. If we find this handler, we intercept and replace it with one of the heap relation handlers, which thus makes the relation a newly constructed data structure which can grow freely from here.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line209">209</span><span class="td">[&nbsp;RELATION_TY_Create&nbsp;kov&nbsp;from&nbsp;sb&nbsp;rel&nbsp;i&nbsp;skov&nbsp;handler;</span></span>
<span class="tr"><span class="th" id="line210">210</span><span class="td">&nbsp;rel&nbsp;=&nbsp;FlexAllocate((RRV_DATA_BASE&nbsp;+&nbsp;3*RRP_MIN_SIZE)*WORDSIZE,</span></span>
<span class="tr"><span class="th" id="line211">211</span><span class="td">&nbsp;&nbsp;RELATION_TY,&nbsp;BLK_FLAG_WORD+BLK_FLAG_MULTIPLE);</span></span>
<span class="tr"><span class="th" id="line212">212</span><span class="td">&nbsp;if&nbsp;((from&nbsp;==&nbsp;0)&nbsp;&amp;&amp;&nbsp;(kov&nbsp;~=&nbsp;0))&nbsp;from&nbsp;=&nbsp;DefaultValueFinder(kov);</span></span>
<span class="tr"><span class="th" id="line213">213</span><span class="td">&nbsp;if&nbsp;(from)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line214">214</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;RRV_DATA_BASE:&nbsp;i++)&nbsp;BlkValueWrite(rel,&nbsp;i,&nbsp;BlkValueRead(from,&nbsp;i),&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line215">215</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueRead(from,&nbsp;RRV_HANDLER)&nbsp;==&nbsp;EmptyRelationHandler)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line216">216</span><span class="td">&nbsp;&nbsp;&nbsp;handler&nbsp;=&nbsp;ChooseRelationHandler(BlkValueRead(rel,&nbsp;RRV_KIND,&nbsp;true));</span></span>
<span class="tr"><span class="th" id="line217">217</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_NAME,&nbsp;&quot;anonymous&nbsp;relation&quot;,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line218">218</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_PERMISSIONS,</span></span>
<span class="tr"><span class="th" id="line219">219</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RELS_TEST+RELS_ASSERT_TRUE+RELS_ASSERT_FALSE+RELS_SHOW,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line220">220</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_HANDLER,&nbsp;handler,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line221">221</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_STORAGE,&nbsp;RRP_MIN_SIZE-1,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line222">222</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DESCRIPTION,&nbsp;&quot;an&nbsp;anonymous&nbsp;relation&quot;,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line223">223</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;0,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line224">224</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;0,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line225">225</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line226">226</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line227">227</span><span class="td">&nbsp;&nbsp;handler&nbsp;=&nbsp;ChooseRelationHandler(kov);</span></span>
<span class="tr"><span class="th" id="line228">228</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_NAME,&nbsp;&quot;anonymous&nbsp;relation&quot;,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line229">229</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_PERMISSIONS,</span></span>
<span class="tr"><span class="th" id="line230">230</span><span class="td">&nbsp;&nbsp;&nbsp;RELS_TEST+RELS_ASSERT_TRUE+RELS_ASSERT_FALSE+RELS_SHOW,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line231">231</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_STORAGE,&nbsp;RRP_MIN_SIZE-1,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line232">232</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_KIND,&nbsp;kov,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line233">233</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_HANDLER,&nbsp;handler,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line234">234</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DESCRIPTION,&nbsp;&quot;an&nbsp;anonymous&nbsp;relation&quot;,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line235">235</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;0,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line236">236</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;0,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line237">237</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line238">238</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line239">239</span><span class="td">&nbsp;return&nbsp;BlkValueCreateSB1(sb,&nbsp;rel);</span></span>
<span class="tr"><span class="th" id="line240">240</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-destruction">Destruction.</h3><p><p> If the relation stores block values on either side, invoke the handler using a special task value to free the memory associated with them.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line247">247</span><span class="td">[&nbsp;RELATION_TY_Destroy&nbsp;rel&nbsp;&nbsp;handler;</span></span>
<span class="tr"><span class="th" id="line248">248</span><span class="td">&nbsp;handler&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_HANDLER);</span></span>
<span class="tr"><span class="th" id="line249">249</span><span class="td">&nbsp;handler(rel,&nbsp;RELS_DESTROY);</span></span>
<span class="tr"><span class="th" id="line250">250</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-copying">Copying.</h3><p><p> Same as destruction: invoke the handler using a special value to tell it to perform deep copying.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line257">257</span><span class="td">[&nbsp;RELATION_TY_Copy&nbsp;lto&nbsp;lfrom&nbsp;&nbsp;handler;</span></span>
<span class="tr"><span class="th" id="line258">258</span><span class="td">&nbsp;handler&nbsp;=&nbsp;BlkValueRead(lto,&nbsp;RRV_HANDLER);</span></span>
<span class="tr"><span class="th" id="line259">259</span><span class="td">&nbsp;handler(lto,&nbsp;RELS_COPY);</span></span>
<span class="tr"><span class="th" id="line260">260</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-comparison">Comparison.</h3><p><p> It really isn&#39;t clear how to define equality for relations, but we follow the doctrine above. What we don&#39;t do is to test its actual state &ndash; that would be very slow and might be impossible.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line268">268</span><span class="td">[&nbsp;RELATION_TY_Compare&nbsp;rleft&nbsp;rright&nbsp;ind1&nbsp;ind2;</span></span>
<span class="tr"><span class="th" id="line269">269</span><span class="td">&nbsp;ind1&nbsp;=&nbsp;BlkValueRead(rleft,&nbsp;RRV_HANDLER);</span></span>
<span class="tr"><span class="th" id="line270">270</span><span class="td">&nbsp;ind2&nbsp;=&nbsp;BlkValueRead(rright,&nbsp;RRV_HANDLER);</span></span>
<span class="tr"><span class="th" id="line271">271</span><span class="td">&nbsp;if&nbsp;(ind1&nbsp;~=&nbsp;ind2)&nbsp;return&nbsp;ind1&nbsp;-&nbsp;ind2;</span></span>
<span class="tr"><span class="th" id="line272">272</span><span class="td">&nbsp;if&nbsp;(IsMutableRelationHandler(ind1)&nbsp;==&nbsp;false)&nbsp;return&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line273">273</span><span class="td">&nbsp;return&nbsp;rleft&nbsp;-&nbsp;rright;</span></span>
<span class="tr"><span class="th" id="line274">274</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line275">275</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line276">276</span><span class="td">[&nbsp;RELATION_TY_Distinguish&nbsp;rleft&nbsp;rright;</span></span>
<span class="tr"><span class="th" id="line277">277</span><span class="td">&nbsp;if&nbsp;(RELATION_TY_Compare(rleft,&nbsp;rright)&nbsp;==&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line278">278</span><span class="td">&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line279">279</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-printing">Printing.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line284">284</span><span class="td">[&nbsp;RELATION_TY_Say&nbsp;rel;</span></span>
<span class="tr"><span class="th" id="line285">285</span><span class="td">&nbsp;if&nbsp;(rel&nbsp;==&nbsp;0)&nbsp;print&nbsp;&quot;(null&nbsp;relation)&quot;;&nbsp;!&nbsp;shouldn&#39;t&nbsp;happen</span></span>
<span class="tr"><span class="th" id="line286">286</span><span class="td">&nbsp;else&nbsp;print&nbsp;(string)&nbsp;RlnGetF(rel,&nbsp;RR_NAME);</span></span>
<span class="tr"><span class="th" id="line287">287</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-naming">Naming.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line292">292</span><span class="td">[&nbsp;RELATION_TY_Name&nbsp;rel&nbsp;txt;</span></span>
<span class="tr"><span class="th" id="line293">293</span><span class="td">&nbsp;if&nbsp;(rel)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line294">294</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_NAME,&nbsp;txt);</span></span>
<span class="tr"><span class="th" id="line295">295</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DESCRIPTION,&nbsp;txt);</span></span>
<span class="tr"><span class="th" id="line296">296</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line297">297</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-choose-relation-handler">Choose Relation Handler.</h3><p><p> We implement two different various-to-various handler routines for the sake of efficiency. The choice of handler routines is made based on the kinds of value being related. Each handler also has a corresponding wrapper for symmetric relations.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line306">306</span><span class="td">[&nbsp;ChooseRelationHandler&nbsp;kov&nbsp;sym;</span></span>
<span class="tr"><span class="th" id="line307">307</span><span class="td">&nbsp;if&nbsp;(KOVIsBlockValue(KindBaseTerm(kov,&nbsp;0)))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line308">308</span><span class="td">&nbsp;&nbsp;if&nbsp;(sym)&nbsp;return&nbsp;SymHashListRelationHandler;</span></span>
<span class="tr"><span class="th" id="line309">309</span><span class="td">&nbsp;&nbsp;return&nbsp;HashListRelationHandler;</span></span>
<span class="tr"><span class="th" id="line310">310</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line311">311</span><span class="td">&nbsp;if&nbsp;(sym)&nbsp;return&nbsp;SymDoubleHashSetRelationHandler;</span></span>
<span class="tr"><span class="th" id="line312">312</span><span class="td">&nbsp;return&nbsp;DoubleHashSetRelationHandler;</span></span>
<span class="tr"><span class="th" id="line313">313</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line314">314</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line315">315</span><span class="td">[&nbsp;IsMutableRelationHandler&nbsp;h;</span></span>
<span class="tr"><span class="th" id="line316">316</span><span class="td">&nbsp;if&nbsp;(h&nbsp;==&nbsp;SymHashListRelationHandler&nbsp;or&nbsp;HashListRelationHandler&nbsp;or</span></span>
<span class="tr"><span class="th" id="line317">317</span><span class="td">&nbsp;&nbsp;SymDoubleHashSetRelationHandler&nbsp;or&nbsp;DoubleHashSetRelationHandler)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line318">318</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line319">319</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-valency">Valency.</h3><p><p> &quot;Valency&quot; refers to the number of participants allowed on either side of the relation: various-to-various, one-to-various, various-to-one, or one-to-one. A newly created relation is always various-to-various. We allow the author to change the valency, but only if no entries have been added yet.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line329">329</span><span class="td">[&nbsp;RELATION_TY_SetValency&nbsp;rel&nbsp;val&nbsp;&nbsp;kov&nbsp;filled&nbsp;cur&nbsp;handler&nbsp;ext;</span></span>
<span class="tr"><span class="th" id="line330">330</span><span class="td">&nbsp;filled&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED);</span></span>
<span class="tr"><span class="th" id="line331">331</span><span class="td">&nbsp;if&nbsp;(filled)&nbsp;{&nbsp;RunTimeProblem(RTP_RELATIONCHANGEIMPOSSIBLE);&nbsp;rfalse;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line332">332</span><span class="td">&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line333">333</span><span class="td">&nbsp;if&nbsp;(val&nbsp;==&nbsp;RRVAL_EQUIV&nbsp;or&nbsp;RRVAL_SYM_V_TO_V&nbsp;or&nbsp;RRVAL_SYM_O_TO_O)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line334">334</span><span class="td">&nbsp;&nbsp;if&nbsp;(KindBaseTerm(kov,&nbsp;0)&nbsp;~=&nbsp;KindBaseTerm(kov,&nbsp;1))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line335">335</span><span class="td">&nbsp;&nbsp;&nbsp;RunTimeProblem(RTP_RELATIONCHANGEIMPOSSIBLE);&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line336">336</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line337">337</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line338">338</span><span class="td">&nbsp;cur&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_HANDLER);</span></span>
<span class="tr"><span class="th" id="line339">339</span><span class="td">&nbsp;switch&nbsp;(val)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line340">340</span><span class="td">&nbsp;&nbsp;RRVAL_V_TO_V:&nbsp;&nbsp;handler&nbsp;=&nbsp;ChooseRelationHandler(kov,&nbsp;false);</span></span>
<span class="tr"><span class="th" id="line341">341</span><span class="td">&nbsp;&nbsp;RRVAL_V_TO_O:&nbsp;&nbsp;handler&nbsp;=&nbsp;HashTableRelationHandler;</span></span>
<span class="tr"><span class="th" id="line342">342</span><span class="td">&nbsp;&nbsp;RRVAL_O_TO_V:&nbsp;&nbsp;handler&nbsp;=&nbsp;ReversedHashTableRelationHandler;</span></span>
<span class="tr"><span class="th" id="line343">343</span><span class="td">&nbsp;&nbsp;RRVAL_O_TO_O:&nbsp;&nbsp;handler&nbsp;=&nbsp;TwoInOneHashTableRelationHandler;</span></span>
<span class="tr"><span class="th" id="line344">344</span><span class="td">&nbsp;&nbsp;RRVAL_EQUIV:&nbsp;&nbsp;handler&nbsp;=&nbsp;EquivHashTableRelationHandler;</span></span>
<span class="tr"><span class="th" id="line345">345</span><span class="td">&nbsp;&nbsp;RRVAL_SYM_V_TO_V:&nbsp;handler&nbsp;=&nbsp;ChooseRelationHandler(kov,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line346">346</span><span class="td">&nbsp;&nbsp;RRVAL_SYM_O_TO_O:&nbsp;handler&nbsp;=&nbsp;Sym2in1HashTableRelationHandler;</span></span>
<span class="tr"><span class="th" id="line347">347</span><span class="td">&nbsp;&nbsp;default:&nbsp;&nbsp;&nbsp;RunTimeProblem(RTP_RELATIONCHANGEIMPOSSIBLE);&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line348">348</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line349">349</span><span class="td">&nbsp;if&nbsp;(cur&nbsp;==&nbsp;handler)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line350">350</span><span class="td">&nbsp;!&nbsp;adjust&nbsp;size&nbsp;when&nbsp;going&nbsp;to&nbsp;or&nbsp;from&nbsp;2-in-1</span></span>
<span class="tr"><span class="th" id="line351">351</span><span class="td">&nbsp;if&nbsp;(cur&nbsp;==&nbsp;TwoInOneHashTableRelationHandler)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line352">352</span><span class="td">&nbsp;&nbsp;ext&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE)&nbsp;+&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line353">353</span><span class="td">&nbsp;&nbsp;BlkValueSetLBCapacity(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*ext);</span></span>
<span class="tr"><span class="th" id="line354">354</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(handler&nbsp;==&nbsp;TwoInOneHashTableRelationHandler)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line355">355</span><span class="td">&nbsp;&nbsp;ext&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE)&nbsp;+&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line356">356</span><span class="td">&nbsp;&nbsp;BlkValueSetLBCapacity(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*ext);</span></span>
<span class="tr"><span class="th" id="line357">357</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line358">358</span><span class="td">&nbsp;BlkValueWrite(rel,&nbsp;RRV_HANDLER,&nbsp;handler);</span></span>
<span class="tr"><span class="th" id="line359">359</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line360">360</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line361">361</span><span class="td">[&nbsp;RELATION_TY_GetValency&nbsp;rel&nbsp;&nbsp;handler;</span></span>
<span class="tr"><span class="th" id="line362">362</span><span class="td">&nbsp;return&nbsp;BlkValueRead(rel,&nbsp;RRV_PERMISSIONS)&nbsp;&amp;&nbsp;VALENCY_MASK;</span></span>
<span class="tr"><span class="th" id="line363">363</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-double-hash-set-relation-handler">Double Hash Set Relation Handler.</h3><p><p> This implements relations which are stored as a double-hashed set. The storage comprises a list of three-word entries <em>(F, X, Y)</em>, where <em>F</em> is a flags word. The ordering of the list is determined by a probe sequence which depends on the combined hash values of <em>X</em> and <em>Y</em>.<p></p><p> The &quot;storage&quot; word in the header stores one less than the number of entries in the list; the number of entries in the list is always a power of two, so this will always be a bit mask. The &quot;used&quot; and &quot;filled&quot; words store the number of entries which currently hold a value, and the number of entries which have ever held a value (even if it was since deleted), respectively.<p></p><p> The utility routine <span class="fixed"><a href="./RelationKind.i6t.html#line593">DoubleHashSetLookUp</a></span> locates the hash entry for a key/value pair. It returns either the (non-negative) number of the entry where the pair was found, or the (negative) bitwise NOT of the number of the first unused entry where the pair could be inserted. It uses the utility routine <span class="fixed"><a href="./RelationKind.i6t.html#line662">DoubleHashSetEntryMatches</a></span> to compare entries to the sought pair.<p></p><p> The utility routine <span class="fixed"><a href="./RelationKind.i6t.html#line626">DoubleHashSetCheckResize</a></span> checks whether the dictionary has become too full after inserting a pair, and expands it if so.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line390">390</span><span class="td">[&nbsp;DoubleHashSetRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y&nbsp;sym&nbsp;&nbsp;kov&nbsp;kx&nbsp;ky&nbsp;at&nbsp;tmp&nbsp;v;</span></span>
<span class="tr"><span class="th" id="line391">391</span><span class="td">&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line392">392</span><span class="td">&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;0);&nbsp;ky&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line393">393</span><span class="td">&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_SET_VALENCY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line394">394</span><span class="td">&nbsp;&nbsp;return&nbsp;RELATION_TY_SetValency(rel,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line395">395</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_DESTROY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line396">396</span><span class="td">&nbsp;&nbsp;!&nbsp;clear</span></span>
<span class="tr"><span class="th" id="line397">397</span><span class="td">&nbsp;&nbsp;kx&nbsp;=&nbsp;KOVIsBlockValue(kx);&nbsp;ky&nbsp;=&nbsp;KOVIsBlockValue(ky);</span></span>
<span class="tr"><span class="th" id="line398">398</span><span class="td">&nbsp;&nbsp;if&nbsp;(~~(kx&nbsp;||&nbsp;ky))&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line399">399</span><span class="td">&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line400">400</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line401">401</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line402">402</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(kx)&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line403">403</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ky)&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2));</span></span>
<span class="tr"><span class="th" id="line404">404</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line405">405</span><span class="td">&nbsp;&nbsp;&nbsp;at--;</span></span>
<span class="tr"><span class="th" id="line406">406</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line407">407</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line408">408</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_COPY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line409">409</span><span class="td">&nbsp;&nbsp;X&nbsp;=&nbsp;KOVIsBlockValue(kx);&nbsp;Y&nbsp;=&nbsp;KOVIsBlockValue(ky);</span></span>
<span class="tr"><span class="th" id="line410">410</span><span class="td">&nbsp;&nbsp;if&nbsp;(~~(X&nbsp;||&nbsp;Y))&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line411">411</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line412">412</span><span class="td">&nbsp;&nbsp;while&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line413">413</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line414">414</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line415">415</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(X)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line416">416</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line417">417</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line418">418</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line419">419</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line420">420</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line421">421</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line422">422</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(ky),&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line423">423</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line424">424</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line425">425</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line426">426</span><span class="td">&nbsp;&nbsp;&nbsp;at--;</span></span>
<span class="tr"><span class="th" id="line427">427</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line428">428</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line429">429</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_SHOW)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line430">430</span><span class="td">&nbsp;&nbsp;print&nbsp;(string)&nbsp;BlkValueRead(rel,&nbsp;RRV_DESCRIPTION),&nbsp;&quot;:^&quot;;</span></span>
<span class="tr"><span class="th" id="line431">431</span><span class="td">&nbsp;&nbsp;if&nbsp;(sym)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line432">432</span><span class="td">&nbsp;&nbsp;&nbsp;kov&nbsp;=&nbsp;KOVComparisonFunction(kx);</span></span>
<span class="tr"><span class="th" id="line433">433</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(~~kov)&nbsp;kov&nbsp;=&nbsp;UnsignedCompare;</span></span>
<span class="tr"><span class="th" id="line434">434</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line435">435</span><span class="td">&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line436">436</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line437">437</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line438">438</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;X&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line439">439</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line440">440</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sym&nbsp;&amp;&amp;&nbsp;(kov(X,&nbsp;Y)&nbsp;&gt;&nbsp;0))&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line441">441</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;&nbsp;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line442">442</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;PrintKindValuePair(kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line443">443</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sym)&nbsp;print&nbsp;&quot;&nbsp;&lt;=&gt;&nbsp;&quot;;&nbsp;else&nbsp;print&nbsp;&quot;&nbsp;&gt;=&gt;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line444">444</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;PrintKindValuePair(ky,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line445">445</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line446">446</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line447">447</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line448">448</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line449">449</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_EMPTY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line450">450</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line451">451</span><span class="td">&nbsp;&nbsp;if&nbsp;(X&nbsp;==&nbsp;1)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line452">452</span><span class="td">&nbsp;&nbsp;&nbsp;DoubleHashSetRelationHandler(rel,&nbsp;RELS_DESTROY);</span></span>
<span class="tr"><span class="th" id="line453">453</span><span class="td">&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line454">454</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line455">455</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line456">456</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line457">457</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp&nbsp;+&nbsp;2,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line458">458</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line459">459</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line460">460</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line461">461</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line462">462</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line463">463</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line464">464</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ANY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line465">465</span><span class="td">&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line466">466</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line467">467</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line468">468</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_GET_X&nbsp;or&nbsp;RLANY_CAN_GET_X)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line469">469</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line470">470</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line471">471</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(v,&nbsp;X)&nbsp;~=&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line472">472</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line473">473</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(v&nbsp;~=&nbsp;X)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line474">474</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line475">475</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_CAN_GET_X)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line476">476</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line477">477</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line478">478</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line479">479</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line480">480</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(v,&nbsp;X)&nbsp;~=&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line481">481</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line482">482</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(v&nbsp;~=&nbsp;X)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line483">483</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line484">484</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_CAN_GET_Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line485">485</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line486">486</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line487">487</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line488">488</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line489">489</span><span class="td">&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_GET_X&nbsp;or&nbsp;RLANY_GET_Y)</span></span>
<span class="tr"><span class="th" id="line490">490</span><span class="td">&nbsp;&nbsp;&nbsp;print&nbsp;&quot;***&nbsp;Lookup&nbsp;failed:&nbsp;value&nbsp;not&nbsp;found&nbsp;***^&quot;;</span></span>
<span class="tr"><span class="th" id="line491">491</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line492">492</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ALL_X)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line493">493</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueWeakKind(Y)&nbsp;~=&nbsp;LIST_OF_TY)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line494">494</span><span class="td">&nbsp;&nbsp;LIST_OF_TY_SetLength(Y,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line495">495</span><span class="td">&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line496">496</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line497">497</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line498">498</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line499">499</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line500">500</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(v,&nbsp;X)&nbsp;~=&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line501">501</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line502">502</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(v&nbsp;~=&nbsp;X)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line503">503</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line504">504</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(Y,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line505">505</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line506">506</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line507">507</span><span class="td">&nbsp;&nbsp;return&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line508">508</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ALL_Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line509">509</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueWeakKind(Y)&nbsp;~=&nbsp;LIST_OF_TY)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line510">510</span><span class="td">&nbsp;&nbsp;LIST_OF_TY_SetLength(Y,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line511">511</span><span class="td">&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line512">512</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line513">513</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line514">514</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line515">515</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line516">516</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(v,&nbsp;X)&nbsp;~=&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line517">517</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line518">518</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(v&nbsp;~=&nbsp;X)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line519">519</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line520">520</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(Y,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2));</span></span>
<span class="tr"><span class="th" id="line521">521</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line522">522</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line523">523</span><span class="td">&nbsp;&nbsp;return&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line524">524</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LIST)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line525">525</span><span class="td">&nbsp;&nbsp;if&nbsp;(X&nbsp;==&nbsp;0&nbsp;||&nbsp;BlkValueWeakKind(X)&nbsp;~=&nbsp;LIST_OF_TY)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line526">526</span><span class="td">&nbsp;&nbsp;LIST_OF_TY_SetLength(X,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line527">527</span><span class="td">&nbsp;&nbsp;switch&nbsp;(Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line528">528</span><span class="td">&nbsp;&nbsp;&nbsp;RLIST_ALL_X,&nbsp;RLIST_ALL_Y:</span></span>
<span class="tr"><span class="th" id="line529">529</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line530">530</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line531">531</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line532">532</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp++;</span></span>
<span class="tr"><span class="th" id="line533">533</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLIST_ALL_Y)&nbsp;tmp++;</span></span>
<span class="tr"><span class="th" id="line534">534</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line535">535</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(X,&nbsp;v,&nbsp;false,&nbsp;0,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line536">536</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line537">537</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line538">538</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line539">539</span><span class="td">&nbsp;&nbsp;&nbsp;RLIST_ALL_PAIRS:</span></span>
<span class="tr"><span class="th" id="line540">540</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;LIST_OF_TY_InsertItem&nbsp;will&nbsp;make&nbsp;a&nbsp;deep&nbsp;copy&nbsp;of&nbsp;the&nbsp;item,</span></span>
<span class="tr"><span class="th" id="line541">541</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;so&nbsp;we&nbsp;can&nbsp;reuse&nbsp;a&nbsp;single&nbsp;combination&nbsp;value&nbsp;here</span></span>
<span class="tr"><span class="th" id="line542">542</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
<span class="tr"><span class="th" id="line543">543</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueCreate(kov);</span></span>
<span class="tr"><span class="th" id="line544">544</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line545">545</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line546">546</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line547">547</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line548">548</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE,&nbsp;v);</span></span>
<span class="tr"><span class="th" id="line549">549</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line550">550</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE&nbsp;+&nbsp;1,&nbsp;v);</span></span>
<span class="tr"><span class="th" id="line551">551</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(X,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line552">552</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line553">553</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line554">554</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line555">555</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line556">556</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(Y);</span></span>
<span class="tr"><span class="th" id="line557">557</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line558">558</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line559">559</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line560">560</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line561">561</span><span class="td">&nbsp;at&nbsp;=&nbsp;DoubleHashSetLookUp(rel,&nbsp;kx,&nbsp;ky,&nbsp;X,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line562">562</span><span class="td">&nbsp;switch(task)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line563">563</span><span class="td">&nbsp;&nbsp;RELS_TEST:</span></span>
<span class="tr"><span class="th" id="line564">564</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line565">565</span><span class="td">&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line566">566</span><span class="td">&nbsp;&nbsp;RELS_ASSERT_TRUE:</span></span>
<span class="tr"><span class="th" id="line567">567</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line568">568</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;~at;</span></span>
<span class="tr"><span class="th" id="line569">569</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line570">570</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at)&nbsp;==&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line571">571</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line572">572</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;RRF_USED+RRF_SINGLE);</span></span>
<span class="tr"><span class="th" id="line573">573</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{&nbsp;X&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;X);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line574">574</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{&nbsp;Y&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(ky),&nbsp;Y);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line575">575</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line576">576</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line577">577</span><span class="td">&nbsp;&nbsp;&nbsp;DoubleHashSetCheckResize(rel);</span></span>
<span class="tr"><span class="th" id="line578">578</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line579">579</span><span class="td">&nbsp;&nbsp;RELS_ASSERT_FALSE:</span></span>
<span class="tr"><span class="th" id="line580">580</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line581">581</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;-&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line582">582</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))</span></span>
<span class="tr"><span class="th" id="line583">583</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line584">584</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))</span></span>
<span class="tr"><span class="th" id="line585">585</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2));</span></span>
<span class="tr"><span class="th" id="line586">586</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;RRF_DELETED);</span></span>
<span class="tr"><span class="th" id="line587">587</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line588">588</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line589">589</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line590">590</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line591">591</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line592">592</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line593">593</span><span class="td">[&nbsp;DoubleHashSetLookUp&nbsp;rel&nbsp;kx&nbsp;ky&nbsp;X&nbsp;Y&nbsp;&nbsp;hashv&nbsp;i&nbsp;free&nbsp;mask&nbsp;perturb&nbsp;flags;</span></span>
<span class="tr"><span class="th" id="line594">594</span><span class="td">&nbsp;!&nbsp;calculate&nbsp;a&nbsp;hash&nbsp;value&nbsp;for&nbsp;the&nbsp;pair</span></span>
<span class="tr"><span class="th" id="line595">595</span><span class="td">&nbsp;hashv&nbsp;=&nbsp;GetHashValue(kx,&nbsp;x)&nbsp;+&nbsp;GetHashValue(ky,&nbsp;y);</span></span>
<span class="tr"><span class="th" id="line596">596</span><span class="td">&nbsp;!&nbsp;look&nbsp;in&nbsp;the&nbsp;first&nbsp;expected&nbsp;slot</span></span>
<span class="tr"><span class="th" id="line597">597</span><span class="td">&nbsp;mask&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line598">598</span><span class="td">&nbsp;i&nbsp;=&nbsp;hashv&nbsp;&amp;&nbsp;mask;</span></span>
<span class="tr"><span class="th" id="line599">599</span><span class="td">&nbsp;flags&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*i);</span></span>
<span class="tr"><span class="th" id="line600">600</span><span class="td">&nbsp;if&nbsp;(flags&nbsp;==&nbsp;0)&nbsp;return&nbsp;~i;</span></span>
<span class="tr"><span class="th" id="line601">601</span><span class="td">&nbsp;if&nbsp;(DoubleHashSetEntryMatches(rel,&nbsp;i,&nbsp;kx,&nbsp;ky,&nbsp;X,&nbsp;Y))&nbsp;return&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line602">602</span><span class="td">&nbsp;!&nbsp;not&nbsp;here,&nbsp;keep&nbsp;looking&nbsp;in&nbsp;sequence</span></span>
<span class="tr"><span class="th" id="line603">603</span><span class="td">&nbsp;free&nbsp;=&nbsp;-1;</span></span>
<span class="tr"><span class="th" id="line604">604</span><span class="td">&nbsp;if&nbsp;(flags&nbsp;&amp;&nbsp;RRF_DELETED)&nbsp;free&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line605">605</span><span class="td">&nbsp;perturb&nbsp;=&nbsp;hashv;</span></span>
<span class="tr"><span class="th" id="line606">606</span><span class="td">&nbsp;hashv&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line607">607</span><span class="td">&nbsp;for&nbsp;(::)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line608">608</span><span class="td">&nbsp;&nbsp;hashv&nbsp;=&nbsp;hashv*5&nbsp;+&nbsp;perturb&nbsp;+&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line609">609</span><span class="td">&nbsp;&nbsp;i&nbsp;=&nbsp;hashv&nbsp;&amp;&nbsp;mask;</span></span>
<span class="tr"><span class="th" id="line610">610</span><span class="td">&nbsp;&nbsp;flags&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*i);</span></span>
<span class="tr"><span class="th" id="line611">611</span><span class="td">&nbsp;&nbsp;if&nbsp;(flags&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line612">612</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(free&nbsp;&gt;=&nbsp;0)&nbsp;return&nbsp;~free;</span></span>
<span class="tr"><span class="th" id="line613">613</span><span class="td">&nbsp;&nbsp;&nbsp;return&nbsp;~i;</span></span>
<span class="tr"><span class="th" id="line614">614</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line615">615</span><span class="td">&nbsp;&nbsp;if&nbsp;(DoubleHashSetEntryMatches(rel,&nbsp;i,&nbsp;kx,&nbsp;ky,&nbsp;X,&nbsp;Y))</span></span>
<span class="tr"><span class="th" id="line616">616</span><span class="td">&nbsp;&nbsp;&nbsp;return&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line617">617</span><span class="td">&nbsp;&nbsp;if&nbsp;((free&nbsp;&lt;&nbsp;0)&nbsp;&amp;&amp;&nbsp;(flags&nbsp;&amp;&nbsp;RRF_DELETED))&nbsp;free&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line618">618</span><span class="td">&nbsp;&nbsp;#ifdef&nbsp;TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line619">619</span><span class="td">&nbsp;&nbsp;@log_shift&nbsp;perturb&nbsp;(-RRP_PERTURB_SHIFT)&nbsp;-&gt;&nbsp;perturb;</span></span>
<span class="tr"><span class="th" id="line620">620</span><span class="td">&nbsp;&nbsp;#ifnot;</span></span>
<span class="tr"><span class="th" id="line621">621</span><span class="td">&nbsp;&nbsp;@ushiftr&nbsp;perturb&nbsp;RRP_PERTURB_SHIFT&nbsp;perturb;</span></span>
<span class="tr"><span class="th" id="line622">622</span><span class="td">&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line623">623</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line624">624</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line625">625</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line626">626</span><span class="td">[&nbsp;DoubleHashSetCheckResize&nbsp;rel&nbsp;&nbsp;filled&nbsp;ext&nbsp;newext&nbsp;temp&nbsp;i&nbsp;at&nbsp;kov&nbsp;kx&nbsp;ky&nbsp;F&nbsp;X&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line627">627</span><span class="td">&nbsp;filled&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED);</span></span>
<span class="tr"><span class="th" id="line628">628</span><span class="td">&nbsp;ext&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE)&nbsp;+&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line629">629</span><span class="td">&nbsp;if&nbsp;(filled&nbsp;&gt;=&nbsp;(ext&nbsp;-&nbsp;filled)&nbsp;*&nbsp;RRP_CROWDED_IS)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line630">630</span><span class="td">&nbsp;&nbsp;!&nbsp;copy&nbsp;entries&nbsp;to&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line631">631</span><span class="td">&nbsp;&nbsp;temp&nbsp;=&nbsp;FlexAllocate(ext&nbsp;*&nbsp;(3*WORDSIZE),&nbsp;TEXT_TY,&nbsp;BLK_FLAG_WORD+BLK_FLAG_MULTIPLE);</span></span>
<span class="tr"><span class="th" id="line632">632</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;ext*3:&nbsp;i++)</span></span>
<span class="tr"><span class="th" id="line633">633</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(temp,&nbsp;i,&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE+i),&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line634">634</span><span class="td">&nbsp;&nbsp;!&nbsp;resize&nbsp;and&nbsp;clear&nbsp;our&nbsp;data</span></span>
<span class="tr"><span class="th" id="line635">635</span><span class="td">&nbsp;&nbsp;if&nbsp;(ext&nbsp;&gt;=&nbsp;RRP_LARGE_IS)&nbsp;newext&nbsp;=&nbsp;ext&nbsp;*&nbsp;RRP_RESIZE_LARGE;</span></span>
<span class="tr"><span class="th" id="line636">636</span><span class="td">&nbsp;&nbsp;else&nbsp;newext&nbsp;=&nbsp;ext&nbsp;*&nbsp;RRP_RESIZE_SMALL;</span></span>
<span class="tr"><span class="th" id="line637">637</span><span class="td">&nbsp;&nbsp;BlkValueSetLBCapacity(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;newext*3);</span></span>
<span class="tr"><span class="th" id="line638">638</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_STORAGE,&nbsp;newext&nbsp;-&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line639">639</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED));</span></span>
<span class="tr"><span class="th" id="line640">640</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;newext*3:&nbsp;i++)</span></span>
<span class="tr"><span class="th" id="line641">641</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE+i,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line642">642</span><span class="td">&nbsp;&nbsp;!&nbsp;copy&nbsp;entries&nbsp;back&nbsp;from&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line643">643</span><span class="td">&nbsp;&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line644">644</span><span class="td">&nbsp;&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;0);&nbsp;ky&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line645">645</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;ext:&nbsp;i++)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line646">646</span><span class="td">&nbsp;&nbsp;&nbsp;F&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;3*i,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line647">647</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(F&nbsp;==&nbsp;0&nbsp;||&nbsp;(F&nbsp;&amp;&nbsp;RRF_DELETED))&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line648">648</span><span class="td">&nbsp;&nbsp;&nbsp;X&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;3*i&nbsp;+&nbsp;1,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line649">649</span><span class="td">&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;3*i&nbsp;+&nbsp;2,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line650">650</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;DoubleHashSetLookUp(rel,&nbsp;kx,&nbsp;ky,&nbsp;X,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line651">651</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{&nbsp;print&nbsp;&quot;***&nbsp;Duplicate&nbsp;entry&nbsp;while&nbsp;resizing&nbsp;***^&quot;;&nbsp;rfalse;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line652">652</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;~at;</span></span>
<span class="tr"><span class="th" id="line653">653</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;F);</span></span>
<span class="tr"><span class="th" id="line654">654</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line655">655</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line656">656</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line657">657</span><span class="td">&nbsp;&nbsp;!&nbsp;done&nbsp;with&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line658">658</span><span class="td">&nbsp;&nbsp;FlexFree(temp);</span></span>
<span class="tr"><span class="th" id="line659">659</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line660">660</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line661">661</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line662">662</span><span class="td">[&nbsp;DoubleHashSetEntryMatches&nbsp;rel&nbsp;at&nbsp;kx&nbsp;ky&nbsp;X&nbsp;Y&nbsp;&nbsp;cx&nbsp;cy;</span></span>
<span class="tr"><span class="th" id="line663">663</span><span class="td">&nbsp;cx&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line664">664</span><span class="td">&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line665">665</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueCompare(cx,&nbsp;X)&nbsp;~=&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line666">666</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line667">667</span><span class="td">&nbsp;&nbsp;if&nbsp;(cx&nbsp;~=&nbsp;X)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line668">668</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line669">669</span><span class="td">&nbsp;cy&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line670">670</span><span class="td">&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line671">671</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueCompare(cy,&nbsp;Y)&nbsp;~=&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line672">672</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line673">673</span><span class="td">&nbsp;&nbsp;if&nbsp;(cy&nbsp;~=&nbsp;Y)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line674">674</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line675">675</span><span class="td">&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line676">676</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-hash-list-relation-handler">Hash List Relation Handler.</h3><p><p> This implements relations which are stored as a hash table mapping keys to either single values or lists of values. The storage comprises a list of three-word entries, either <em>(F, X, Y)</em> or <em>(F, X, L)</em>, where <em>F</em> is a flags word distinguishing between the two cases (among other things). In the latter case, <em>L</em> is a pointer to a list (<span class="fixed">LIST_OF_TY</span>) containing the values.<p></p><p> The &quot;storage&quot;, &quot;used&quot;, and &quot;filled&quot; words have the same meanings as above.<p></p><p> <span class="fixed"><a href="./RelationKind.i6t.html#line692">HashListRelationHandler</a></span> is a thin wrapper around <span class="fixed"><a href="./RelationKind.i6t.html#line791">HashCoreRelationHandler</a></span>, which is shared with two other handlers below.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line692">692</span><span class="td">[&nbsp;HashListRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y&nbsp;&nbsp;sym&nbsp;kov&nbsp;kx&nbsp;ky;</span></span>
<span class="tr"><span class="th" id="line693">693</span><span class="td">&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line694">694</span><span class="td">&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;0);&nbsp;ky&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line695">695</span><span class="td">&nbsp;return&nbsp;HashCoreRelationHandler(rel,&nbsp;task,&nbsp;kx,&nbsp;ky,&nbsp;X,&nbsp;Y,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line696">696</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-hash-table-relation-handler">Hash Table Relation Handler.</h3><p><p> This is the same as the Hash List Relation Handler above, except that only one value may be stored for each key. This implements various-to-one relations.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line704">704</span><span class="td">[&nbsp;HashTableRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y&nbsp;&nbsp;kov&nbsp;kx&nbsp;ky;</span></span>
<span class="tr"><span class="th" id="line705">705</span><span class="td">&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line706">706</span><span class="td">&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;0);&nbsp;ky&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line707">707</span><span class="td">&nbsp;return&nbsp;HashCoreRelationHandler(rel,&nbsp;task,&nbsp;kx,&nbsp;ky,&nbsp;X,&nbsp;Y,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line708">708</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-reversed-hash-table-relation-handler">Reversed Hash Table Relation Handler.</h3><p><p> This is the same as the Hash Table Relation Handler except that the sides are reversed. This implements one-to-various relations.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line715">715</span><span class="td">[&nbsp;ReversedHashTableRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y&nbsp;&nbsp;kov&nbsp;kx&nbsp;ky&nbsp;swap;</span></span>
<span class="tr"><span class="th" id="line716">716</span><span class="td">&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line717">717</span><span class="td">&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;0);&nbsp;ky&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line718">718</span><span class="td">&nbsp;switch&nbsp;(task)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line719">719</span><span class="td">&nbsp;&nbsp;RELS_SET_VALENCY:</span></span>
<span class="tr"><span class="th" id="line720">720</span><span class="td">&nbsp;&nbsp;&nbsp;return&nbsp;RELATION_TY_SetValency(rel,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line721">721</span><span class="td">&nbsp;&nbsp;RELS_TEST,&nbsp;RELS_ASSERT_TRUE,&nbsp;RELS_ASSERT_FALSE:</span></span>
<span class="tr"><span class="th" id="line722">722</span><span class="td">&nbsp;&nbsp;&nbsp;return&nbsp;HashCoreRelationHandler(rel,&nbsp;task,&nbsp;ky,&nbsp;kx,&nbsp;Y,&nbsp;X,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line723">723</span><span class="td">&nbsp;&nbsp;RELS_LOOKUP_ANY:</span></span>
<span class="tr"><span class="th" id="line724">724</span><span class="td">&nbsp;&nbsp;&nbsp;switch&nbsp;(Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line725">725</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RLANY_GET_X:&nbsp;Y&nbsp;=&nbsp;RLANY_GET_Y;</span></span>
<span class="tr"><span class="th" id="line726">726</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RLANY_GET_Y:&nbsp;Y&nbsp;=&nbsp;RLANY_GET_X;</span></span>
<span class="tr"><span class="th" id="line727">727</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RLANY_CAN_GET_X:&nbsp;Y&nbsp;=&nbsp;RLANY_CAN_GET_Y;</span></span>
<span class="tr"><span class="th" id="line728">728</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RLANY_CAN_GET_Y:&nbsp;Y&nbsp;=&nbsp;RLANY_CAN_GET_X;</span></span>
<span class="tr"><span class="th" id="line729">729</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line730">730</span><span class="td">&nbsp;&nbsp;RELS_LOOKUP_ALL_X:</span></span>
<span class="tr"><span class="th" id="line731">731</span><span class="td">&nbsp;&nbsp;&nbsp;task&nbsp;=&nbsp;RELS_LOOKUP_ALL_Y;</span></span>
<span class="tr"><span class="th" id="line732">732</span><span class="td">&nbsp;&nbsp;RELS_LOOKUP_ALL_Y:</span></span>
<span class="tr"><span class="th" id="line733">733</span><span class="td">&nbsp;&nbsp;&nbsp;task&nbsp;=&nbsp;RELS_LOOKUP_ALL_X;</span></span>
<span class="tr"><span class="th" id="line734">734</span><span class="td">&nbsp;&nbsp;RELS_SHOW:</span></span>
<span class="tr"><span class="th" id="line735">735</span><span class="td">&nbsp;&nbsp;&nbsp;swap=X;&nbsp;X=Y;&nbsp;Y=swap;</span></span>
<span class="tr"><span class="th" id="line736">736</span><span class="td">&nbsp;&nbsp;&nbsp;swap=kx;&nbsp;kx=ky;&nbsp;ky=swap;</span></span>
<span class="tr"><span class="th" id="line737">737</span><span class="td">&nbsp;&nbsp;&nbsp;RELS_LIST:</span></span>
<span class="tr"><span class="th" id="line738">738</span><span class="td">&nbsp;&nbsp;&nbsp;switch&nbsp;(Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line739">739</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RLIST_ALL_X:&nbsp;Y&nbsp;=&nbsp;RLIST_ALL_Y;</span></span>
<span class="tr"><span class="th" id="line740">740</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;RLIST_ALL_Y:&nbsp;Y&nbsp;=&nbsp;RLIST_ALL_X;</span></span>
<span class="tr"><span class="th" id="line741">741</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line742">742</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line743">743</span><span class="td">&nbsp;return&nbsp;HashCoreRelationHandler(rel,&nbsp;task,&nbsp;kx,&nbsp;ky,&nbsp;X,&nbsp;Y,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line744">744</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-symmetric-relation-handlers">Symmetric Relation Handlers.</h3><p><p> These are simple wrappers around the asymmetric handlers defined above. When a pair is inserted or removed, the wrappers insert or remove the reversed pair as well.<p></p><p><span class="fixed"><a href="./RelationKind.i6t.html#line758">SymDoubleHashSetRelationHandler</a></span> and <span class="fixed"><a href="./RelationKind.i6t.html#line764">SymHashListRelationHandler</a></span><br> implement symmetric V-to-V relations. <span class="fixed"><a href="./RelationKind.i6t.html#line770">Sym2in1HashTableRelationHandler</a></span> implements symmetric 1-to-1. (&quot;<span class="fixed">SymTwoInOneHashTableRelationHandler</span>&quot; would have exceeded Inform 6&#39;s 32-character name limit.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line758">758</span><span class="td">[&nbsp;SymDoubleHashSetRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line759">759</span><span class="td">&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_ASSERT_TRUE&nbsp;or&nbsp;RELS_ASSERT_FALSE)</span></span>
<span class="tr"><span class="th" id="line760">760</span><span class="td">&nbsp;&nbsp;DoubleHashSetRelationHandler(rel,&nbsp;task,&nbsp;Y,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line761">761</span><span class="td">&nbsp;return&nbsp;DoubleHashSetRelationHandler(rel,&nbsp;task,&nbsp;X,&nbsp;Y,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line762">762</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line763">763</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line764">764</span><span class="td">[&nbsp;SymHashListRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line765">765</span><span class="td">&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_ASSERT_TRUE&nbsp;or&nbsp;RELS_ASSERT_FALSE)</span></span>
<span class="tr"><span class="th" id="line766">766</span><span class="td">&nbsp;&nbsp;HashListRelationHandler(rel,&nbsp;task,&nbsp;Y,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line767">767</span><span class="td">&nbsp;return&nbsp;HashListRelationHandler(rel,&nbsp;task,&nbsp;X,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line768">768</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line769">769</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line770">770</span><span class="td">[&nbsp;Sym2in1HashTableRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line771">771</span><span class="td">&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_ASSERT_TRUE&nbsp;or&nbsp;RELS_ASSERT_FALSE)</span></span>
<span class="tr"><span class="th" id="line772">772</span><span class="td">&nbsp;&nbsp;TwoInOneHashTableRelationHandler(rel,&nbsp;task,&nbsp;Y,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line773">773</span><span class="td">&nbsp;return&nbsp;TwoInOneHashTableRelationHandler(rel,&nbsp;task,&nbsp;X,&nbsp;Y,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line774">774</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-hash-core-relation-handler">Hash Core Relation Handler.</h3><p><p> This implements the core functionality that is shared between <span class="fixed"><a href="./RelationKind.i6t.html#line692">HashListRelationHandler</a></span>, <span class="fixed"><a href="./RelationKind.i6t.html#line704">HashTableRelationHandler</a></span>, and <span class="fixed"><a href="./RelationKind.i6t.html#line715">ReversedHashTableRelationHandler</a></span>. All three handlers are the same except for whether the left or right side is the &quot;key&quot; and whether or not multiple values may be stored for a single key.<p></p><p> As noted above, the table contains three-word entries, <em>(F, X, Y)</em>, where <em>F</em> is a flags word. Only the hash code of <em>X</em> is used. If <em>F</em> includes <span class="fixed"><a href="./RelationKind.i6t.html#line70">RRF_SINGLE</a></span>, <em>Y</em> is a single value; otherwise, <em>Y</em> is a list (<span class="fixed">LIST_OF_TY</span>) of values. If <span class="fixed">mult</span> is zero, <span class="fixed"><a href="./RelationKind.i6t.html#line70">RRF_SINGLE</a></span> must always be set, allowing only one value per key: a new pair <em>(X, Y&#39;)</em> will replace the existing pair <em>(X, Y)</em>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line791">791</span><span class="td">[&nbsp;HashCoreRelationHandler&nbsp;rel&nbsp;task&nbsp;kx&nbsp;ky&nbsp;X&nbsp;Y&nbsp;mult&nbsp;&nbsp;sym&nbsp;rev&nbsp;at&nbsp;tmp&nbsp;fl;</span></span>
<span class="tr"><span class="th" id="line792">792</span><span class="td">&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_SET_VALENCY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line793">793</span><span class="td">&nbsp;&nbsp;return&nbsp;RELATION_TY_SetValency(rel,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line794">794</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_DESTROY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line795">795</span><span class="td">&nbsp;&nbsp;!&nbsp;clear</span></span>
<span class="tr"><span class="th" id="line796">796</span><span class="td">&nbsp;&nbsp;kx&nbsp;=&nbsp;KOVIsBlockValue(kx);&nbsp;ky&nbsp;=&nbsp;KOVIsBlockValue(ky);</span></span>
<span class="tr"><span class="th" id="line797">797</span><span class="td">&nbsp;&nbsp;if&nbsp;(~~(kx&nbsp;||&nbsp;ky))&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line798">798</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line799">799</span><span class="td">&nbsp;&nbsp;while&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line800">800</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line801">801</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line802">802</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(kx)&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line803">803</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ky&nbsp;||&nbsp;~~(fl&nbsp;&amp;&nbsp;RRF_SINGLE))</span></span>
<span class="tr"><span class="th" id="line804">804</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2));</span></span>
<span class="tr"><span class="th" id="line805">805</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line806">806</span><span class="td">&nbsp;&nbsp;&nbsp;at--;</span></span>
<span class="tr"><span class="th" id="line807">807</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line808">808</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line809">809</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_COPY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line810">810</span><span class="td">&nbsp;&nbsp;X&nbsp;=&nbsp;KOVIsBlockValue(kx);&nbsp;Y&nbsp;=&nbsp;KOVIsBlockValue(ky);</span></span>
<span class="tr"><span class="th" id="line811">811</span><span class="td">&nbsp;&nbsp;if&nbsp;(~~(X&nbsp;||&nbsp;Y))&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line812">812</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line813">813</span><span class="td">&nbsp;&nbsp;while&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line814">814</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line815">815</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line816">816</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(X)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line817">817</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line818">818</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line819">819</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line820">820</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line821">821</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;||&nbsp;~~(fl&nbsp;&amp;&nbsp;RRF_SINGLE))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line822">822</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line823">823</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(BlkValueWeakKind(tmp)),&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line824">824</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line825">825</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line826">826</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line827">827</span><span class="td">&nbsp;&nbsp;&nbsp;at--;</span></span>
<span class="tr"><span class="th" id="line828">828</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line829">829</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line830">830</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_SHOW)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line831">831</span><span class="td">&nbsp;&nbsp;print&nbsp;(string)&nbsp;BlkValueRead(rel,&nbsp;RRV_DESCRIPTION),&nbsp;&quot;:^&quot;;</span></span>
<span class="tr"><span class="th" id="line832">832</span><span class="td">&nbsp;&nbsp;!&nbsp;Z-machine&nbsp;doesn&#39;t&nbsp;have&nbsp;the&nbsp;room&nbsp;to&nbsp;let&nbsp;us&nbsp;pass&nbsp;sym/rev&nbsp;as&nbsp;parameters</span></span>
<span class="tr"><span class="th" id="line833">833</span><span class="td">&nbsp;&nbsp;switch&nbsp;(RELATION_TY_GetValency(rel))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line834">834</span><span class="td">&nbsp;&nbsp;&nbsp;RRVAL_SYM_V_TO_V:</span></span>
<span class="tr"><span class="th" id="line835">835</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;sym&nbsp;=&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line836">836</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;KOVComparisonFunction(kx);</span></span>
<span class="tr"><span class="th" id="line837">837</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(~~tmp)&nbsp;tmp&nbsp;=&nbsp;UnsignedCompare;</span></span>
<span class="tr"><span class="th" id="line838">838</span><span class="td">&nbsp;&nbsp;&nbsp;RRVAL_O_TO_V:</span></span>
<span class="tr"><span class="th" id="line839">839</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rev&nbsp;=&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line840">840</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line841">841</span><span class="td">&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line842">842</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line843">843</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line844">844</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;X&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line845">845</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line846">846</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line847">847</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sym&nbsp;&amp;&amp;&nbsp;tmp(X,&nbsp;Y)&nbsp;&gt;&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line848">848</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;&nbsp;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line849">849</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rev)&nbsp;PrintKindValuePair(ky,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line850">850</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;PrintKindValuePair(kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line851">851</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sym)&nbsp;print&nbsp;&quot;&nbsp;&lt;=&gt;&nbsp;&quot;;&nbsp;else&nbsp;print&nbsp;&quot;&nbsp;&gt;=&gt;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line852">852</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rev)&nbsp;PrintKindValuePair(kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line853">853</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;PrintKindValuePair(ky,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line854">854</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line855">855</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line856">856</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(mult=1:&nbsp;mult&lt;=LIST_OF_TY_GetLength(Y):&nbsp;mult++)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line857">857</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;LIST_OF_TY_GetItem(Y,&nbsp;mult);</span></span>
<span class="tr"><span class="th" id="line858">858</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sym&nbsp;&amp;&amp;&nbsp;tmp(X,&nbsp;fl)&nbsp;&gt;&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line859">859</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;&nbsp;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line860">860</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rev)&nbsp;PrintKindValuePair(ky,&nbsp;fl);</span></span>
<span class="tr"><span class="th" id="line861">861</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;PrintKindValuePair(kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line862">862</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sym)&nbsp;print&nbsp;&quot;&nbsp;&lt;=&gt;&nbsp;&quot;;&nbsp;else&nbsp;print&nbsp;&quot;&nbsp;&gt;=&gt;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line863">863</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rev)&nbsp;PrintKindValuePair(kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line864">864</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;PrintKindValuePair(ky,&nbsp;fl);</span></span>
<span class="tr"><span class="th" id="line865">865</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line866">866</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line867">867</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line868">868</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line869">869</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line870">870</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line871">871</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_EMPTY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line872">872</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line873">873</span><span class="td">&nbsp;&nbsp;if&nbsp;(X&nbsp;==&nbsp;1)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line874">874</span><span class="td">&nbsp;&nbsp;&nbsp;HashCoreRelationHandler(rel,&nbsp;RELS_DESTROY);</span></span>
<span class="tr"><span class="th" id="line875">875</span><span class="td">&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line876">876</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line877">877</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line878">878</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line879">879</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp&nbsp;+&nbsp;2,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line880">880</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line881">881</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line882">882</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line883">883</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line884">884</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line885">885</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line886">886</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ANY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line887">887</span><span class="td">&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_GET_Y&nbsp;or&nbsp;RLANY_CAN_GET_Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line888">888</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;HashCoreLookUp(rel,&nbsp;kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line889">889</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line890">890</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_CAN_GET_Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line891">891</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line892">892</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line893">893</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line894">894</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)&nbsp;return&nbsp;tmp;</span></span>
<span class="tr"><span class="th" id="line895">895</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;LIST_OF_TY_GetItem(tmp,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line896">896</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line897">897</span><span class="td">&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line898">898</span><span class="td">&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line899">899</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line900">900</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line901">901</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line902">902</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sym&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line903">903</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line904">904</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line905">905</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(X,&nbsp;sym)&nbsp;~=&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line906">906</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line907">907</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(X&nbsp;~=&nbsp;sym)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line908">908</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line909">909</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line910">910</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(LIST_OF_TY_FindItem(sym,&nbsp;X)&nbsp;==&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line911">911</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line912">912</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_CAN_GET_X)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line913">913</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line914">914</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line915">915</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line916">916</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line917">917</span><span class="td">&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_GET_X&nbsp;or&nbsp;RLANY_GET_Y)</span></span>
<span class="tr"><span class="th" id="line918">918</span><span class="td">&nbsp;&nbsp;&nbsp;print&nbsp;&quot;***&nbsp;Lookup&nbsp;failed:&nbsp;value&nbsp;not&nbsp;found&nbsp;***^&quot;;</span></span>
<span class="tr"><span class="th" id="line919">919</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line920">920</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ALL_X)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line921">921</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueWeakKind(Y)&nbsp;~=&nbsp;LIST_OF_TY)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line922">922</span><span class="td">&nbsp;&nbsp;LIST_OF_TY_SetLength(Y,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line923">923</span><span class="td">&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line924">924</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line925">925</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line926">926</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line927">927</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;sym&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line928">928</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line929">929</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line930">930</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(X,&nbsp;sym)&nbsp;~=&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line931">931</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line932">932</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(X&nbsp;~=&nbsp;sym)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line933">933</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line934">934</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line935">935</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(LIST_OF_TY_FindItem(sym,&nbsp;X)&nbsp;==&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line936">936</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line937">937</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(Y,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line938">938</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line939">939</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line940">940</span><span class="td">&nbsp;&nbsp;return&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line941">941</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ALL_Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line942">942</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueWeakKind(Y)&nbsp;~=&nbsp;LIST_OF_TY)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line943">943</span><span class="td">&nbsp;&nbsp;LIST_OF_TY_SetLength(Y,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line944">944</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;HashCoreLookUp(rel,&nbsp;kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line945">945</span><span class="td">&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line946">946</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line947">947</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line948">948</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line949">949</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)</span></span>
<span class="tr"><span class="th" id="line950">950</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(Y,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line951">951</span><span class="td">&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line952">952</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_AppendList(Y,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line953">953</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line954">954</span><span class="td">&nbsp;&nbsp;return&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line955">955</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LIST)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line956">956</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueWeakKind(X)&nbsp;~=&nbsp;LIST_OF_TY)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line957">957</span><span class="td">&nbsp;&nbsp;LIST_OF_TY_SetLength(X,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line958">958</span><span class="td">&nbsp;&nbsp;switch&nbsp;(Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line959">959</span><span class="td">&nbsp;&nbsp;&nbsp;RLIST_ALL_X:</span></span>
<span class="tr"><span class="th" id="line960">960</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line961">961</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line962">962</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line963">963</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)</span></span>
<span class="tr"><span class="th" id="line964">964</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(X,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line965">965</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line966">966</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line967">967</span><span class="td">&nbsp;&nbsp;&nbsp;RLIST_ALL_Y:</span></span>
<span class="tr"><span class="th" id="line968">968</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line969">969</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line970">970</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line971">971</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line972">972</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line973">973</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)</span></span>
<span class="tr"><span class="th" id="line974">974</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(X,&nbsp;tmp,&nbsp;false,&nbsp;0,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line975">975</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line976">976</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_AppendList(X,&nbsp;tmp,&nbsp;false,&nbsp;0,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line977">977</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line978">978</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line979">979</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line980">980</span><span class="td">&nbsp;&nbsp;&nbsp;RLIST_ALL_PAIRS:</span></span>
<span class="tr"><span class="th" id="line981">981</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(RELATION_TY_GetValency(rel)&nbsp;==&nbsp;RRVAL_O_TO_V)&nbsp;rev&nbsp;=&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line982">982</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;LIST_OF_TY_InsertItem&nbsp;will&nbsp;make&nbsp;a&nbsp;deep&nbsp;copy&nbsp;of&nbsp;the&nbsp;item,</span></span>
<span class="tr"><span class="th" id="line983">983</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;so&nbsp;we&nbsp;can&nbsp;reuse&nbsp;a&nbsp;single&nbsp;combination&nbsp;value&nbsp;here</span></span>
<span class="tr"><span class="th" id="line984">984</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueCreate(COMBINATION_TY,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line985">985</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line986">986</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line987">987</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line988">988</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line989">989</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE&nbsp;+&nbsp;rev,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line990">990</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line991">991</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line992">992</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE&nbsp;+&nbsp;1&nbsp;-&nbsp;rev,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line993">993</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(X,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line994">994</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line995">995</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(mult&nbsp;=&nbsp;LIST_OF_TY_GetLength(tmp):&nbsp;mult&nbsp;&gt;&nbsp;0:&nbsp;mult--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line996">996</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE&nbsp;+&nbsp;1&nbsp;-&nbsp;rev,</span></span>
<span class="tr"><span class="th" id="line997">997</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_GetItem(tmp,&nbsp;mult));</span></span>
<span class="tr"><span class="th" id="line998">998</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(X,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line999">999</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1000">1000</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1001">1001</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1002">1002</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1003">1003</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1004">1004</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1005">1005</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(Y);</span></span>
<span class="tr"><span class="th" id="line1006">1006</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line1007">1007</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1008">1008</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1009">1009</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1010">1010</span><span class="td">&nbsp;at&nbsp;=&nbsp;HashCoreLookUp(rel,&nbsp;kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1011">1011</span><span class="td">&nbsp;switch(task)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1012">1012</span><span class="td">&nbsp;&nbsp;RELS_TEST:</span></span>
<span class="tr"><span class="th" id="line1013">1013</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1014">1014</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line1015">1015</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1016">1016</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1017">1017</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1018">1018</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(tmp,&nbsp;Y)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1019">1019</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1020">1020</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;==&nbsp;Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1021">1021</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1022">1022</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1023">1023</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1024">1024</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;LIST_OF_TY_FindItem(tmp,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1025">1025</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1026">1026</span><span class="td">&nbsp;&nbsp;RELS_ASSERT_TRUE:</span></span>
<span class="tr"><span class="th" id="line1027">1027</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1028">1028</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;no&nbsp;entry&nbsp;exists&nbsp;for&nbsp;this&nbsp;key,&nbsp;just&nbsp;add&nbsp;one</span></span>
<span class="tr"><span class="th" id="line1029">1029</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;~at;</span></span>
<span class="tr"><span class="th" id="line1030">1030</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1031">1031</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at)&nbsp;==&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1032">1032</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1033">1033</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;RRF_USED+RRF_SINGLE);</span></span>
<span class="tr"><span class="th" id="line1034">1034</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{&nbsp;X&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;X);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1035">1035</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{&nbsp;Y&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(ky),&nbsp;Y);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1036">1036</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1037">1037</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1038">1038</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;HashCoreCheckResize(rel);</span></span>
<span class="tr"><span class="th" id="line1039">1039</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;break;</span></span>
<span class="tr"><span class="th" id="line1040">1040</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1041">1041</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;an&nbsp;entry&nbsp;exists:&nbsp;could&nbsp;be&nbsp;a&nbsp;list&nbsp;or&nbsp;a&nbsp;single&nbsp;value</span></span>
<span class="tr"><span class="th" id="line1042">1042</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);&nbsp;&nbsp;!&nbsp;flags</span></span>
<span class="tr"><span class="th" id="line1043">1043</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);&nbsp;!&nbsp;value&nbsp;or&nbsp;list</span></span>
<span class="tr"><span class="th" id="line1044">1044</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1045">1045</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;if&nbsp;Y&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;stored&nbsp;key,&nbsp;we&nbsp;have&nbsp;nothing&nbsp;to&nbsp;do</span></span>
<span class="tr"><span class="th" id="line1046">1046</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1047">1047</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(tmp,&nbsp;Y)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1048">1048</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1049">1049</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;==&nbsp;Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1050">1050</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1051">1051</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;it&#39;s&nbsp;different:&nbsp;either&nbsp;replace&nbsp;it&nbsp;or&nbsp;expand&nbsp;into&nbsp;a&nbsp;list,</span></span>
<span class="tr"><span class="th" id="line1052">1052</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;depending&nbsp;on&nbsp;the&nbsp;value&nbsp;of&nbsp;mult</span></span>
<span class="tr"><span class="th" id="line1053">1053</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(mult)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1054">1054</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueCreate(LIST_OF_TY);&nbsp;!&nbsp;new&nbsp;list</span></span>
<span class="tr"><span class="th" id="line1055">1055</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(fl,&nbsp;LIST_ITEM_KOV_F,&nbsp;ky);</span></span>
<span class="tr"><span class="th" id="line1056">1056</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_SetLength(fl,&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1057">1057</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(fl,&nbsp;LIST_ITEM_BASE,&nbsp;tmp);&nbsp;!&nbsp;do&nbsp;not&nbsp;copy</span></span>
<span class="tr"><span class="th" id="line1058">1058</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_PutItem(fl,&nbsp;2,&nbsp;Y);&nbsp;&nbsp;!&nbsp;copy&nbsp;if&nbsp;needed</span></span>
<span class="tr"><span class="th" id="line1059">1059</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;fl);</span></span>
<span class="tr"><span class="th" id="line1060">1060</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;RRF_USED);</span></span>
<span class="tr"><span class="th" id="line1061">1061</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1062">1062</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1063">1063</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(tmp);</span></span>
<span class="tr"><span class="th" id="line1064">1064</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(ky),&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1065">1065</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1066">1066</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1067">1067</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1068">1068</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1069">1069</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;if&nbsp;Y&nbsp;is&nbsp;present&nbsp;already,&nbsp;do&nbsp;nothing.&nbsp;otherwise&nbsp;add&nbsp;it.</span></span>
<span class="tr"><span class="th" id="line1070">1070</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(tmp,&nbsp;Y,&nbsp;0,&nbsp;0,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1071">1071</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1072">1072</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1073">1073</span><span class="td">&nbsp;&nbsp;RELS_ASSERT_FALSE:</span></span>
<span class="tr"><span class="th" id="line1074">1074</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1075">1075</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;an&nbsp;entry&nbsp;exists:&nbsp;could&nbsp;be&nbsp;a&nbsp;list&nbsp;or&nbsp;a&nbsp;single&nbsp;value</span></span>
<span class="tr"><span class="th" id="line1076">1076</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);&nbsp;&nbsp;!&nbsp;flags</span></span>
<span class="tr"><span class="th" id="line1077">1077</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);&nbsp;!&nbsp;value&nbsp;or&nbsp;list</span></span>
<span class="tr"><span class="th" id="line1078">1078</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_SINGLE)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1079">1079</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;if&nbsp;the&nbsp;stored&nbsp;key&nbsp;isn&#39;t&nbsp;Y,&nbsp;we&nbsp;have&nbsp;nothing&nbsp;to&nbsp;do</span></span>
<span class="tr"><span class="th" id="line1080">1080</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1081">1081</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(tmp,&nbsp;Y)&nbsp;~=&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1082">1082</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1083">1083</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;~=&nbsp;Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1084">1084</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1085">1085</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;delete&nbsp;the&nbsp;entry</span></span>
<span class="tr"><span class="th" id="line1086">1086</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))</span></span>
<span class="tr"><span class="th" id="line1087">1087</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2));</span></span>
<span class="tr"><span class="th" id="line1088">1088</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.DeleteEntryIgnoringY;</span></span>
<span class="tr"><span class="th" id="line1089">1089</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;-&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1090">1090</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))</span></span>
<span class="tr"><span class="th" id="line1091">1091</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line1092">1092</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;RRF_DELETED);</span></span>
<span class="tr"><span class="th" id="line1093">1093</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1094">1094</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1095">1095</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1096">1096</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;remove&nbsp;Y&nbsp;from&nbsp;the&nbsp;list&nbsp;if&nbsp;present</span></span>
<span class="tr"><span class="th" id="line1097">1097</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_RemoveValue(tmp,&nbsp;Y,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1098">1098</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;if&nbsp;the&nbsp;list&nbsp;is&nbsp;now&nbsp;empty,&nbsp;delete&nbsp;the&nbsp;whole&nbsp;entry</span></span>
<span class="tr"><span class="th" id="line1099">1099</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(LIST_OF_TY_GetLength(tmp)&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1100">1100</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(tmp);</span></span>
<span class="tr"><span class="th" id="line1101">1101</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump&nbsp;<a href="./RelationKind.i6t.html#line1088">DeleteEntryIgnoringY</a>;</span></span>
<span class="tr"><span class="th" id="line1102">1102</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1103">1103</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1104">1104</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1105">1105</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1106">1106</span><span class="td">&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1107">1107</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1108">1108</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1109">1109</span><span class="td">[&nbsp;HashCoreLookUp&nbsp;rel&nbsp;kx&nbsp;X&nbsp;&nbsp;hashv&nbsp;i&nbsp;free&nbsp;mask&nbsp;perturb&nbsp;flags;</span></span>
<span class="tr"><span class="th" id="line1110">1110</span><span class="td">!print&nbsp;&quot;[HCLU&nbsp;rel=&quot;,&nbsp;rel,&nbsp;&quot;&nbsp;kx=&quot;,&nbsp;kx,&nbsp;&quot;&nbsp;X=&quot;,&nbsp;X,&nbsp;&quot;:&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line1111">1111</span><span class="td">&nbsp;!&nbsp;calculate&nbsp;a&nbsp;hash&nbsp;value&nbsp;for&nbsp;the&nbsp;key</span></span>
<span class="tr"><span class="th" id="line1112">1112</span><span class="td">&nbsp;hashv&nbsp;=&nbsp;GetHashValue(kx,&nbsp;x);</span></span>
<span class="tr"><span class="th" id="line1113">1113</span><span class="td">&nbsp;!&nbsp;look&nbsp;in&nbsp;the&nbsp;first&nbsp;expected&nbsp;slot</span></span>
<span class="tr"><span class="th" id="line1114">1114</span><span class="td">&nbsp;mask&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1115">1115</span><span class="td">&nbsp;i&nbsp;=&nbsp;hashv&nbsp;&amp;&nbsp;mask;</span></span>
<span class="tr"><span class="th" id="line1116">1116</span><span class="td">!print&nbsp;&quot;hv=&quot;,&nbsp;hashv,&nbsp;&quot;,&nbsp;trying&nbsp;&quot;,&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1117">1117</span><span class="td">&nbsp;flags&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*i);</span></span>
<span class="tr"><span class="th" id="line1118">1118</span><span class="td">&nbsp;if&nbsp;(flags&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1119">1119</span><span class="td">!print&nbsp;&quot;&nbsp;-&nbsp;not&nbsp;found]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1120">1120</span><span class="td">&nbsp;&nbsp;return&nbsp;~i;</span></span>
<span class="tr"><span class="th" id="line1121">1121</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1122">1122</span><span class="td">&nbsp;if&nbsp;(HashCoreEntryMatches(rel,&nbsp;i,&nbsp;kx,&nbsp;X))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1123">1123</span><span class="td">!print&nbsp;&quot;&nbsp;-&nbsp;found]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1124">1124</span><span class="td">&nbsp;&nbsp;return&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1125">1125</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1126">1126</span><span class="td">&nbsp;!&nbsp;not&nbsp;here,&nbsp;keep&nbsp;looking&nbsp;in&nbsp;sequence</span></span>
<span class="tr"><span class="th" id="line1127">1127</span><span class="td">&nbsp;free&nbsp;=&nbsp;-1;</span></span>
<span class="tr"><span class="th" id="line1128">1128</span><span class="td">&nbsp;if&nbsp;(flags&nbsp;&amp;&nbsp;RRF_DELETED)&nbsp;free&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1129">1129</span><span class="td">&nbsp;perturb&nbsp;=&nbsp;hashv;</span></span>
<span class="tr"><span class="th" id="line1130">1130</span><span class="td">&nbsp;hashv&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1131">1131</span><span class="td">&nbsp;for&nbsp;(::)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1132">1132</span><span class="td">&nbsp;&nbsp;hashv&nbsp;=&nbsp;hashv*5&nbsp;+&nbsp;perturb&nbsp;+&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line1133">1133</span><span class="td">&nbsp;&nbsp;i&nbsp;=&nbsp;hashv&nbsp;&amp;&nbsp;mask;</span></span>
<span class="tr"><span class="th" id="line1134">1134</span><span class="td">!print&nbsp;&quot;,&nbsp;&quot;,&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1135">1135</span><span class="td">&nbsp;&nbsp;flags&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*i);</span></span>
<span class="tr"><span class="th" id="line1136">1136</span><span class="td">&nbsp;&nbsp;if&nbsp;(flags&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1137">1137</span><span class="td">!print&nbsp;&quot;&nbsp;-&nbsp;not&nbsp;found]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1138">1138</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(free&nbsp;&gt;=&nbsp;0)&nbsp;return&nbsp;~free;</span></span>
<span class="tr"><span class="th" id="line1139">1139</span><span class="td">&nbsp;&nbsp;&nbsp;return&nbsp;~i;</span></span>
<span class="tr"><span class="th" id="line1140">1140</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1141">1141</span><span class="td">&nbsp;&nbsp;if&nbsp;(HashCoreEntryMatches(rel,&nbsp;i,&nbsp;kx,&nbsp;X))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1142">1142</span><span class="td">!print&nbsp;&quot;&nbsp;-&nbsp;found]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1143">1143</span><span class="td">&nbsp;&nbsp;&nbsp;return&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1144">1144</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1145">1145</span><span class="td">&nbsp;&nbsp;if&nbsp;((free&nbsp;&lt;&nbsp;0)&nbsp;&amp;&amp;&nbsp;(flags&nbsp;&amp;&nbsp;RRF_DELETED))&nbsp;free&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1146">1146</span><span class="td">&nbsp;&nbsp;#ifdef&nbsp;TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line1147">1147</span><span class="td">&nbsp;&nbsp;@log_shift&nbsp;perturb&nbsp;(-RRP_PERTURB_SHIFT)&nbsp;-&gt;&nbsp;perturb;</span></span>
<span class="tr"><span class="th" id="line1148">1148</span><span class="td">&nbsp;&nbsp;#ifnot;</span></span>
<span class="tr"><span class="th" id="line1149">1149</span><span class="td">&nbsp;&nbsp;@ushiftr&nbsp;perturb&nbsp;RRP_PERTURB_SHIFT&nbsp;perturb;</span></span>
<span class="tr"><span class="th" id="line1150">1150</span><span class="td">&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line1151">1151</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1152">1152</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1153">1153</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1154">1154</span><span class="td">[&nbsp;HashCoreCheckResize&nbsp;rel&nbsp;&nbsp;filled&nbsp;ext&nbsp;newext&nbsp;temp&nbsp;i&nbsp;at&nbsp;kov&nbsp;kx&nbsp;F&nbsp;X&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line1155">1155</span><span class="td">&nbsp;filled&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED);</span></span>
<span class="tr"><span class="th" id="line1156">1156</span><span class="td">&nbsp;ext&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE)&nbsp;+&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line1157">1157</span><span class="td">&nbsp;if&nbsp;(filled&nbsp;&gt;=&nbsp;(ext&nbsp;-&nbsp;filled)&nbsp;*&nbsp;RRP_CROWDED_IS)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1158">1158</span><span class="td">&nbsp;&nbsp;!&nbsp;copy&nbsp;entries&nbsp;to&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line1159">1159</span><span class="td">&nbsp;&nbsp;temp&nbsp;=&nbsp;FlexAllocate(ext&nbsp;*&nbsp;(3*WORDSIZE),&nbsp;TEXT_TY,&nbsp;BLK_FLAG_WORD+BLK_FLAG_MULTIPLE);</span></span>
<span class="tr"><span class="th" id="line1160">1160</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;ext*3:&nbsp;i++)</span></span>
<span class="tr"><span class="th" id="line1161">1161</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(temp,&nbsp;i,&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE+i),&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1162">1162</span><span class="td">&nbsp;&nbsp;!&nbsp;resize&nbsp;and&nbsp;clear&nbsp;our&nbsp;data</span></span>
<span class="tr"><span class="th" id="line1163">1163</span><span class="td">&nbsp;&nbsp;if&nbsp;(ext&nbsp;&gt;=&nbsp;RRP_LARGE_IS)&nbsp;newext&nbsp;=&nbsp;ext&nbsp;*&nbsp;RRP_RESIZE_LARGE;</span></span>
<span class="tr"><span class="th" id="line1164">1164</span><span class="td">&nbsp;&nbsp;else&nbsp;newext&nbsp;=&nbsp;ext&nbsp;*&nbsp;RRP_RESIZE_SMALL;</span></span>
<span class="tr"><span class="th" id="line1165">1165</span><span class="td">&nbsp;&nbsp;BlkValueSetLBCapacity(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;newext*3);</span></span>
<span class="tr"><span class="th" id="line1166">1166</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_STORAGE,&nbsp;newext&nbsp;-&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1167">1167</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED));</span></span>
<span class="tr"><span class="th" id="line1168">1168</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;newext*3:&nbsp;i++)</span></span>
<span class="tr"><span class="th" id="line1169">1169</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE+i,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1170">1170</span><span class="td">&nbsp;&nbsp;!&nbsp;copy&nbsp;entries&nbsp;back&nbsp;from&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line1171">1171</span><span class="td">&nbsp;&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line1172">1172</span><span class="td">&nbsp;&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1173">1173</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;ext:&nbsp;i++)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1174">1174</span><span class="td">&nbsp;&nbsp;&nbsp;F&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;3*i,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1175">1175</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(F&nbsp;==&nbsp;0&nbsp;||&nbsp;(F&nbsp;&amp;&nbsp;RRF_DELETED))&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line1176">1176</span><span class="td">&nbsp;&nbsp;&nbsp;X&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;3*i&nbsp;+&nbsp;1,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1177">1177</span><span class="td">&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;3*i&nbsp;+&nbsp;2,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1178">1178</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;HashCoreLookUp(rel,&nbsp;kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1179">1179</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{&nbsp;print&nbsp;&quot;***&nbsp;Duplicate&nbsp;entry&nbsp;while&nbsp;resizing&nbsp;***^&quot;;&nbsp;rfalse;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1180">1180</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;~at;</span></span>
<span class="tr"><span class="th" id="line1181">1181</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;F);</span></span>
<span class="tr"><span class="th" id="line1182">1182</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1183">1183</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1184">1184</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1185">1185</span><span class="td">&nbsp;&nbsp;!&nbsp;done&nbsp;with&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line1186">1186</span><span class="td">&nbsp;&nbsp;FlexFree(temp);</span></span>
<span class="tr"><span class="th" id="line1187">1187</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1188">1188</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1189">1189</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1190">1190</span><span class="td">[&nbsp;HashCoreEntryMatches&nbsp;rel&nbsp;at&nbsp;kx&nbsp;X&nbsp;&nbsp;cx&nbsp;cy;</span></span>
<span class="tr"><span class="th" id="line1191">1191</span><span class="td">&nbsp;cx&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1192">1192</span><span class="td">&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1193">1193</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueCompare(cx,&nbsp;X)&nbsp;~=&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1194">1194</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1195">1195</span><span class="td">&nbsp;&nbsp;if&nbsp;(cx&nbsp;~=&nbsp;X)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1196">1196</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1197">1197</span><span class="td">&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1198">1198</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-equivalence-hash-table-relation-handler">Equivalence Hash Table Relation Handler.</h3><p><p> This implements group relations. The table format is identical to that used by <span class="fixed"><a href="./RelationKind.i6t.html#line791">HashCoreRelationHandler</a></span>, but we use it differently. Although the relation appears to relate Xs to Xs as far as the game is concerned, the table actually relates Xs to numbers, where each number identifies a group of related items. Any X not listed in the table is implicitly in a single-member group.<p></p><p> When a pair <em>(X, Y)</em> is inserted, one of four cases occurs:<p></p><p> 1. Neither <em>X</em> nor <em>Y</em> has a table entry. We search the table to find the next unused group number, then add both <em>X</em> and <em>Y</em> to that group.<p></p><p> 2. Both <em>X</em> and <em>Y</em> have existing table entries. If the group numbers differ, we walk through the table and change all occurrences of the higher number to the lower one.<p></p><p> 3. <em>X</em> has an existing table entry but <em>Y</em> does not. We add a <em>Y</em> entry using the group number of <em>X</em>.<p></p><p> 4. <em>Y</em> has an existing table entry but <em>X</em> does not. We add an <em>X</em> entry using the group number of <em>Y</em>.<p></p><p> When a pair <em>(X, Y)</em> is removed, we first verify that <em>X</em> and <em>Y</em> are in the same group, then delete the table entry for <em>X</em>. This may leave <em>Y</em> in a single-member group, which could be deleted, but detecting that situation would be inefficient, so we keep the <em>Y</em> entry regardless.<p></p><p> This code uses the Hash Core utility functions defined above.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1231">1231</span><span class="td">[&nbsp;EquivHashTableRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y&nbsp;&nbsp;kx&nbsp;at&nbsp;at2&nbsp;tmp&nbsp;fl&nbsp;i&nbsp;ext;</span></span>
<span class="tr"><span class="th" id="line1232">1232</span><span class="td">&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(BlkValueRead(rel,&nbsp;RRV_KIND),&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1233">1233</span><span class="td">&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_SET_VALENCY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1234">1234</span><span class="td">&nbsp;&nbsp;return&nbsp;RELATION_TY_SetValency(rel,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1235">1235</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_DESTROY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1236">1236</span><span class="td">&nbsp;&nbsp;!&nbsp;clear</span></span>
<span class="tr"><span class="th" id="line1237">1237</span><span class="td">&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1238">1238</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1239">1239</span><span class="td">&nbsp;&nbsp;&nbsp;while&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1240">1240</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line1241">1241</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1242">1242</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line1243">1243</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1244">1244</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at--;</span></span>
<span class="tr"><span class="th" id="line1245">1245</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1246">1246</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1247">1247</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1248">1248</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_COPY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1249">1249</span><span class="td">&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1250">1250</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1251">1251</span><span class="td">&nbsp;&nbsp;&nbsp;while&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1252">1252</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line1253">1253</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1254">1254</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1255">1255</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1256">1256</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1257">1257</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1258">1258</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at--;</span></span>
<span class="tr"><span class="th" id="line1259">1259</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1260">1260</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1261">1261</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1262">1262</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_SHOW)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1263">1263</span><span class="td">&nbsp;&nbsp;print&nbsp;(string)&nbsp;BlkValueRead(rel,&nbsp;RRV_DESCRIPTION),&nbsp;&quot;:^&quot;;</span></span>
<span class="tr"><span class="th" id="line1264">1264</span><span class="td">&nbsp;&nbsp;ext&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1265">1265</span><span class="td">&nbsp;&nbsp;!&nbsp;flag&nbsp;all&nbsp;items&nbsp;by&nbsp;negating&nbsp;their&nbsp;group&nbsp;numbers</span></span>
<span class="tr"><span class="th" id="line1266">1266</span><span class="td">&nbsp;&nbsp;for&nbsp;(at=0,&nbsp;X=RRV_DATA_BASE:&nbsp;at&lt;=ext:&nbsp;at++,&nbsp;X=X+3)</span></span>
<span class="tr"><span class="th" id="line1267">1267</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;X)&nbsp;&amp;&nbsp;RRF_USED)</span></span>
<span class="tr"><span class="th" id="line1268">1268</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;X&nbsp;+&nbsp;2,&nbsp;-(BlkValueRead(rel,&nbsp;X&nbsp;+&nbsp;2)));</span></span>
<span class="tr"><span class="th" id="line1269">1269</span><span class="td">&nbsp;&nbsp;!&nbsp;display&nbsp;groups,&nbsp;unflagging&nbsp;them&nbsp;as&nbsp;we&nbsp;go</span></span>
<span class="tr"><span class="th" id="line1270">1270</span><span class="td">&nbsp;&nbsp;for&nbsp;(at=0,&nbsp;X=RRV_DATA_BASE,&nbsp;fl=0:&nbsp;at&lt;=ext:&nbsp;at++,&nbsp;X=X+3,&nbsp;fl=0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1271">1271</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;X)&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1272">1272</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;X&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1273">1273</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&gt;&nbsp;0)&nbsp;continue;&nbsp;&nbsp;!&nbsp;already&nbsp;visited</span></span>
<span class="tr"><span class="th" id="line1274">1274</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;X&nbsp;+&nbsp;2,&nbsp;-fl);&nbsp;!&nbsp;unflag&nbsp;it</span></span>
<span class="tr"><span class="th" id="line1275">1275</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;display&nbsp;the&nbsp;group&nbsp;starting&nbsp;with&nbsp;this&nbsp;member,&nbsp;but&nbsp;only</span></span>
<span class="tr"><span class="th" id="line1276">1276</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;if&nbsp;there&nbsp;are&nbsp;more&nbsp;members&nbsp;in&nbsp;the&nbsp;group</span></span>
<span class="tr"><span class="th" id="line1277">1277</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;X&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1278">1278</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line1279">1279</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(at2=at+1,&nbsp;Y=RRV_DATA_BASE+3*at2:&nbsp;at2&lt;=ext:&nbsp;at2++,&nbsp;Y=Y+3)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1280">1280</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;Y)&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1281">1281</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;Y&nbsp;+&nbsp;2)&nbsp;~=&nbsp;fl)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line1282">1282</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;Y&nbsp;+&nbsp;2,&nbsp;-fl);</span></span>
<span class="tr"><span class="th" id="line1283">1283</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(~~i)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1284">1284</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;print&nbsp;the&nbsp;saved&nbsp;first&nbsp;member</span></span>
<span class="tr"><span class="th" id="line1285">1285</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;&nbsp;&nbsp;{&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line1286">1286</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintKindValuePair(kx,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1287">1287</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line1288">1288</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1289">1289</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;,&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line1290">1290</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintKindValuePair(kx,&nbsp;BlkValueRead(rel,&nbsp;Y&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line1291">1291</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1292">1292</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1293">1293</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(i)&nbsp;print&nbsp;&quot;&nbsp;}^&quot;;</span></span>
<span class="tr"><span class="th" id="line1294">1294</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1295">1295</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1296">1296</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1297">1297</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_EMPTY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1298">1298</span><span class="td">&nbsp;&nbsp;!&nbsp;never&nbsp;empty&nbsp;since&nbsp;R(x,x)&nbsp;is&nbsp;always&nbsp;true</span></span>
<span class="tr"><span class="th" id="line1299">1299</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1300">1300</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ANY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1301">1301</span><span class="td">&nbsp;&nbsp;!&nbsp;kind&nbsp;of&nbsp;a&nbsp;cheat,&nbsp;but&nbsp;it&#39;s&nbsp;faster&nbsp;than&nbsp;searching&nbsp;for&nbsp;a&nbsp;better&nbsp;value&nbsp;to&nbsp;return</span></span>
<span class="tr"><span class="th" id="line1302">1302</span><span class="td">&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_CAN_GET_X&nbsp;or&nbsp;RLANY_CAN_GET_Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1303">1303</span><span class="td">&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line1304">1304</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ALL_X&nbsp;or&nbsp;RELS_LOOKUP_ALL_Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1305">1305</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueWeakKind(Y)&nbsp;~=&nbsp;LIST_OF_TY)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1306">1306</span><span class="td">&nbsp;&nbsp;LIST_OF_TY_SetLength(Y,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1307">1307</span><span class="td">&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;LIST_ITEM_KOV_F,&nbsp;kx);</span></span>
<span class="tr"><span class="th" id="line1308">1308</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;HashCoreLookUp(rel,&nbsp;kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1309">1309</span><span class="td">&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1310">1310</span><span class="td">&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(Y,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1311">1311</span><span class="td">&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1312">1312</span><span class="td">&nbsp;&nbsp;&nbsp;X&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1313">1313</span><span class="td">&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1314">1314</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at;</span></span>
<span class="tr"><span class="th" id="line1315">1315</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1316">1316</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1317">1317</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2)&nbsp;~=&nbsp;X)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line1318">1318</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(Y,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line1319">1319</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1320">1320</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1321">1321</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1322">1322</span><span class="td">&nbsp;&nbsp;return&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line1323">1323</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LIST)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1324">1324</span><span class="td">&nbsp;&nbsp;print&nbsp;&quot;***&nbsp;Domains&nbsp;of&nbsp;equivalence&nbsp;relations&nbsp;cannot&nbsp;be&nbsp;listed&nbsp;***^&quot;;</span></span>
<span class="tr"><span class="th" id="line1325">1325</span><span class="td">&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line1326">1326</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1327">1327</span><span class="td">&nbsp;at&nbsp;=&nbsp;HashCoreLookUp(rel,&nbsp;kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1328">1328</span><span class="td">&nbsp;at2&nbsp;=&nbsp;HashCoreLookUp(rel,&nbsp;kx,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1329">1329</span><span class="td">&nbsp;switch(task)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1330">1330</span><span class="td">&nbsp;&nbsp;RELS_TEST:</span></span>
<span class="tr"><span class="th" id="line1331">1331</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1332">1332</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;X&nbsp;is&nbsp;a&nbsp;loner,&nbsp;but&nbsp;could&nbsp;still&nbsp;be&nbsp;true&nbsp;if&nbsp;X&nbsp;==&nbsp;Y</span></span>
<span class="tr"><span class="th" id="line1333">1333</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1334">1334</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(X,&nbsp;Y)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1335">1335</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1336">1336</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(X&nbsp;==&nbsp;Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1337">1337</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1338">1338</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1339">1339</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1340">1340</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&lt;&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1341">1341</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;==&nbsp;at2)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1342">1342</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1343">1343</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2&nbsp;+&nbsp;2)&nbsp;==&nbsp;tmp)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1344">1344</span><span class="td">&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1345">1345</span><span class="td">&nbsp;&nbsp;RELS_ASSERT_TRUE:</span></span>
<span class="tr"><span class="th" id="line1346">1346</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;if&nbsp;X&nbsp;and&nbsp;Y&nbsp;are&nbsp;the&nbsp;same,&nbsp;we&nbsp;have&nbsp;nothing&nbsp;to&nbsp;do</span></span>
<span class="tr"><span class="th" id="line1347">1347</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1348">1348</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(X,&nbsp;Y)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1349">1349</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1350">1350</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(X&nbsp;==&nbsp;Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1351">1351</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1352">1352</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1353">1353</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&lt;&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1354">1354</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;X&nbsp;and&nbsp;Y&nbsp;both&nbsp;missing:&nbsp;find&nbsp;a&nbsp;new&nbsp;group&nbsp;number&nbsp;and&nbsp;add&nbsp;both&nbsp;entries</span></span>
<span class="tr"><span class="th" id="line1355">1355</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;0;&nbsp;&nbsp;!&nbsp;candidate&nbsp;group&nbsp;number</span></span>
<span class="tr"><span class="th" id="line1356">1356</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ext&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1357">1357</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;=ext:&nbsp;i++)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1358">1358</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*i);</span></span>
<span class="tr"><span class="th" id="line1359">1359</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1360">1360</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*i&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1361">1361</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&gt;&nbsp;tmp)&nbsp;tmp&nbsp;=&nbsp;fl;</span></span>
<span class="tr"><span class="th" id="line1362">1362</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1363">1363</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1364">1364</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp++;&nbsp;&nbsp;&nbsp;!&nbsp;new&nbsp;group&nbsp;number</span></span>
<span class="tr"><span class="th" id="line1365">1365</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1366">1366</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;add&nbsp;X&nbsp;entry</span></span>
<span class="tr"><span class="th" id="line1367">1367</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;~at;</span></span>
<span class="tr"><span class="th" id="line1368">1368</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{&nbsp;X&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;X);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1369">1369</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line1370">1370</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;==&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1371">1371</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1372">1372</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;RRF_USED+RRF_SINGLE);</span></span>
<span class="tr"><span class="th" id="line1373">1373</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1374">1374</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1375">1375</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;add&nbsp;Y&nbsp;entry.&nbsp;at2&nbsp;might&nbsp;change&nbsp;if&nbsp;X&nbsp;and&nbsp;Y&nbsp;have&nbsp;the&nbsp;same&nbsp;hash&nbsp;code.</span></span>
<span class="tr"><span class="th" id="line1376">1376</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;~(HashCoreLookUp(rel,&nbsp;kx,&nbsp;Y));</span></span>
<span class="tr"><span class="th" id="line1377">1377</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{&nbsp;Y&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;Y);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1378">1378</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2);</span></span>
<span class="tr"><span class="th" id="line1379">1379</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;==&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1380">1380</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1381">1381</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2,&nbsp;RRF_USED+RRF_SINGLE);</span></span>
<span class="tr"><span class="th" id="line1382">1382</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2&nbsp;+&nbsp;1,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1383">1383</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2&nbsp;+&nbsp;2,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1384">1384</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump&nbsp;<a href="./RelationKind.i6t.html#line1423">CheckResize</a>;</span></span>
<span class="tr"><span class="th" id="line1385">1385</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1386">1386</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;X&nbsp;missing,&nbsp;Y&nbsp;present:&nbsp;add&nbsp;a&nbsp;new&nbsp;X&nbsp;entry</span></span>
<span class="tr"><span class="th" id="line1387">1387</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;~at;</span></span>
<span class="tr"><span class="th" id="line1388">1388</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{&nbsp;X&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;X);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1389">1389</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1390">1390</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at);</span></span>
<span class="tr"><span class="th" id="line1391">1391</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;==&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1392">1392</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1393">1393</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;RRF_USED+RRF_SINGLE);</span></span>
<span class="tr"><span class="th" id="line1394">1394</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1395">1395</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1396">1396</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1397">1397</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump&nbsp;<a href="./RelationKind.i6t.html#line1423">CheckResize</a>;</span></span>
<span class="tr"><span class="th" id="line1398">1398</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1399">1399</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&lt;&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1400">1400</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;X&nbsp;present,&nbsp;Y&nbsp;missing:&nbsp;add&nbsp;a&nbsp;new&nbsp;Y&nbsp;entry</span></span>
<span class="tr"><span class="th" id="line1401">1401</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;~at2;</span></span>
<span class="tr"><span class="th" id="line1402">1402</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{&nbsp;Y&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;Y);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1403">1403</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1404">1404</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2);</span></span>
<span class="tr"><span class="th" id="line1405">1405</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;==&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1406">1406</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1407">1407</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2,&nbsp;RRF_USED+RRF_SINGLE);</span></span>
<span class="tr"><span class="th" id="line1408">1408</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2&nbsp;+&nbsp;1,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1409">1409</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1410">1410</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2&nbsp;+&nbsp;2,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1411">1411</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump&nbsp;<a href="./RelationKind.i6t.html#line1423">CheckResize</a>;</span></span>
<span class="tr"><span class="th" id="line1412">1412</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1413">1413</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;X&nbsp;and&nbsp;Y&nbsp;both&nbsp;present:&nbsp;merge&nbsp;higher&nbsp;group&nbsp;into&nbsp;lower&nbsp;group</span></span>
<span class="tr"><span class="th" id="line1414">1414</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);&nbsp;!&nbsp;higher&nbsp;group</span></span>
<span class="tr"><span class="th" id="line1415">1415</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2&nbsp;+&nbsp;2);&nbsp;!&nbsp;lower&nbsp;group</span></span>
<span class="tr"><span class="th" id="line1416">1416</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;&lt;&nbsp;fl)&nbsp;{&nbsp;i&nbsp;=&nbsp;tmp;&nbsp;tmp&nbsp;=&nbsp;fl;&nbsp;fl&nbsp;=&nbsp;i;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1417">1417</span><span class="td">&nbsp;&nbsp;&nbsp;ext&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1418">1418</span><span class="td">&nbsp;&nbsp;&nbsp;for&nbsp;(at=0:&nbsp;at&lt;=ext:&nbsp;at++)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1419">1419</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2;</span></span>
<span class="tr"><span class="th" id="line1420">1420</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;i)&nbsp;==&nbsp;tmp)</span></span>
<span class="tr"><span class="th" id="line1421">1421</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;i,&nbsp;fl);</span></span>
<span class="tr"><span class="th" id="line1422">1422</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1423">1423</span><span class="td">&nbsp;&nbsp;&nbsp;.CheckResize;</span></span>
<span class="tr"><span class="th" id="line1424">1424</span><span class="td">&nbsp;&nbsp;&nbsp;HashCoreCheckResize(rel);</span></span>
<span class="tr"><span class="th" id="line1425">1425</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1426">1426</span><span class="td">&nbsp;&nbsp;RELS_ASSERT_FALSE:</span></span>
<span class="tr"><span class="th" id="line1427">1427</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;if&nbsp;X&nbsp;and&nbsp;Y&nbsp;are&nbsp;already&nbsp;in&nbsp;different&nbsp;groups,&nbsp;we&nbsp;have&nbsp;nothing&nbsp;to&nbsp;do</span></span>
<span class="tr"><span class="th" id="line1428">1428</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0&nbsp;||&nbsp;at2&nbsp;&lt;&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1429">1429</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1430">1430</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at2&nbsp;+&nbsp;2)&nbsp;~=&nbsp;tmp)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1431">1431</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;delete&nbsp;the&nbsp;entry&nbsp;for&nbsp;X</span></span>
<span class="tr"><span class="th" id="line1432">1432</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;-&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1433">1433</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))</span></span>
<span class="tr"><span class="th" id="line1434">1434</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line1435">1435</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at,&nbsp;RRF_DELETED);</span></span>
<span class="tr"><span class="th" id="line1436">1436</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1437">1437</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;3*at&nbsp;+&nbsp;2,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1438">1438</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1439">1439</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1440">1440</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-two-in-one-hash-table-relation-handler">Two-In-One Hash Table Relation Handler.</h3><p><p> This implements one-to-one relations, which are stored as a hash table mapping keys to single values and vice versa. To enforce the one-to-one constraint, we need the ability to quickly check whether a value is present. This could be done with two separate hash tables, one mapping X to Y and one the opposite, but in the interest of conserving memory, we use a single table for both.<p></p><p> Each four-word entry <em>(F, E, K, V)</em> consists of a flags word <em>F</em>, an entry key <em>E</em> (which may be a &quot;key&quot; or &quot;value&quot; in the hash table sense), a corresponding key <em>K</em> (when <em>E</em> is used as a value), and a corresponding value <em>V</em> (when <em>E</em> is used as a key). The pair of related values <em>(X, Y)</em> is represented as two table entries: <em>(F, X, _, Y)</em> and <em>(F, Y, X, _)</em>.<p></p><p> To conserve memory when block values are used, we only create one copy of <em>X</em> and/or <em>Y</em> to share between both entries. When adding a key or value which already exists on either side of the relation, the previous copy will be used. Copies are freed when they are no longer used as entry keys.<p></p><p> Each entry&#39;s flags word <em>F</em> indicates, in addition to the standard flags <span class="fixed"><a href="./RelationKind.i6t.html#line68">RRF_USED</a></span> and <span class="fixed"><a href="./RelationKind.i6t.html#line69">RRF_DELETED</a></span>, also whether the entry contains a corresponding key <em>K</em> and/or value <em>V</em> (<span class="fixed"><a href="./RelationKind.i6t.html#line71">RRF_HASX</a></span>, <span class="fixed"><a href="./RelationKind.i6t.html#line72">RRF_HASY</a></span>) and whether the entry&#39;s key is the same kind of value as <em>X</em> or <em>Y</em> (<span class="fixed"><a href="./RelationKind.i6t.html#line73">RRF_ENTKEYX</a></span>, <span class="fixed"><a href="./RelationKind.i6t.html#line74">RRF_ENTKEYY</a></span>). If both sides of the relation use thesame kind of value, or if both sides are word values, both <span class="fixed"><a href="./RelationKind.i6t.html#line73">RRF_ENTKEYX</a></span><br> and <span class="fixed"><a href="./RelationKind.i6t.html#line74">RRF_ENTKEYY</a></span> will be set on every used entry.<p></p><p> Of particular note for this handler is the utility function <span class="fixed"><a href="./RelationKind.i6t.html#line1742">TwoInOneDelete</a></span>, which clears one half of an entry (given its entry key), and optionally clears the corresponding other half stored in a different entry. That is, given the entries <em>(F, X, _, Y)</em> at index <span class="fixed">i</span> and <em>(F, Y, X, _)</em> elsewhere, <span class="fixed"><a href="./RelationKind.i6t.html#line1742">TwoInOneDelete(rel, i, kx, ky, RRF_ENTKEYX, 1)</a></span> will clear both entries and mark them as deleted. If, however, those entries overlap with other pairs &ndash; say they&#39;re <em>(F, X, A, Y)</em> and <em>(F, Y, X, B)</em> &ndash; then the same call to <span class="fixed"><a href="./RelationKind.i6t.html#line1742">TwoInOneDelete</a></span> will leave us with <em>(F, X, A, _)</em> and <em>(F, Y, _, B)</em>, having cleared the parts corresponding to the pair <em>(X, Y)</em> but not the parts corresponding to the pairs <em>(A, X)</em> and <em>(Y, B)</em>, and will not mark either as deleted. (Such overlap is only possible when the domains of <em>X</em> and <em>Y</em> are the same kind of value.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1483">1483</span><span class="td">[&nbsp;TwoInOneHashTableRelationHandler&nbsp;rel&nbsp;task&nbsp;X&nbsp;Y&nbsp;sym&nbsp;&nbsp;kov&nbsp;kx&nbsp;ky&nbsp;at&nbsp;at2&nbsp;tmp&nbsp;fl;</span></span>
<span class="tr"><span class="th" id="line1484">1484</span><span class="td">&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line1485">1485</span><span class="td">&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;0);&nbsp;ky&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1486">1486</span><span class="td">&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_SET_VALENCY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1487">1487</span><span class="td">&nbsp;&nbsp;return&nbsp;RELATION_TY_SetValency(rel,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1488">1488</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_DESTROY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1489">1489</span><span class="td">&nbsp;&nbsp;!&nbsp;clear</span></span>
<span class="tr"><span class="th" id="line1490">1490</span><span class="td">&nbsp;&nbsp;kx&nbsp;=&nbsp;KOVIsBlockValue(kx);&nbsp;ky&nbsp;=&nbsp;KOVIsBlockValue(ky);</span></span>
<span class="tr"><span class="th" id="line1491">1491</span><span class="td">&nbsp;&nbsp;if&nbsp;(~~(kx&nbsp;||&nbsp;ky))&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1492">1492</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1493">1493</span><span class="td">&nbsp;&nbsp;while&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1494">1494</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1495">1495</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)</span></span>
<span class="tr"><span class="th" id="line1496">1496</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((kx&nbsp;&amp;&amp;&nbsp;(fl&nbsp;&amp;&nbsp;RRF_ENTKEYX))&nbsp;||&nbsp;(ky&nbsp;&amp;&amp;&nbsp;(fl&nbsp;&amp;&nbsp;RRF_ENTKEYY)))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1497">1497</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line1498">1498</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1499">1499</span><span class="td">&nbsp;&nbsp;&nbsp;at--;</span></span>
<span class="tr"><span class="th" id="line1500">1500</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1501">1501</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1502">1502</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_COPY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1503">1503</span><span class="td">&nbsp;&nbsp;X&nbsp;=&nbsp;KOVIsBlockValue(kx);&nbsp;Y&nbsp;=&nbsp;KOVIsBlockValue(ky);</span></span>
<span class="tr"><span class="th" id="line1504">1504</span><span class="td">&nbsp;&nbsp;if&nbsp;(~~(X&nbsp;||&nbsp;Y))&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1505">1505</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1506">1506</span><span class="td">&nbsp;&nbsp;while&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1507">1507</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1508">1508</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_USED)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1509">1509</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((X&nbsp;&amp;&amp;&nbsp;(fl&nbsp;&amp;&nbsp;RRF_ENTKEYX))&nbsp;||&nbsp;(Y&nbsp;&amp;&amp;&nbsp;(fl&nbsp;&amp;&nbsp;RRF_ENTKEYY)))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1510">1510</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;copy&nbsp;the&nbsp;entry&nbsp;key</span></span>
<span class="tr"><span class="th" id="line1511">1511</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1512">1512</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_ENTKEYX)</span></span>
<span class="tr"><span class="th" id="line1513">1513</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1514">1514</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line1515">1515</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(ky),&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1516">1516</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1517">1517</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;update&nbsp;references&nbsp;in&nbsp;X/Y&nbsp;fields&nbsp;pointing&nbsp;here</span></span>
<span class="tr"><span class="th" id="line1518">1518</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_HASX)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1519">1519</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;kx,</span></span>
<span class="tr"><span class="th" id="line1520">1520</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;2),</span></span>
<span class="tr"><span class="th" id="line1521">1521</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RRF_ENTKEYX);</span></span>
<span class="tr"><span class="th" id="line1522">1522</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&gt;=&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1523">1523</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at2&nbsp;+&nbsp;3,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1524">1524</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1525">1525</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_HASY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1526">1526</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;ky,</span></span>
<span class="tr"><span class="th" id="line1527">1527</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3),</span></span>
<span class="tr"><span class="th" id="line1528">1528</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1529">1529</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&gt;=&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1530">1530</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at2&nbsp;+&nbsp;2,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1531">1531</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1532">1532</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1533">1533</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1534">1534</span><span class="td">&nbsp;&nbsp;&nbsp;at--;</span></span>
<span class="tr"><span class="th" id="line1535">1535</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1536">1536</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1537">1537</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_SHOW)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1538">1538</span><span class="td">&nbsp;&nbsp;print&nbsp;(string)&nbsp;BlkValueRead(rel,&nbsp;RRV_DESCRIPTION),&nbsp;&quot;:^&quot;;</span></span>
<span class="tr"><span class="th" id="line1539">1539</span><span class="td">&nbsp;&nbsp;if&nbsp;(sym)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1540">1540</span><span class="td">&nbsp;&nbsp;&nbsp;kov&nbsp;=&nbsp;KOVComparisonFunction(kx);</span></span>
<span class="tr"><span class="th" id="line1541">1541</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(~~kov)&nbsp;kov&nbsp;=&nbsp;UnsignedCompare;</span></span>
<span class="tr"><span class="th" id="line1542">1542</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1543">1543</span><span class="td">&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1544">1544</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1545">1545</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;((fl&nbsp;&amp;&nbsp;(RRF_USED+RRF_ENTKEYX+RRF_HASY))&nbsp;==</span></span>
<span class="tr"><span class="th" id="line1546">1546</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;(RRF_USED+RRF_ENTKEYX+RRF_HASY))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1547">1547</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;X&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1548">1548</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3);</span></span>
<span class="tr"><span class="th" id="line1549">1549</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sym&nbsp;&amp;&amp;&nbsp;kov(X,&nbsp;Y)&nbsp;&gt;&nbsp;0)&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line1550">1550</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;&nbsp;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line1551">1551</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;PrintKindValuePair(kx,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1552">1552</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sym)&nbsp;print&nbsp;&quot;&nbsp;&lt;=&gt;&nbsp;&quot;;&nbsp;else&nbsp;print&nbsp;&quot;&nbsp;&gt;=&gt;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line1553">1553</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;PrintKindValuePair(ky,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1554">1554</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line1555">1555</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1556">1556</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1557">1557</span><span class="td">&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line1558">1558</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_EMPTY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1559">1559</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1560">1560</span><span class="td">&nbsp;&nbsp;if&nbsp;(X&nbsp;==&nbsp;1)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1561">1561</span><span class="td">&nbsp;&nbsp;&nbsp;TwoInOneHashTableRelationHandler(rel,&nbsp;RELS_DESTROY);</span></span>
<span class="tr"><span class="th" id="line1562">1562</span><span class="td">&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1563">1563</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at;</span></span>
<span class="tr"><span class="th" id="line1564">1564</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1565">1565</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1566">1566</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp&nbsp;+&nbsp;2,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1567">1567</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;tmp&nbsp;+&nbsp;3,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1568">1568</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1569">1569</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1570">1570</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1571">1571</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1572">1572</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1573">1573</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1574">1574</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ANY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1575">1575</span><span class="td">&nbsp;&nbsp;switch&nbsp;(Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1576">1576</span><span class="td">&nbsp;&nbsp;&nbsp;RLANY_GET_X,&nbsp;RLANY_CAN_GET_X:</span></span>
<span class="tr"><span class="th" id="line1577">1577</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;ky,&nbsp;X,&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1578">1578</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1579">1579</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at;</span></span>
<span class="tr"><span class="th" id="line1580">1580</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_HASX)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1581">1581</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_CAN_GET_X)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1582">1582</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2);</span></span>
<span class="tr"><span class="th" id="line1583">1583</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1584">1584</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1585">1585</span><span class="td">&nbsp;&nbsp;&nbsp;RLANY_GET_Y,&nbsp;RLANY_CAN_GET_Y:</span></span>
<span class="tr"><span class="th" id="line1586">1586</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;kx,&nbsp;X,&nbsp;RRF_ENTKEYX);</span></span>
<span class="tr"><span class="th" id="line1587">1587</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1588">1588</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at;</span></span>
<span class="tr"><span class="th" id="line1589">1589</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_HASY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1590">1590</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_CAN_GET_Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1591">1591</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;3);</span></span>
<span class="tr"><span class="th" id="line1592">1592</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1593">1593</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1594">1594</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1595">1595</span><span class="td">&nbsp;&nbsp;if&nbsp;(Y&nbsp;==&nbsp;RLANY_GET_X&nbsp;or&nbsp;RLANY_GET_Y)</span></span>
<span class="tr"><span class="th" id="line1596">1596</span><span class="td">&nbsp;&nbsp;&nbsp;print&nbsp;&quot;***&nbsp;Lookup&nbsp;failed:&nbsp;value&nbsp;not&nbsp;found&nbsp;***^&quot;;</span></span>
<span class="tr"><span class="th" id="line1597">1597</span><span class="td">&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1598">1598</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ALL_X)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1599">1599</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;ky,&nbsp;X,&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1600">1600</span><span class="td">&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1601">1601</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at;</span></span>
<span class="tr"><span class="th" id="line1602">1602</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_HASX)</span></span>
<span class="tr"><span class="th" id="line1603">1603</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(Y,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;2));</span></span>
<span class="tr"><span class="th" id="line1604">1604</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1605">1605</span><span class="td">&nbsp;&nbsp;return&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line1606">1606</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LOOKUP_ALL_Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1607">1607</span><span class="td">&nbsp;&nbsp;at&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;kx,&nbsp;X,&nbsp;RRF_ENTKEYX);</span></span>
<span class="tr"><span class="th" id="line1608">1608</span><span class="td">&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1609">1609</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at;</span></span>
<span class="tr"><span class="th" id="line1610">1610</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;RRF_HASY)</span></span>
<span class="tr"><span class="th" id="line1611">1611</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(Y,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;3));</span></span>
<span class="tr"><span class="th" id="line1612">1612</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1613">1613</span><span class="td">&nbsp;&nbsp;return&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line1614">1614</span><span class="td">&nbsp;}&nbsp;else&nbsp;if&nbsp;(task&nbsp;==&nbsp;RELS_LIST)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1615">1615</span><span class="td">&nbsp;&nbsp;switch&nbsp;(Y)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1616">1616</span><span class="td">&nbsp;&nbsp;&nbsp;RLIST_ALL_X:</span></span>
<span class="tr"><span class="th" id="line1617">1617</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;RRF_USED+RRF_ENTKEYX+RRF_HASY;</span></span>
<span class="tr"><span class="th" id="line1618">1618</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;jump&nbsp;<a href="./RelationKind.i6t.html#line1621">ListEntryKeys</a>;</span></span>
<span class="tr"><span class="th" id="line1619">1619</span><span class="td">&nbsp;&nbsp;&nbsp;RLIST_ALL_Y:</span></span>
<span class="tr"><span class="th" id="line1620">1620</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;RRF_USED+RRF_ENTKEYY+RRF_HASX;</span></span>
<span class="tr"><span class="th" id="line1621">1621</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;.ListEntryKeys;</span></span>
<span class="tr"><span class="th" id="line1622">1622</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1623">1623</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at;</span></span>
<span class="tr"><span class="th" id="line1624">1624</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((BlkValueRead(rel,&nbsp;tmp)&nbsp;&amp;&nbsp;fl)&nbsp;==&nbsp;fl)</span></span>
<span class="tr"><span class="th" id="line1625">1625</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(X,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1),&nbsp;false,&nbsp;0,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1626">1626</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1627">1627</span><span class="td">&nbsp;&nbsp;&nbsp;RLIST_ALL_PAIRS:</span></span>
<span class="tr"><span class="th" id="line1628">1628</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(X,&nbsp;LIST_ITEM_KOV_F);</span></span>
<span class="tr"><span class="th" id="line1629">1629</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KindAtomic(tmp)&nbsp;~=&nbsp;COMBINATION_TY)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1630">1630</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;LIST_OF_TY_InsertItem&nbsp;will&nbsp;make&nbsp;a&nbsp;deep&nbsp;copy&nbsp;of&nbsp;the&nbsp;item,</span></span>
<span class="tr"><span class="th" id="line1631">1631</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;so&nbsp;we&nbsp;can&nbsp;reuse&nbsp;a&nbsp;single&nbsp;combination&nbsp;value&nbsp;here</span></span>
<span class="tr"><span class="th" id="line1632">1632</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueCreate(tmp);</span></span>
<span class="tr"><span class="th" id="line1633">1633</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(at&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE):&nbsp;at&nbsp;&gt;=&nbsp;0:&nbsp;at--)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1634">1634</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at;</span></span>
<span class="tr"><span class="th" id="line1635">1635</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;tmp);</span></span>
<span class="tr"><span class="th" id="line1636">1636</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((fl&nbsp;&amp;&nbsp;(RRF_USED+RRF_ENTKEYX+RRF_HASY))&nbsp;==</span></span>
<span class="tr"><span class="th" id="line1637">1637</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(RRF_USED+RRF_ENTKEYX+RRF_HASY))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1638">1638</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line1639">1639</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE&nbsp;+&nbsp;1,&nbsp;BlkValueRead(rel,&nbsp;tmp&nbsp;+&nbsp;3));</span></span>
<span class="tr"><span class="th" id="line1640">1640</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_OF_TY_InsertItem(X,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1641">1641</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1642">1642</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1643">1643</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1644">1644</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(Y,&nbsp;COMBINATION_ITEM_BASE&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1645">1645</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueFree(Y);</span></span>
<span class="tr"><span class="th" id="line1646">1646</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line1647">1647</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1648">1648</span><span class="td">&nbsp;&nbsp;return&nbsp;X;</span></span>
<span class="tr"><span class="th" id="line1649">1649</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1650">1650</span><span class="td">&nbsp;at&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;kx,&nbsp;X,&nbsp;RRF_ENTKEYX);</span></span>
<span class="tr"><span class="th" id="line1651">1651</span><span class="td">&nbsp;switch(task)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1652">1652</span><span class="td">&nbsp;&nbsp;RELS_TEST:</span></span>
<span class="tr"><span class="th" id="line1653">1653</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1654">1654</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1655">1655</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(~~(fl&nbsp;&amp;&nbsp;RRF_HASY))&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1656">1656</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3);</span></span>
<span class="tr"><span class="th" id="line1657">1657</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1658">1658</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(tmp,&nbsp;Y)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1659">1659</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1660">1660</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;==&nbsp;Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1661">1661</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1662">1662</span><span class="td">&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1663">1663</span><span class="td">&nbsp;&nbsp;RELS_ASSERT_TRUE:</span></span>
<span class="tr"><span class="th" id="line1664">1664</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1665">1665</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;create&nbsp;a&nbsp;new&nbsp;forward&nbsp;entry</span></span>
<span class="tr"><span class="th" id="line1666">1666</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;~at;</span></span>
<span class="tr"><span class="th" id="line1667">1667</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1668">1668</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1669">1669</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;==&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1670">1670</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1671">1671</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;RRF_USED+RRF_HASY+RRF_ENTKEYX;</span></span>
<span class="tr"><span class="th" id="line1672">1672</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(kx&nbsp;==&nbsp;ky&nbsp;||&nbsp;~~(KOVIsBlockValue(kx)&nbsp;||&nbsp;KOVIsBlockValue(ky)))</span></span>
<span class="tr"><span class="th" id="line1673">1673</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;fl&nbsp;+&nbsp;RRF_ENTKEYY;</span></span>
<span class="tr"><span class="th" id="line1674">1674</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at,&nbsp;fl);</span></span>
<span class="tr"><span class="th" id="line1675">1675</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(kx))&nbsp;{&nbsp;X&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(kx),&nbsp;X);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1676">1676</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1677">1677</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;2,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1678">1678</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1679">1679</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1680">1680</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_HASY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1681">1681</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;if&nbsp;the&nbsp;Y&nbsp;we&#39;re&nbsp;inserting&nbsp;is&nbsp;already&nbsp;there,&nbsp;we&#39;re&nbsp;done</span></span>
<span class="tr"><span class="th" id="line1682">1682</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3);</span></span>
<span class="tr"><span class="th" id="line1683">1683</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1684">1684</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(tmp,&nbsp;Y)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1685">1685</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1686">1686</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;==&nbsp;Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1687">1687</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1688">1688</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;it&#39;s&nbsp;different,&nbsp;so&nbsp;delete&nbsp;the&nbsp;reverse&nbsp;entry</span></span>
<span class="tr"><span class="th" id="line1689">1689</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;ky,&nbsp;tmp,&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1690">1690</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&gt;=&nbsp;0)&nbsp;TwoInOneDelete(rel,&nbsp;at2,&nbsp;kx,&nbsp;ky,&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1691">1691</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1692">1692</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at,&nbsp;fl&nbsp;+&nbsp;RRF_HASY);</span></span>
<span class="tr"><span class="th" id="line1693">1693</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1694">1694</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;use&nbsp;the&nbsp;existing&nbsp;copy&nbsp;of&nbsp;X</span></span>
<span class="tr"><span class="th" id="line1695">1695</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;X&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1696">1696</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1697">1697</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;use&nbsp;the&nbsp;existing&nbsp;copy&nbsp;of&nbsp;Y&nbsp;if&nbsp;there&nbsp;is&nbsp;one</span></span>
<span class="tr"><span class="th" id="line1698">1698</span><span class="td">&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;ky,&nbsp;Y,&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1699">1699</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1700">1700</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&gt;=&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1701">1701</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at2&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1702">1702</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;else</span></span>
<span class="tr"><span class="th" id="line1703">1703</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(ky),&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1704">1704</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1705">1705</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1706">1706</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1707">1707</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;!&nbsp;delete&nbsp;existing&nbsp;reverse&nbsp;entry&nbsp;(and&nbsp;its&nbsp;own&nbsp;forward&nbsp;entry)</span></span>
<span class="tr"><span class="th" id="line1708">1708</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;TwoInOneDelete(rel,&nbsp;at2,&nbsp;kx,&nbsp;ky,&nbsp;RRF_ENTKEYY,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1709">1709</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1710">1710</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;~at2;</span></span>
<span class="tr"><span class="th" id="line1711">1711</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1712">1712</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;create&nbsp;reverse&nbsp;entry</span></span>
<span class="tr"><span class="th" id="line1713">1713</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1714">1714</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at2);</span></span>
<span class="tr"><span class="th" id="line1715">1715</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fl&nbsp;==&nbsp;0)</span></span>
<span class="tr"><span class="th" id="line1716">1716</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED)&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1717">1717</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;fl&nbsp;|&nbsp;(RRF_USED+RRF_HASX+RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1718">1718</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(kx&nbsp;==&nbsp;ky&nbsp;||&nbsp;~~(KOVIsBlockValue(kx)&nbsp;||&nbsp;KOVIsBlockValue(ky)))</span></span>
<span class="tr"><span class="th" id="line1719">1719</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;fl&nbsp;|&nbsp;RRF_ENTKEYX;</span></span>
<span class="tr"><span class="th" id="line1720">1720</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at2,&nbsp;fl);</span></span>
<span class="tr"><span class="th" id="line1721">1721</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at2&nbsp;+&nbsp;1,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1722">1722</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at2&nbsp;+&nbsp;2,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1723">1723</span><span class="td">&nbsp;&nbsp;&nbsp;TwoInOneCheckResize(rel);</span></span>
<span class="tr"><span class="th" id="line1724">1724</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1725">1725</span><span class="td">&nbsp;&nbsp;RELS_ASSERT_FALSE:</span></span>
<span class="tr"><span class="th" id="line1726">1726</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;we&nbsp;only&nbsp;have&nbsp;work&nbsp;to&nbsp;do&nbsp;if&nbsp;the&nbsp;entry&nbsp;exists&nbsp;and&nbsp;has&nbsp;a&nbsp;Y&nbsp;which</span></span>
<span class="tr"><span class="th" id="line1727">1727</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;matches&nbsp;the&nbsp;Y&nbsp;we&#39;re&nbsp;deleting</span></span>
<span class="tr"><span class="th" id="line1728">1728</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&lt;&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1729">1729</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1730">1730</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;((fl&nbsp;&amp;&nbsp;RRF_HASY)&nbsp;==&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1731">1731</span><span class="td">&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3);</span></span>
<span class="tr"><span class="th" id="line1732">1732</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(KOVIsBlockValue(ky))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1733">1733</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(BlkValueCompare(tmp,&nbsp;Y)&nbsp;~=&nbsp;0)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1734">1734</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1735">1735</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(tmp&nbsp;~=&nbsp;Y)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1736">1736</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1737">1737</span><span class="td">&nbsp;&nbsp;&nbsp;TwoInOneDelete(rel,&nbsp;at,&nbsp;kx,&nbsp;ky,&nbsp;RRF_ENTKEYX,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1738">1738</span><span class="td">&nbsp;&nbsp;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1739">1739</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1740">1740</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1741">1741</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1742">1742</span><span class="td">[&nbsp;TwoInOneDelete&nbsp;rel&nbsp;at&nbsp;kx&nbsp;ky&nbsp;ekflag&nbsp;both&nbsp;&nbsp;fl&nbsp;at2&nbsp;E&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1743">1743</span><span class="td">!print&nbsp;&quot;[2in1DEL&nbsp;at=&quot;,&nbsp;at,&nbsp;&quot;&nbsp;(E=&quot;,&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1),&nbsp;&quot;)&nbsp;ekflag=&quot;,&nbsp;ekflag,&nbsp;&quot;&nbsp;both=&quot;,&nbsp;both,&nbsp;&quot;]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1744">1744</span><span class="td">&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1745">1745</span><span class="td">&nbsp;if&nbsp;(ekflag&nbsp;==&nbsp;RRF_ENTKEYX)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1746">1746</span><span class="td">&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_HASY)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1747">1747</span><span class="td">&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3;</span></span>
<span class="tr"><span class="th" id="line1748">1748</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(both)&nbsp;E&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;i);</span></span>
<span class="tr"><span class="th" id="line1749">1749</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;i,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1750">1750</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;delete&nbsp;matching&nbsp;Y&lt;-X&nbsp;entry&nbsp;if&nbsp;needed</span></span>
<span class="tr"><span class="th" id="line1751">1751</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(both)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1752">1752</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;ky,&nbsp;E,&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1753">1753</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&gt;=&nbsp;0)&nbsp;TwoInOneDelete(rel,&nbsp;at2,&nbsp;kx,&nbsp;ky,&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1754">1754</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;==&nbsp;at)&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1755">1755</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1756">1756</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;fl&nbsp;&amp;&nbsp;~RRF_HASY;</span></span>
<span class="tr"><span class="th" id="line1757">1757</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1758">1758</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1759">1759</span><span class="td">&nbsp;&nbsp;if&nbsp;(fl&nbsp;&amp;&nbsp;RRF_HASX)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1760">1760</span><span class="td">&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;2;</span></span>
<span class="tr"><span class="th" id="line1761">1761</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(both)&nbsp;E&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;i);</span></span>
<span class="tr"><span class="th" id="line1762">1762</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;i,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1763">1763</span><span class="td">&nbsp;&nbsp;&nbsp;!&nbsp;delete&nbsp;matching&nbsp;X-&gt;Y&nbsp;entry&nbsp;if&nbsp;needed</span></span>
<span class="tr"><span class="th" id="line1764">1764</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(both)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1765">1765</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;at2&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;kx,&nbsp;E,&nbsp;RRF_ENTKEYX);</span></span>
<span class="tr"><span class="th" id="line1766">1766</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;&gt;=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1767">1767</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TwoInOneDelete(rel,&nbsp;at2,&nbsp;kx,&nbsp;ky,&nbsp;RRF_ENTKEYX);</span></span>
<span class="tr"><span class="th" id="line1768">1768</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(at2&nbsp;==&nbsp;at)&nbsp;fl&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at);</span></span>
<span class="tr"><span class="th" id="line1769">1769</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1770">1770</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1771">1771</span><span class="td">&nbsp;&nbsp;&nbsp;fl&nbsp;=&nbsp;fl&nbsp;&amp;&nbsp;~RRF_HASX;</span></span>
<span class="tr"><span class="th" id="line1772">1772</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1773">1773</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1774">1774</span><span class="td">&nbsp;if&nbsp;((fl&nbsp;&amp;&nbsp;(RRF_HASX+RRF_HASY))&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1775">1775</span><span class="td">&nbsp;&nbsp;!&nbsp;entry&nbsp;is&nbsp;now&nbsp;empty,&nbsp;mark&nbsp;it&nbsp;deleted</span></span>
<span class="tr"><span class="th" id="line1776">1776</span><span class="td">&nbsp;&nbsp;if&nbsp;(((fl&nbsp;&amp;&nbsp;RRF_ENTKEYX)&nbsp;&amp;&amp;&nbsp;KOVIsBlockValue(kx))&nbsp;||</span></span>
<span class="tr"><span class="th" id="line1777">1777</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ky&nbsp;~=&nbsp;kx)&nbsp;&amp;&amp;&nbsp;(fl&nbsp;&amp;&nbsp;RRF_ENTKEYY)&nbsp;&amp;&amp;&nbsp;KOVIsBlockValue(ky)))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1778">1778</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueFree(BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1));</span></span>
<span class="tr"><span class="th" id="line1779">1779</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1780">1780</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at,&nbsp;RRF_DELETED);</span></span>
<span class="tr"><span class="th" id="line1781">1781</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1782">1782</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;2,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1783">1783</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1784">1784</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_USED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED)&nbsp;-&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1785">1785</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1786">1786</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at,&nbsp;fl);</span></span>
<span class="tr"><span class="th" id="line1787">1787</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1788">1788</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1789">1789</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1790">1790</span><span class="td">[&nbsp;TwoInOneLookUp&nbsp;rel&nbsp;ke&nbsp;E&nbsp;ekflag&nbsp;&nbsp;hashv&nbsp;i&nbsp;free&nbsp;mask&nbsp;perturb&nbsp;flags;</span></span>
<span class="tr"><span class="th" id="line1791">1791</span><span class="td">!print&nbsp;&quot;[2in1LU&nbsp;rel=&quot;,&nbsp;rel,&nbsp;&quot;&nbsp;ke=&quot;,&nbsp;ke,&nbsp;&quot;&nbsp;E=&quot;,&nbsp;E,&nbsp;&quot;&nbsp;ekf=&quot;,&nbsp;ekflag,&nbsp;&quot;:&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line1792">1792</span><span class="td">&nbsp;!&nbsp;calculate&nbsp;a&nbsp;hash&nbsp;value&nbsp;for&nbsp;the&nbsp;key</span></span>
<span class="tr"><span class="th" id="line1793">1793</span><span class="td">&nbsp;hashv&nbsp;=&nbsp;GetHashValue(ke,&nbsp;E);</span></span>
<span class="tr"><span class="th" id="line1794">1794</span><span class="td">&nbsp;!&nbsp;look&nbsp;in&nbsp;the&nbsp;first&nbsp;expected&nbsp;slot</span></span>
<span class="tr"><span class="th" id="line1795">1795</span><span class="td">&nbsp;mask&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1796">1796</span><span class="td">&nbsp;i&nbsp;=&nbsp;hashv&nbsp;&amp;&nbsp;mask;</span></span>
<span class="tr"><span class="th" id="line1797">1797</span><span class="td">!print&nbsp;&quot;hv=&quot;,&nbsp;hashv,&nbsp;&quot;,&nbsp;trying&nbsp;&quot;,&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1798">1798</span><span class="td">&nbsp;flags&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*i);</span></span>
<span class="tr"><span class="th" id="line1799">1799</span><span class="td">&nbsp;if&nbsp;(flags&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1800">1800</span><span class="td">!print&nbsp;&quot;&nbsp;-&nbsp;not&nbsp;found]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1801">1801</span><span class="td">&nbsp;&nbsp;return&nbsp;~i;</span></span>
<span class="tr"><span class="th" id="line1802">1802</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1803">1803</span><span class="td">&nbsp;if&nbsp;((flags&nbsp;&amp;&nbsp;ekflag)&nbsp;&amp;&amp;&nbsp;TwoInOneEntryMatches(rel,&nbsp;i,&nbsp;ke,&nbsp;E))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1804">1804</span><span class="td">!print&nbsp;&quot;&nbsp;-&nbsp;found]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1805">1805</span><span class="td">&nbsp;&nbsp;return&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1806">1806</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1807">1807</span><span class="td">&nbsp;!&nbsp;not&nbsp;here,&nbsp;keep&nbsp;looking&nbsp;in&nbsp;sequence</span></span>
<span class="tr"><span class="th" id="line1808">1808</span><span class="td">&nbsp;free&nbsp;=&nbsp;-1;</span></span>
<span class="tr"><span class="th" id="line1809">1809</span><span class="td">&nbsp;if&nbsp;(flags&nbsp;&amp;&nbsp;RRF_DELETED)&nbsp;free&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1810">1810</span><span class="td">&nbsp;perturb&nbsp;=&nbsp;hashv;</span></span>
<span class="tr"><span class="th" id="line1811">1811</span><span class="td">&nbsp;hashv&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1812">1812</span><span class="td">&nbsp;for&nbsp;(::)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1813">1813</span><span class="td">&nbsp;&nbsp;hashv&nbsp;=&nbsp;hashv*5&nbsp;+&nbsp;perturb&nbsp;+&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line1814">1814</span><span class="td">&nbsp;&nbsp;i&nbsp;=&nbsp;hashv&nbsp;&amp;&nbsp;mask;</span></span>
<span class="tr"><span class="th" id="line1815">1815</span><span class="td">!print&nbsp;&quot;,&nbsp;&quot;,&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1816">1816</span><span class="td">&nbsp;&nbsp;flags&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*i);</span></span>
<span class="tr"><span class="th" id="line1817">1817</span><span class="td">&nbsp;&nbsp;if&nbsp;(flags&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1818">1818</span><span class="td">!print&nbsp;&quot;&nbsp;-&nbsp;not&nbsp;found]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1819">1819</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(free&nbsp;&gt;=&nbsp;0)&nbsp;return&nbsp;~free;</span></span>
<span class="tr"><span class="th" id="line1820">1820</span><span class="td">&nbsp;&nbsp;&nbsp;return&nbsp;~i;</span></span>
<span class="tr"><span class="th" id="line1821">1821</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1822">1822</span><span class="td">&nbsp;&nbsp;if&nbsp;((flags&nbsp;&amp;&nbsp;ekflag)&nbsp;&amp;&amp;&nbsp;TwoInOneEntryMatches(rel,&nbsp;i,&nbsp;ke,&nbsp;E))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1823">1823</span><span class="td">!print&nbsp;&quot;&nbsp;-&nbsp;found]^&quot;;</span></span>
<span class="tr"><span class="th" id="line1824">1824</span><span class="td">&nbsp;&nbsp;&nbsp;return&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1825">1825</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1826">1826</span><span class="td">&nbsp;&nbsp;if&nbsp;((free&nbsp;&lt;&nbsp;0)&nbsp;&amp;&amp;&nbsp;(flags&nbsp;&amp;&nbsp;RRF_DELETED))&nbsp;free&nbsp;=&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line1827">1827</span><span class="td">&nbsp;&nbsp;#ifdef&nbsp;TARGET_ZCODE;</span></span>
<span class="tr"><span class="th" id="line1828">1828</span><span class="td">&nbsp;&nbsp;@log_shift&nbsp;perturb&nbsp;(-RRP_PERTURB_SHIFT)&nbsp;-&gt;&nbsp;perturb;</span></span>
<span class="tr"><span class="th" id="line1829">1829</span><span class="td">&nbsp;&nbsp;#ifnot;</span></span>
<span class="tr"><span class="th" id="line1830">1830</span><span class="td">&nbsp;&nbsp;@ushiftr&nbsp;perturb&nbsp;RRP_PERTURB_SHIFT&nbsp;perturb;</span></span>
<span class="tr"><span class="th" id="line1831">1831</span><span class="td">&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line1832">1832</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1833">1833</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1834">1834</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1835">1835</span><span class="td">[&nbsp;TwoInOneCheckResize&nbsp;rel&nbsp;&nbsp;filled&nbsp;ext&nbsp;newext&nbsp;temp&nbsp;i&nbsp;at&nbsp;kov&nbsp;kx&nbsp;ky&nbsp;F&nbsp;E&nbsp;X&nbsp;Y;</span></span>
<span class="tr"><span class="th" id="line1836">1836</span><span class="td">&nbsp;filled&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_FILLED);</span></span>
<span class="tr"><span class="th" id="line1837">1837</span><span class="td">&nbsp;ext&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_STORAGE)&nbsp;+&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line1838">1838</span><span class="td">&nbsp;if&nbsp;(filled&nbsp;&gt;=&nbsp;(ext&nbsp;-&nbsp;filled)&nbsp;*&nbsp;RRP_CROWDED_IS)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1839">1839</span><span class="td">&nbsp;&nbsp;!&nbsp;copy&nbsp;entries&nbsp;to&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line1840">1840</span><span class="td">&nbsp;&nbsp;temp&nbsp;=&nbsp;FlexAllocate(ext&nbsp;*&nbsp;(4*WORDSIZE),&nbsp;TEXT_TY,&nbsp;BLK_FLAG_WORD+BLK_FLAG_MULTIPLE);</span></span>
<span class="tr"><span class="th" id="line1841">1841</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;ext*4:&nbsp;i++)</span></span>
<span class="tr"><span class="th" id="line1842">1842</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(temp,&nbsp;i,&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE+i),&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1843">1843</span><span class="td">&nbsp;&nbsp;!&nbsp;resize&nbsp;and&nbsp;clear&nbsp;our&nbsp;data</span></span>
<span class="tr"><span class="th" id="line1844">1844</span><span class="td">&nbsp;&nbsp;if&nbsp;(ext&nbsp;&gt;=&nbsp;RRP_LARGE_IS)&nbsp;newext&nbsp;=&nbsp;ext&nbsp;*&nbsp;RRP_RESIZE_LARGE;</span></span>
<span class="tr"><span class="th" id="line1845">1845</span><span class="td">&nbsp;&nbsp;else&nbsp;newext&nbsp;=&nbsp;ext&nbsp;*&nbsp;RRP_RESIZE_SMALL;</span></span>
<span class="tr"><span class="th" id="line1846">1846</span><span class="td">&nbsp;&nbsp;BlkValueSetLBCapacity(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;newext*4);</span></span>
<span class="tr"><span class="th" id="line1847">1847</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_STORAGE,&nbsp;newext&nbsp;-&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1848">1848</span><span class="td">&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_FILLED,&nbsp;BlkValueRead(rel,&nbsp;RRV_USED));</span></span>
<span class="tr"><span class="th" id="line1849">1849</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;newext*4:&nbsp;i++)</span></span>
<span class="tr"><span class="th" id="line1850">1850</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE+i,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line1851">1851</span><span class="td">&nbsp;&nbsp;!&nbsp;copy&nbsp;entries&nbsp;back&nbsp;from&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line1852">1852</span><span class="td">&nbsp;&nbsp;kov&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_KIND);</span></span>
<span class="tr"><span class="th" id="line1853">1853</span><span class="td">&nbsp;&nbsp;kx&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;0);&nbsp;ky&nbsp;=&nbsp;KindBaseTerm(kov,&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1854">1854</span><span class="td">&nbsp;&nbsp;for&nbsp;(i=0:&nbsp;i&lt;ext:&nbsp;i++)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1855">1855</span><span class="td">&nbsp;&nbsp;&nbsp;F&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;4*i,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1856">1856</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(F&nbsp;==&nbsp;0&nbsp;||&nbsp;(F&nbsp;&amp;&nbsp;RRF_DELETED))&nbsp;continue;</span></span>
<span class="tr"><span class="th" id="line1857">1857</span><span class="td">&nbsp;&nbsp;&nbsp;E&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;4*i&nbsp;+&nbsp;1,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1858">1858</span><span class="td">&nbsp;&nbsp;&nbsp;X&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;4*i&nbsp;+&nbsp;2,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1859">1859</span><span class="td">&nbsp;&nbsp;&nbsp;Y&nbsp;=&nbsp;BlkValueRead(temp,&nbsp;4*i&nbsp;+&nbsp;3,&nbsp;true);</span></span>
<span class="tr"><span class="th" id="line1860">1860</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(F&nbsp;&amp;&nbsp;RRF_ENTKEYX)&nbsp;at&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;kx,&nbsp;E,&nbsp;RRF_ENTKEYX);</span></span>
<span class="tr"><span class="th" id="line1861">1861</span><span class="td">&nbsp;&nbsp;&nbsp;else&nbsp;at&nbsp;=&nbsp;TwoInOneLookUp(rel,&nbsp;ky,&nbsp;E,&nbsp;RRF_ENTKEYY);</span></span>
<span class="tr"><span class="th" id="line1862">1862</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(at&nbsp;&gt;=&nbsp;0)&nbsp;{&nbsp;print&nbsp;&quot;***&nbsp;Duplicate&nbsp;entry&nbsp;while&nbsp;resizing&nbsp;***^&quot;;&nbsp;rfalse;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1863">1863</span><span class="td">&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;~at;</span></span>
<span class="tr"><span class="th" id="line1864">1864</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at,&nbsp;F);</span></span>
<span class="tr"><span class="th" id="line1865">1865</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1,&nbsp;E);</span></span>
<span class="tr"><span class="th" id="line1866">1866</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;2,&nbsp;X);</span></span>
<span class="tr"><span class="th" id="line1867">1867</span><span class="td">&nbsp;&nbsp;&nbsp;BlkValueWrite(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;3,&nbsp;Y);</span></span>
<span class="tr"><span class="th" id="line1868">1868</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1869">1869</span><span class="td">&nbsp;&nbsp;!&nbsp;done&nbsp;with&nbsp;temporary&nbsp;space</span></span>
<span class="tr"><span class="th" id="line1870">1870</span><span class="td">&nbsp;&nbsp;FlexFree(temp);</span></span>
<span class="tr"><span class="th" id="line1871">1871</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1872">1872</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1873">1873</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1874">1874</span><span class="td">[&nbsp;TwoInOneEntryMatches&nbsp;rel&nbsp;at&nbsp;ke&nbsp;E&nbsp;&nbsp;ce;</span></span>
<span class="tr"><span class="th" id="line1875">1875</span><span class="td">&nbsp;ce&nbsp;=&nbsp;BlkValueRead(rel,&nbsp;RRV_DATA_BASE&nbsp;+&nbsp;4*at&nbsp;+&nbsp;1);</span></span>
<span class="tr"><span class="th" id="line1876">1876</span><span class="td">&nbsp;if&nbsp;(KOVIsBlockValue(ke))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1877">1877</span><span class="td">&nbsp;&nbsp;if&nbsp;(BlkValueCompare(ce,&nbsp;E)&nbsp;~=&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1878">1878</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line1879">1879</span><span class="td">&nbsp;&nbsp;if&nbsp;(ce&nbsp;~=&nbsp;E)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line1880">1880</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line1881">1881</span><span class="td">&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line1882">1882</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relationkind-empty">Empty.</h3><p><p> This implements the &quot;empty&quot; adjective. We can always check whether a relation is empty. For most relation types, we can cause the relation to become empty by removing all pairs: but this is impossible for equivalence relations, which are never empty, since any <em>X</em> is equivalent to itself. And we can never force a relation to become non-empty, since that would require making up data.<p></p><p> In any case, the implementation is delegated to the relation handler.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1894">1894</span><span class="td">[&nbsp;RELATION_TY_Empty&nbsp;rel&nbsp;set&nbsp;&nbsp;handler;</span></span>
<span class="tr"><span class="th" id="line1895">1895</span><span class="td">&nbsp;handler&nbsp;=&nbsp;RlnGetF(rel,&nbsp;RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line1896">1896</span><span class="td">&nbsp;return&nbsp;handler(rel,&nbsp;RELS_EMPTY,&nbsp;set);</span></span>
<span class="tr"><span class="th" id="line1897">1897</span><span class="td">];</span></span>
</div><footer><hr><p><em>From I6T lib 6/12N &copy; Graham Nelson and published under the <a href="https://github.com/zedlopez/standard_rules/blob/main/LICENSE.md">Artistic License 2.0</a>. Distributed with <a href="http://inform7.com/">Inform 7 6M62</a>.</em></p></footer></body></html>
