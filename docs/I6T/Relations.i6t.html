<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head><title>Relations</title>
  <style>
span.th, span.td { display: table-cell; }
span.td { padding-left: 2rem; }
span.th { width:4rem; text-align: right; }
span.tr { display: table-row;     counter-increment: linenum; }
.pre-lines { font-family: monospace; margin-left: 3rem; line-height: 1.5rem; }
/*span.line_no::before {
    content: counter(linenum);
    text-align: right;
    display: block;
    font-family: monospace;
    font-weight: normal;
}*/
h1 { margin: 0; }
.fixed { font-family: monospace }
.em { font-style: italic; }
.center { text-align: center; }
    body { font-family: sans-serif; margin: 1.5rem 0 3rem 3rem; background-color: #fafaf0; width: 80rem; }
    .pre { font-family: monospace; margin: auto; width: 80rem; }
#front_matter,.text { width: 48rem; }
/* h3 { margin-top: 1.5rem; padding-top: 1.5rem; }*/
.text { border-bottom: .5px solid black; border-top: .5px solid black; margin-top: 1rem;
padding-bottom: .5rem; margin-bottom: 1.5rem; margin-top: 1.75rem; padding-top: .25rem;}
footer { margin-top: 3rem; padding-top: 1rem; border-top: .5px solid black; margin-bottom: 0;}
/*.subtitle { font-weight: bold; font-size: 1.2rem; }*/
    </style>
</head>
<body>
<header>
<h1>I6 Template Layer</h1>
<div class="subtitle"><a href="http://inform7.com/">Inform 7 6M62</a> &bull; <a href="./index.html">Index</a> &bull; <a href="./Introduction.i6t.html">Introduction</a></div><hr></header>
<div id="front_matter">
<h2><a href="./Relations.i6t.txt">Relations.i6t</a></h2><h3 id="#relations-relation-records">Relation Records.</h3><p><p> See <a href="./RelationKind.i6t.html">RelationKind.i6t</a> for further explanation.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line12">12</span><span class="td">Constant RR_NAME             5;</span></span>
<span class="tr"><span class="th" id="line13">13</span><span class="td">Constant RR_PERMISSIONS        6;</span></span>
<span class="tr"><span class="th" id="line14">14</span><span class="td">Constant RR_STORAGE            7;</span></span>
<span class="tr"><span class="th" id="line15">15</span><span class="td">Constant RR_KIND            8;</span></span>
<span class="tr"><span class="th" id="line16">16</span><span class="td">Constant RR_HANDLER            9;</span></span>
<span class="tr"><span class="th" id="line17">17</span><span class="td">Constant RR_DESCRIPTION        10;</span></span>
</div><div class='text'>
<h3 id="#relations-valency-adjectives">Valency Adjectives.</h3><p><p> These are defined in the Standard Rules; the following routines must either test the state (if <span class="fixed">set</span> is negative), or change the state to <span class="fixed">set</span>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line24">24</span><span class="td">Constant VALENCY_MASK = RELS_EQUIVALENCE+RELS_SYMMETRIC+RELS_X_UNIQUE+RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line25">25</span><span class="td">[ RELATION_TY_EquivalenceAdjective rel set  perms state handler;</span></span>
<span class="tr"><span class="th" id="line26">26</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    perms = RlnGetF(rel, RR_PERMISSIONS);</span></span>
<span class="tr"><span class="th" id="line27">27</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (perms &amp; RELS_EQUIVALENCE) state = true;</span></span>
<span class="tr"><span class="th" id="line28">28</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (set &lt; 0) return state;</span></span>
<span class="tr"><span class="th" id="line29">29</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set) &amp;&amp; (state == false)) {</span></span>
<span class="tr"><span class="th" id="line30">30</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        perms = perms + RELS_EQUIVALENCE;</span></span>
<span class="tr"><span class="th" id="line31">31</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_SYMMETRIC == 0) perms = perms + RELS_SYMMETRIC;</span></span>
<span class="tr"><span class="th" id="line32">32</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line33">33</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set == false) &amp;&amp; (state)) {</span></span>
<span class="tr"><span class="th" id="line34">34</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        perms = perms - RELS_EQUIVALENCE;</span></span>
<span class="tr"><span class="th" id="line35">35</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_SYMMETRIC) perms = perms - RELS_SYMMETRIC;</span></span>
<span class="tr"><span class="th" id="line36">36</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line37">37</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    RlnSetF(rel, RR_PERMISSIONS, perms);</span></span>
<span class="tr"><span class="th" id="line38">38</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    handler = RlnGetF(rel, RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line39">39</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (handler(rel, RELS_SET_VALENCY, perms &amp; VALENCY_MASK) == 0)</span></span>
<span class="tr"><span class="th" id="line40">40</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        &quot;*** Can&#39;t change this to an equivalence relation ***&quot;;        </span></span>
<span class="tr"><span class="th" id="line41">41</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line42">42</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line43">43</span><span class="td">[ RELATION_TY_SymmetricAdjective rel set  perms state handler;</span></span>
<span class="tr"><span class="th" id="line44">44</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    perms = RlnGetF(rel, RR_PERMISSIONS);</span></span>
<span class="tr"><span class="th" id="line45">45</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (perms &amp; RELS_SYMMETRIC) state = true;</span></span>
<span class="tr"><span class="th" id="line46">46</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (set &lt; 0) return state;</span></span>
<span class="tr"><span class="th" id="line47">47</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set) &amp;&amp; (state == false)) perms = perms + RELS_SYMMETRIC;</span></span>
<span class="tr"><span class="th" id="line48">48</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set == false) &amp;&amp; (state)) perms = perms - RELS_SYMMETRIC;</span></span>
<span class="tr"><span class="th" id="line49">49</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    RlnSetF(rel, RR_PERMISSIONS, perms);</span></span>
<span class="tr"><span class="th" id="line50">50</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    handler = RlnGetF(rel, RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line51">51</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (handler(rel, RELS_SET_VALENCY, perms &amp; VALENCY_MASK) == 0)</span></span>
<span class="tr"><span class="th" id="line52">52</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        &quot;*** Can&#39;t change this to a symmetric relation ***&quot;;        </span></span>
<span class="tr"><span class="th" id="line53">53</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line54">54</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line55">55</span><span class="td">[ RELATION_TY_OToOAdjective rel set  perms state handler i;</span></span>
<span class="tr"><span class="th" id="line56">56</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    perms = RlnGetF(rel, RR_PERMISSIONS);</span></span>
<span class="tr"><span class="th" id="line57">57</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (perms &amp; (RELS_X_UNIQUE+RELS_Y_UNIQUE) == RELS_X_UNIQUE+RELS_Y_UNIQUE) state = true;</span></span>
<span class="tr"><span class="th" id="line58">58</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (set &lt; 0) return state;</span></span>
<span class="tr"><span class="th" id="line59">59</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set) &amp;&amp; (state == false)) {</span></span>
<span class="tr"><span class="th" id="line60">60</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_X_UNIQUE == 0) perms = perms + RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line61">61</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_Y_UNIQUE == 0) perms = perms + RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line62">62</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_EQUIVALENCE) perms = perms - RELS_EQUIVALENCE;</span></span>
<span class="tr"><span class="th" id="line63">63</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line64">64</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set == false) &amp;&amp; (state)) {</span></span>
<span class="tr"><span class="th" id="line65">65</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_X_UNIQUE) perms = perms - RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line66">66</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_Y_UNIQUE) perms = perms - RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line67">67</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line68">68</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    RlnSetF(rel, RR_PERMISSIONS, perms);</span></span>
<span class="tr"><span class="th" id="line69">69</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    handler = RlnGetF(rel, RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line70">70</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (handler(rel, RELS_SET_VALENCY, perms &amp; VALENCY_MASK) == 0)</span></span>
<span class="tr"><span class="th" id="line71">71</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        &quot;*** Can&#39;t change this to a one-to-one relation ***&quot;;        </span></span>
<span class="tr"><span class="th" id="line72">72</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line73">73</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line74">74</span><span class="td">[ RELATION_TY_OToVAdjective rel set  perms state handler;</span></span>
<span class="tr"><span class="th" id="line75">75</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    perms = RlnGetF(rel, RR_PERMISSIONS);</span></span>
<span class="tr"><span class="th" id="line76">76</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (perms &amp; (RELS_X_UNIQUE+RELS_Y_UNIQUE) == RELS_X_UNIQUE) state = true;</span></span>
<span class="tr"><span class="th" id="line77">77</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (set &lt; 0) return state;</span></span>
<span class="tr"><span class="th" id="line78">78</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set) &amp;&amp; (state == false)) {</span></span>
<span class="tr"><span class="th" id="line79">79</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_X_UNIQUE == 0) perms = perms + RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line80">80</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_Y_UNIQUE) perms = perms - RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line81">81</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_SYMMETRIC) perms = perms - RELS_SYMMETRIC;</span></span>
<span class="tr"><span class="th" id="line82">82</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_EQUIVALENCE) perms = perms - RELS_EQUIVALENCE;</span></span>
<span class="tr"><span class="th" id="line83">83</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line84">84</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set == false) &amp;&amp; (state)) {</span></span>
<span class="tr"><span class="th" id="line85">85</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_X_UNIQUE) perms = perms - RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line86">86</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_Y_UNIQUE) perms = perms - RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line87">87</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line88">88</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    RlnSetF(rel, RR_PERMISSIONS, perms);</span></span>
<span class="tr"><span class="th" id="line89">89</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    handler = RlnGetF(rel, RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line90">90</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (handler(rel, RELS_SET_VALENCY, perms &amp; VALENCY_MASK) == 0)</span></span>
<span class="tr"><span class="th" id="line91">91</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        &quot;*** Can&#39;t change this to a one-to-various relation ***&quot;;        </span></span>
<span class="tr"><span class="th" id="line92">92</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line93">93</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line94">94</span><span class="td">[ RELATION_TY_VToOAdjective rel set  perms state handler;</span></span>
<span class="tr"><span class="th" id="line95">95</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    perms = RlnGetF(rel, RR_PERMISSIONS);</span></span>
<span class="tr"><span class="th" id="line96">96</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (perms &amp; (RELS_X_UNIQUE+RELS_Y_UNIQUE) == RELS_Y_UNIQUE) state = true;</span></span>
<span class="tr"><span class="th" id="line97">97</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (set &lt; 0) return state;</span></span>
<span class="tr"><span class="th" id="line98">98</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set) &amp;&amp; (state == false)) {</span></span>
<span class="tr"><span class="th" id="line99">99</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_X_UNIQUE) perms = perms - RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line100">100</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_Y_UNIQUE == 0) perms = perms + RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line101">101</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_SYMMETRIC) perms = perms - RELS_SYMMETRIC;</span></span>
<span class="tr"><span class="th" id="line102">102</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_EQUIVALENCE) perms = perms - RELS_EQUIVALENCE;</span></span>
<span class="tr"><span class="th" id="line103">103</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line104">104</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set == false) &amp;&amp; (state)) {</span></span>
<span class="tr"><span class="th" id="line105">105</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_X_UNIQUE) perms = perms - RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line106">106</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_Y_UNIQUE) perms = perms - RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line107">107</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line108">108</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    RlnSetF(rel, RR_PERMISSIONS, perms);</span></span>
<span class="tr"><span class="th" id="line109">109</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    handler = RlnGetF(rel, RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line110">110</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (handler(rel, RELS_SET_VALENCY, perms &amp; VALENCY_MASK) == 0)</span></span>
<span class="tr"><span class="th" id="line111">111</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        &quot;*** Can&#39;t change this to a various-to-one relation ***&quot;;        </span></span>
<span class="tr"><span class="th" id="line112">112</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line113">113</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line114">114</span><span class="td">[ RELATION_TY_VToVAdjective rel set  perms state handler;</span></span>
<span class="tr"><span class="th" id="line115">115</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    perms = RlnGetF(rel, RR_PERMISSIONS);</span></span>
<span class="tr"><span class="th" id="line116">116</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (perms &amp; (RELS_X_UNIQUE+RELS_Y_UNIQUE) == 0) state = true;</span></span>
<span class="tr"><span class="th" id="line117">117</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (set &lt; 0) return state;</span></span>
<span class="tr"><span class="th" id="line118">118</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set) &amp;&amp; (state == false)) {</span></span>
<span class="tr"><span class="th" id="line119">119</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_X_UNIQUE) perms = perms - RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line120">120</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_Y_UNIQUE) perms = perms - RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line121">121</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line122">122</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((set == false) &amp;&amp; (state)) {</span></span>
<span class="tr"><span class="th" id="line123">123</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_X_UNIQUE == 0) perms = perms + RELS_X_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line124">124</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (perms &amp; RELS_Y_UNIQUE == 0) perms = perms + RELS_Y_UNIQUE;</span></span>
<span class="tr"><span class="th" id="line125">125</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line126">126</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    RlnSetF(rel, RR_PERMISSIONS, perms);</span></span>
<span class="tr"><span class="th" id="line127">127</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    handler = RlnGetF(rel, RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line128">128</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (handler(rel, RELS_SET_VALENCY, perms &amp; VALENCY_MASK) == 0)</span></span>
<span class="tr"><span class="th" id="line129">129</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        &quot;*** Can&#39;t change this to a various-to-various relation ***&quot;;        </span></span>
<span class="tr"><span class="th" id="line130">130</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-one-to-one-relations">One To One Relations.</h3><p><p> We provide routines to assert a 1-to-1 relation true, or to assert it false. The relation <span class="fixed">rel</span> is represented by a property number, and the property in question is used to store the fact of a relationship: <em>O<sub>1</sub> ~ O<sub>2</sub></em> if and only if <span class="fixed">O1.rel == O2</span>.<p></p><p> There is no routine to test a 1-to-1 relation, since the predicate calculus code in NI simplifies propositions which test these into direct looking up of the property relation.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line143">143</span><span class="td">[ Relation_Now1to1 obj1 relation_property obj2 ol; ! Assert 1-1 true</span></span>
<span class="tr"><span class="th" id="line144">144</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (obj2) objectloop (ol provides relation_property)</span></span>
<span class="tr"><span class="th" id="line145">145</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (ol.relation_property == obj2) ol.relation_property = nothing;</span></span>
<span class="tr"><span class="th" id="line146">146</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (obj1) obj1.relation_property = obj2;</span></span>
<span class="tr"><span class="th" id="line147">147</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line148">148</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line149">149</span><span class="td">[ Relation_NowN1toV obj1 relation_property obj2; ! Assert 1-1 false</span></span>
<span class="tr"><span class="th" id="line150">150</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((obj1) &amp;&amp; (obj1.relation_property == obj2)) obj1.relation_property = nothing;</span></span>
<span class="tr"><span class="th" id="line151">151</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line152">152</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line153">153</span><span class="td">[ Relation_Now1to1V obj1 obj2 KOV relation_property ol N; ! Assert 1-1 true</span></span>
<span class="tr"><span class="th" id="line154">154</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (obj2) {</span></span>
<span class="tr"><span class="th" id="line155">155</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        N = KOVDomainSize(KOV);</span></span>
<span class="tr"><span class="th" id="line156">156</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (ol=1: ol&lt;=N: ol++)</span></span>
<span class="tr"><span class="th" id="line157">157</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (GProperty(KOV, ol, relation_property) == obj2)</span></span>
<span class="tr"><span class="th" id="line158">158</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                WriteGProperty(KOV, ol, relation_property, 0);</span></span>
<span class="tr"><span class="th" id="line159">159</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line160">160</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (obj1) WriteGProperty(KOV, obj1, relation_property, obj2);</span></span>
<span class="tr"><span class="th" id="line161">161</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line162">162</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line163">163</span><span class="td">[ Relation_NowN1toVV obj1 obj2 KOV relation_property; ! Assert 1-1 false</span></span>
<span class="tr"><span class="th" id="line164">164</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((obj1) &amp;&amp; (GProperty(KOV, obj1, relation_property) == obj2))</span></span>
<span class="tr"><span class="th" id="line165">165</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        WriteGProperty(KOV, obj1, relation_property, 0);</span></span>
<span class="tr"><span class="th" id="line166">166</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-symmetric-one-to-one-relations">Symmetric One To One Relations.</h3><p><p> Here the relation is used for both objects: <em>O<sub>1</sub> ~ O<sub>2</sub></em> if and only if both <span class="fixed">O1.relation_property == O2</span> and <span class="fixed">O2.relation_property == O1</span>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line173">173</span><span class="td">[ Relation_NowS1to1 obj1 relation_property obj2; ! Assert symmetric 1-1 true</span></span>
<span class="tr"><span class="th" id="line174">174</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((obj1 ofclass Object) &amp;&amp; (obj1 provides relation_property) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line175">175</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        (obj2 ofclass Object) &amp;&amp; (obj2 provides relation_property)) {</span></span>
<span class="tr"><span class="th" id="line176">176</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (obj1.relation_property) { (obj1.relation_property).relation_property = 0; }</span></span>
<span class="tr"><span class="th" id="line177">177</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (obj2.relation_property) { (obj2.relation_property).relation_property = 0; }</span></span>
<span class="tr"><span class="th" id="line178">178</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        obj1.relation_property = obj2; obj2.relation_property = obj1;</span></span>
<span class="tr"><span class="th" id="line179">179</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line180">180</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line181">181</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line182">182</span><span class="td">[ Relation_NowSN1to1 obj1 relation_property obj2; ! Assert symmetric 1-1 false</span></span>
<span class="tr"><span class="th" id="line183">183</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((obj1 ofclass Object) &amp;&amp; (obj1 provides relation_property) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line184">184</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        (obj2 ofclass Object) &amp;&amp; (obj2 provides relation_property) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line185">185</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        (obj1.relation_property == obj2)) {</span></span>
<span class="tr"><span class="th" id="line186">186</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        obj1.relation_property = 0; obj2.relation_property = 0;</span></span>
<span class="tr"><span class="th" id="line187">187</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line188">188</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line189">189</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line190">190</span><span class="td">[ Relation_NowS1to1V obj1 obj2 KOV relation_property; ! Assert symmetric 1-1 true</span></span>
<span class="tr"><span class="th" id="line191">191</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (GProperty(KOV, obj1, relation_property))</span></span>
<span class="tr"><span class="th" id="line192">192</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        WriteGProperty(KOV, GProperty(KOV, obj1, relation_property), relation_property, 0);</span></span>
<span class="tr"><span class="th" id="line193">193</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (GProperty(KOV, obj2, relation_property)) </span></span>
<span class="tr"><span class="th" id="line194">194</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        WriteGProperty(KOV, GProperty(KOV, obj2, relation_property), relation_property, 0);</span></span>
<span class="tr"><span class="th" id="line195">195</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    WriteGProperty(KOV, obj1, relation_property, obj2);</span></span>
<span class="tr"><span class="th" id="line196">196</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    WriteGProperty(KOV, obj2, relation_property, obj1);</span></span>
<span class="tr"><span class="th" id="line197">197</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line198">198</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line199">199</span><span class="td">[ Relation_NowSN1to1V obj1 obj2 KOV relation_property; ! Assert symmetric 1-1 false</span></span>
<span class="tr"><span class="th" id="line200">200</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (GProperty(KOV, obj1, relation_property) == obj2) {</span></span>
<span class="tr"><span class="th" id="line201">201</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        WriteGProperty(KOV, obj1, relation_property, 0);</span></span>
<span class="tr"><span class="th" id="line202">202</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        WriteGProperty(KOV, obj2, relation_property, 0);</span></span>
<span class="tr"><span class="th" id="line203">203</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line204">204</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-various-to-various-relations">Various To Various Relations.</h3><p><p> Here the relation is represented by an array holding its metadata. Each object in the domain of the relation provides two properties, holding its left index and its right index. The index is its position in the left or right domain. For instance, suppose we relate things to doors, and there are five things in the world, two of which are doors; then the left indexes will range from 0 to 4, while the right indexes will range from 0 to 1. It&#39;s very likely that the doors will have different left and right indexes. (If the relation relates a given kind to itself, say doors to doors, then left and right indexes will always be equal.)<p></p><p> It is possible for either the left or right domain set to be an enumerated kind of value, where the I6 representation of values is 1, 2, 3, ..., <em>N</em>, where there are <em>N</em> possibilities. In that case we obtain the index simply by subtracting 1 in order to begin from 0. We mark the domain set as being a KOV rather than a kind of object by storing 0 instead of a property in the relevant part of the relation metadata: note that 0 is not a valid property number.<p></p><p> The structure for a relation consists of eight <span class="fixed">--&gt;</span> words, followed by a bitmap in which we store 16 bits in each <span class="fixed">--&gt;</span> word. (Yes, this is wasteful in Glulx, where <span class="fixed">--&gt;</span> words store 32 bits, but memory is not in short supply in Glulx and the total cost of relations is in practice small; we prefer to keep all the code involved simple.) The structure is precompiled by the Inform compiler: we do not create new ones on the fly.<p></p><p> In the case of a symmetric various to various relation, we could in theory save memory once again by storing only the lower triangle of the bitmap, but the time and complexity overhead are not worth it. When asserting that <em>O<sub>1</sub> ~ O<sub>2</sub></em> for a symmetric V-to-V, we also automatically assert that <em>O<sub>2</sub> ~ O<sub>1</sub></em>, thus maintaining the bitmap as a symmetric matrix; but in reading the bitmap, we look only at the lower triangle. This costs a little time, but has the advantage of allowing the route-finding routine for V-to-V to use the same code for symmetric and asymmetric relations.<p></p><p> If this all seems rather suboptimally programmed in order to reduce code complexity, I can only say that careless drafts here were the source of some extremely difficult bugs to find.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line246">246</span><span class="td">Constant VTOVS_LEFT_INDEX_PROP = 0;</span></span>
<span class="tr"><span class="th" id="line247">247</span><span class="td">Constant VTOVS_RIGHT_INDEX_PROP = 1;</span></span>
<span class="tr"><span class="th" id="line248">248</span><span class="td">Constant VTOVS_LEFT_DOMAIN_SIZE = 2;</span></span>
<span class="tr"><span class="th" id="line249">249</span><span class="td">Constant VTOVS_RIGHT_DOMAIN_SIZE = 3;</span></span>
<span class="tr"><span class="th" id="line250">250</span><span class="td">Constant VTOVS_LEFT_PRINTING_ROUTINE = 4;</span></span>
<span class="tr"><span class="th" id="line251">251</span><span class="td">Constant VTOVS_RIGHT_PRINTING_ROUTINE = 5;</span></span>
<span class="tr"><span class="th" id="line252">252</span><span class="td">Constant VTOVS_CACHE_BROKEN = 6;</span></span>
<span class="tr"><span class="th" id="line253">253</span><span class="td">Constant VTOVS_CACHE = 7;</span></span>
<span class="tr"><span class="th" id="line254">254</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line255">255</span><span class="td">[ Relation_NowVtoV obj1 relation obj2 sym pr pr2 i1 i2 vtov_structure;</span></span>
<span class="tr"><span class="th" id="line256">256</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (sym &amp;&amp; (obj2 ~= obj1)) { Relation_NowVtoV(obj2, relation, obj1, false); }</span></span>
<span class="tr"><span class="th" id="line257">257</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line258">258</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = vtov_structure--&gt;VTOVS_LEFT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line259">259</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr2 = vtov_structure--&gt;VTOVS_RIGHT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line260">260</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure--&gt;VTOVS_CACHE_BROKEN = true; ! Mark any cache as broken</span></span>
<span class="tr"><span class="th" id="line261">261</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr) {</span></span>
<span class="tr"><span class="th" id="line262">262</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if ((obj1 ofclass Object) &amp;&amp; (obj1 provides pr)) i1 = obj1.pr;</span></span>
<span class="tr"><span class="th" id="line263">263</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        else return RunTimeProblem(RTP_IMPREL, obj1, relation);</span></span>
<span class="tr"><span class="th" id="line264">264</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else i1 = obj1-1;</span></span>
<span class="tr"><span class="th" id="line265">265</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr2) {</span></span>
<span class="tr"><span class="th" id="line266">266</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if ((obj2 ofclass Object) &amp;&amp; (obj2 provides pr2)) i2 = obj2.pr2;</span></span>
<span class="tr"><span class="th" id="line267">267</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        else return RunTimeProblem(RTP_IMPREL, obj2, relation);</span></span>
<span class="tr"><span class="th" id="line268">268</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else i2 = obj2-1;</span></span>
<span class="tr"><span class="th" id="line269">269</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = i1*(vtov_structure--&gt;VTOVS_RIGHT_DOMAIN_SIZE) + i2;</span></span>
<span class="tr"><span class="th" id="line270">270</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    i1 = IncreasingPowersOfTwo_TB--&gt;(pr%16);</span></span>
<span class="tr"><span class="th" id="line271">271</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = pr/16 + 8;</span></span>
<span class="tr"><span class="th" id="line272">272</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure--&gt;pr = (vtov_structure--&gt;pr) | i1;</span></span>
<span class="tr"><span class="th" id="line273">273</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line274">274</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line275">275</span><span class="td">[ Relation_NowNVtoV obj1 relation obj2 sym pr pr2 i1 i2 vtov_structure;</span></span>
<span class="tr"><span class="th" id="line276">276</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (sym &amp;&amp; (obj2 ~= obj1)) { Relation_NowNVtoV(obj2, relation, obj1, false); }</span></span>
<span class="tr"><span class="th" id="line277">277</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line278">278</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = vtov_structure--&gt;VTOVS_LEFT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line279">279</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr2 = vtov_structure--&gt;VTOVS_RIGHT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line280">280</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure--&gt;VTOVS_CACHE_BROKEN = true; ! Mark any cache as broken</span></span>
<span class="tr"><span class="th" id="line281">281</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr) {</span></span>
<span class="tr"><span class="th" id="line282">282</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if ((obj1 ofclass Object) &amp;&amp; (obj1 provides pr)) i1 = obj1.pr;</span></span>
<span class="tr"><span class="th" id="line283">283</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        else return RunTimeProblem(RTP_IMPREL, obj1, relation);</span></span>
<span class="tr"><span class="th" id="line284">284</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else i1 = obj1-1;</span></span>
<span class="tr"><span class="th" id="line285">285</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr2) {</span></span>
<span class="tr"><span class="th" id="line286">286</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if ((obj2 ofclass Object) &amp;&amp; (obj2 provides pr2)) i2 = obj2.pr2;</span></span>
<span class="tr"><span class="th" id="line287">287</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        else return RunTimeProblem(RTP_IMPREL, obj2, relation);</span></span>
<span class="tr"><span class="th" id="line288">288</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else i2 = obj2-1;</span></span>
<span class="tr"><span class="th" id="line289">289</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = i1*(vtov_structure--&gt;VTOVS_RIGHT_DOMAIN_SIZE) + i2;</span></span>
<span class="tr"><span class="th" id="line290">290</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    i1 = IncreasingPowersOfTwo_TB--&gt;(pr%16);</span></span>
<span class="tr"><span class="th" id="line291">291</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = pr/16 + 8;</span></span>
<span class="tr"><span class="th" id="line292">292</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((vtov_structure--&gt;pr) &amp; i1) vtov_structure--&gt;pr = vtov_structure--&gt;pr - i1;</span></span>
<span class="tr"><span class="th" id="line293">293</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line294">294</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line295">295</span><span class="td">[ Relation_TestVtoV obj1 relation obj2 sym pr pr2 i1 i2 vtov_structure;</span></span>
<span class="tr"><span class="th" id="line296">296</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line297">297</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = vtov_structure--&gt;VTOVS_LEFT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line298">298</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr2 = vtov_structure--&gt;VTOVS_RIGHT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line299">299</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (sym &amp;&amp; (obj2 &gt; obj1)) { sym = obj1; obj1 = obj2; obj2 = sym; }</span></span>
<span class="tr"><span class="th" id="line300">300</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr) {</span></span>
<span class="tr"><span class="th" id="line301">301</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if ((obj1 ofclass Object) &amp;&amp; (obj1 provides pr)) i1 = obj1.pr;</span></span>
<span class="tr"><span class="th" id="line302">302</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        else { RunTimeProblem(RTP_IMPREL, obj1, relation); rfalse; }</span></span>
<span class="tr"><span class="th" id="line303">303</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else i1 = obj1-1;</span></span>
<span class="tr"><span class="th" id="line304">304</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr2) {</span></span>
<span class="tr"><span class="th" id="line305">305</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if ((obj2 ofclass Object) &amp;&amp; (obj2 provides pr2)) i2 = obj2.pr2;</span></span>
<span class="tr"><span class="th" id="line306">306</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        else { RunTimeProblem(RTP_IMPREL, obj2, relation); rfalse; }</span></span>
<span class="tr"><span class="th" id="line307">307</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else i2 = obj2-1;</span></span>
<span class="tr"><span class="th" id="line308">308</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = i1*(vtov_structure--&gt;VTOVS_RIGHT_DOMAIN_SIZE) + i2;</span></span>
<span class="tr"><span class="th" id="line309">309</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    i1 = IncreasingPowersOfTwo_TB--&gt;(pr%16);</span></span>
<span class="tr"><span class="th" id="line310">310</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = pr/16 + 8;</span></span>
<span class="tr"><span class="th" id="line311">311</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((vtov_structure--&gt;pr) &amp; i1) rtrue; rfalse;</span></span>
<span class="tr"><span class="th" id="line312">312</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-equivalence-relations">Equivalence Relations.</h3><p><p> For every equivalence relation there is a corresponding function <em>f</em> such that <em>x ~ y</em> if and only if <em>f(x)=f(y)</em>, where <em>f(x)</em> is a number identifying the equivalence class of <em>x</em>. Rather than inefficiently storing a large relation bitmap (and then having a very complicated time updating it to keep the relation transitive), we store <em>f</em>: that is, for every object in the domain set, there is a property <span class="fixed">prop</span> such that <span class="fixed">O.prop</span> is the value <em>f(O)</em>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line324">324</span><span class="td">[ Relation_NowEquiv obj1 relation_property obj2 big little;</span></span>
<span class="tr"><span class="th" id="line325">325</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    big = obj1.relation_property; little = obj2.relation_property;</span></span>
<span class="tr"><span class="th" id="line326">326</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (big == little) return;</span></span>
<span class="tr"><span class="th" id="line327">327</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (big &lt; little) { little = obj1.relation_property; big = obj2.relation_property; }</span></span>
<span class="tr"><span class="th" id="line328">328</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (obj1 provides relation_property)</span></span>
<span class="tr"><span class="th" id="line329">329</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (obj1.relation_property == big) obj1.relation_property = little;</span></span>
<span class="tr"><span class="th" id="line330">330</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line331">331</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line332">332</span><span class="td">[ Relation_NowNEquiv obj1 relation_property obj2 old new;</span></span>
<span class="tr"><span class="th" id="line333">333</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    old = obj1.relation_property; new = obj2.relation_property;</span></span>
<span class="tr"><span class="th" id="line334">334</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (old ~= new) return;</span></span>
<span class="tr"><span class="th" id="line335">335</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    new = 0;</span></span>
<span class="tr"><span class="th" id="line336">336</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (obj2 provides relation_property)</span></span>
<span class="tr"><span class="th" id="line337">337</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (obj2.relation_property &gt; new) new = obj2.relation_property;</span></span>
<span class="tr"><span class="th" id="line338">338</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    new++;</span></span>
<span class="tr"><span class="th" id="line339">339</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    obj1.relation_property = new;</span></span>
<span class="tr"><span class="th" id="line340">340</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line341">341</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line342">342</span><span class="td">[ Relation_NowEquivV obj1 obj2 KOV relation_property n big little i;</span></span>
<span class="tr"><span class="th" id="line343">343</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    big = GProperty(KOV, obj1, relation_property);</span></span>
<span class="tr"><span class="th" id="line344">344</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    little = GProperty(KOV, obj2, relation_property);</span></span>
<span class="tr"><span class="th" id="line345">345</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (big == little) return;</span></span>
<span class="tr"><span class="th" id="line346">346</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (big &lt; little) {</span></span>
<span class="tr"><span class="th" id="line347">347</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        little = GProperty(KOV, obj1, relation_property);</span></span>
<span class="tr"><span class="th" id="line348">348</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        big = GProperty(KOV, obj2, relation_property);</span></span>
<span class="tr"><span class="th" id="line349">349</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line350">350</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    n = KOVDomainSize(KOV);</span></span>
<span class="tr"><span class="th" id="line351">351</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    for (i=1: i&lt;=n: i++)</span></span>
<span class="tr"><span class="th" id="line352">352</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (GProperty(KOV, i, relation_property) == big)</span></span>
<span class="tr"><span class="th" id="line353">353</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            WriteGProperty(KOV, i, relation_property, little);</span></span>
<span class="tr"><span class="th" id="line354">354</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line355">355</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line356">356</span><span class="td">[ Relation_NowNEquivV obj1 obj2 KOV relation_property n old new i;</span></span>
<span class="tr"><span class="th" id="line357">357</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    old = GProperty(KOV, obj1, relation_property); </span></span>
<span class="tr"><span class="th" id="line358">358</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    new = GProperty(KOV, obj2, relation_property);</span></span>
<span class="tr"><span class="th" id="line359">359</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (old ~= new) return;</span></span>
<span class="tr"><span class="th" id="line360">360</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    new = 0;</span></span>
<span class="tr"><span class="th" id="line361">361</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    n = KOVDomainSize(KOV);</span></span>
<span class="tr"><span class="th" id="line362">362</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    for (i=1: i&lt;=n: i++)</span></span>
<span class="tr"><span class="th" id="line363">363</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (GProperty(KOV, i, relation_property) &gt; new)</span></span>
<span class="tr"><span class="th" id="line364">364</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            new = GProperty(KOV, i, relation_property);</span></span>
<span class="tr"><span class="th" id="line365">365</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    new++;</span></span>
<span class="tr"><span class="th" id="line366">366</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    WriteGProperty(KOV, obj1, relation_property, new);</span></span>
<span class="tr"><span class="th" id="line367">367</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-show-various-to-various">Show Various to Various.</h3><p><p> The rest of the code for relations has no use except for debugging: it implements the RELATIONS testing command. Speed is unimportant here.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line374">374</span><span class="td">[ Relation_ShowVtoV relation sym x obj1 obj2 pr pr2 proutine1 proutine2 vtov_structure;</span></span>
<span class="tr"><span class="th" id="line375">375</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line376">376</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = vtov_structure--&gt;VTOVS_LEFT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line377">377</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr2 = vtov_structure--&gt;VTOVS_RIGHT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line378">378</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    proutine1 = vtov_structure--&gt;VTOVS_LEFT_PRINTING_ROUTINE;</span></span>
<span class="tr"><span class="th" id="line379">379</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    proutine2 = vtov_structure--&gt;VTOVS_RIGHT_PRINTING_ROUTINE;</span></span>
<span class="tr"><span class="th" id="line380">380</span><span class="td">&nbsp; </span></span>
<span class="tr"><span class="th" id="line381">381</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr &amp;&amp; pr2) {</span></span>
<span class="tr"><span class="th" id="line382">382</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides pr)</span></span>
<span class="tr"><span class="th" id="line383">383</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          objectloop (obj2 provides pr2) {</span></span>
<span class="tr"><span class="th" id="line384">384</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (sym &amp;&amp; obj2 &gt; obj1) continue;</span></span>
<span class="tr"><span class="th" id="line385">385</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line386">386</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line387">387</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &quot;, (The) obj1;</span></span>
<span class="tr"><span class="th" id="line388">388</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (sym) print &quot;  &lt;=&gt;  &quot;; else print &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line389">389</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print (the) obj2, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line390">390</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line391">391</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          }</span></span>
<span class="tr"><span class="th" id="line392">392</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return;</span></span>
<span class="tr"><span class="th" id="line393">393</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line394">394</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr &amp;&amp; (pr2==0)) {</span></span>
<span class="tr"><span class="th" id="line395">395</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides pr)</span></span>
<span class="tr"><span class="th" id="line396">396</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          for (obj2=1:obj2&lt;=vtov_structure--&gt;VTOVS_RIGHT_DOMAIN_SIZE:obj2++) {</span></span>
<span class="tr"><span class="th" id="line397">397</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line398">398</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line399">399</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &quot;, (The) obj1, &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line400">400</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (proutine2).call(obj2);</span></span>
<span class="tr"><span class="th" id="line401">401</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line402">402</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line403">403</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          }</span></span>
<span class="tr"><span class="th" id="line404">404</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return;</span></span>
<span class="tr"><span class="th" id="line405">405</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line406">406</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((pr==0) &amp;&amp; (pr2)) {</span></span>
<span class="tr"><span class="th" id="line407">407</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj1=1:obj1&lt;=vtov_structure--&gt;2:obj1++)</span></span>
<span class="tr"><span class="th" id="line408">408</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          objectloop (obj2 provides pr2) {</span></span>
<span class="tr"><span class="th" id="line409">409</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line410">410</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line411">411</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &quot;;</span></span>
<span class="tr"><span class="th" id="line412">412</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    (proutine1).call(obj1);</span></span>
<span class="tr"><span class="th" id="line413">413</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &gt;=&gt;  &quot;, (the) obj2, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line414">414</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line415">415</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          }</span></span>
<span class="tr"><span class="th" id="line416">416</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return;</span></span>
<span class="tr"><span class="th" id="line417">417</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line418">418</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    for (obj1=1:obj1&lt;=vtov_structure--&gt;2:obj1++)</span></span>
<span class="tr"><span class="th" id="line419">419</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          for (obj2=1:obj2&lt;=vtov_structure--&gt;VTOVS_RIGHT_DOMAIN_SIZE:obj2++)</span></span>
<span class="tr"><span class="th" id="line420">420</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line421">421</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line422">422</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                print &quot;  &quot;;</span></span>
<span class="tr"><span class="th" id="line423">423</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                (proutine1).call(obj1);</span></span>
<span class="tr"><span class="th" id="line424">424</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                print &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line425">425</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                (proutine2).call(obj2);</span></span>
<span class="tr"><span class="th" id="line426">426</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                print &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line427">427</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          }</span></span>
<span class="tr"><span class="th" id="line428">428</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-show-one-to-one">Show One to One.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line433">433</span><span class="td">[ Relation_ShowOtoO relation sym x relation_property t N obj1 obj2;</span></span>
<span class="tr"><span class="th" id="line434">434</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    relation_property = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line435">435</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    t = KindBaseTerm(RlnGetF(relation, RR_KIND), 0); ! Kind of left term</span></span>
<span class="tr"><span class="th" id="line436">436</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    N = KOVDomainSize(t);</span></span>
<span class="tr"><span class="th" id="line437">437</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (t == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line438">438</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides relation_property) {</span></span>
<span class="tr"><span class="th" id="line439">439</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            obj2 = obj1.relation_property;</span></span>
<span class="tr"><span class="th" id="line440">440</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (sym &amp;&amp; obj2 &lt; obj1) continue;</span></span>
<span class="tr"><span class="th" id="line441">441</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (obj2 == 0) continue;</span></span>
<span class="tr"><span class="th" id="line442">442</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line443">443</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            print &quot;  &quot;, (The) obj1;</span></span>
<span class="tr"><span class="th" id="line444">444</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (sym) print &quot;  ==  &quot;; else print &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line445">445</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            print (the) obj2, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line446">446</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line447">447</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else {</span></span>
<span class="tr"><span class="th" id="line448">448</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj1=1: obj1&lt;=N: obj1++) {</span></span>
<span class="tr"><span class="th" id="line449">449</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            obj2 = GProperty(t, obj1, relation_property);</span></span>
<span class="tr"><span class="th" id="line450">450</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (sym &amp;&amp; obj2 &lt; obj1) continue;</span></span>
<span class="tr"><span class="th" id="line451">451</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (obj2 == 0) continue;</span></span>
<span class="tr"><span class="th" id="line452">452</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line453">453</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            print &quot;  &quot;;</span></span>
<span class="tr"><span class="th" id="line454">454</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            PrintKindValuePair(t, obj1);</span></span>
<span class="tr"><span class="th" id="line455">455</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (sym) print &quot;  ==  &quot;; else print &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line456">456</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            PrintKindValuePair(t, obj2);</span></span>
<span class="tr"><span class="th" id="line457">457</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            print &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line458">458</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line459">459</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line460">460</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-show-reversed-one-to-one">Show Reversed One to One.</h3><p><p> There&#39;s no such kind of relation as this: but the same code used to show 1-to-1 relations is also used to show various-to-1 relations, since the storage is the same. To show 1-to-various relations, we need a transposed form of the same code in which left and right are exchanged: this is it.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line469">469</span><span class="td">[ Relation_RShowOtoO relation sym x relation_property obj1 obj2 t1 t2 N1 N2;</span></span>
<span class="tr"><span class="th" id="line470">470</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    relation_property = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line471">471</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    t1 = KindBaseTerm(RlnGetF(relation, RR_KIND), 0); ! Kind of left term</span></span>
<span class="tr"><span class="th" id="line472">472</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    t2 = KindBaseTerm(RlnGetF(relation, RR_KIND), 1); ! Kind of right term</span></span>
<span class="tr"><span class="th" id="line473">473</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (t2 == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line474">474</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (t1 == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line475">475</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            objectloop (obj1) {</span></span>
<span class="tr"><span class="th" id="line476">476</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (obj2 provides relation_property) {</span></span>
<span class="tr"><span class="th" id="line477">477</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (obj2.relation_property ~= obj1) continue;</span></span>
<span class="tr"><span class="th" id="line478">478</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line479">479</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &quot;, (The) obj1;</span></span>
<span class="tr"><span class="th" id="line480">480</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line481">481</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print (the) obj2, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line482">482</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line483">483</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line484">484</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</span></span>
<span class="tr"><span class="th" id="line485">485</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            N1 = KOVDomainSize(t1);</span></span>
<span class="tr"><span class="th" id="line486">486</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            for (obj1=1: obj1&lt;=N1: obj1++) {</span></span>
<span class="tr"><span class="th" id="line487">487</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (obj2 provides relation_property) {</span></span>
<span class="tr"><span class="th" id="line488">488</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (obj2.relation_property ~= obj1) continue;</span></span>
<span class="tr"><span class="th" id="line489">489</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line490">490</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &quot;; PrintKindValuePair(t1, obj1);</span></span>
<span class="tr"><span class="th" id="line491">491</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line492">492</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print (the) obj2, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line493">493</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line494">494</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line495">495</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line496">496</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else {</span></span>
<span class="tr"><span class="th" id="line497">497</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        N2 = KOVDomainSize(t2);</span></span>
<span class="tr"><span class="th" id="line498">498</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (t1 == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line499">499</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            objectloop (obj1) {</span></span>
<span class="tr"><span class="th" id="line500">500</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                for (obj2=1: obj2&lt;=N2: obj2++) {</span></span>
<span class="tr"><span class="th" id="line501">501</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (GProperty(t2, obj2, relation_property) ~= obj1) continue;</span></span>
<span class="tr"><span class="th" id="line502">502</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line503">503</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &quot;, (The) obj1;</span></span>
<span class="tr"><span class="th" id="line504">504</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line505">505</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    PrintKindValuePair(t2, obj2);</span></span>
<span class="tr"><span class="th" id="line506">506</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line507">507</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line508">508</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line509">509</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</span></span>
<span class="tr"><span class="th" id="line510">510</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            N1 = KOVDomainSize(t1);</span></span>
<span class="tr"><span class="th" id="line511">511</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            for (obj1=1: obj1&lt;=N1: obj1++) {</span></span>
<span class="tr"><span class="th" id="line512">512</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                for (obj2=1: obj2&lt;=N2: obj2++) {</span></span>
<span class="tr"><span class="th" id="line513">513</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (GProperty(t2, obj2, relation_property) ~= obj1) continue;</span></span>
<span class="tr"><span class="th" id="line514">514</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (x == 0) { print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;; x=1; }</span></span>
<span class="tr"><span class="th" id="line515">515</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &quot;;</span></span>
<span class="tr"><span class="th" id="line516">516</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    PrintKindValuePair(t1, obj1);</span></span>
<span class="tr"><span class="th" id="line517">517</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  &gt;=&gt;  &quot;;</span></span>
<span class="tr"><span class="th" id="line518">518</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    PrintKindValuePair(t2, obj2);</span></span>
<span class="tr"><span class="th" id="line519">519</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line520">520</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line521">521</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line522">522</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line523">523</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line524">524</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-show-equivalence">Show Equivalence.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line529">529</span><span class="td">[ RSE_Flip KOV v relation_property x;</span></span>
<span class="tr"><span class="th" id="line530">530</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    x = GProperty(KOV, v, relation_property); x = -x;</span></span>
<span class="tr"><span class="th" id="line531">531</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    WriteGProperty(KOV, v, relation_property, x);</span></span>
<span class="tr"><span class="th" id="line532">532</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line533">533</span><span class="td">[ RSE_Set KOV v relation_property;</span></span>
<span class="tr"><span class="th" id="line534">534</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (GProperty(KOV, v, relation_property) &lt; 0) rtrue; rfalse;</span></span>
<span class="tr"><span class="th" id="line535">535</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line536">536</span><span class="td">[ Relation_ShowEquiv relation relation_property obj1 obj2 v c d somegroups t N x;</span></span>
<span class="tr"><span class="th" id="line537">537</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    print (string) RlnGetF(relation, RR_DESCRIPTION), &quot;:^&quot;;</span></span>
<span class="tr"><span class="th" id="line538">538</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    relation_property = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line539">539</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    t = KindBaseTerm(RlnGetF(relation, RR_KIND), 0); ! Kind of left term</span></span>
<span class="tr"><span class="th" id="line540">540</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    N = KOVDomainSize(t);</span></span>
<span class="tr"><span class="th" id="line541">541</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (t == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line542">542</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides relation_property)</span></span>
<span class="tr"><span class="th" id="line543">543</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            obj1.relation_property = -(obj1.relation_property);</span></span>
<span class="tr"><span class="th" id="line544">544</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides relation_property) {</span></span>
<span class="tr"><span class="th" id="line545">545</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (obj1.relation_property &lt; 0) {</span></span>
<span class="tr"><span class="th" id="line546">546</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                v = obj1.relation_property; c = 0;</span></span>
<span class="tr"><span class="th" id="line547">547</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (obj2 has workflag2) give obj2 ~workflag2;</span></span>
<span class="tr"><span class="th" id="line548">548</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (obj2 provides relation_property) {</span></span>
<span class="tr"><span class="th" id="line549">549</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (obj2.relation_property == v) {</span></span>
<span class="tr"><span class="th" id="line550">550</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        give obj2 workflag2;</span></span>
<span class="tr"><span class="th" id="line551">551</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        obj2.relation_property = -v;</span></span>
<span class="tr"><span class="th" id="line552">552</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        c++;</span></span>
<span class="tr"><span class="th" id="line553">553</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</span></span>
<span class="tr"><span class="th" id="line554">554</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line555">555</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (c&gt;1) {</span></span>
<span class="tr"><span class="th" id="line556">556</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    somegroups = true;</span></span>
<span class="tr"><span class="th" id="line557">557</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  { &quot;;</span></span>
<span class="tr"><span class="th" id="line558">558</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    WriteListOfMarkedObjects(ENGLISH_BIT);</span></span>
<span class="tr"><span class="th" id="line559">559</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot; }^&quot;;</span></span>
<span class="tr"><span class="th" id="line560">560</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                } else obj1.relation_property = v;</span></span>
<span class="tr"><span class="th" id="line561">561</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line562">562</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line563">563</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj2 has workflag2) give obj2 ~workflag2;</span></span>
<span class="tr"><span class="th" id="line564">564</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        c = 0; objectloop (obj1 provides relation_property)</span></span>
<span class="tr"><span class="th" id="line565">565</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (obj1.relation_property &lt; 0) { c++; give obj1 workflag2; }</span></span>
<span class="tr"><span class="th" id="line566">566</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (c == 0) return;</span></span>
<span class="tr"><span class="th" id="line567">567</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (somegroups) print &quot;  and &quot;; else print &quot;  &quot;;</span></span>
<span class="tr"><span class="th" id="line568">568</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (c &lt; 4) { WriteListOfMarkedObjects(ENGLISH_BIT); print &quot; in&quot;; }</span></span>
<span class="tr"><span class="th" id="line569">569</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        else print c;</span></span>
<span class="tr"><span class="th" id="line570">570</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (c == 1) print &quot; a&quot;;</span></span>
<span class="tr"><span class="th" id="line571">571</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        print &quot; single-member group&quot;;</span></span>
<span class="tr"><span class="th" id="line572">572</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (c &gt; 1) print &quot;s&quot;;</span></span>
<span class="tr"><span class="th" id="line573">573</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        print &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line574">574</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides relation_property)</span></span>
<span class="tr"><span class="th" id="line575">575</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (obj1.relation_property &lt; 0)</span></span>
<span class="tr"><span class="th" id="line576">576</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                obj1.relation_property = -(obj1.relation_property);</span></span>
<span class="tr"><span class="th" id="line577">577</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else {</span></span>
<span class="tr"><span class="th" id="line578">578</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        ! A slower method, since we have less efficient storage:</span></span>
<span class="tr"><span class="th" id="line579">579</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj1 = 1: obj1 &lt;= N: obj1++)</span></span>
<span class="tr"><span class="th" id="line580">580</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            RSE_Flip(t, obj1, relation_property);</span></span>
<span class="tr"><span class="th" id="line581">581</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj1 = 1: obj1 &lt;= N: obj1++) {</span></span>
<span class="tr"><span class="th" id="line582">582</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (RSE_Set(t, obj1, relation_property)) {</span></span>
<span class="tr"><span class="th" id="line583">583</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                v = GProperty(t, obj1, relation_property);</span></span>
<span class="tr"><span class="th" id="line584">584</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                c = 0;</span></span>
<span class="tr"><span class="th" id="line585">585</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                for (obj2 = 1: obj2 &lt;= N: obj2++)</span></span>
<span class="tr"><span class="th" id="line586">586</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (GProperty(t, obj2, relation_property) == v)</span></span>
<span class="tr"><span class="th" id="line587">587</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        c++;</span></span>
<span class="tr"><span class="th" id="line588">588</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (c&gt;1) {</span></span>
<span class="tr"><span class="th" id="line589">589</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    somegroups = true;</span></span>
<span class="tr"><span class="th" id="line590">590</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;  {&quot;;</span></span>
<span class="tr"><span class="th" id="line591">591</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    d = 0;</span></span>
<span class="tr"><span class="th" id="line592">592</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    for (obj2 = 1: obj2 &lt;= N: obj2++) {</span></span>
<span class="tr"><span class="th" id="line593">593</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (GProperty(t, obj2, relation_property) == v) {</span></span>
<span class="tr"><span class="th" id="line594">594</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            print &quot; &quot;; PrintKindValuePair(t, obj2);</span></span>
<span class="tr"><span class="th" id="line595">595</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            if (d &lt; c-1) print &quot;,&quot;; print &quot; &quot;;</span></span>
<span class="tr"><span class="th" id="line596">596</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            RSE_Flip(t, obj2, relation_property);</span></span>
<span class="tr"><span class="th" id="line597">597</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            d++;</span></span>
<span class="tr"><span class="th" id="line598">598</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</span></span>
<span class="tr"><span class="th" id="line599">599</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</span></span>
<span class="tr"><span class="th" id="line600">600</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    print &quot;}^&quot;;</span></span>
<span class="tr"><span class="th" id="line601">601</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                } else WriteGProperty(t, obj1, relation_property, v);</span></span>
<span class="tr"><span class="th" id="line602">602</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line603">603</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line604">604</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj2 has workflag2) give obj2 ~workflag2;</span></span>
<span class="tr"><span class="th" id="line605">605</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        c = 0;</span></span>
<span class="tr"><span class="th" id="line606">606</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj1 = 1: obj1 &lt;= N: obj1++)</span></span>
<span class="tr"><span class="th" id="line607">607</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (RSE_Set(t, obj1, relation_property)) c++;</span></span>
<span class="tr"><span class="th" id="line608">608</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (c == 0) return;</span></span>
<span class="tr"><span class="th" id="line609">609</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (somegroups) print &quot;  and &quot;; else print &quot;  &quot;;</span></span>
<span class="tr"><span class="th" id="line610">610</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (c == 1) print &quot;a&quot;; else print c;</span></span>
<span class="tr"><span class="th" id="line611">611</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        print &quot; single-member group&quot;;</span></span>
<span class="tr"><span class="th" id="line612">612</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (c &gt; 1) print &quot;s&quot;;</span></span>
<span class="tr"><span class="th" id="line613">613</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        print &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line614">614</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj1 = 1: obj1 &lt;= N: obj1++)</span></span>
<span class="tr"><span class="th" id="line615">615</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (RSE_Set(t, obj1, relation_property))</span></span>
<span class="tr"><span class="th" id="line616">616</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                RSE_Flip(t, obj1, relation_property);</span></span>
<span class="tr"><span class="th" id="line617">617</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line618">618</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-relation-emptying">Relation Emptying.</h3><p><p> These routines, mercifully a little simpler, define the adjective &quot;empty&quot; as it applied to relations. Each routine has to forcibly empty the relation if the clear flag is set, and in any case return either true or false to say whether the relation is empty at the end of the call. For relations in groups, &quot;empty&quot; is understood to mean that each object relates only to itself.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line628">628</span><span class="td">[ Relation_EmptyOtoO relation sym clear relation_property obj1 obj2 t1 t2 N1 N2;</span></span>
<span class="tr"><span class="th" id="line629">629</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    relation_property = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line630">630</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    t1 = KindBaseTerm(RlnGetF(relation, RR_KIND), 0); ! Kind of left term</span></span>
<span class="tr"><span class="th" id="line631">631</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    t2 = KindBaseTerm(RlnGetF(relation, RR_KIND), 1); ! Kind of right term</span></span>
<span class="tr"><span class="th" id="line632">632</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (t2 == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line633">633</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj2 provides relation_property) {</span></span>
<span class="tr"><span class="th" id="line634">634</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            obj1 = obj2.relation_property;</span></span>
<span class="tr"><span class="th" id="line635">635</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (obj1) {</span></span>
<span class="tr"><span class="th" id="line636">636</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (clear) obj2.relation_property = nothing;</span></span>
<span class="tr"><span class="th" id="line637">637</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                else rfalse;</span></span>
<span class="tr"><span class="th" id="line638">638</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line639">639</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line640">640</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else {</span></span>
<span class="tr"><span class="th" id="line641">641</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj2=1: obj2&lt;=N2: obj2++) {</span></span>
<span class="tr"><span class="th" id="line642">642</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            obj1 = GProperty(t2, obj2, relation_property);</span></span>
<span class="tr"><span class="th" id="line643">643</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (obj1) {</span></span>
<span class="tr"><span class="th" id="line644">644</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (clear) WriteGProperty(t2, obj2, relation_property, 0);</span></span>
<span class="tr"><span class="th" id="line645">645</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                else rfalse;</span></span>
<span class="tr"><span class="th" id="line646">646</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line647">647</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line648">648</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line649">649</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (t1 ~= t2) {</span></span>
<span class="tr"><span class="th" id="line650">650</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (t1 == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line651">651</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            objectloop (obj1 provides relation_property) {</span></span>
<span class="tr"><span class="th" id="line652">652</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                obj2 = obj1.relation_property;</span></span>
<span class="tr"><span class="th" id="line653">653</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (obj2) {</span></span>
<span class="tr"><span class="th" id="line654">654</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (clear) obj1.relation_property = nothing;</span></span>
<span class="tr"><span class="th" id="line655">655</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    else rfalse;</span></span>
<span class="tr"><span class="th" id="line656">656</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line657">657</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line658">658</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</span></span>
<span class="tr"><span class="th" id="line659">659</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            for (obj1=1: obj1&lt;=N2: obj1++) {</span></span>
<span class="tr"><span class="th" id="line660">660</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                obj2 = GProperty(t1, obj1, relation_property);</span></span>
<span class="tr"><span class="th" id="line661">661</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (obj2) {</span></span>
<span class="tr"><span class="th" id="line662">662</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (clear) WriteGProperty(t1, obj1, relation_property, 0);</span></span>
<span class="tr"><span class="th" id="line663">663</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    else rfalse;</span></span>
<span class="tr"><span class="th" id="line664">664</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line665">665</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line666">666</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line667">667</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line668">668</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    rtrue;</span></span>
<span class="tr"><span class="th" id="line669">669</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line670">670</span><span class="td">[ Relation_EmptyEquiv relation sym clear</span></span>
<span class="tr"><span class="th" id="line671">671</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    relation_property obj1 obj2 t N v;</span></span>
<span class="tr"><span class="th" id="line672">672</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    relation_property = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line673">673</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    t = KindBaseTerm(RlnGetF(relation, RR_KIND), 0); ! Kind of left term</span></span>
<span class="tr"><span class="th" id="line674">674</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    N = KOVDomainSize(t);</span></span>
<span class="tr"><span class="th" id="line675">675</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (clear) {</span></span>
<span class="tr"><span class="th" id="line676">676</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        v = 1;</span></span>
<span class="tr"><span class="th" id="line677">677</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (t == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line678">678</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            objectloop (obj1 provides relation_property)</span></span>
<span class="tr"><span class="th" id="line679">679</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                obj1.relation_property = v++;</span></span>
<span class="tr"><span class="th" id="line680">680</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</span></span>
<span class="tr"><span class="th" id="line681">681</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            for (obj1=1: obj1&lt;=N: obj1++)</span></span>
<span class="tr"><span class="th" id="line682">682</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                WriteGProperty(t, obj1, relation_property, v++);</span></span>
<span class="tr"><span class="th" id="line683">683</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line684">684</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        rtrue;</span></span>
<span class="tr"><span class="th" id="line685">685</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }    </span></span>
<span class="tr"><span class="th" id="line686">686</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (t == OBJECT_TY) {</span></span>
<span class="tr"><span class="th" id="line687">687</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides relation_property)</span></span>
<span class="tr"><span class="th" id="line688">688</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            objectloop (obj2 provides relation_property)</span></span>
<span class="tr"><span class="th" id="line689">689</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if ((obj1 &lt; obj2) &amp;&amp; (obj1.relation_property == obj2.relation_property))</span></span>
<span class="tr"><span class="th" id="line690">690</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    rfalse;</span></span>
<span class="tr"><span class="th" id="line691">691</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else {</span></span>
<span class="tr"><span class="th" id="line692">692</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj1=1: obj1&lt;=N: obj1++)</span></span>
<span class="tr"><span class="th" id="line693">693</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            for (obj2=obj1+1: obj1&lt;=N: obj1++)</span></span>
<span class="tr"><span class="th" id="line694">694</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (GProperty(t, obj1, relation_property) == GProperty(t, obj2, relation_property))</span></span>
<span class="tr"><span class="th" id="line695">695</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    rfalse;</span></span>
<span class="tr"><span class="th" id="line696">696</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line697">697</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    rtrue;</span></span>
<span class="tr"><span class="th" id="line698">698</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line699">699</span><span class="td">[ Relation_EmptyVtoV relation sym clear vtov_structure obj1 obj2 pr pr2 proutine1 proutine2;</span></span>
<span class="tr"><span class="th" id="line700">700</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line701">701</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr = vtov_structure--&gt;VTOVS_LEFT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line702">702</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr2 = vtov_structure--&gt;VTOVS_RIGHT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line703">703</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    proutine1 = vtov_structure--&gt;VTOVS_LEFT_PRINTING_ROUTINE;</span></span>
<span class="tr"><span class="th" id="line704">704</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    proutine2 = vtov_structure--&gt;VTOVS_RIGHT_PRINTING_ROUTINE;</span></span>
<span class="tr"><span class="th" id="line705">705</span><span class="td">&nbsp; </span></span>
<span class="tr"><span class="th" id="line706">706</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr &amp;&amp; pr2) {</span></span>
<span class="tr"><span class="th" id="line707">707</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides pr)</span></span>
<span class="tr"><span class="th" id="line708">708</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            objectloop (obj2 provides pr2) {</span></span>
<span class="tr"><span class="th" id="line709">709</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (sym &amp;&amp; obj2 &gt; obj1) continue;</span></span>
<span class="tr"><span class="th" id="line710">710</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line711">711</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (clear) Relation_NowNVtoV(obj1, relation, obj2, sym);</span></span>
<span class="tr"><span class="th" id="line712">712</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    else rfalse;</span></span>
<span class="tr"><span class="th" id="line713">713</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line714">714</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line715">715</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return;</span></span>
<span class="tr"><span class="th" id="line716">716</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line717">717</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (pr &amp;&amp; (pr2==0)) {</span></span>
<span class="tr"><span class="th" id="line718">718</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj1 provides pr)</span></span>
<span class="tr"><span class="th" id="line719">719</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            for (obj2=1:obj2&lt;=vtov_structure--&gt;VTOVS_RIGHT_DOMAIN_SIZE:obj2++) {</span></span>
<span class="tr"><span class="th" id="line720">720</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line721">721</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (clear) Relation_NowNVtoV(obj1, relation, obj2, sym);</span></span>
<span class="tr"><span class="th" id="line722">722</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    else rfalse;</span></span>
<span class="tr"><span class="th" id="line723">723</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line724">724</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line725">725</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return;</span></span>
<span class="tr"><span class="th" id="line726">726</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line727">727</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((pr==0) &amp;&amp; (pr2)) {</span></span>
<span class="tr"><span class="th" id="line728">728</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj1=1:obj1&lt;=vtov_structure--&gt;2:obj1++)</span></span>
<span class="tr"><span class="th" id="line729">729</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            objectloop (obj2 provides pr2) {</span></span>
<span class="tr"><span class="th" id="line730">730</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line731">731</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (clear) Relation_NowNVtoV(obj1, relation, obj2, sym);</span></span>
<span class="tr"><span class="th" id="line732">732</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    else rfalse;</span></span>
<span class="tr"><span class="th" id="line733">733</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line734">734</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line735">735</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return;</span></span>
<span class="tr"><span class="th" id="line736">736</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line737">737</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    for (obj1=1:obj1&lt;=vtov_structure--&gt;2:obj1++)</span></span>
<span class="tr"><span class="th" id="line738">738</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (obj2=1:obj2&lt;=vtov_structure--&gt;VTOVS_RIGHT_DOMAIN_SIZE:obj2++)</span></span>
<span class="tr"><span class="th" id="line739">739</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line740">740</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (Relation_TestVtoV(obj1, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line741">741</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (clear) Relation_NowNVtoV(obj1, relation, obj2, sym);</span></span>
<span class="tr"><span class="th" id="line742">742</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    else rfalse;</span></span>
<span class="tr"><span class="th" id="line743">743</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line744">744</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line745">745</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    rtrue;</span></span>
<span class="tr"><span class="th" id="line746">746</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-map-route-finding">Map Route-Finding.</h3><p><p> The general problem we have to solve here is: given <em>x, y &isin; R</em>, where <em>R</em> is the set of rooms and we write <em>x ~ y</em> if there is a map connection from <em>x</em> to <em>y</em>, (i) find the smallest <em>m</em> such that there exist <em>x = r<sub>1</sub> ~ r<sub>2</sub> ~ ... ~ r<sub>m</sub> = y &isin; R</em>, or determine that no such <em>m</em> exists, and (ii) find <em>d</em>, the first direction to take from <em>x</em> to lead to <em>r<sub>2</sub></em>, or set <em>d=0</em> if no such path exists or if <em>m=1</em> so that <em>x=y</em>.<p></p><p> Thus a typical outcome might be either &quot;a shortest path from the Town Square to the Hilltop takes 11 moves, starting by going northeast from the Town Square&quot;, or alternatively &quot;there&#39;s no path from the Town Square to the Hilltop at all&quot;. Note that the length of the shortest path is unambiguous, but that there might be many alternative paths of this minimum length: we deliberately do not specify which path is chosen if so, and the two algorithms used below do not necessarily choose the same one.<p></p><p> Route-finding is not an easy operation in computation terms: the various algorithms available have theoretical running times which are easy (if sobering) to compute, but which are not in practice typical of what will happen, because they are quite sensitive to the map in question. Are all the rooms laid out in a long line? Are there clusters of connected rooms like islands? Are there dense clumps of interconnecting rooms? Are there huge but possibly time-saving loops? And so on. Overhead is also important. We present a choice of two algorithms: the &quot;fast&quot; one has a theoretical running time of <em>O(n<sup>3)</sup></em>, where <em>n</em> is the number of rooms, whereas the &quot;slow&quot; one runs in <em>O(n<sup>2)</sup></em>, yet in practice the fast one easily outperforms the slow on typical heavy-use cases with large maps.<p></p><p> The other issue is memory usage: we essentially have to strike a bargain between speed and memory overhead. Our &quot;slow&quot; algorithm needs only <em>O(n)</em> storage, whereas our &quot;fast&quot; algorithm needs <em>O(n<sup>2)</sup></em>, and this is very significant in the Z-machine where array space is in desperately short supply and where, if <em>n &gt; 50</em> or so, the user is already likely to be fighting for the last few bytes in readable memory.<p></p><p> The user is therefore offered the choice, by selecting the use options &quot;Use fast route-finding&quot; and &quot;Use slow route-finding&quot;: and the defaults, if neither option is explicitly set, are fast on Glulx and slow on the Z-machine. If both use options are explicitly set &ndash; which might happen due to a disagreement between extensions &ndash; &quot;fast&quot; wins.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line792">792</span><span class="td">#ifndef FAST_ROUTE_FINDING;</span></span>
<span class="tr"><span class="th" id="line793">793</span><span class="td">#ifndef SLOW_ROUTE_FINDING;</span></span>
<span class="tr"><span class="th" id="line794">794</span><span class="td">#ifdef TARGET_GLULX;</span></span>
<span class="tr"><span class="th" id="line795">795</span><span class="td">Constant FAST_ROUTE_FINDING;</span></span>
<span class="tr"><span class="th" id="line796">796</span><span class="td">#ifnot;</span></span>
<span class="tr"><span class="th" id="line797">797</span><span class="td">Constant SLOW_ROUTE_FINDING;</span></span>
<span class="tr"><span class="th" id="line798">798</span><span class="td">#endif;</span></span>
<span class="tr"><span class="th" id="line799">799</span><span class="td">#endif;</span></span>
<span class="tr"><span class="th" id="line800">800</span><span class="td">#endif;</span></span>
</div><div class='text'>
<h3 id="#relations-cache-control">Cache Control.</h3><p><p> We provide code to enable our route-finding algorithms to cache their partial results from one usage to the next (though at present only the &quot;fast&quot; algorithm does this). The difficulty here is that the result of a route search depends on three things, any of which may change:<p></p><p> (a) which subset of rooms we are route-finding through; (b) which subset of doors we are allowing ourselves to use; and (c) the current map connections between rooms.<p></p><p> We keep track of (c) by watching for calls to <span class="fixed"><a href="./Relations.i6t.html#line833">SignalMapChange()</a></span> from the routines in <a href="./WorldModel.i6t.html">WorldModel.i6t</a> which alter the map. (a) and (b), however, require tracking from call to call what the current subset of rooms and doors is. (It is not sufficient to remember the criteria used last time and this time, because circumstances could have changed such that the criteria produce a different outcome. For instance, searching through lighted rooms and using unlocked doors will produce a different result if a door has been locked or unlocked since last time, or if a room has become lighted or not.) We store the set of applicable rooms and doors by enumerating them in the property <span class="fixed">room_index</span> and by the flags in the <span class="fixed">DoorRoutingViable</span> array respectively.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line825">825</span><span class="td">Constant NUM_DOORS = {-value:Instances::count(K_door)};</span></span>
<span class="tr"><span class="th" id="line826">826</span><span class="td">Constant NUM_ROOMS = {-value:Instances::count(K_room)};</span></span>
<span class="tr"><span class="th" id="line827">827</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line828">828</span><span class="td">Array DoorRoutingViable -&gt; NUM_DOORS+1;</span></span>
<span class="tr"><span class="th" id="line829">829</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line830">830</span><span class="td">Global map_has_changed = true;</span></span>
<span class="tr"><span class="th" id="line831">831</span><span class="td">Global last_filter; Global last_use_doors;</span></span>
<span class="tr"><span class="th" id="line832">832</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line833">833</span><span class="td">[ SignalMapChange; map_has_changed = true; ];</span></span>
<span class="tr"><span class="th" id="line834">834</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line835">835</span><span class="td">[ MapRouteTo from to filter use_doors count  oy oyi ds;</span></span>
<span class="tr"><span class="th" id="line836">836</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == nothing) return nothing;</span></span>
<span class="tr"><span class="th" id="line837">837</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (to == nothing) return nothing;</span></span>
<span class="tr"><span class="th" id="line838">838</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == to) return nothing;</span></span>
<span class="tr"><span class="th" id="line839">839</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((filter) &amp;&amp; (filter(from) == 0)) return nothing;</span></span>
<span class="tr"><span class="th" id="line840">840</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((filter) &amp;&amp; (filter(to) == 0)) return nothing;</span></span>
<span class="tr"><span class="th" id="line841">841</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((last_filter ~= filter) || (last_use_doors ~= use_doors)) map_has_changed = true;</span></span>
<span class="tr"><span class="th" id="line842">842</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    oyi = 0;</span></span>
<span class="tr"><span class="th" id="line843">843</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (oy has mark_as_room) {</span></span>
<span class="tr"><span class="th" id="line844">844</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if ((filter == 0) || (filter(oy))) {</span></span>
<span class="tr"><span class="th" id="line845">845</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (oy.room_index == -1) map_has_changed = true;</span></span>
<span class="tr"><span class="th" id="line846">846</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            oy.room_index = oyi++;</span></span>
<span class="tr"><span class="th" id="line847">847</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</span></span>
<span class="tr"><span class="th" id="line848">848</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (oy.room_index &gt;= 0) map_has_changed = true;</span></span>
<span class="tr"><span class="th" id="line849">849</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            oy.room_index = -1;</span></span>
<span class="tr"><span class="th" id="line850">850</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line851">851</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line852">852</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    oyi = 0;</span></span>
<span class="tr"><span class="th" id="line853">853</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (oy ofclass K4_door) {</span></span>
<span class="tr"><span class="th" id="line854">854</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        ds = false;</span></span>
<span class="tr"><span class="th" id="line855">855</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if ((use_doors &amp; 2) ||</span></span>
<span class="tr"><span class="th" id="line856">856</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            (oy has open) || ((oy has openable) &amp;&amp; (oy hasnt locked))) ds = true;</span></span>
<span class="tr"><span class="th" id="line857">857</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (DoorRoutingViable-&gt;oyi ~= ds) map_has_changed = true;</span></span>
<span class="tr"><span class="th" id="line858">858</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        DoorRoutingViable-&gt;oyi = ds;</span></span>
<span class="tr"><span class="th" id="line859">859</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        oyi++;</span></span>
<span class="tr"><span class="th" id="line860">860</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line861">861</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (map_has_changed) {</span></span>
<span class="tr"><span class="th" id="line862">862</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        #ifdef FAST_ROUTE_FINDING; ComputeFWMatrix(filter, use_doors); #endif;</span></span>
<span class="tr"><span class="th" id="line863">863</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        map_has_changed = false; last_filter = filter; last_use_doors = use_doors;</span></span>
<span class="tr"><span class="th" id="line864">864</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line865">865</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    #ifdef FAST_ROUTE_FINDING;</span></span>
<span class="tr"><span class="th" id="line866">866</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (count) return FastCountRouteTo(from, to, filter, use_doors);</span></span>
<span class="tr"><span class="th" id="line867">867</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return FastRouteTo(from, to, filter, use_doors);</span></span>
<span class="tr"><span class="th" id="line868">868</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    #ifnot;</span></span>
<span class="tr"><span class="th" id="line869">869</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (count) return SlowCountRouteTo(from, to, filter, use_doors);</span></span>
<span class="tr"><span class="th" id="line870">870</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return SlowRouteTo(from, to, filter, use_doors);</span></span>
<span class="tr"><span class="th" id="line871">871</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    #endif;</span></span>
<span class="tr"><span class="th" id="line872">872</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-fast-route-finding">Fast Route-Finding.</h3><p><p> The following is a form of Floyd&#39;s adaptation of Warshall&#39;s algorithm for finding the transitive closure of a directed graph.<p></p><p> We need to store a matrix which for each pair of rooms <em>R<sub>i</sub></em> and <em>R<sub>j</sub></em> records <em>a<sub>ij</sub></em>, the shortest path length from <em>R<sub>i</sub></em> to <em>R<sub>j</sub></em> or 0 if no path exists, and also <em>d<sub>ij</sub></em>, the first direction to take on leaving <em>R<sub>i</sub></em> along a shortest path to <em>R<sub>j</sub></em>, or 0 if no path exists. For the sake of economy we represent the directions as their instance counts (numbered from 0 in order of creation), not as their direction object values, and then store a single word for each pair <em>(i, j)</em>: we store <em>d<sub>ij</sub> + D a<sub>ij</sub></em>. This restricts us on a signed 16-bit virtual machine, and with the conventional set of <em>D=12</em> directions, to the range <em>0 &le; a<sub>ij</sub> &le; 5461</em>, that is, to path lengths of 5461 steps or fewer. A work of IF with 5461 rooms will not fit in the Z-machine anyway: such a work would be on Glulx, which is 32-bit, and where <em>0 &le; a<sub>ij</sub> &le; 357,913,941</em>.<p></p><p> We begin with <em>a<sub>ij</sub> = 0</em> for all pairs except where there is a viable map connection between <em>R<sub>i</sub></em> and <em>R<sub>j</sub></em>: for those we set <em>a<sub>ij</sub>=1</em> and <em>d<sub>ij</sub></em> equal to the direction of that map connection.<p></p><p> Following Floyd and Warshall we test if each known shortest path <em>R<sub>x</sub></em> to <em>R<sub>y</sub></em> can be used to shorten the best known path from <em>R<sub>x</sub></em> to anywhere else: that is, we look for cases where <em>a<sub>xy</sub> + a<sub>yj</sub> &lt; a<sub>xj</sub></em>, since those show that going from <em>R<sub>x</sub></em> to <em>R<sub>j</sub></em> via <em>R<sub>y</sub></em> takes fewer steps than going directly. See for instance Robert Sedgewick, <strong> Algorithms</strong> (1988), chapter 32.<p></p><p> The trouble with the Floyd-Warshall algorithm is not so much that it takes in principle <em>O(n<sup>3)</sup></em> time to construct the matrix: it does, but the coefficient is low, and in the early stages of the outer loop the fact that the vertex degree is at most <em>D</em> and usually much lower helps to reduce the work further. The trouble is that there is no way to compute only the part of the matrix we want: we have to have the entire thing, and that means storing <em>n<sup>2</sup></em> words of data, by which point we have computed not only the fastest route from <em>R<sub>x</sub></em> to <em>R<sub>y</sub></em> but also the fastest route from anywhere to anywhere else. Even when the original map is sparse, the Floyd-Warshall matrix is not, and it is difficult to store in any very compressed way without greatly increasing the complexity of the code. This is why we cache the results: we might as well, since we had to build the entire memory structure anyway, and it means the time expense is only paid once (or once for every time the state of doors and map connections changes), and the cache is useful for all future routes whatever their endpoints.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line919">919</span><span class="td">#ifdef FAST_ROUTE_FINDING;</span></span>
<span class="tr"><span class="th" id="line920">920</span><span class="td">Array FWMatrix --&gt; NUM_ROOMS*NUM_ROOMS;</span></span>
<span class="tr"><span class="th" id="line921">921</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line922">922</span><span class="td">[ FastRouteTo from to filter use_doors diri i dir oy;</span></span>
<span class="tr"><span class="th" id="line923">923</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == to) return nothing;</span></span>
<span class="tr"><span class="th" id="line924">924</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    i = (FWMatrix--&gt;(from.room_index*NUM_ROOMS + to.room_index))/No_Directions;</span></span>
<span class="tr"><span class="th" id="line925">925</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (i == 0) return nothing;</span></span>
<span class="tr"><span class="th" id="line926">926</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    diri = (FWMatrix--&gt;(from.room_index*NUM_ROOMS + to.room_index))%No_Directions;</span></span>
<span class="tr"><span class="th" id="line927">927</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    i=0; objectloop (dir ofclass K3_direction) {</span></span>
<span class="tr"><span class="th" id="line928">928</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (i == diri) return dir;</span></span>
<span class="tr"><span class="th" id="line929">929</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        i++;</span></span>
<span class="tr"><span class="th" id="line930">930</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line931">931</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return nothing;</span></span>
<span class="tr"><span class="th" id="line932">932</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line933">933</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line934">934</span><span class="td">[ FastCountRouteTo from to filter use_doors  k;</span></span>
<span class="tr"><span class="th" id="line935">935</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == to) return 0;</span></span>
<span class="tr"><span class="th" id="line936">936</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    k = (FWMatrix--&gt;(from.room_index*NUM_ROOMS + to.room_index))/No_Directions;</span></span>
<span class="tr"><span class="th" id="line937">937</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (k == 0) return -1;</span></span>
<span class="tr"><span class="th" id="line938">938</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return k;</span></span>
<span class="tr"><span class="th" id="line939">939</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line940">940</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line941">941</span><span class="td">[ ComputeFWMatrix filter use_doors  oy ox oj axy ayj axj dir diri nd row;</span></span>
<span class="tr"><span class="th" id="line942">942</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (oy has mark_as_room) if (oy.room_index &gt;= 0)</span></span>
<span class="tr"><span class="th" id="line943">943</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (ox has mark_as_room) if (ox.room_index &gt;= 0)</span></span>
<span class="tr"><span class="th" id="line944">944</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            FWMatrix--&gt;(oy.room_index*NUM_ROOMS + ox.room_index) = 0;</span></span>
<span class="tr"><span class="th" id="line945">945</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line946">946</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (oy has mark_as_room) if (oy.room_index &gt;= 0) {</span></span>
<span class="tr"><span class="th" id="line947">947</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        row = (oy.IK1_Count)*No_Directions;</span></span>
<span class="tr"><span class="th" id="line948">948</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        for (diri=0: diri&lt;No_Directions: diri++) {</span></span>
<span class="tr"><span class="th" id="line949">949</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            ox = Map_Storage--&gt;(row+diri);</span></span>
<span class="tr"><span class="th" id="line950">950</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if ((ox) &amp;&amp; (ox has mark_as_room) &amp;&amp; (ox.room_index &gt;= 0)) {</span></span>
<span class="tr"><span class="th" id="line951">951</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                FWMatrix--&gt;(oy.room_index*NUM_ROOMS + ox.room_index) = No_Directions + diri;</span></span>
<span class="tr"><span class="th" id="line952">952</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                continue;</span></span>
<span class="tr"><span class="th" id="line953">953</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line954">954</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (use_doors &amp;&amp; (ox ofclass K4_door) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line955">955</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ((use_doors &amp; 2) || (DoorRoutingViable-&gt;(ox.IK4_Count)))) {</span></span>
<span class="tr"><span class="th" id="line956">956</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                @push location; location = oy;</span></span>
<span class="tr"><span class="th" id="line957">957</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                ox = ox.door_to();</span></span>
<span class="tr"><span class="th" id="line958">958</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                @pull location;</span></span>
<span class="tr"><span class="th" id="line959">959</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if ((ox) &amp;&amp; (ox has mark_as_room) &amp;&amp; (ox.room_index &gt;= 0)) {</span></span>
<span class="tr"><span class="th" id="line960">960</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    FWMatrix--&gt;(oy.room_index*NUM_ROOMS + ox.room_index) = No_Directions + diri;</span></span>
<span class="tr"><span class="th" id="line961">961</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    continue;</span></span>
<span class="tr"><span class="th" id="line962">962</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line963">963</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line964">964</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }    </span></span>
<span class="tr"><span class="th" id="line965">965</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line966">966</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line967">967</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (oy has mark_as_room) if (oy.room_index &gt;= 0)</span></span>
<span class="tr"><span class="th" id="line968">968</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (ox has mark_as_room) if (ox.room_index &gt;= 0) {</span></span>
<span class="tr"><span class="th" id="line969">969</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            axy = (FWMatrix--&gt;(ox.room_index*NUM_ROOMS + oy.room_index))/No_Directions;</span></span>
<span class="tr"><span class="th" id="line970">970</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (axy &gt; 0)</span></span>
<span class="tr"><span class="th" id="line971">971</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (oj has mark_as_room) if (oj.room_index &gt;= 0) {</span></span>
<span class="tr"><span class="th" id="line972">972</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    ayj = (FWMatrix--&gt;(oy.room_index*NUM_ROOMS + oj.room_index))/No_Directions;</span></span>
<span class="tr"><span class="th" id="line973">973</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (ayj &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line974">974</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        !print &quot;Is it faster to go from &quot;, (name) ox, &quot; to &quot;,</span></span>
<span class="tr"><span class="th" id="line975">975</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        !   (name) oj, &quot; via &quot;, (name) oy, &quot;?^&quot;;</span></span>
<span class="tr"><span class="th" id="line976">976</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        axj = (FWMatrix--&gt;(ox.room_index*NUM_ROOMS + oj.room_index))/</span></span>
<span class="tr"><span class="th" id="line977">977</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            No_Directions;</span></span>
<span class="tr"><span class="th" id="line978">978</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if ((axj == 0) || (axy + ayj &lt; axj)) {</span></span>
<span class="tr"><span class="th" id="line979">979</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            !print &quot;Yes^&quot;;</span></span>
<span class="tr"><span class="th" id="line980">980</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            FWMatrix--&gt;(ox.room_index*NUM_ROOMS + oj.room_index) =</span></span>
<span class="tr"><span class="th" id="line981">981</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                (axy + ayj)*No_Directions +</span></span>
<span class="tr"><span class="th" id="line982">982</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                (FWMatrix--&gt;(ox.room_index*NUM_ROOMS + oy.room_index))%</span></span>
<span class="tr"><span class="th" id="line983">983</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    No_Directions;</span></span>
<span class="tr"><span class="th" id="line984">984</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</span></span>
<span class="tr"><span class="th" id="line985">985</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</span></span>
<span class="tr"><span class="th" id="line986">986</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line987">987</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line988">988</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line989">989</span><span class="td">#ENDIF;</span></span>
</div><div class='text'>
<h3 id="#relations-slow-route-finding">Slow Route-Finding.</h3><p><p> The alternative algorithm, used when only <em>O(n)</em> memory is available, computes only some of the shortest paths leading to <em>R<sub>y</sub></em>, and is not cached &ndash; both because the storage is likely to be reused often by other searches and because there is little gain from doing so, given that a subsequent search with different endpoints will not benefit from the results of this one. On the other hand, to call it &quot;slow&quot; is a little unfair. It is somewhat like Prim&#39;s algorithm for finding a minimum spanning tree, rooted at <em>R<sub>y</sub></em>, and grows the tree outward from <em>R<sub>y</sub></em> until either <em>R<sub>x</sub></em> is reached &ndash; in which case we stop immediately &ndash; or the (directed) component containing <em>R<sub>y</sub></em> has been exhausted &ndash; in which case <em>R<sub>x</sub></em>, which must lie outside this, can have no path to <em>R<sub>y</sub></em>. In principle, the running time is <em>O(dn<sup>2)</sup></em>, where <em>d &le; D</em> is the maximum vertex degree and <em>n</em> is the number of rooms in the component containing <em>R<sub>y</sub></em>: in practice the degree is often much less than 12, while the algorithm finishes quickly in cases where <em>R<sub>y</sub></em> is relatively isolated and inaccessible or where a shortish route does exist, and those are very common cases in typical usage. There will be circumstances where, because few routes need to be found and because of the shape of the map, the &quot;slow&quot; algorithm will outperform the &quot;fast&quot; one: this is why the user is allowed to control which algorithm is used.<p></p><p> For each room <em>R<sub>z</sub></em>, the property <span class="fixed">vector</span> stores the direction object of the way to go to its parent room in the tree rooted at <em>R<sub>y</sub></em>. Thus if the algorithm succeeds in finding a route from <em>R<sub>x</sub></em> to <em>R<sub>y</sub></em> then we generate the route by starting at <em>R<sub>x</sub></em> and repeatedly going in the <span class="fixed">vector</span> direction from where we currently stand until we reach <em>R<sub>y</sub></em>. Since every room needs a <span class="fixed">vector</span> value, this requires <em>n</em> words of storage. (The <span class="fixed">vector</span> values store only enough of the minimal spanning tree to go upwards through the tree, but that&#39;s the only way we need to traverse it.)<p></p><p> The method can be summed up thus:<p></p><p> (a) Begin with every vector blank except that of <em>R<sub>y</sub></em>, the destination. (b) Repeatedly: For every room in the domain set, try each direction: if this leads to a room whose vector was determined on the last round (<strong> not</strong> on this one, as that may be a suboptimal route), set the vector to point to that room. (c) Stop as soon as the vector from the origin is set, or when a round happens in which no further vectors are found: in which case, we have completely explored the component of the map from which the destination can be reached, and the origin isn&#39;t in it, so we can return &quot;no&quot;.<p></p><p> To prove the correctness of this, we show inductively that after round <em>n</em> we have set the <span class="fixed">vector</span> for every room having a shortest path to <em>R<sub>y</sub></em> of length <em>n</em>, and that every <span class="fixed">vector</span> points to a room having a <span class="fixed">vector</span> in the direction of the shortest path from there to <em>R<sub>y</sub></em>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1039">1039</span><span class="td">#ifndef FAST_ROUTE_FINDING;</span></span>
<span class="tr"><span class="th" id="line1040">1040</span><span class="td">[ SlowRouteTo from to filter use_doors  obj dir in_direction progressed sl through_door;</span></span>
<span class="tr"><span class="th" id="line1041">1041</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == nothing) return nothing;</span></span>
<span class="tr"><span class="th" id="line1042">1042</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (to == nothing) return nothing;</span></span>
<span class="tr"><span class="th" id="line1043">1043</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == to) return nothing;</span></span>
<span class="tr"><span class="th" id="line1044">1044</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (obj has mark_as_room) obj.vector = 0;</span></span>
<span class="tr"><span class="th" id="line1045">1045</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    to.vector = 1;</span></span>
<span class="tr"><span class="th" id="line1046">1046</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    !print &quot;Routing from &quot;, (the) from, &quot; to &quot;, (the) to, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line1047">1047</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    while (true) {</span></span>
<span class="tr"><span class="th" id="line1048">1048</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        progressed = false;</span></span>
<span class="tr"><span class="th" id="line1049">1049</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        !print &quot;Pass begins^&quot;;</span></span>
<span class="tr"><span class="th" id="line1050">1050</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj has mark_as_room)</span></span>
<span class="tr"><span class="th" id="line1051">1051</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if ((filter == 0) || (filter(obj)))</span></span>
<span class="tr"><span class="th" id="line1052">1052</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (obj.vector == 0)</span></span>
<span class="tr"><span class="th" id="line1053">1053</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    objectloop (dir ofclass K3_direction) {</span></span>
<span class="tr"><span class="th" id="line1054">1054</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        in_direction = Map_Storage--&gt;((obj.IK1_Count)*No_Directions + dir.IK3_Count);</span></span>
<span class="tr"><span class="th" id="line1055">1055</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (in_direction == nothing) continue;</span></span>
<span class="tr"><span class="th" id="line1056">1056</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        !print (the) obj, &quot; &gt; &quot;, (the) dir, &quot; &gt; &quot;, (the) in_direction, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line1057">1057</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if ((in_direction)</span></span>
<span class="tr"><span class="th" id="line1058">1058</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            &amp;&amp; (in_direction has mark_as_room)</span></span>
<span class="tr"><span class="th" id="line1059">1059</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            &amp;&amp; (in_direction.vector &gt; 0)</span></span>
<span class="tr"><span class="th" id="line1060">1060</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            &amp;&amp; ((filter == 0) || (filter(in_direction)))) {</span></span>
<span class="tr"><span class="th" id="line1061">1061</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            obj.vector = dir | WORD_HIGHBIT;</span></span>
<span class="tr"><span class="th" id="line1062">1062</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            !print &quot;* &quot;, (the) obj, &quot; vector is &quot;, (the) dir, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line1063">1063</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            progressed = true;</span></span>
<span class="tr"><span class="th" id="line1064">1064</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            continue;</span></span>
<span class="tr"><span class="th" id="line1065">1065</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</span></span>
<span class="tr"><span class="th" id="line1066">1066</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (use_doors &amp;&amp; (in_direction ofclass K4_door) &amp;&amp;</span></span>
<span class="tr"><span class="th" id="line1067">1067</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            ((use_doors &amp; 2) ||</span></span>
<span class="tr"><span class="th" id="line1068">1068</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             (in_direction has open) ||</span></span>
<span class="tr"><span class="th" id="line1069">1069</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             ((in_direction has openable) &amp;&amp; (in_direction hasnt locked)))) {</span></span>
<span class="tr"><span class="th" id="line1070">1070</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            sl = location; location = obj;</span></span>
<span class="tr"><span class="th" id="line1071">1071</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            through_door = in_direction.door_to();</span></span>
<span class="tr"><span class="th" id="line1072">1072</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            location = sl;</span></span>
<span class="tr"><span class="th" id="line1073">1073</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            !print &quot;Through door is &quot;, (the) through_door, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line1074">1074</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            if ((through_door)</span></span>
<span class="tr"><span class="th" id="line1075">1075</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                &amp;&amp; (through_door has mark_as_room)</span></span>
<span class="tr"><span class="th" id="line1076">1076</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                &amp;&amp; (through_door.vector &gt; 0)</span></span>
<span class="tr"><span class="th" id="line1077">1077</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                &amp;&amp; ((filter == 0) || (filter(through_door)))) {</span></span>
<span class="tr"><span class="th" id="line1078">1078</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                obj.vector = dir | WORD_HIGHBIT;</span></span>
<span class="tr"><span class="th" id="line1079">1079</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                !print &quot;* &quot;, (the) obj, &quot; vector is &quot;, (the) dir, &quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line1080">1080</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                progressed = true;</span></span>
<span class="tr"><span class="th" id="line1081">1081</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                continue;</span></span>
<span class="tr"><span class="th" id="line1082">1082</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            }</span></span>
<span class="tr"><span class="th" id="line1083">1083</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</span></span>
<span class="tr"><span class="th" id="line1084">1084</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</span></span>
<span class="tr"><span class="th" id="line1085">1085</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj has mark_as_room) obj.vector = obj.vector &amp;~ WORD_HIGHBIT;</span></span>
<span class="tr"><span class="th" id="line1086">1086</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (from.vector) return from.vector;</span></span>
<span class="tr"><span class="th" id="line1087">1087</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (progressed == false) return from.vector;</span></span>
<span class="tr"><span class="th" id="line1088">1088</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1089">1089</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1090">1090</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1091">1091</span><span class="td">[ SlowCountRouteTo from to filter use_doors obj i;</span></span>
<span class="tr"><span class="th" id="line1092">1092</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == nothing) return -1;</span></span>
<span class="tr"><span class="th" id="line1093">1093</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (to == nothing) return -1;</span></span>
<span class="tr"><span class="th" id="line1094">1094</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == to) return 0;</span></span>
<span class="tr"><span class="th" id="line1095">1095</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from has mark_as_room &amp;&amp; to has mark_as_room) {</span></span>
<span class="tr"><span class="th" id="line1096">1096</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        obj = MapRouteTo(from,to,filter,use_doors);</span></span>
<span class="tr"><span class="th" id="line1097">1097</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (obj == nothing) return -1;</span></span>
<span class="tr"><span class="th" id="line1098">1098</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        i = 0; obj = from;</span></span>
<span class="tr"><span class="th" id="line1099">1099</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        while ((obj ~= to) &amp;&amp; (i&lt;NUM_ROOMS)) { i++; obj = MapConnection(obj,obj.vector); }</span></span>
<span class="tr"><span class="th" id="line1100">1100</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return i;</span></span>
<span class="tr"><span class="th" id="line1101">1101</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1102">1102</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return -1;</span></span>
<span class="tr"><span class="th" id="line1103">1103</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1104">1104</span><span class="td">#ENDIF;</span></span>
</div><div class='text'>
<h3 id="#relations-relation-route-finding">Relation Route-Finding.</h3><p><p> The general problem we have to solve here is: given <em>x, y &isin; D</em>, where <em> ~ </em> is a relation on a domain set <em>D</em> of objects,<p></p><p> (i) find the smallest <em>n</em> such that there exist <em>x = r<sub>1</sub> ~ r<sub>2</sub> ~ ... ~ r<sub>n</sub> = y &isin; D</em> such that <em>r<sub>i</sub> ~ r<sub>i+1</sub></em>, or determine that no such <em>n</em> exists, and if so (ii) find a value of <em>r<sub>2</sub></em> in such a &quot;route&quot; between <em>x</em> and <em>y</em>, or set <em>r<sub>2</sub>=0</em> if <em>x=y</em> so that <em>n=1</em>.<p></p><p> While in general a relation can have different left and right domains (a relation between doors and rooms, say), route-finding on those relations is unlikely to be very useful, so is discouraged. (In the case of doors and rooms, a route could never be longer than 1 step, since no object is both a door and a room, for instance.) The &quot;fast&quot; V-to-V algorithm requires <em>D</em> to have the same left and right domains; NI compiles the memory caches for V-to-V relations to force any cases with different domains into using the &quot;slow&quot; algorithm.<p></p><p> <span class="fixed"><a href="./Relations.i6t.html#line1131">MAX_ROUTE_LENGTH</a></span> is used simply as a sanity check to prevent hangs if something should go wrong, for instance if the property of a 1-to-V relation has been modified by some third-party code in such a way that it loses its defining invariant.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1131">1131</span><span class="td">Constant MAX_ROUTE_LENGTH = {-value:Instances::count(K_object)} + 32;</span></span>
<span class="tr"><span class="th" id="line1132">1132</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1133">1133</span><span class="td">[ RelationRouteTo relation from to count  handler;</span></span>
<span class="tr"><span class="th" id="line1134">1134</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (count) {</span></span>
<span class="tr"><span class="th" id="line1135">1135</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (from == nothing) return -1;</span></span>
<span class="tr"><span class="th" id="line1136">1136</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (to == nothing) return -1;</span></span>
<span class="tr"><span class="th" id="line1137">1137</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (relation == 0) return -1;</span></span>
<span class="tr"><span class="th" id="line1138">1138</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    } else {</span></span>
<span class="tr"><span class="th" id="line1139">1139</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (from == nothing) return nothing;</span></span>
<span class="tr"><span class="th" id="line1140">1140</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (to == nothing) return nothing;</span></span>
<span class="tr"><span class="th" id="line1141">1141</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (relation == 0) return nothing;</span></span>
<span class="tr"><span class="th" id="line1142">1142</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1143">1143</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (from == to) return nothing;</span></span>
<span class="tr"><span class="th" id="line1144">1144</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (((RlnGetF(relation, RR_PERMISSIONS)) &amp; RELS_ROUTE_FIND) == 0) {</span></span>
<span class="tr"><span class="th" id="line1145">1145</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        RunTimeProblem(RTP_ROUTELESS);</span></span>
<span class="tr"><span class="th" id="line1146">1146</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return nothing;</span></span>
<span class="tr"><span class="th" id="line1147">1147</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1148">1148</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (RlnGetF(relation, RR_STORAGE) == 0) return nothing;</span></span>
<span class="tr"><span class="th" id="line1149">1149</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    handler = RlnGetF(relation, RR_HANDLER);</span></span>
<span class="tr"><span class="th" id="line1150">1150</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (count) return handler(relation, RELS_ROUTE_FIND_COUNT, from, to);</span></span>
<span class="tr"><span class="th" id="line1151">1151</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return handler(relation, RELS_ROUTE_FIND, from, to);</span></span>
<span class="tr"><span class="th" id="line1152">1152</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line1153">1153</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line1154">1154</span><span class="td">[ RelFollowVector rv from to  obj i;</span></span>
<span class="tr"><span class="th" id="line1155">1155</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (rv == nothing) return -1;</span></span>
<span class="tr"><span class="th" id="line1156">1156</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    i = 0; obj = from;</span></span>
<span class="tr"><span class="th" id="line1157">1157</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    while ((obj ~= to) &amp;&amp; (i&lt;=MAX_ROUTE_LENGTH)) { i++; obj = obj.vector; }</span></span>
<span class="tr"><span class="th" id="line1158">1158</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return i;</span></span>
<span class="tr"><span class="th" id="line1159">1159</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-one-to-various-route-finding">One To Various Route-Finding.</h3><p><p> Here we can immediately determine, given <em>y</em>, the unique <em>y&#39;</em> such that <em>y&#39; ~ y</em>, so finding a path from <em>x</em> to <em>y</em> is a matter of following the only path leading to <em>y</em> and seeing if it ever passed through <em>x</em>; thus the running time is <em>O(n)</em>, where <em>n</em> is the size of the domain. It would be pointless to cache this.<p></p><p> Note that we can assume here that <em>x &ne; y</em>, or rather, that <span class="fixed">from ~= to</span>, because that case has already been taken care of.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1172">1172</span><span class="td">[ OtoVRelRouteTo relation_property from to previous;</span></span>
<span class="tr"><span class="th" id="line1173">1173</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    while ((to) &amp;&amp; (to provides relation_property) &amp;&amp; (to.relation_property)) {</span></span>
<span class="tr"><span class="th" id="line1174">1174</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        previous = to.relation_property;</span></span>
<span class="tr"><span class="th" id="line1175">1175</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        previous.vector = to;</span></span>
<span class="tr"><span class="th" id="line1176">1176</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (previous == from) return to;</span></span>
<span class="tr"><span class="th" id="line1177">1177</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        to = previous;</span></span>
<span class="tr"><span class="th" id="line1178">1178</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1179">1179</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return nothing;</span></span>
<span class="tr"><span class="th" id="line1180">1180</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-various-to-one-route-finding">Various To One Route-Finding.</h3><p><p> This time the simplifying assumption is that, given <em>x</em>, we can immediately determine the unique <em>x&#39;</em> such that <em>x ~ x&#39;</em>, so it suffices to follow the only path forwards from <em>x</em> and see if it ever reaches <em>y</em>. The routine is not quite a mirror image of the one above, because both have the same return requirements: we have to ensure that the <span class="fixed">vector</span> properties lay out the path, and also return the next step after <em>x</em>.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1191">1191</span><span class="td">[ VtoORelRouteTo relation_property from to next  start;</span></span>
<span class="tr"><span class="th" id="line1192">1192</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    start = from;</span></span>
<span class="tr"><span class="th" id="line1193">1193</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    while ((from) &amp;&amp; (from provides relation_property) &amp;&amp; (from.relation_property)) {</span></span>
<span class="tr"><span class="th" id="line1194">1194</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        next = from.relation_property;</span></span>
<span class="tr"><span class="th" id="line1195">1195</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        from.vector = next;</span></span>
<span class="tr"><span class="th" id="line1196">1196</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (next == to) return start.vector;</span></span>
<span class="tr"><span class="th" id="line1197">1197</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        from = next;</span></span>
<span class="tr"><span class="th" id="line1198">1198</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1199">1199</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return nothing;</span></span>
<span class="tr"><span class="th" id="line1200">1200</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-slow-various-to-various-route-finding">Slow Various To Various Route-Finding.</h3><p><p> Now there are no simplifying assumptions and the problem is essentially the same as the one solved for route-finding in the map, above. Once again we present two different algorithms: first, a form of Prim&#39;s algorithm for minimal spanning trees. Note that, whereas this algorithm was not always so &quot;slow&quot; for the map &ndash; because of the fairly low vertex degrees involved, i.e., because most rooms had few connections to other rooms &ndash; here the relation might well be almost complete, with almost all the objects related to each other, and then the algorithm will indeed be &quot;slow&quot;. So it is likely that the &quot;fast&quot; algorithm will always be better, if the memory can be spared for it.<p></p><p> We use the fast algorithm for a given relation if and only if the NI compiler has allocated the necessary cache memory; the two use options above, for map route-finding, don&#39;t control this.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1219">1219</span><span class="td">[ VtoVRelRouteTo relation from to count obj obj2 related progressed left_ix pr2 i vtov_structure;</span></span>
<span class="tr"><span class="th" id="line1220">1220</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    vtov_structure = RlnGetF(relation, RR_STORAGE);</span></span>
<span class="tr"><span class="th" id="line1221">1221</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (vtov_structure--&gt;VTOVS_CACHE)</span></span>
<span class="tr"><span class="th" id="line1222">1222</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return FastVtoVRelRouteTo(relation, from, to, count);</span></span>
<span class="tr"><span class="th" id="line1223">1223</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    left_ix = vtov_structure--&gt;VTOVS_LEFT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line1224">1224</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    pr2 = vtov_structure--&gt;VTOVS_RIGHT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line1225">1225</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    objectloop (obj ofclass Object &amp;&amp; obj provides vector) obj.vector = 0;</span></span>
<span class="tr"><span class="th" id="line1226">1226</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    to.vector = 1;</span></span>
<span class="tr"><span class="th" id="line1227">1227</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    while (true) {</span></span>
<span class="tr"><span class="th" id="line1228">1228</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        progressed = false;</span></span>
<span class="tr"><span class="th" id="line1229">1229</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj ofclass Object &amp;&amp; obj provides left_ix)</span></span>
<span class="tr"><span class="th" id="line1230">1230</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (obj.vector == 0) {</span></span>
<span class="tr"><span class="th" id="line1231">1231</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (obj2 ofclass Object &amp;&amp; obj2 provides pr2 &amp;&amp; obj2.vector &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line1232">1232</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (Relation_TestVtoV(obj, relation, obj2)) {</span></span>
<span class="tr"><span class="th" id="line1233">1233</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        obj.vector = obj2 | WORD_HIGHBIT;</span></span>
<span class="tr"><span class="th" id="line1234">1234</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        progressed = true;</span></span>
<span class="tr"><span class="th" id="line1235">1235</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        continue;</span></span>
<span class="tr"><span class="th" id="line1236">1236</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</span></span>
<span class="tr"><span class="th" id="line1237">1237</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                }</span></span>
<span class="tr"><span class="th" id="line1238">1238</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line1239">1239</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        objectloop (obj ofclass Object &amp;&amp; obj provides left_ix)</span></span>
<span class="tr"><span class="th" id="line1240">1240</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            obj.vector = obj.vector &amp;~ WORD_HIGHBIT;</span></span>
<span class="tr"><span class="th" id="line1241">1241</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (from.vector) break;</span></span>
<span class="tr"><span class="th" id="line1242">1242</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (progressed == false) break;</span></span>
<span class="tr"><span class="th" id="line1243">1243</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1244">1244</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (count) {</span></span>
<span class="tr"><span class="th" id="line1245">1245</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (from.vector == nothing) return -1;</span></span>
<span class="tr"><span class="th" id="line1246">1246</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        i = 0; obj = from;</span></span>
<span class="tr"><span class="th" id="line1247">1247</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        while ((obj ~= to) &amp;&amp; (i&lt;=MAX_ROUTE_LENGTH)) { i++; obj = obj.vector; }</span></span>
<span class="tr"><span class="th" id="line1248">1248</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        return i;</span></span>
<span class="tr"><span class="th" id="line1249">1249</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1250">1250</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return from.vector;</span></span>
<span class="tr"><span class="th" id="line1251">1251</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-fast-various-to-various-route-finding">Fast Various To Various Route-Finding.</h3><p><p> Now, as above, a form of the Floyd-Warshall algorithm. The matrix is here stored in the cache of memory pointed to in the V-to-V relation structure. We are unable to combine <em>a<sub>ij</sub></em> and <em>d<sub>ij</sub></em> into a single cell of memory, so in fact we store two separate matrices: one for <em>a<sub>ij</sub></em> (this is <span class="fixed">cache</span> below), the other for <em>n<sub>ij</sub></em>, where <em>n<sub>ij</sub></em> is the next object in the shortest path from <em>O<sub>i</sub></em> to <em>O<sub>j</sub></em> (this is <span class="fixed">cache2</span> below).<p></p><p> Where <em>n&lt;256</em> a shortest path must be such that <em>a<sub>ij</sub> &le; 255</em>, so can be stored in a single byte, and we similarly store <em>n<sub>ij</sub></em> as the index of the object rather than the object value itself: the index ranges from 0 to <em>n-1</em>, so that <em>0 &le; n<sub>ij</sub> &lt; 255</em> and we can use <em>n<sub>ij</sub> = 255</em> as a sentinel value meaning &quot;no path&quot;. Although the reconversion of <em>n<sub>ij</sub></em> back into a valid object value takes a little time, it is only <em>O(n)</em>, and of course we know <em>n</em> is relatively small; and in this way we reduce the storage overhead to only <em>n<sup>2</sup></em> bytes.<p></p><p> Where <em>n &ge; 256</em>, we resign ourselves to storing two words for each pair <em>(i,j)</em>, making <em>2n<sup>2</sup></em> bytes of storage on the Z-machine and <em>4n<sup>2</sup></em> bytes of storage on Glulx, but lookup of a cached result is slightly faster.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1276">1276</span><span class="td">[ FastVtoVRelRouteTo relation from to count</span></span>
<span class="tr"><span class="th" id="line1277">1277</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    domainsize cache cache2 left_ix ox oy oj offset axy axj ayj;</span></span>
<span class="tr"><span class="th" id="line1278">1278</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    domainsize = RlnGetF(relation, RR_STORAGE)--&gt;2; ! Number of left instances</span></span>
<span class="tr"><span class="th" id="line1279">1279</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    left_ix = RlnGetF(relation, RR_STORAGE)--&gt;VTOVS_LEFT_INDEX_PROP;</span></span>
<span class="tr"><span class="th" id="line1280">1280</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if ((from provides left_ix) &amp;&amp; (to provides left_ix)) {</span></span>
<span class="tr"><span class="th" id="line1281">1281</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        if (domainsize &lt; 256) {</span></span>
<span class="tr"><span class="th" id="line1282">1282</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cache = RlnGetF(relation, RR_STORAGE)--&gt;VTOVS_CACHE;</span></span>
<span class="tr"><span class="th" id="line1283">1283</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cache2 = cache + domainsize*domainsize;</span></span>
<span class="tr"><span class="th" id="line1284">1284</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (RlnGetF(relation, RR_STORAGE)--&gt;VTOVS_CACHE_BROKEN == true) {</span></span>
<span class="tr"><span class="th" id="line1285">1285</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                RlnGetF(relation, RR_STORAGE)--&gt;VTOVS_CACHE_BROKEN = false;</span></span>
<span class="tr"><span class="th" id="line1286">1286</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (oy provides left_ix)</span></span>
<span class="tr"><span class="th" id="line1287">1287</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    objectloop (ox provides left_ix)</span></span>
<span class="tr"><span class="th" id="line1288">1288</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (Relation_TestVtoV(oy, relation, ox)) {</span></span>
<span class="tr"><span class="th" id="line1289">1289</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            offset = ((oy.left_ix)*domainsize + (ox.left_ix));</span></span>
<span class="tr"><span class="th" id="line1290">1290</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            cache-&gt;offset = 1;</span></span>
<span class="tr"><span class="th" id="line1291">1291</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            cache2-&gt;offset = ox.left_ix;</span></span>
<span class="tr"><span class="th" id="line1292">1292</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        } else {</span></span>
<span class="tr"><span class="th" id="line1293">1293</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            offset = ((oy.left_ix)*domainsize + (ox.left_ix));</span></span>
<span class="tr"><span class="th" id="line1294">1294</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            cache-&gt;offset = 0;</span></span>
<span class="tr"><span class="th" id="line1295">1295</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            cache2-&gt;offset = 255;</span></span>
<span class="tr"><span class="th" id="line1296">1296</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</span></span>
<span class="tr"><span class="th" id="line1297">1297</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                for (oy=0: oy&lt;domainsize: oy++)</span></span>
<span class="tr"><span class="th" id="line1298">1298</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    for (ox=0: ox&lt;domainsize: ox++) {</span></span>
<span class="tr"><span class="th" id="line1299">1299</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        axy = cache-&gt;(ox*domainsize + oy);</span></span>
<span class="tr"><span class="th" id="line1300">1300</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (axy &gt; 0)</span></span>
<span class="tr"><span class="th" id="line1301">1301</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            for (oj=0: oj&lt;domainsize: oj++) {</span></span>
<span class="tr"><span class="th" id="line1302">1302</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                ayj = cache-&gt;(oy*domainsize + oj);</span></span>
<span class="tr"><span class="th" id="line1303">1303</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                if (ayj &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line1304">1304</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    offset = ox*domainsize + oj;</span></span>
<span class="tr"><span class="th" id="line1305">1305</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    axj = cache-&gt;offset;</span></span>
<span class="tr"><span class="th" id="line1306">1306</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    if ((axj == 0) || (axy + ayj &lt; axj)) {</span></span>
<span class="tr"><span class="th" id="line1307">1307</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                        cache-&gt;offset = (axy + ayj);</span></span>
<span class="tr"><span class="th" id="line1308">1308</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                        cache2-&gt;offset = cache2-&gt;(ox*domainsize + oy);</span></span>
<span class="tr"><span class="th" id="line1309">1309</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    }</span></span>
<span class="tr"><span class="th" id="line1310">1310</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                }</span></span>
<span class="tr"><span class="th" id="line1311">1311</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            }</span></span>
<span class="tr"><span class="th" id="line1312">1312</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</span></span>
<span class="tr"><span class="th" id="line1313">1313</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line1314">1314</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (count) {</span></span>
<span class="tr"><span class="th" id="line1315">1315</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                count = cache-&gt;((from.left_ix)*domainsize + (to.left_ix));</span></span>
<span class="tr"><span class="th" id="line1316">1316</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (count == 0) return -1;</span></span>
<span class="tr"><span class="th" id="line1317">1317</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return count;</span></span>
<span class="tr"><span class="th" id="line1318">1318</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line1319">1319</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            oy = cache2-&gt;((from.left_ix)*domainsize + (to.left_ix));</span></span>
<span class="tr"><span class="th" id="line1320">1320</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (oy &lt; 255)</span></span>
<span class="tr"><span class="th" id="line1321">1321</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (ox provides left_ix)</span></span>
<span class="tr"><span class="th" id="line1322">1322</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    if (ox.left_ix == oy) return ox;</span></span>
<span class="tr"><span class="th" id="line1323">1323</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return nothing;</span></span>
<span class="tr"><span class="th" id="line1324">1324</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        } else {</span></span>
<span class="tr"><span class="th" id="line1325">1325</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cache = RlnGetF(relation, RR_STORAGE)--&gt;VTOVS_CACHE;</span></span>
<span class="tr"><span class="th" id="line1326">1326</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            cache2 = cache + WORDSIZE*domainsize*domainsize;</span></span>
<span class="tr"><span class="th" id="line1327">1327</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (RlnGetF(relation, RR_STORAGE)--&gt;VTOVS_CACHE_BROKEN == true) {</span></span>
<span class="tr"><span class="th" id="line1328">1328</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                RlnGetF(relation, RR_STORAGE)--&gt;VTOVS_CACHE_BROKEN = false;</span></span>
<span class="tr"><span class="th" id="line1329">1329</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                objectloop (oy provides left_ix)</span></span>
<span class="tr"><span class="th" id="line1330">1330</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    objectloop (ox provides left_ix)</span></span>
<span class="tr"><span class="th" id="line1331">1331</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (Relation_TestVtoV(oy, relation, ox)) {</span></span>
<span class="tr"><span class="th" id="line1332">1332</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            offset = ((oy.left_ix)*domainsize + (ox.left_ix));</span></span>
<span class="tr"><span class="th" id="line1333">1333</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            cache--&gt;offset = 1;</span></span>
<span class="tr"><span class="th" id="line1334">1334</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            cache2--&gt;offset = ox;</span></span>
<span class="tr"><span class="th" id="line1335">1335</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        } else {</span></span>
<span class="tr"><span class="th" id="line1336">1336</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            offset = ((oy.left_ix)*domainsize + (ox.left_ix));</span></span>
<span class="tr"><span class="th" id="line1337">1337</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            cache--&gt;offset = 0;</span></span>
<span class="tr"><span class="th" id="line1338">1338</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            cache2--&gt;offset = nothing;</span></span>
<span class="tr"><span class="th" id="line1339">1339</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        }</span></span>
<span class="tr"><span class="th" id="line1340">1340</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                for (oy=0: oy&lt;domainsize: oy++)</span></span>
<span class="tr"><span class="th" id="line1341">1341</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    for (ox=0: ox&lt;domainsize: ox++) {</span></span>
<span class="tr"><span class="th" id="line1342">1342</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        axy = cache--&gt;(ox*domainsize + oy);</span></span>
<span class="tr"><span class="th" id="line1343">1343</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        if (axy &gt; 0)</span></span>
<span class="tr"><span class="th" id="line1344">1344</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            for (oj=0: oj&lt;domainsize: oj++) {</span></span>
<span class="tr"><span class="th" id="line1345">1345</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                ayj = cache--&gt;(oy*domainsize + oj);</span></span>
<span class="tr"><span class="th" id="line1346">1346</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                if (ayj &gt; 0) {</span></span>
<span class="tr"><span class="th" id="line1347">1347</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    offset = ox*domainsize + oj;</span></span>
<span class="tr"><span class="th" id="line1348">1348</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    axj = cache--&gt;offset;</span></span>
<span class="tr"><span class="th" id="line1349">1349</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    if ((axj == 0) || (axy + ayj &lt; axj)) {</span></span>
<span class="tr"><span class="th" id="line1350">1350</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                        cache--&gt;offset = (axy + ayj);</span></span>
<span class="tr"><span class="th" id="line1351">1351</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                        cache2--&gt;offset = cache2--&gt;(ox*domainsize + oy);</span></span>
<span class="tr"><span class="th" id="line1352">1352</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                    }</span></span>
<span class="tr"><span class="th" id="line1353">1353</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                }</span></span>
<span class="tr"><span class="th" id="line1354">1354</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                            }</span></span>
<span class="tr"><span class="th" id="line1355">1355</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    }</span></span>
<span class="tr"><span class="th" id="line1356">1356</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line1357">1357</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            if (count) {</span></span>
<span class="tr"><span class="th" id="line1358">1358</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                count = cache--&gt;((from.left_ix)*domainsize + (to.left_ix));</span></span>
<span class="tr"><span class="th" id="line1359">1359</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                if (count == 0) return -1;</span></span>
<span class="tr"><span class="th" id="line1360">1360</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                return count;</span></span>
<span class="tr"><span class="th" id="line1361">1361</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            }</span></span>
<span class="tr"><span class="th" id="line1362">1362</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;            return cache2--&gt;((from.left_ix)*domainsize + (to.left_ix));</span></span>
<span class="tr"><span class="th" id="line1363">1363</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        }</span></span>
<span class="tr"><span class="th" id="line1364">1364</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    }</span></span>
<span class="tr"><span class="th" id="line1365">1365</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    if (count) return -1;</span></span>
<span class="tr"><span class="th" id="line1366">1366</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    return nothing;</span></span>
<span class="tr"><span class="th" id="line1367">1367</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#relations-iterating-relations">Iterating Relations.</h3><p><p> The following is provided to make it possible to run an I6 routine on each relation in turn. (Each right-way-round relation, at any rate.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line1374">1374</span><span class="td">[ IterateRelations callback;</span></span>
<span class="tr"><span class="th" id="line1375">1375</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;    {-call:Relations::relations_command}</span></span>
<span class="tr"><span class="th" id="line1376">1376</span><span class="td">];</span></span>
</div><footer><p><em>From I6T lib 6/12N &copy; Graham Nelson and published under the <a href="https://github.com/zedlopez/standard_rules/blob/main/LICENSE.md">Artistic License 2.0</a>. Distributed with <a href="http://inform7.com/">Inform 7 6M62</a>.</em></p></footer></body></html>
