<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head><title>Rulebooks</title>
  <style>
span.th, span.td { display: table-cell; }
span.td { padding-left: 2rem; }
span.th { width:4rem; text-align: right; }
span.tr { display: table-row;     counter-increment: linenum; }
span.line_no::before {
    content: counter(linenum);
    text-align: right;
    display: block;
    font-family: monospace;
    font-weight: normal;
}
h1 { margin: 0; }
.fixed { font-family: monospace }
.em { font-style: italic; }
.center { text-align: center; }
    body { font-family: sans-serif; margin: 1.5rem 0 0 3rem; background-color: #fafaf0; width: 80rem; }
    .pre { font-family: monospace; margin: auto; width: 80rem; }
#front_matter,.text { width: 50rem; }
.text { border-bottom: .5px solid black; border-top: .5px solid black; margin-top: 1rem;
padding-bottom: 1rem; margin-bottom: 2rem; }
/*.subtitle { font-weight: bold; font-size: 1.2rem; }*/
    </style>
</head>
<body>
<header>
<h1>I6 Template Layer</h1>
<div class="subtitle"><a href="http://inform7.com/">Inform 7 6M62</a> &bull; <a href="./index.html">Index</a> &bull; <a href="./Introduction.i6t.html">Introduction</a></div><hr></header>
<div id="front_matter">
<h2><a href="./Rulebooks.i6t">Rulebooks.i6t</a></h2><h3 id="#rulebooks-latest-rule-result">Latest Rule Result.</h3><p><p> This used to be a large data structure which kept track of the effect of procedural rules, but in January 2011 procedurals were abolished. It retains only one purpose: as a place to record the result of the most recently completed rule. This used to sit on the top of the stack, and is now the only thing which ever sits on it. So the &quot;stack&quot; has just one 3-word record now. The meanings of these are as follows. The first word is one of the following:<p></p><p> (1) <span class="fixed"><a href="./Rulebooks.i6t.html#line26">RS_SUCCEEDS</a></span> indicates that the most recent rule or rulebook processed ended in success. Word 2 is <span class="fixed">false</span> if there&#39;s no value, or the kind if there is, in which case word 3 contains the value itself. (2) <span class="fixed"><a href="./Rulebooks.i6t.html#line27">RS_FAILS</a></span> is similar, but for a failure. Note that failures can also return values. (3) <span class="fixed"><a href="./Rulebooks.i6t.html#line25">RS_NEITHER</a></span> is similar except that it cannot return any value, so that words 2 and 3 are meaningless.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line25">25</span><span class="td">Constant&nbsp;RS_NEITHER&nbsp;&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line26">26</span><span class="td">Constant&nbsp;RS_SUCCEEDS&nbsp;=&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line27">27</span><span class="td">Constant&nbsp;RS_FAILS&nbsp;&nbsp;=&nbsp;2;</span></span>
<span class="tr"><span class="th" id="line28">28</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line29">29</span><span class="td">Array&nbsp;latest_rule_result&nbsp;--&gt;&nbsp;3;</span></span>
<span class="tr"><span class="th" id="line30">30</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line31">31</span><span class="td">[&nbsp;RecordRuleOutcome&nbsp;usage&nbsp;rule1&nbsp;rule2;</span></span>
<span class="tr"><span class="th" id="line32">32</span><span class="td">&nbsp;if&nbsp;((latest_rule_result--&gt;0&nbsp;==&nbsp;RS_SUCCEEDS&nbsp;or&nbsp;RS_FAILS)&nbsp;&amp;&amp;</span></span>
<span class="tr"><span class="th" id="line33">33</span><span class="td">&nbsp;&nbsp;(KOVIsBlockValue(latest_rule_result--&gt;1)))</span></span>
<span class="tr"><span class="th" id="line34">34</span><span class="td">&nbsp;&nbsp;BlkValueFree(latest_rule_result--&gt;2);</span></span>
<span class="tr"><span class="th" id="line35">35</span><span class="td">&nbsp;if&nbsp;((usage&nbsp;==&nbsp;RS_SUCCEEDS&nbsp;or&nbsp;RS_FAILS)&nbsp;&amp;&amp;&nbsp;(KOVIsBlockValue(rule1)))</span></span>
<span class="tr"><span class="th" id="line36">36</span><span class="td">&nbsp;&nbsp;rule2&nbsp;=&nbsp;BlkValueCopy(BlkValueCreate(rule1),&nbsp;rule2);</span></span>
<span class="tr"><span class="th" id="line37">37</span><span class="td">&nbsp;latest_rule_result--&gt;0&nbsp;=&nbsp;usage;</span></span>
<span class="tr"><span class="th" id="line38">38</span><span class="td">&nbsp;latest_rule_result--&gt;1&nbsp;=&nbsp;rule1;</span></span>
<span class="tr"><span class="th" id="line39">39</span><span class="td">&nbsp;latest_rule_result--&gt;2&nbsp;=&nbsp;rule2;</span></span>
<span class="tr"><span class="th" id="line40">40</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#rulebooks-following">Following.</h3><p><p> Until January 2011, there were two ways to invoke a rulebook: to &quot;follow&quot; it or simply &quot;process&quot; it. With the demise of procedural rules, these became equivalent.<p></p><p> In the early days of Inform 7, stack usage became a serious issue since some forms of the Frotz Z-machine interpreter provided only 4K of stack by default. (&quot;Only&quot; 4K. In the mid-1980s, one of the obstacles facing IF authors at Infocom was the need to get the stack usage down to fewer than 600 bytes in order that the story file could be run on the smaller home computers of the day.) <span class="fixed"><a href="./Rulebooks.i6t.html#line92">FollowRulebook</a></span> was the major consumer of stack space, on average, because of its frequent recursion. Now that the process is simpler, this has become less problematic, since the routine now has fewer local variables.<p></p><p> <span class="fixed"><a href="./Rulebooks.i6t.html#line92">FollowRulebook</a></span> takes three arguments, of which only the first is compulsory:<p></p><p> (a) The <span class="fixed">rulebook</span> is an I7 value of kind &quot;rule&quot;, which means it can be either the ID number of a rulebook &ndash; from 0 up to <em>N-1</em>, where <em>N</em> is the number of rulebooks compiled by Inform, typically about 600 &ndash; or else the address of a routine representing an individual rule. (b) The <span class="fixed">parameter</span> supplied to the rulebook. Much as arguments can be supplied to a function in a conventional language&#39;s function call, so a parameter can be supplied whenever a rulebook is invoked. (c) <span class="fixed">no_paragraph_skips</span> is a flag: if explicitly set <span class="fixed">true</span>, then the rulebook is run with paragraph breaking suppressed. This is the process by which paragraph division points are placed between rules, so that if two rules both print text then a paragraph break appears between. While that is appropriate for rulebooks attached to actions or for &quot;every turn&quot; rules, it is disastrous for rulebooks attached to activities such as &quot;printing the name of something&quot;.<p></p><p> <span class="fixed"><a href="./Rulebooks.i6t.html#line92">FollowRulebook</a></span> returns <span class="fixed">R</span> if rule <span class="fixed">R</span> in the rulebook (or rule) chose to &quot;succeed&quot; or &quot;fail&quot;, and <span class="fixed">false</span> if it made no choice. (To repeat: if the rule explicitly fails, then <span class="fixed"><a href="./Rulebooks.i6t.html#line92">FollowRulebook</a></span> returns <span class="fixed">true</span>. It&#39;s easy to write plausible-looking code which goes wrong because it assumes that the return value is success vs. failure.) The outcome of <span class="fixed"><a href="./Rulebooks.i6t.html#line92">FollowRulebook</a></span> is stored as described above: thus the most recent rule or rulebook succeeded or failed if &ndash; <p></p><p>	<span class="fixed">(latest_rule_result--&gt;0 == RS_SUCCEEDS)</span><br>	<span class="fixed">(latest_rule_result--&gt;0 == RS_FAILS)</span><br><p></p><p> and otherwise there was no decision.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line89">89</span><span class="td">Global&nbsp;process_rulebook_count;&nbsp;!&nbsp;Depth&nbsp;of&nbsp;processing&nbsp;recursion</span></span>
<span class="tr"><span class="th" id="line90">90</span><span class="td">Global&nbsp;debugging_rules&nbsp;=&nbsp;false;&nbsp;!&nbsp;Are&nbsp;we&nbsp;tracing&nbsp;rule&nbsp;invocations?</span></span>
<span class="tr"><span class="th" id="line91">91</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line92">92</span><span class="td">[&nbsp;FollowRulebook&nbsp;rulebook&nbsp;parameter&nbsp;no_paragraph_skips</span></span>
<span class="tr"><span class="th" id="line93">93</span><span class="td">&nbsp;rv&nbsp;ss&nbsp;spv;</span></span>
<span class="tr"><span class="th" id="line94">94</span><span class="td">&nbsp;ss&nbsp;=&nbsp;self;</span></span>
<span class="tr"><span class="th" id="line95">95</span><span class="td">&nbsp;if&nbsp;((Protect_I7_Arrays--&gt;0&nbsp;~=&nbsp;16339)&nbsp;||&nbsp;(Protect_I7_Arrays--&gt;1&nbsp;~=&nbsp;12345))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line96">96</span><span class="td">&nbsp;&nbsp;print&nbsp;&quot;^^***&nbsp;Fatal&nbsp;programming&nbsp;error:&nbsp;I7&nbsp;arrays&nbsp;corrupted&nbsp;***^^&quot;;</span></span>
<span class="tr"><span class="th" id="line97">97</span><span class="td">&nbsp;&nbsp;@quit;</span></span>
<span class="tr"><span class="th" id="line98">98</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line99">99</span><span class="td">&nbsp;if&nbsp;(parameter)&nbsp;{&nbsp;self&nbsp;=&nbsp;parameter;&nbsp;parameter_object&nbsp;=&nbsp;parameter;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line100">100</span><span class="td">&nbsp;spv&nbsp;=&nbsp;parameter_value;&nbsp;parameter_value&nbsp;=&nbsp;parameter;</span></span>
<span class="tr"><span class="th" id="line101">101</span><span class="td">&nbsp;!&nbsp;we&nbsp;won&#39;t&nbsp;need&nbsp;parameter&nbsp;again,&nbsp;so&nbsp;can&nbsp;reuse&nbsp;it</span></span>
<span class="tr"><span class="th" id="line102">102</span><span class="td">&nbsp;parameter&nbsp;=&nbsp;debugging_rules;</span></span>
<span class="tr"><span class="th" id="line103">103</span><span class="td">&nbsp;#ifndef&nbsp;MEMORY_ECONOMY;</span></span>
<span class="tr"><span class="th" id="line104">104</span><span class="td">&nbsp;if&nbsp;(debugging_rules)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line105">105</span><span class="td">&nbsp;&nbsp;DebugRulebooks(rulebook,&nbsp;parameter);</span></span>
<span class="tr"><span class="th" id="line106">106</span><span class="td">&nbsp;&nbsp;process_rulebook_count&nbsp;=&nbsp;process_rulebook_count&nbsp;+&nbsp;debugging_rules;</span></span>
<span class="tr"><span class="th" id="line107">107</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line108">108</span><span class="td">&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line109">109</span><span class="td">&nbsp;if&nbsp;((rulebook&nbsp;&gt;=&nbsp;0)&nbsp;&amp;&amp;&nbsp;(rulebook&nbsp;&lt;&nbsp;NUMBER_RULEBOOKS_CREATED))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line110">110</span><span class="td">&nbsp;&nbsp;rv&nbsp;=&nbsp;rulebooks_array--&gt;rulebook;</span></span>
<span class="tr"><span class="th" id="line111">111</span><span class="td">&nbsp;&nbsp;if&nbsp;(rv&nbsp;~=&nbsp;EMPTY_RULEBOOK)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line112">112</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(rulebook&nbsp;~=&nbsp;ACTION_PROCESSING_RB)&nbsp;MStack_CreateRBVars(rulebook);</span></span>
<span class="tr"><span class="th" id="line113">113</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(say__p)&nbsp;RulebookParBreak(no_paragraph_skips);</span></span>
<span class="tr"><span class="th" id="line114">114</span><span class="td">&nbsp;&nbsp;&nbsp;rv&nbsp;=&nbsp;rv(no_paragraph_skips);</span></span>
<span class="tr"><span class="th" id="line115">115</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(rulebook&nbsp;~=&nbsp;ACTION_PROCESSING_RB)&nbsp;MStack_DestroyRBVars(rulebook);</span></span>
<span class="tr"><span class="th" id="line116">116</span><span class="td">&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line117">117</span><span class="td">&nbsp;&nbsp;&nbsp;rv&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line118">118</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line119">119</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line120">120</span><span class="td">&nbsp;&nbsp;if&nbsp;(say__p)&nbsp;RulebookParBreak(no_paragraph_skips);</span></span>
<span class="tr"><span class="th" id="line121">121</span><span class="td">&nbsp;&nbsp;rv&nbsp;=&nbsp;indirect(rulebook);</span></span>
<span class="tr"><span class="th" id="line122">122</span><span class="td">&nbsp;&nbsp;if&nbsp;(rv&nbsp;==&nbsp;2)&nbsp;rv&nbsp;=&nbsp;reason_the_action_failed;</span></span>
<span class="tr"><span class="th" id="line123">123</span><span class="td">&nbsp;&nbsp;else&nbsp;if&nbsp;(rv)&nbsp;rv&nbsp;=&nbsp;rulebook;</span></span>
<span class="tr"><span class="th" id="line124">124</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line125">125</span><span class="td">&nbsp;if&nbsp;(rv)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line126">126</span><span class="td">&nbsp;&nbsp;#ifndef&nbsp;MEMORY_ECONOMY;</span></span>
<span class="tr"><span class="th" id="line127">127</span><span class="td">&nbsp;&nbsp;if&nbsp;(debugging_rules)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line128">128</span><span class="td">&nbsp;&nbsp;&nbsp;process_rulebook_count&nbsp;=&nbsp;process_rulebook_count&nbsp;-&nbsp;debugging_rules;</span></span>
<span class="tr"><span class="th" id="line129">129</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(process_rulebook_count&nbsp;&lt;&nbsp;0)&nbsp;process_rulebook_count&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line130">130</span><span class="td">&nbsp;&nbsp;&nbsp;spaces(2*process_rulebook_count);</span></span>
<span class="tr"><span class="th" id="line131">131</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(latest_rule_result--&gt;0&nbsp;==&nbsp;RS_SUCCEEDS)&nbsp;print&nbsp;&quot;[stopped:&nbsp;success]^&quot;;</span></span>
<span class="tr"><span class="th" id="line132">132</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(latest_rule_result--&gt;0&nbsp;==&nbsp;RS_FAILS)&nbsp;print&nbsp;&quot;[stopped:&nbsp;fail]^&quot;;</span></span>
<span class="tr"><span class="th" id="line133">133</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line134">134</span><span class="td">&nbsp;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line135">135</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line136">136</span><span class="td">&nbsp;&nbsp;if&nbsp;(debugging_rules)</span></span>
<span class="tr"><span class="th" id="line137">137</span><span class="td">&nbsp;&nbsp;&nbsp;process_rulebook_count&nbsp;=&nbsp;process_rulebook_count&nbsp;-&nbsp;debugging_rules;</span></span>
<span class="tr"><span class="th" id="line138">138</span><span class="td">&nbsp;&nbsp;latest_rule_result--&gt;0&nbsp;=&nbsp;RS_NEITHER;</span></span>
<span class="tr"><span class="th" id="line139">139</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line140">140</span><span class="td">&nbsp;debugging_rules&nbsp;=&nbsp;parameter;</span></span>
<span class="tr"><span class="th" id="line141">141</span><span class="td">&nbsp;self&nbsp;=&nbsp;ss;&nbsp;parameter_value&nbsp;=&nbsp;spv;</span></span>
<span class="tr"><span class="th" id="line142">142</span><span class="td">&nbsp;return&nbsp;rv;</span></span>
<span class="tr"><span class="th" id="line143">143</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line144">144</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line145">145</span><span class="td">[&nbsp;RulebookParBreak&nbsp;no_paragraph_skips;</span></span>
<span class="tr"><span class="th" id="line146">146</span><span class="td">&nbsp;if&nbsp;((no_paragraph_skips&nbsp;==&nbsp;false)&nbsp;&amp;&amp;&nbsp;(say__pc&nbsp;&amp;&nbsp;PARA_NORULEBOOKBREAKS&nbsp;==&nbsp;0))</span></span>
<span class="tr"><span class="th" id="line147">147</span><span class="td">&nbsp;&nbsp;DivideParagraphPoint();</span></span>
<span class="tr"><span class="th" id="line148">148</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#rulebooks-specifying-outcomes">Specifying Outcomes.</h3><p><p> The following provide ways for rules to succeed, fail or decline to do either.<p></p><p> <span class="fixed"><a href="./Rulebooks.i6t.html#line182">SetRulebookOutcome</a></span> is a little different: it changes the outcome state of the most recent rule completed, not the current one. (It&#39;s used only when saving and restoring this in the actions machinery: rules should not call it.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line160">160</span><span class="td">[&nbsp;ActRulebookSucceeds&nbsp;rule_id;</span></span>
<span class="tr"><span class="th" id="line161">161</span><span class="td">&nbsp;if&nbsp;(rule_id)&nbsp;reason_the_action_failed&nbsp;=&nbsp;rule_id;</span></span>
<span class="tr"><span class="th" id="line162">162</span><span class="td">&nbsp;RulebookSucceeds();</span></span>
<span class="tr"><span class="th" id="line163">163</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line164">164</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line165">165</span><span class="td">[&nbsp;ActRulebookFails&nbsp;rule_id;</span></span>
<span class="tr"><span class="th" id="line166">166</span><span class="td">&nbsp;if&nbsp;(rule_id)&nbsp;reason_the_action_failed&nbsp;=&nbsp;rule_id;</span></span>
<span class="tr"><span class="th" id="line167">167</span><span class="td">&nbsp;RulebookFails();</span></span>
<span class="tr"><span class="th" id="line168">168</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line169">169</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line170">170</span><span class="td">[&nbsp;RulebookSucceeds&nbsp;weak_kind&nbsp;value;</span></span>
<span class="tr"><span class="th" id="line171">171</span><span class="td">&nbsp;RecordRuleOutcome(RS_SUCCEEDS,&nbsp;weak_kind,&nbsp;value);</span></span>
<span class="tr"><span class="th" id="line172">172</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line173">173</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line174">174</span><span class="td">[&nbsp;RulebookFails&nbsp;weak_kind&nbsp;value;</span></span>
<span class="tr"><span class="th" id="line175">175</span><span class="td">&nbsp;RecordRuleOutcome(RS_FAILS,&nbsp;weak_kind,&nbsp;value);</span></span>
<span class="tr"><span class="th" id="line176">176</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line177">177</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line178">178</span><span class="td">[&nbsp;RuleHasNoOutcome;</span></span>
<span class="tr"><span class="th" id="line179">179</span><span class="td">&nbsp;RecordRuleOutcome(RS_NEITHER,&nbsp;0,&nbsp;0);</span></span>
<span class="tr"><span class="th" id="line180">180</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line181">181</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line182">182</span><span class="td">[&nbsp;SetRulebookOutcome&nbsp;a;</span></span>
<span class="tr"><span class="th" id="line183">183</span><span class="td">&nbsp;latest_rule_result--&gt;0&nbsp;=&nbsp;a;</span></span>
<span class="tr"><span class="th" id="line184">184</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#rulebooks-discovering-outcomes">Discovering Outcomes.</h3><p><p> And here is how to tell what the results were.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line190">190</span><span class="td">[&nbsp;RulebookOutcome&nbsp;a;</span></span>
<span class="tr"><span class="th" id="line191">191</span><span class="td">&nbsp;a&nbsp;=&nbsp;latest_rule_result--&gt;0;</span></span>
<span class="tr"><span class="th" id="line192">192</span><span class="td">&nbsp;if&nbsp;((a&nbsp;==&nbsp;RS_FAILS)&nbsp;||&nbsp;(a&nbsp;==&nbsp;RS_SUCCEEDS))&nbsp;return&nbsp;a;</span></span>
<span class="tr"><span class="th" id="line193">193</span><span class="td">&nbsp;return&nbsp;RS_NEITHER;</span></span>
<span class="tr"><span class="th" id="line194">194</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line195">195</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line196">196</span><span class="td">[&nbsp;RulebookFailed;</span></span>
<span class="tr"><span class="th" id="line197">197</span><span class="td">&nbsp;if&nbsp;(latest_rule_result--&gt;0&nbsp;==&nbsp;RS_FAILS)&nbsp;rtrue;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line198">198</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line199">199</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line200">200</span><span class="td">[&nbsp;RulebookSucceeded;</span></span>
<span class="tr"><span class="th" id="line201">201</span><span class="td">&nbsp;if&nbsp;(latest_rule_result--&gt;0&nbsp;==&nbsp;RS_SUCCEEDS)&nbsp;rtrue;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line202">202</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line203">203</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line204">204</span><span class="td">[&nbsp;ResultOfRule&nbsp;RB&nbsp;V&nbsp;F&nbsp;K&nbsp;a;</span></span>
<span class="tr"><span class="th" id="line205">205</span><span class="td">&nbsp;if&nbsp;(RB)&nbsp;FollowRulebook(RB,&nbsp;V,&nbsp;F);</span></span>
<span class="tr"><span class="th" id="line206">206</span><span class="td">&nbsp;a&nbsp;=&nbsp;latest_rule_result--&gt;0;</span></span>
<span class="tr"><span class="th" id="line207">207</span><span class="td">&nbsp;if&nbsp;((a&nbsp;==&nbsp;RS_FAILS)&nbsp;||&nbsp;(a&nbsp;==&nbsp;RS_SUCCEEDS))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line208">208</span><span class="td">&nbsp;&nbsp;a&nbsp;=&nbsp;latest_rule_result--&gt;1;</span></span>
<span class="tr"><span class="th" id="line209">209</span><span class="td">&nbsp;&nbsp;if&nbsp;(a)&nbsp;return&nbsp;latest_rule_result--&gt;2;</span></span>
<span class="tr"><span class="th" id="line210">210</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line211">211</span><span class="td">&nbsp;if&nbsp;(K)&nbsp;return&nbsp;DefaultValueOfKOV(K);</span></span>
<span class="tr"><span class="th" id="line212">212</span><span class="td">&nbsp;return&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line213">213</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#rulebooks-printing-rule-names">Printing Rule Names.</h3><p><p> This is the I6 printing rule used for a value of kind &quot;rule&quot;, which as noted above can either be rulebook ID numbers in the range 0 to <em>N-1</em> or are addresses of individual rules.<p></p><p> Names of rules and rulebooks take up a fair amount of space, and one of the main memory economies enforced by the &quot;Use memory economy&quot; option is to omit the necessary arrays. (It&#39;s not the text which is the problem so much as the table of addresses pointing to that text, which has to live in precious readable memory on the Z-machine.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line227">227</span><span class="td">#IFNDEF&nbsp;MEMORY_ECONOMY;</span></span>
<span class="tr"><span class="th" id="line228">228</span><span class="td">{-array:Phrases::Manager::RulebookNames}</span></span>
<span class="tr"><span class="th" id="line229">229</span><span class="td">#ENDIF;&nbsp;!&nbsp;MEMORY_ECONOMY</span></span>
<span class="tr"><span class="th" id="line230">230</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line231">231</span><span class="td">[&nbsp;RulePrintingRule&nbsp;R&nbsp;p1;</span></span>
<span class="tr"><span class="th" id="line232">232</span><span class="td">#ifndef&nbsp;MEMORY_ECONOMY;</span></span>
<span class="tr"><span class="th" id="line233">233</span><span class="td">&nbsp;if&nbsp;((R&gt;=0)&nbsp;&amp;&amp;&nbsp;(R&lt;NUMBER_RULEBOOKS_CREATED))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line234">234</span><span class="td">&nbsp;&nbsp;print&nbsp;(string)&nbsp;(RulebookNames--&gt;R);</span></span>
<span class="tr"><span class="th" id="line235">235</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line236">236</span><span class="td">{-call:Phrases::Manager::compile_rule_printing_switch}</span></span>
<span class="tr"><span class="th" id="line237">237</span><span class="td">&nbsp;&nbsp;print&nbsp;&quot;(nameless&nbsp;rule&nbsp;at&nbsp;address&nbsp;&quot;,&nbsp;R,&nbsp;&quot;)&quot;;</span></span>
<span class="tr"><span class="th" id="line238">238</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line239">239</span><span class="td">#ifnot;</span></span>
<span class="tr"><span class="th" id="line240">240</span><span class="td">&nbsp;if&nbsp;((R&gt;=0)&nbsp;&amp;&amp;&nbsp;(R&lt;NUMBER_RULEBOOKS_CREATED))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line241">241</span><span class="td">&nbsp;&nbsp;print&nbsp;&quot;(rulebook&nbsp;&quot;,&nbsp;R,&nbsp;&quot;)&quot;;</span></span>
<span class="tr"><span class="th" id="line242">242</span><span class="td">&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line243">243</span><span class="td">&nbsp;&nbsp;print&nbsp;&quot;(rule&nbsp;at&nbsp;address&nbsp;&quot;,&nbsp;R,&nbsp;&quot;)&quot;;</span></span>
<span class="tr"><span class="th" id="line244">244</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line245">245</span><span class="td">#endif;</span></span>
<span class="tr"><span class="th" id="line246">246</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#rulebooks-casting">Casting.</h3><p><p> Nothing needs to be done to a rulebook value to make it a rule value.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line252">252</span><span class="td">[&nbsp;RULEBOOK_TY_to_RULE_TY&nbsp;r;</span></span>
<span class="tr"><span class="th" id="line253">253</span><span class="td">&nbsp;return&nbsp;r;</span></span>
<span class="tr"><span class="th" id="line254">254</span><span class="td">];</span></span>
</div><div class='text'>
<h3 id="#rulebooks-debugging">Debugging.</h3><p><p> Two modest routines to print out the names of rules and rulebooks when they occur, in so far as memory economy allows this.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line261">261</span><span class="td">[&nbsp;DebugRulebooks&nbsp;subs&nbsp;parameter&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line262">262</span><span class="td">&nbsp;spaces(2*process_rulebook_count);</span></span>
<span class="tr"><span class="th" id="line263">263</span><span class="td">&nbsp;print&nbsp;&quot;[&quot;,&nbsp;(RulePrintingRule)&nbsp;subs;</span></span>
<span class="tr"><span class="th" id="line264">264</span><span class="td">&nbsp;if&nbsp;(parameter)&nbsp;print&nbsp;&quot;&nbsp;/&nbsp;on&nbsp;O&quot;,&nbsp;parameter;</span></span>
<span class="tr"><span class="th" id="line265">265</span><span class="td">&nbsp;print&nbsp;&quot;]^&quot;;</span></span>
<span class="tr"><span class="th" id="line266">266</span><span class="td">];</span></span>
<span class="tr"><span class="th" id="line267">267</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line268">268</span><span class="td">[&nbsp;DB_Rule&nbsp;R&nbsp;N&nbsp;blocked;</span></span>
<span class="tr"><span class="th" id="line269">269</span><span class="td">&nbsp;if&nbsp;(R==0)&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line270">270</span><span class="td">&nbsp;print&nbsp;&quot;[Rule&nbsp;~&quot;,&nbsp;(RulePrintingRule)&nbsp;R,&nbsp;&quot;~&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line271">271</span><span class="td">&nbsp;#ifdef&nbsp;NUMBERED_RULES;&nbsp;print&nbsp;&quot;(&quot;,&nbsp;N,&nbsp;&quot;)&nbsp;&quot;;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line272">272</span><span class="td">&nbsp;if&nbsp;(blocked&nbsp;==&nbsp;false)&nbsp;&quot;applies.]&quot;;</span></span>
<span class="tr"><span class="th" id="line273">273</span><span class="td">&nbsp;print&nbsp;&quot;does&nbsp;not&nbsp;apply&nbsp;(wrong&nbsp;&quot;,&nbsp;(address)&nbsp;blocked,&nbsp;&quot;).]^&quot;;</span></span>
<span class="tr"><span class="th" id="line274">274</span><span class="td">];</span></span>
</div><footer><hr><p><em>From I6T lib 6/12N &copy; Graham Nelson and published under the <a href="https://github.com/zedlopez/standard_rules/blob/main/LICENSE.md">Artistic License 2.0</a>. Distributed with <a href="http://inform7.com/">Inform 7 6M62</a>.</em></p></footer></body></html>
