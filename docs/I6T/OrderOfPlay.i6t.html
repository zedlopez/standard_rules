<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head><title>OrderOfPlay</title>
  <style>
span.th, span.td { display: table-cell; }
span.td { padding-left: 2rem; }
span.th { width:4rem; text-align: right; }
span.tr { display: table-row;     counter-increment: linenum; }
span.line_no::before {
    content: counter(linenum);
    text-align: right;
    display: block;
    font-family: monospace;
    font-weight: normal;
}
h1 { margin: 0; }
.fixed { font-family: monospace }
.em { font-style: italic; }
.center { text-align: center; }
    body { font-family: sans-serif; margin: 1.5rem 0 0 3rem; background-color: #fafaf0; width: 80rem; }
    .pre { font-family: monospace; margin: auto; width: 80rem; }
#front_matter,.text { width: 50rem; }
.text { border-bottom: .5px solid black; border-top: .5px solid black; margin-top: 1rem;
padding-bottom: 1rem; margin-bottom: 2rem; }
/*.subtitle { font-weight: bold; font-size: 1.2rem; }*/
    </style>
</head>
<body>
<header>
<h1>I6 Template Layer</h1>
<div class="subtitle"><a href="http://inform7.com/">Inform 7 6M62</a> &bull; <a href="./index.html">Index</a> &bull; <a href="./Introduction.html">Introduction</a></div><hr></header>
<div id="front_matter">
<h2><a href="./OrderOfPlay.i6t">OrderOfPlay.i6t</a></h2><h3>Main.</h3><p><p> This is where every I6 story file begins execution: it can end either by returning, or by a <span class="fixed">quit</span> statement or equivalent opcode. (In I7 this does indeed happen when the quitting the game action is carried out, or when QUIT is typed as a reply to the final question; it&#39;s only if the user has altered the shutdown rulebook that we might ever actually return from <span class="fixed"><a href="./Output-Stub.i6t.html#line12">Main</a></span>.) The return value from <span class="fixed"><a href="./Output-Stub.i6t.html#line12">Main</a></span> is not meaningful.<p></p><p> The <span class="fixed"><a href="./OrderOfPlay.i6t.html#line23">EarlyInTurnSequence</a></span> flag is used to enforce the requirement that the &quot;parse command rule&quot; and &quot;generate action rule&quot; do nothing unless the turn sequence rulebook is being followed directly from <span class="fixed"><a href="./Output-Stub.i6t.html#line12">Main</a></span>, an anomaly explained in the Standard Rules.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line23">23</span><span class="td">Global&nbsp;EarlyInTurnSequence;</span></span>
<span class="tr"><span class="th" id="line24">24</span><span class="td">Global&nbsp;IterationsOfTurnSequence;</span></span>
<span class="tr"><span class="th" id="line25">25</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line26">26</span><span class="td">[&nbsp;Main;</span></span>
<span class="tr"><span class="th" id="line27">27</span><span class="td">&nbsp;#ifdef&nbsp;TARGET_ZCODE;&nbsp;max_z_object&nbsp;=&nbsp;#largest_object&nbsp;-&nbsp;255;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line28">28</span><span class="td">&nbsp;ClearRTP();</span></span>
<span class="tr"><span class="th" id="line29">29</span><span class="td">&nbsp;FollowRulebook(STARTUP_RB);</span></span>
<span class="tr"><span class="th" id="line30">30</span><span class="td">&nbsp;#ifdef&nbsp;DEBUG;&nbsp;InternalTestCases();&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line31">31</span><span class="td">&nbsp;while&nbsp;(true)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line32">32</span><span class="td">&nbsp;&nbsp;while&nbsp;(deadflag&nbsp;==&nbsp;false)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line33">33</span><span class="td">&nbsp;&nbsp;&nbsp;EarlyInTurnSequence&nbsp;=&nbsp;true;</span></span>
<span class="tr"><span class="th" id="line34">34</span><span class="td">&nbsp;&nbsp;&nbsp;action&nbsp;=&nbsp;##Wait;&nbsp;meta&nbsp;=&nbsp;false;&nbsp;noun&nbsp;=&nbsp;nothing;&nbsp;second&nbsp;=&nbsp;nothing;</span></span>
<span class="tr"><span class="th" id="line35">35</span><span class="td">&nbsp;&nbsp;&nbsp;actor&nbsp;=&nbsp;player;</span></span>
<span class="tr"><span class="th" id="line36">36</span><span class="td">&nbsp;&nbsp;&nbsp;FollowRulebook(TURN_SEQUENCE_RB);</span></span>
<span class="tr"><span class="th" id="line37">37</span><span class="td">&nbsp;&nbsp;&nbsp;IterationsOfTurnSequence++;</span></span>
<span class="tr"><span class="th" id="line38">38</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line39">39</span><span class="td">&nbsp;&nbsp;if&nbsp;(FollowRulebook(SHUTDOWN_RB)&nbsp;==&nbsp;false)&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line40">40</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line41">41</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Virtual Machine Startup Rule.</h3><p><p> We delegate to the appropriate VM-specific section of code for the real work. The printing of three blank lines at the start of play is traditional: on early Z-machine interpreters such as InfoTaskForce and Zip it was a necessity because of the way they buffered output. On modern windowed ones it still helps to space the opening text better.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line51">51</span><span class="td">[&nbsp;VIRTUAL_MACHINE_STARTUP_R;</span></span>
<span class="tr"><span class="th" id="line52">52</span><span class="td">&nbsp;CarryOutActivity(STARTING_VIRTUAL_MACHINE_ACT);</span></span>
<span class="tr"><span class="th" id="line53">53</span><span class="td">&nbsp;VM_Initialise();</span></span>
<span class="tr"><span class="th" id="line54">54</span><span class="td">&nbsp;print&nbsp;&quot;^^^&quot;;</span></span>
<span class="tr"><span class="th" id="line55">55</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line56">56</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Initial Situation.</h3><p><p> The array <span class="fixed">InitialSituation</span> is compiled by NI and contains:<p></p><p> (-0) The object number for the player, which is usually <span class="fixed">selfobj</span>. (-1) The object in or on which the player begins, if he does. (This will always be an enterable container or supporter, or <span class="fixed">nothing</span>.) (-2) The room in which the player begins, which is usually the first room created in the source text. (-3) The initial time of day, which is usually 9 AM.<p></p><p> The start object and start room are meaningful only if the player&#39;s object is compiled outside of the object tree (as can happen if the source text reads, say, &quot;Mrs Bridges is a woman. The player is Mrs Bridges.&quot;): in other circumstances they are often correct, but this must not be relied on.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line74">74</span><span class="td">Constant&nbsp;PLAYER_OBJECT_INIS&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line75">75</span><span class="td">Constant&nbsp;START_OBJECT_INIS&nbsp;=&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line76">76</span><span class="td">Constant&nbsp;START_ROOM_INIS&nbsp;=&nbsp;2;</span></span>
<span class="tr"><span class="th" id="line77">77</span><span class="td">Constant&nbsp;START_TIME_INIS&nbsp;=&nbsp;3;</span></span>
<span class="tr"><span class="th" id="line78">78</span><span class="td">Constant&nbsp;DONE_INIS&nbsp;=&nbsp;4;</span></span>
<span class="tr"><span class="th" id="line79">79</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line80">80</span><span class="td">{-array:PL::Player::InitialSituation}</span></span>
</div><div class='text'>
<h3>Initialise Memory Rule.</h3><p><p> This rule amalgamates some minimal initialisations which all need to happen before we can risk using some of the more exotic I7 kinds:<p></p><p> (a) The language definition might call for initialisation, although the default language of play (English) does not.<p></p><p> (b) A handful of variables are filled in. <span class="fixed">I7_LOOKMODE</span> is a constant created by the use options &quot;use full-length room descriptions&quot; or &quot;use abbreviated room descriptions&quot;, but otherwise not existing. It is particularly important that <span class="fixed"><a href="./Output.i6t.html#line228">player</a></span> have the correct value, as the process of initialising the memory heap uses the player as the presumed actor when creating memory representations of literal stored actions where no actor was specified; this is why <span class="fixed"><a href="./Output.i6t.html#line228">player</a></span> is initialised here and not in the &quot;position player in model world rule&quot; below. The other interesting point here is that we explicitly set <span class="fixed"><a href="./Output.i6t.html#line169">location</a></span> and <span class="fixed"><a href="./Output.i6t.html#line229">real_location</a></span> to <span class="fixed">nothing</span>, which is certainly incorrect, even though we know better. We do this so that the &quot;update chronological records rule&quot; cannot see where the player is: see the Standard Rules for an explanation of why this is, albeit perhaps dubiously, a good thing.<p></p><p> (c) We start the machinery needed to check that property accesses are valid during play.<p></p><p> (d) And we initialise the memory allocation heap, and expand the literal constants, as hinted above: these are called &quot;block constants&quot; since they occupy blocks of memory.<p></p><p> The <span class="fixed"><a href="./Output.i6t.html#line207">not_yet_in_play</a></span> flag, which is cleared when the first command is about to be read from the keyboard, suppresses the standard status line text: thus, if there is some long text to read before the player finds out where he is, the surprise will not be spoiled.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line116">116</span><span class="td">[&nbsp;INITIALISE_MEMORY_R;</span></span>
<span class="tr"><span class="th" id="line117">117</span><span class="td">&nbsp;#ifdef&nbsp;TARGET_GLULX;&nbsp;VM_PreInitialise();&nbsp;#Endif;</span></span>
<span class="tr"><span class="th" id="line118">118</span><span class="td">&nbsp;#Ifdef&nbsp;LanguageInitialise;&nbsp;LanguageInitialise();&nbsp;#Endif;</span></span>
<span class="tr"><span class="th" id="line119">119</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line120">120</span><span class="td">&nbsp;not_yet_in_play&nbsp;=&nbsp;true;</span></span>
<span class="tr"><span class="th" id="line121">121</span><span class="td">&nbsp;#ifdef&nbsp;I7_LOOKMODE;&nbsp;lookmode&nbsp;=&nbsp;I7_LOOKMODE;&nbsp;#endif;</span></span>
<span class="tr"><span class="th" id="line122">122</span><span class="td">&nbsp;player&nbsp;=&nbsp;InitialSituation--&gt;PLAYER_OBJECT_INIS;</span></span>
<span class="tr"><span class="th" id="line123">123</span><span class="td">&nbsp;the_time&nbsp;=&nbsp;InitialSituation--&gt;START_TIME_INIS;</span></span>
<span class="tr"><span class="th" id="line124">124</span><span class="td">&nbsp;real_location&nbsp;=&nbsp;nothing;</span></span>
<span class="tr"><span class="th" id="line125">125</span><span class="td">&nbsp;location&nbsp;=&nbsp;nothing;</span></span>
<span class="tr"><span class="th" id="line126">126</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line127">127</span><span class="td">&nbsp;CreatePropertyOffsets();</span></span>
<span class="tr"><span class="th" id="line128">128</span><span class="td">&nbsp;HeapInitialise();&nbsp;!&nbsp;Create&nbsp;a&nbsp;completely&nbsp;unused&nbsp;memory&nbsp;allocation&nbsp;heap</span></span>
<span class="tr"><span class="th" id="line129">129</span><span class="td">&nbsp;StackFramingInitialise();&nbsp;!&nbsp;Create&nbsp;an&nbsp;empty&nbsp;stack</span></span>
<span class="tr"><span class="th" id="line130">130</span><span class="td">&nbsp;CreateDynamicRelations();&nbsp;!&nbsp;Create&nbsp;relation&nbsp;structures&nbsp;on&nbsp;the&nbsp;heap</span></span>
<span class="tr"><span class="th" id="line131">131</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line132">132</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line133">133</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Seed Random Number Generator Rule.</h3><p><p> Unless a seed is provided by NI, and it won&#39;t be for released story files, the VM&#39;s interpreter is supposed to start up with a good seed in its random number generator: something usually derived from, say, the milliseconds part of the current time of day, which is unlikely to repeat or show any pattern in real-world use. However, early Z-machine interpreters often did this quite badly, starting with poor seed values which meant that the first few random numbers always had something in common (being fairly small in their range, for instance). To obviate this we extract and throw away 100 random numbers to get the generator going, shaking out more obvious early patterns, but that cannot really help much if the VM interpreter&#39;s RNG is badly written. &quot;Anyone who considers arithmetical methods of producing random digits is, of course, in a state of sin&quot; (von Neumann).<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line150">150</span><span class="td">[&nbsp;SEED_RANDOM_NUMBER_GENERATOR_R&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line151">151</span><span class="td">&nbsp;if&nbsp;({-value:rng_seed_at_start_of_play})&nbsp;VM_Seed_RNG({-value:rng_seed_at_start_of_play});</span></span>
<span class="tr"><span class="th" id="line152">152</span><span class="td">&nbsp;for&nbsp;(i=1:&nbsp;i&lt;=100:&nbsp;i++)&nbsp;random(i);</span></span>
<span class="tr"><span class="th" id="line153">153</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line154">154</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Position Player In Model World Rule.</h3><p><p> This seems as good a place as any to write down the invariant we attempt to maintain for the player&#39;s position variables:<p></p><p> (1) The <span class="fixed"><a href="./Output.i6t.html#line228">player</a></span> variable is the object through which the player plays, which is always a person: its value is always set by starting from <span class="fixed">selfobj</span> and then making a sequence of 0 or more <span class="fixed"><a href="./WorldModel.i6t.html#line419">ChangePlayer(new_value)</a></span> calls. (This enables us to make sure it has the correct property values for printed name and so forth.)<p></p><p> (2) The <span class="fixed"><a href="./Output.i6t.html#line169">location</a></span> is always either the current room, a valid I7 room, or <span class="fixed">thedark</span>, which is not a valid I7 object but is distinguishable both from all I7 objects and from <span class="fixed">nothing</span>. The <span class="fixed"><a href="./Output.i6t.html#line229">real_location</a></span> is always the current room, which is always a valid I7 room. <span class="fixed"><a href="./Output.i6t.html#line169">location</a></span> equals <span class="fixed">thedark</span> if and only if the player does not have light to see by; the routine <span class="fixed"><a href="./Light.i6t.html#line157">SilentlyConsiderLight</a></span> updates this without printing any messages to announce the fall or lifting of darkness (hence &quot;silently&quot;).<p></p><p> (3) The <span class="fixed"><a href="./Output.i6t.html#line228">player</a></span> object is always in the subtree of <span class="fixed"><a href="./Output.i6t.html#line229">real_location</a></span>, and is always in a chain <em></em> where <em></em> is the player, <em></em> is <span class="fixed"><a href="./Output.i6t.html#line229">real_location</a></span>, <em></em> and <em></em> are all either enterable containers, enterable supporters, or component parts of such. The routine <span class="fixed"><a href="./WorldModel.i6t.html#line78">LocationOf</a></span>, applied to the player object, always agrees with <span class="fixed"><a href="./Output.i6t.html#line229">real_location</a></span>.<p></p><p> (4) &quot;Floating&quot; objects, such as backdrops and two-sided doors, are in theory present in more than one room at once. In practice they can only be in a single position in the I6 object tree at any one time. The rule is that if they are theoretically present in the <span class="fixed"><a href="./Output.i6t.html#line229">real_location</a></span>, then they are actually present in the subtree of <span class="fixed"><a href="./Output.i6t.html#line229">real_location</a></span>. The routine <span class="fixed"><a href="./WorldModel.i6t.html#line475">MoveFloatingObjects</a></span> updates this, and must be called whenever the player moves from one room to another.<p></p><p> (5) Any objects carried by the player have the I6 <span class="fixed">moved</span> attribute set. The <span class="fixed"><a href="./Output.i6t.html#line233">SACK_OBJECT</a></span> variable is always set to the object of kind &quot;player&#39;s holdall&quot; which the player has most recently been carrying, or had as a component part of himself. The &quot;note object acquisitions&quot; rule updates this.<p></p><p> These invariants are usually all false before the following rule is executed; they are all true once it has completed. In addition, because the global action variables usually hold details of the action most recently carried out, we initialise these as if the most recent action had been the player waiting. (Nobody ought to use these variables at this point, but in case they do use them by accident in a &quot;when play begins&quot; rule, we want Inform to behave predictably and without type-unsafe values entering code.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line204">204</span><span class="td">[&nbsp;POSITION_PLAYER_IN_MODEL_R&nbsp;player_to_be;</span></span>
<span class="tr"><span class="th" id="line205">205</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line206">206</span><span class="td">&nbsp;player&nbsp;=&nbsp;selfobj;</span></span>
<span class="tr"><span class="th" id="line207">207</span><span class="td">&nbsp;player_to_be&nbsp;=&nbsp;InitialSituation--&gt;PLAYER_OBJECT_INIS;</span></span>
<span class="tr"><span class="th" id="line208">208</span><span class="td">&nbsp;</span></span>
<span class="tr"><span class="th" id="line209">209</span><span class="td">&nbsp;location&nbsp;=&nbsp;LocationOf(player_to_be);</span></span>
<span class="tr"><span class="th" id="line210">210</span><span class="td">&nbsp;if&nbsp;(location&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line211">211</span><span class="td">&nbsp;&nbsp;location&nbsp;=&nbsp;InitialSituation--&gt;START_ROOM_INIS;</span></span>
<span class="tr"><span class="th" id="line212">212</span><span class="td">&nbsp;&nbsp;if&nbsp;(InitialSituation--&gt;START_OBJECT_INIS)</span></span>
<span class="tr"><span class="th" id="line213">213</span><span class="td">&nbsp;&nbsp;&nbsp;move&nbsp;player_to_be&nbsp;to&nbsp;InitialSituation--&gt;START_OBJECT_INIS;</span></span>
<span class="tr"><span class="th" id="line214">214</span><span class="td">&nbsp;&nbsp;else&nbsp;move&nbsp;player_to_be&nbsp;to&nbsp;location;</span></span>
<span class="tr"><span class="th" id="line215">215</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line216">216</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line217">217</span><span class="td">&nbsp;if&nbsp;(player_to_be&nbsp;~=&nbsp;player)&nbsp;{&nbsp;remove&nbsp;selfobj;&nbsp;ChangePlayer(player_to_be);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line218">218</span><span class="td">&nbsp;else&nbsp;{&nbsp;real_location&nbsp;=&nbsp;location;&nbsp;SilentlyConsiderLight();&nbsp;}</span></span>
<span class="tr"><span class="th" id="line219">219</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line220">220</span><span class="td">&nbsp;NOTE_OBJECT_ACQUISITIONS_R();&nbsp;MoveFloatingObjects();</span></span>
<span class="tr"><span class="th" id="line221">221</span><span class="td">&nbsp;</span></span>
<span class="tr"><span class="th" id="line222">222</span><span class="td">&nbsp;actor&nbsp;=&nbsp;player;&nbsp;act_requester&nbsp;=&nbsp;nothing;&nbsp;actors_location&nbsp;=&nbsp;real_location;&nbsp;action&nbsp;=&nbsp;##Wait;</span></span>
<span class="tr"><span class="th" id="line223">223</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line224">224</span><span class="td">&nbsp;InitialSituation--&gt;DONE_INIS&nbsp;=&nbsp;true;</span></span>
<span class="tr"><span class="th" id="line225">225</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line226">226</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Parse Command Rule.</h3><p><p> This section contains only two primitive rules from the turn sequence rulebook, the matched pair of the &quot;parse command rule&quot; and the &quot;generate action rule&quot;; the others are found in the sections on Light and Time.<p></p><p> We use almost identically the same parser as that in the I6 library, since it is a well-proven and understood algorithm. The I6 parser returns some of its results in a supplied array (here <span class="fixed">parser_results</span>, though the I6 library used to call this <span class="fixed">inputobjs</span>), but others are in global variables:<p></p><p> (1) The <span class="fixed">parser_results</span> array holds four words, used as indexed by the constants below.<p></p><p> (-a) The action can be a valid I6 action number, or an I6 &quot;fake action&quot;, a concept not used overtly in I7. Most valid I6 actions correspond exactly to I7 actions, but in principle it is possible to define (say) extra debugging commands entirely at the I6 level.<p></p><p> (-b) The count <span class="fixed"><a href="./OrderOfPlay.i6t.html#line292">NO_INPS_PRES</a></span> is always 0, 1 or 2, and then that many of the next two words are meaningful.<p></p><p> (-c) Each of the &quot;inp&quot; values is either 0, meaning &quot;put the multiple object list here&quot;; or 1, meaning &quot;not an object but a value&quot;; or a valid I6 object. (We use the scoping rules to ensure that any I6 object visible to the parser is also a valid I7 object, so &ndash; unlike with actions &ndash; we need not distinguish between the two.)<p></p><p> (2) The global variable <span class="fixed"><a href="./Output.i6t.html#line237">actor</a></span> is set to the person asked to carry out the command, or is the same as <span class="fixed"><a href="./Output.i6t.html#line228">player</a></span> if nobody was mentioned. Thus it will be the object for Floyd in the command FLOYD, GET PERMIT, but will be just <span class="fixed"><a href="./Output.i6t.html#line228">player</a></span> in the command EAST.<p></p><p> (3) The global variables <span class="fixed"><a href="./Output.i6t.html#line262">special_number1</a></span> and, if necessary, <span class="fixed"><a href="./Output.i6t.html#line263">special_number2</a></span> hold values corresponding to the first and second of the &quot;inps&quot; to be returned as 1. Thus, if one of the &quot;inps&quot; is a value and the other is an object, then <span class="fixed"><a href="./Output.i6t.html#line262">special_number1</a></span> is that value; only if both are values rather than objects will <span class="fixed"><a href="./Output.i6t.html#line263">special_number2</a></span> be used. There is no indication of the kind of these values: I6 is typeless.<p></p><p> (4) At most one of the &quot;inps&quot; is permitted to be 1, referring to a multiple object list. (And a multiple value list is forbidden.) If this happens, the list of objects is stored in an I6 table array (i.e., with the 0th word being the number of subsequent words) called <span class="fixed">multiple_object</span>, and the parser will have set the <span class="fixed"><a href="./Output.i6t.html#line245">toomany_flag</a></span> if an overflow occurred &ndash; that is, if the list was truncated because it originally called for more than 63 objects.<p></p><p> (5) The global variable <span class="fixed"><a href="./Output.i6t.html#line241">meta</a></span> is set if the action is one marked as such in the I6 grammar. A confusion in the design of I6 is that being out of world, as we would say in I7 terms, is associated not with an action as such but with the command verb triggering it. (This in practice caused no trouble since we never used, say, the word SAVE for both saving the game and saving, I don&#39;t know, box top coupons.) The state of <span class="fixed"><a href="./Output.i6t.html#line241">meta</a></span> returned by the I6 parser does not quite correspond to I7&#39;s &quot;out of world&quot; concept, so we will alter it in a few cases.<p></p><p> Some of these conventions are a little odd-looking now: why not simply have a larger results array, rather than this pile of occasionally used variables? The reasons are purely historical: the I6 parser developed gradually over about a decade.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line291">291</span><span class="td">Constant&nbsp;ACTION_PRES&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line292">292</span><span class="td">Constant&nbsp;NO_INPS_PRES&nbsp;=&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line293">293</span><span class="td">Constant&nbsp;INP1_PRES&nbsp;=&nbsp;2;</span></span>
<span class="tr"><span class="th" id="line294">294</span><span class="td">Constant&nbsp;INP2_PRES&nbsp;=&nbsp;3;&nbsp;!&nbsp;Parser.i6t&nbsp;code&nbsp;assumes&nbsp;this&nbsp;is&nbsp;INP1_PRES&nbsp;+&nbsp;1</span></span>
<span class="tr"><span class="th" id="line295">295</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line296">296</span><span class="td">[&nbsp;PARSE_COMMAND_R;</span></span>
<span class="tr"><span class="th" id="line297">297</span><span class="td">&nbsp;if&nbsp;(EarlyInTurnSequence&nbsp;==&nbsp;false)&nbsp;rfalse;&nbsp;!&nbsp;Prevent&nbsp;use&nbsp;outside&nbsp;top&nbsp;level</span></span>
<span class="tr"><span class="th" id="line298">298</span><span class="td">&nbsp;not_yet_in_play&nbsp;=&nbsp;false;</span></span>
<span class="tr"><span class="th" id="line299">299</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line300">300</span><span class="td">&nbsp;Parser__parse();</span></span>
<span class="tr"><span class="th" id="line301">301</span><span class="td">&nbsp;TreatParserResults();</span></span>
<span class="tr"><span class="th" id="line302">302</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line303">303</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Treat Parser Results.</h3><p><p> We don&#39;t quite use the results exactly as they are returned by the parser: we make modifications in a few special cases.<p></p><p> (1) <span class="fixed">##MistakeAction</span> is a valid I6 action, but not an I7 one. It is used to implement &quot;Understand ... as a mistake&quot;, which provides a short-cut way for I7 source text to specify responses to mistaken guesses at the syntax expected for commands. It can therefore result from a whole variety of different commands, some of which might be flagged <span class="fixed"><a href="./Output.i6t.html#line241">meta</a></span>, others not. We forcibly set the <span class="fixed"><a href="./Output.i6t.html#line241">meta</a></span> flag: a mistake in guessing the command always happens out of world.<p></p><p> (2) A command in the form PERSON, TELL ME ABOUT SOMETHING is altered to the action resulting from ASK PERSON ABOUT SOMETHING, so that <span class="fixed">##Tell</span> is converted to <span class="fixed">##Ask</span> in these cases.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line322">322</span><span class="td">[&nbsp;TreatParserResults;</span></span>
<span class="tr"><span class="th" id="line323">323</span><span class="td">&nbsp;if&nbsp;(parser_results--&gt;ACTION_PRES&nbsp;==&nbsp;##MistakeAction)&nbsp;meta&nbsp;=&nbsp;true;</span></span>
<span class="tr"><span class="th" id="line324">324</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line325">325</span><span class="td">&nbsp;if&nbsp;(parser_results--&gt;ACTION_PRES&nbsp;==&nbsp;##Tell&nbsp;&amp;&amp;</span></span>
<span class="tr"><span class="th" id="line326">326</span><span class="td">&nbsp;&nbsp;parser_results--&gt;INP1_PRES&nbsp;==&nbsp;player&nbsp;&amp;&amp;&nbsp;actor&nbsp;~=&nbsp;player)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line327">327</span><span class="td">&nbsp;&nbsp;parser_results--&gt;ACTION_PRES&nbsp;=&nbsp;##Ask;</span></span>
<span class="tr"><span class="th" id="line328">328</span><span class="td">&nbsp;&nbsp;parser_results--&gt;INP1_PRES&nbsp;=&nbsp;actor;&nbsp;actor&nbsp;=&nbsp;player;</span></span>
<span class="tr"><span class="th" id="line329">329</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line330">330</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Generate Action Rule.</h3><p><p> For what are, again, historical reasons to do with the development of I6, the current action is recorded in a slate of global variables:<p></p><p> (1) <span class="fixed"><a href="./Output.i6t.html#line237">actor</a></span> is as above; <span class="fixed"><a href="./Output.i6t.html#line240">action</a></span> is the I6 action number or fake action number, though in I7 usage no fake actions should ever reach this point.<p></p><p> (2) <span class="fixed"><a href="./Output.i6t.html#line236">act_requester</a></span> is the person requesting that the actor should perform the action, or <span class="fixed">nothing</span> if the action is the actor&#39;s own choice. In the command FLOYD, MOP FLOOR, the <span class="fixed"><a href="./Output.i6t.html#line236">act_requester</a></span> is the player and the actor is Floyd; but when an action arises from a try phrase in I7, such as &quot;try Floyd mopping the floor&quot;, <span class="fixed"><a href="./Output.i6t.html#line236">act_requester</a></span> is <span class="fixed">nothing</span> because it is Floyd&#39;s own decision to do this. (The computer, of course, represents the will-power of all characters other than the player.)<p></p><p> (3) <span class="fixed"><a href="./Output.i6t.html#line242">inp1</a></span> and <span class="fixed"><a href="./Output.i6t.html#line243">inp2</a></span> are global variables whose contents mean the same as those of <span class="fixed">parser_results--&gt;INP1_PRES</span> and <span class="fixed">parser_results--&gt;INP2_PRES</span>. (This is not duplication, because actions also arise from &quot;try&quot; rather than the parser.)<p></p><p> (4) The variable <span class="fixed"><a href="./Output.i6t.html#line246">multiflag</a></span> is set during the processing of a multiple object list, and clear otherwise. (It is used for instance by the Standard Rules to give more concise reports of some successful actions.) Note that it remains set during any knock-on actions caused by actions in the multiple object list: the following rule is the only place where <span class="fixed"><a href="./Output.i6t.html#line246">multiflag</a></span> is set or cleared.<p></p><p> (5) <span class="fixed"><a href="./Output.i6t.html#line248">noun</a></span> and <span class="fixed"><a href="./Output.i6t.html#line249">second</a></span> are global variables which are equal to <span class="fixed"><a href="./Output.i6t.html#line242">inp1</a></span> and <span class="fixed"><a href="./Output.i6t.html#line243">inp2</a></span> when the latter hold valid object numbers, and are equal to <span class="fixed">nothing</span> otherwise. (This is not duplication either, because it provides us with type-safe access to objects: there is no KOV which can safely represent <span class="fixed"><a href="./Output.i6t.html#line242">inp1</a></span> and <span class="fixed"><a href="./Output.i6t.html#line243">inp2</a></span>, but <span class="fixed"><a href="./Output.i6t.html#line248">noun</a></span> and <span class="fixed"><a href="./Output.i6t.html#line249">second</a></span> are valid for the I7 kind of value &quot;object&quot;.)<p></p><p> In the following rule, we create this set of variables for the action or multiple action(s) suggested by the parser: each action is sent on to <span class="fixed"><a href="./Actions.i6t.html#line305">BeginAction</a></span> for processing. Once done, we reset the above variables in what might seem an odd way: we allow straightforward actions by the player to remain in the variables, but convert requests to other people to the neutral &quot;waiting&quot; action carried out by the player (which is the zero value for actions). Now, in a better world, we would always erase the action like this, because an action once completed ought to be forgotten. The value of <span class="fixed"><a href="./Output.i6t.html#line248">noun</a></span> ought to be visible only during the action&#39;s processing.<p></p><p> But in practice many I7 users write &quot;every turn&quot; rules which are predicated on what the turn&#39;s main action was: say, &quot;Every turn when going: ...&quot; The every turn stage is not until later in the turn sequence, so such rules can only work if we keep the main parser-generated action of the turn in the action variables when we finish up here: so that&#39;s what we do. (Note that <span class="fixed"><a href="./Actions.i6t.html#line305">BeginAction</a></span> preserves the values of the action variables, storing copies on the stack, so whatever may have happened during processing, we finish this routine with the same action variable values that we set at the beginning.)<p></p><p> Finally, note that an out of world action stops the turn sequence early, at the end of action generation: this is what prevents the time of day advancing, every turn rules from firing, and so forth &ndash; see the Standard Rules.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line391">391</span><span class="td">[&nbsp;GENERATE_ACTION_R&nbsp;i;</span></span>
<span class="tr"><span class="th" id="line392">392</span><span class="td">&nbsp;if&nbsp;(EarlyInTurnSequence&nbsp;==&nbsp;false)&nbsp;rfalse;&nbsp;!&nbsp;Prevent&nbsp;use&nbsp;outside&nbsp;top&nbsp;level</span></span>
<span class="tr"><span class="th" id="line393">393</span><span class="td">&nbsp;EarlyInTurnSequence&nbsp;=&nbsp;false;</span></span>
<span class="tr"><span class="th" id="line394">394</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line395">395</span><span class="td">&nbsp;action&nbsp;=&nbsp;parser_results--&gt;ACTION_PRES;</span></span>
<span class="tr"><span class="th" id="line396">396</span><span class="td">&nbsp;act_requester&nbsp;=&nbsp;nothing;&nbsp;if&nbsp;(actor&nbsp;~=&nbsp;player)&nbsp;act_requester&nbsp;=&nbsp;player;</span></span>
<span class="tr"><span class="th" id="line397">397</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line398">398</span><span class="td">&nbsp;inp1&nbsp;=&nbsp;0;&nbsp;inp2&nbsp;=&nbsp;0;&nbsp;multiflag&nbsp;=&nbsp;false;</span></span>
<span class="tr"><span class="th" id="line399">399</span><span class="td">&nbsp;if&nbsp;(parser_results--&gt;NO_INPS_PRES&nbsp;&gt;=&nbsp;1)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line400">400</span><span class="td">&nbsp;&nbsp;inp1&nbsp;=&nbsp;parser_results--&gt;INP1_PRES;&nbsp;if&nbsp;(inp1&nbsp;==&nbsp;0)&nbsp;multiflag&nbsp;=&nbsp;true;</span></span>
<span class="tr"><span class="th" id="line401">401</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line402">402</span><span class="td">&nbsp;if&nbsp;(parser_results--&gt;NO_INPS_PRES&nbsp;&gt;=&nbsp;2)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line403">403</span><span class="td">&nbsp;&nbsp;inp2&nbsp;=&nbsp;parser_results--&gt;INP2_PRES;&nbsp;if&nbsp;(inp2&nbsp;==&nbsp;0)&nbsp;multiflag&nbsp;=&nbsp;true;</span></span>
<span class="tr"><span class="th" id="line404">404</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line405">405</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line406">406</span><span class="td">&nbsp;if&nbsp;(inp1&nbsp;==&nbsp;1)&nbsp;noun&nbsp;=&nbsp;nothing;&nbsp;else&nbsp;noun&nbsp;=&nbsp;inp1;</span></span>
<span class="tr"><span class="th" id="line407">407</span><span class="td">&nbsp;if&nbsp;(inp2&nbsp;==&nbsp;1)&nbsp;second&nbsp;=&nbsp;nothing;&nbsp;else&nbsp;second&nbsp;=&nbsp;inp2;</span></span>
<span class="tr"><span class="th" id="line408">408</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line409">409</span><span class="td">&nbsp;if&nbsp;(multiflag)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line410">410</span><span class="td">&nbsp;&nbsp;if&nbsp;(multiple_object--&gt;0&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line411">411</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(actor&nbsp;==&nbsp;player)&nbsp;{&nbsp;GENERATE_ACTION_RM(&#39;B&#39;);&nbsp;new_line;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line412">412</span><span class="td">&nbsp;&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line413">413</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line414">414</span><span class="td">&nbsp;&nbsp;if&nbsp;(toomany_flag)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line415">415</span><span class="td">&nbsp;&nbsp;&nbsp;toomany_flag&nbsp;=&nbsp;false;</span></span>
<span class="tr"><span class="th" id="line416">416</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(actor&nbsp;==&nbsp;player)&nbsp;{&nbsp;GENERATE_ACTION_RM(&#39;A&#39;);&nbsp;}</span></span>
<span class="tr"><span class="th" id="line417">417</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line418">418</span><span class="td">&nbsp;&nbsp;i&nbsp;=&nbsp;multiple_object--&gt;0;</span></span>
<span class="tr"><span class="th" id="line419">419</span><span class="td">&nbsp;&nbsp;FollowRulebook(MULTIPLE_ACTION_PROCESSING_RB);</span></span>
<span class="tr"><span class="th" id="line420">420</span><span class="td">&nbsp;&nbsp;if&nbsp;((multiple_object--&gt;0&nbsp;==&nbsp;1)&nbsp;&amp;&amp;&nbsp;(i&nbsp;&gt;&nbsp;1))&nbsp;{</span></span>
<span class="tr"><span class="th" id="line421">421</span><span class="td">&nbsp;&nbsp;&nbsp;multiflag&nbsp;=&nbsp;false;</span></span>
<span class="tr"><span class="th" id="line422">422</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(inp1&nbsp;==&nbsp;0)&nbsp;noun&nbsp;=&nbsp;multiple_object--&gt;1;</span></span>
<span class="tr"><span class="th" id="line423">423</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;((inp2&nbsp;==&nbsp;0)&nbsp;&amp;&amp;&nbsp;(parser_results--&gt;NO_INPS_PRES&nbsp;&gt;=&nbsp;2))</span></span>
<span class="tr"><span class="th" id="line424">424</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;=&nbsp;multiple_object--&gt;1;</span></span>
<span class="tr"><span class="th" id="line425">425</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line426">426</span><span class="td">&nbsp;&nbsp;if&nbsp;(multiple_object--&gt;0&nbsp;==&nbsp;0)&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line427">427</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line428">428</span><span class="td">&nbsp;</span></span>
<span class="tr"><span class="th" id="line429">429</span><span class="td">&nbsp;if&nbsp;(multiflag)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line430">430</span><span class="td">&nbsp;&nbsp;GenerateMultipleActions();</span></span>
<span class="tr"><span class="th" id="line431">431</span><span class="td">&nbsp;&nbsp;multiflag&nbsp;=&nbsp;false;</span></span>
<span class="tr"><span class="th" id="line432">432</span><span class="td">&nbsp;}&nbsp;else&nbsp;BeginAction(action,&nbsp;noun,&nbsp;second);</span></span>
<span class="tr"><span class="th" id="line433">433</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line434">434</span><span class="td">&nbsp;if&nbsp;((actor&nbsp;~=&nbsp;player)&nbsp;||&nbsp;(act_requester))&nbsp;action&nbsp;=&nbsp;##Wait;</span></span>
<span class="tr"><span class="th" id="line435">435</span><span class="td">&nbsp;actor&nbsp;=&nbsp;player;&nbsp;act_requester&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line436">436</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line437">437</span><span class="td">&nbsp;if&nbsp;(meta)&nbsp;{&nbsp;RulebookSucceeds();&nbsp;rtrue;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line438">438</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line439">439</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Generate Multiple Actions.</h3><p><p> So this routine is used to issue the individual actions necessary when a multiple object list has been supplied as either the noun or second noun part of an action generated by the parser. Note that we stop processing the list in the event of the game ending, or of the <span class="fixed"><a href="./Output.i6t.html#line169">location</a></span> variable changing its value, which can happen either through movement of the player, or through passage from darkness to light or vice versa.<p></p><p> We use <span class="fixed"><a href="./Printing.i6t.html#line208">RunParagraphOn</a></span> to omit skipped lines as paragraph breaks between the results from any item in the list: this is both more condensed on screen in ordinary lists, and might allow the user to play tricks such as gathering up reports from a list and delivering them later in some processed way.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line455">455</span><span class="td">[&nbsp;GenerateMultipleActions&nbsp;initial_location&nbsp;k&nbsp;item;</span></span>
<span class="tr"><span class="th" id="line456">456</span><span class="td">&nbsp;initial_location&nbsp;=&nbsp;location;</span></span>
<span class="tr"><span class="th" id="line457">457</span><span class="td">&nbsp;for&nbsp;(k=1:&nbsp;k&lt;=multiple_object--&gt;0:&nbsp;k++)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line458">458</span><span class="td">&nbsp;&nbsp;item&nbsp;=&nbsp;multiple_object--&gt;k;</span></span>
<span class="tr"><span class="th" id="line459">459</span><span class="td">&nbsp;&nbsp;RunParagraphOn();</span></span>
<span class="tr"><span class="th" id="line460">460</span><span class="td">&nbsp;&nbsp;if&nbsp;(inp1&nbsp;==&nbsp;0)&nbsp;{&nbsp;inp1&nbsp;=&nbsp;item;&nbsp;BeginAction(action,&nbsp;item,&nbsp;second,&nbsp;item);&nbsp;inp1&nbsp;=&nbsp;0;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line461">461</span><span class="td">&nbsp;&nbsp;else&nbsp;{&nbsp;inp2&nbsp;=&nbsp;item;&nbsp;BeginAction(action,&nbsp;noun,&nbsp;item,&nbsp;item);&nbsp;inp2&nbsp;=&nbsp;0;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line462">462</span><span class="td">&nbsp;&nbsp;if&nbsp;(deadflag)&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line463">463</span><span class="td">&nbsp;&nbsp;if&nbsp;(location&nbsp;~=&nbsp;initial_location)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line464">464</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(player&nbsp;==&nbsp;actor)&nbsp;{&nbsp;ACTION_PROCESSING_INTERNAL_RM(&#39;J&#39;);&nbsp;new_line;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line465">465</span><span class="td">&nbsp;&nbsp;&nbsp;return;</span></span>
<span class="tr"><span class="th" id="line466">466</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line467">467</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line468">468</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Timed Events Rule.</h3><p><p> A timed event is a rule stored in the <span class="fixed">TimedEventsTable</span>, an I6 table array: zero entries in this table are ignored, and the sequence is significant only if more than one event goes off at the same moment, in which case earlier entries go off first. Each rule in the table has a corresponding timer value in <span class="fixed">TimedEventTimesTable</span>. If this is negative, it represents a number of turns to go before the event happens &ndash; or properly speaking, the number of times the timed events rule is invoked. Otherwise the timer value must be a valid time of day at which the event happens (note that valid times are all non-negative integers). We allow a bracket of 30 minutes after the event time proper; this is designed to cope with situations in which the user sets some timed events, then advances the clock by hand (or uses a long step time, say in which each turn equates to 20 minutes).<p></p><p> Because an event is struck out of the table just before it is fired, it will not continue to go off the rest of the half-hour. Moreover, because the striking out happens <strong> before</strong> rather than after the rule fires, a rule can re-time itself to go off again later, somewhat like the snooze feature on an alarm clock, without the risk of it going off again immediately in the same use of the timed events rule: there is guaranteed to be a blank slot in the timer array at or before the current position because we have just blanked one.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line494">494</span><span class="td">[&nbsp;TIMED_EVENTS_R&nbsp;i&nbsp;d&nbsp;event_timer&nbsp;fire&nbsp;rule;</span></span>
<span class="tr"><span class="th" id="line495">495</span><span class="td">&nbsp;for&nbsp;(i=1:&nbsp;i&lt;=(TimedEventsTable--&gt;0):&nbsp;i++)</span></span>
<span class="tr"><span class="th" id="line496">496</span><span class="td">&nbsp;&nbsp;if&nbsp;((rule=TimedEventsTable--&gt;i)&nbsp;~=&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line497">497</span><span class="td">&nbsp;&nbsp;&nbsp;event_timer&nbsp;=&nbsp;TimedEventTimesTable--&gt;i;&nbsp;fire&nbsp;=&nbsp;false;</span></span>
<span class="tr"><span class="th" id="line498">498</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(event_timer&lt;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line499">499</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;(TimedEventTimesTable--&gt;i)++;</span></span>
<span class="tr"><span class="th" id="line500">500</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(TimedEventTimesTable--&gt;i&nbsp;==&nbsp;0)&nbsp;fire&nbsp;=&nbsp;true;</span></span>
<span class="tr"><span class="th" id="line501">501</span><span class="td">&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line502">502</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;(the_time&nbsp;-&nbsp;event_timer&nbsp;+&nbsp;TWENTY_FOUR_HOURS)&nbsp;%&nbsp;TWENTY_FOUR_HOURS;</span></span>
<span class="tr"><span class="th" id="line503">503</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((d&nbsp;&gt;=&nbsp;0)&nbsp;&amp;&amp;&nbsp;(d&nbsp;&lt;&nbsp;30))&nbsp;fire&nbsp;=&nbsp;true;</span></span>
<span class="tr"><span class="th" id="line504">504</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line505">505</span><span class="td">&nbsp;&nbsp;&nbsp;if&nbsp;(fire)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line506">506</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;TimedEventsTable--&gt;i&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line507">507</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;FollowRulebook(rule);</span></span>
<span class="tr"><span class="th" id="line508">508</span><span class="td">&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line509">509</span><span class="td">&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line510">510</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line511">511</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Setting Timed Events.</h3><p><p> This is the corresponding routine which adds events to the timer tables, and is used to define phrases like &quot;the cuckoo clock explodes in 7 turns from now&quot; or &quot;the cuckoo clock explodes at 4 PM&quot;. Here the <span class="fixed">rule</span> would be &quot;cuckoo clock explodes&quot;, and the <span class="fixed">event_time</span> would either be 4 PM with <span class="fixed">absolute_time</span> set, or simply 7 with <span class="fixed">absolute_time</span> clear.<p></p><p> Note that the same event can occur only once in the timer tables: a new setting for its firing overwrites an old one. (This ensures that the table does not slowly balloon in size if the user has not been careful to ensure that events always fire.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line526">526</span><span class="td">[&nbsp;SetTimedEvent&nbsp;rule&nbsp;event_time&nbsp;absolute_time&nbsp;i&nbsp;b;</span></span>
<span class="tr"><span class="th" id="line527">527</span><span class="td">&nbsp;for&nbsp;(i=1:&nbsp;i&lt;=(TimedEventsTable--&gt;0):&nbsp;i++)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line528">528</span><span class="td">&nbsp;&nbsp;if&nbsp;(rule&nbsp;==&nbsp;TimedEventsTable--&gt;i)&nbsp;{&nbsp;b=i;&nbsp;break;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line529">529</span><span class="td">&nbsp;&nbsp;if&nbsp;((b==0)&nbsp;&amp;&amp;&nbsp;(TimedEventsTable--&gt;i&nbsp;==&nbsp;0))&nbsp;b=i;</span></span>
<span class="tr"><span class="th" id="line530">530</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line531">531</span><span class="td">&nbsp;if&nbsp;(b==0)&nbsp;return&nbsp;RunTimeProblem(RTP_TOOMANYEVENTS);</span></span>
<span class="tr"><span class="th" id="line532">532</span><span class="td">&nbsp;TimedEventsTable--&gt;b&nbsp;=&nbsp;rule;</span></span>
<span class="tr"><span class="th" id="line533">533</span><span class="td">&nbsp;if&nbsp;(absolute_time)&nbsp;TimedEventTimesTable--&gt;b&nbsp;=&nbsp;event_time;</span></span>
<span class="tr"><span class="th" id="line534">534</span><span class="td">&nbsp;else&nbsp;TimedEventTimesTable--&gt;b&nbsp;=&nbsp;-event_time;</span></span>
<span class="tr"><span class="th" id="line535">535</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Setting Time Of Day.</h3><p><p> This is the old I6 library routine <span class="fixed"><a href="./OrderOfPlay.i6t.html#line544">SetTime</a></span>, which is no longer used in I7 at present; but might be, some day.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line542">542</span><span class="td">Global&nbsp;time_step;</span></span>
<span class="tr"><span class="th" id="line543">543</span><span class="td"></span></span>
<span class="tr"><span class="th" id="line544">544</span><span class="td">[&nbsp;SetTime&nbsp;t&nbsp;s;</span></span>
<span class="tr"><span class="th" id="line545">545</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;the_time&nbsp;=&nbsp;t;&nbsp;time_rate&nbsp;=&nbsp;s;&nbsp;time_step&nbsp;=&nbsp;0;</span></span>
<span class="tr"><span class="th" id="line546">546</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(s&nbsp;&lt;&nbsp;0)&nbsp;time_step&nbsp;=&nbsp;0-s;</span></span>
<span class="tr"><span class="th" id="line547">547</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Advance Time Rule.</h3><p><p> This rule advances the two measures of the passing of time: the number of <span class="fixed"><a href="./Output.i6t.html#line208">turns</a></span> of play, and <span class="fixed"><a href="./Output.i6t.html#line209">the_time</a></span> of day.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line554">554</span><span class="td">[&nbsp;ADVANCE_TIME_R;</span></span>
<span class="tr"><span class="th" id="line555">555</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;turns++;</span></span>
<span class="tr"><span class="th" id="line556">556</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(the_time&nbsp;~=&nbsp;NULL)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line557">557</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(time_rate&nbsp;&gt;=&nbsp;0)&nbsp;the_time&nbsp;=&nbsp;the_time+time_rate;</span></span>
<span class="tr"><span class="th" id="line558">558</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{</span></span>
<span class="tr"><span class="th" id="line559">559</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time_step--;</span></span>
<span class="tr"><span class="th" id="line560">560</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(time_step&nbsp;==&nbsp;0)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line561">561</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the_time++;</span></span>
<span class="tr"><span class="th" id="line562">562</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time_step&nbsp;=&nbsp;-time_rate;</span></span>
<span class="tr"><span class="th" id="line563">563</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line564">564</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line565">565</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the_time&nbsp;=&nbsp;the_time&nbsp;%&nbsp;TWENTY_FOUR_HOURS;</span></span>
<span class="tr"><span class="th" id="line566">566</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line567">567</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line568">568</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Note Object Acquisitions Rule.</h3><p><p> See the Standard Rules for comment on this.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line574">574</span><span class="td">[&nbsp;NOTE_OBJECT_ACQUISITIONS_R&nbsp;obj;</span></span>
<span class="tr"><span class="th" id="line575">575</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;objectloop&nbsp;(obj&nbsp;in&nbsp;player)&nbsp;give&nbsp;obj&nbsp;moved;</span></span>
<span class="tr"><span class="th" id="line576">576</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;objectloop&nbsp;(obj&nbsp;has&nbsp;concealed)</span></span>
<span class="tr"><span class="th" id="line577">577</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(IndirectlyContains(player,&nbsp;obj))&nbsp;give&nbsp;obj&nbsp;~concealed;</span></span>
<span class="tr"><span class="th" id="line578">578</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;#Ifdef&nbsp;RUCKSACK_CLASS;</span></span>
<span class="tr"><span class="th" id="line579">579</span><span class="td">&nbsp;objectloop&nbsp;(obj&nbsp;in&nbsp;player)</span></span>
<span class="tr"><span class="th" id="line580">580</span><span class="td">&nbsp;&nbsp;if&nbsp;(obj&nbsp;ofclass&nbsp;RUCKSACK_CLASS)</span></span>
<span class="tr"><span class="th" id="line581">581</span><span class="td">&nbsp;&nbsp;&nbsp;SACK_OBJECT&nbsp;=&nbsp;obj;</span></span>
<span class="tr"><span class="th" id="line582">582</span><span class="td">&nbsp;objectloop&nbsp;(obj&nbsp;ofclass&nbsp;RUCKSACK_CLASS&nbsp;&amp;&amp;&nbsp;obj&nbsp;provides&nbsp;component_parent</span></span>
<span class="tr"><span class="th" id="line583">583</span><span class="td">&nbsp;&nbsp;&amp;&amp;&nbsp;obj.component_parent&nbsp;==&nbsp;player)</span></span>
<span class="tr"><span class="th" id="line584">584</span><span class="td">&nbsp;&nbsp;SACK_OBJECT&nbsp;=&nbsp;obj;</span></span>
<span class="tr"><span class="th" id="line585">585</span><span class="td">&nbsp;#Endif;</span></span>
<span class="tr"><span class="th" id="line586">586</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line587">587</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Resurrect Player If Asked Rule.</h3><p><p> If a rule in the &quot;when play ends&quot; rulebook set <span class="fixed"><a href="./Output.i6t.html#line204">resurrect_please</a></span>, by executing the &quot;resume the game&quot; phrase, then this is where we notice that: making the shutdown rulebook succeed then tells <span class="fixed"><a href="./Output-Stub.i6t.html#line12">Main</a></span> to fall back into the turn sequence.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line596">596</span><span class="td">[&nbsp;RESURRECT_PLAYER_IF_ASKED_R;</span></span>
<span class="tr"><span class="th" id="line597">597</span><span class="td">&nbsp;if&nbsp;(resurrect_please)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line598">598</span><span class="td">&nbsp;&nbsp;RulebookSucceeds();&nbsp;resurrect_please&nbsp;=&nbsp;false;</span></span>
<span class="tr"><span class="th" id="line599">599</span><span class="td">&nbsp;&nbsp;deadflag&nbsp;=&nbsp;0;&nbsp;story_complete&nbsp;=&nbsp;false;&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line600">600</span><span class="td">&nbsp;}</span></span>
<span class="tr"><span class="th" id="line601">601</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line602">602</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Ask The Final Question Rule.</h3><p><p> And so we come to the bittersweet end: we ask the final question endlessly, until the player gives a reply which takes drastic enough action to destroy the current execution context in the VM, for instance by typing QUIT, RESTART, UNDO or RESTORE. The question and answer are all managed by the activity, which is defined in I7 source text in the Standard Rules.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line612">612</span><span class="td">[&nbsp;ASK_FINAL_QUESTION_R;</span></span>
<span class="tr"><span class="th" id="line613">613</span><span class="td">&nbsp;print&nbsp;&quot;^&quot;;</span></span>
<span class="tr"><span class="th" id="line614">614</span><span class="td">&nbsp;while&nbsp;(true)&nbsp;{</span></span>
<span class="tr"><span class="th" id="line615">615</span><span class="td">&nbsp;&nbsp;CarryOutActivity(DEALING_WITH_FINAL_QUESTION_ACT);</span></span>
<span class="tr"><span class="th" id="line616">616</span><span class="td">&nbsp;&nbsp;DivideParagraphPoint();</span></span>
<span class="tr"><span class="th" id="line617">617</span><span class="td">&nbsp;&nbsp;if&nbsp;(resurrect_please)&nbsp;rtrue;</span></span>
<span class="tr"><span class="th" id="line618">618</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line619">619</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Read The Final Answer Rule.</h3><p><p> This erases the current command, so is a technique we couldn&#39;t use during actual play, but here commands are but a distant memory. So we can use the same buffers for the final question as for game commands.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line627">627</span><span class="td">[&nbsp;READ_FINAL_ANSWER_R;</span></span>
<span class="tr"><span class="th" id="line628">628</span><span class="td">&nbsp;DrawStatusLine();</span></span>
<span class="tr"><span class="th" id="line629">629</span><span class="td">&nbsp;KeyboardPrimitive(buffer,&nbsp;parse);</span></span>
<span class="tr"><span class="th" id="line630">630</span><span class="td">&nbsp;players_command&nbsp;=&nbsp;100&nbsp;+&nbsp;WordCount();</span></span>
<span class="tr"><span class="th" id="line631">631</span><span class="td">&nbsp;num_words&nbsp;=&nbsp;WordCount();</span></span>
<span class="tr"><span class="th" id="line632">632</span><span class="td">&nbsp;wn&nbsp;=&nbsp;1;</span></span>
<span class="tr"><span class="th" id="line633">633</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line634">634</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Immediately Restart VM Rule.</h3><p><p> Now for four rules acting on typical responses to the final question.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line640">640</span><span class="td">[&nbsp;IMMEDIATELY_RESTART_VM_R;&nbsp;@restart;&nbsp;];</span></span>
</div><div class='text'>
<h3>Immediately Restore Saved Game Rule.</h3><p><p> It is almost certainly unnecessary to set <span class="fixed"><a href="./Output.i6t.html#line237">actor</a></span> to <span class="fixed"><a href="./Output.i6t.html#line228">player</a></span> here, but we do so just in case, because <span class="fixed"><a href="./Glulx.i6t.html#line2024">RESTORE_THE_GAME_R</a></span> is protected against doing anything when it thinks it might have been called erroneously through a command like &quot;DAPHNE, RESTORE&quot;. (Out of world actions should never be carried out that way, but again, it&#39;s a precaution.)<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line650">650</span><span class="td">[&nbsp;IMMEDIATELY_RESTORE_SAVED_R;&nbsp;actor&nbsp;=&nbsp;player;&nbsp;RESTORE_THE_GAME_R();&nbsp;];</span></span>
</div><div class='text'>
<h3>Immediately Quit Rule.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line655">655</span><span class="td">[&nbsp;IMMEDIATELY_QUIT_R;&nbsp;@quit;&nbsp;];</span></span>
</div><div class='text'>
<h3>Immediately Undo Rule.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line660">660</span><span class="td">[&nbsp;IMMEDIATELY_UNDO_R;&nbsp;Perform_Undo();&nbsp;];</span></span>
</div><div class='text'>
<h3>Print Obituary Headline Rule.</h3><p><p> Finally, definitions of three primitive rules for the &quot;printing the player&#39;s obituary&quot; activity.<p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line667">667</span><span class="td">[&nbsp;PRINT_OBITUARY_HEADLINE_R;</span></span>
<span class="tr"><span class="th" id="line668">668</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;^^&nbsp;&nbsp;&nbsp;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line669">669</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;VM_Style(ALERT_VMSTY);</span></span>
<span class="tr"><span class="th" id="line670">670</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;***&quot;;</span></span>
<span class="tr"><span class="th" id="line671">671</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(deadflag&nbsp;==&nbsp;1)&nbsp;PRINT_OBITUARY_HEADLINE_RM(&#39;A&#39;);</span></span>
<span class="tr"><span class="th" id="line672">672</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(deadflag&nbsp;==&nbsp;2)&nbsp;PRINT_OBITUARY_HEADLINE_RM(&#39;B&#39;);</span></span>
<span class="tr"><span class="th" id="line673">673</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(deadflag&nbsp;==&nbsp;3)&nbsp;PRINT_OBITUARY_HEADLINE_RM(&#39;C&#39;);</span></span>
<span class="tr"><span class="th" id="line674">674</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(deadflag&nbsp;~=&nbsp;0&nbsp;or&nbsp;1&nbsp;or&nbsp;2&nbsp;or&nbsp;3)&nbsp;&nbsp;{</span></span>
<span class="tr"><span class="th" id="line675">675</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line676">676</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_TY_Say(deadflag);</span></span>
<span class="tr"><span class="th" id="line677">677</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;&nbsp;&quot;;</span></span>
<span class="tr"><span class="th" id="line678">678</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>
<span class="tr"><span class="th" id="line679">679</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;***&quot;;</span></span>
<span class="tr"><span class="th" id="line680">680</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;VM_Style(NORMAL_VMSTY);</span></span>
<span class="tr"><span class="th" id="line681">681</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;^^&quot;;&nbsp;#Ifndef&nbsp;NO_SCORING;&nbsp;print&nbsp;&quot;^&quot;;&nbsp;#Endif;</span></span>
<span class="tr"><span class="th" id="line682">682</span><span class="td">&nbsp;&nbsp;&nbsp;&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line683">683</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Print Final Score Rule.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line688">688</span><span class="td">[&nbsp;PRINT_FINAL_SCORE_R;</span></span>
<span class="tr"><span class="th" id="line689">689</span><span class="td">&nbsp;#Iftrue&nbsp;USE_SCORING&nbsp;~=&nbsp;0;&nbsp;ANNOUNCE_SCORE_R();&nbsp;#Endif;</span></span>
<span class="tr"><span class="th" id="line690">690</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line691">691</span><span class="td">];</span></span>
</div><div class='text'>
<h3>Display Final Status Line Rule.</h3><p><p></p><p></div><div class="pre">
<span class="tr"><span class="th" id="line696">696</span><span class="td">[&nbsp;DISPLAY_FINAL_STATUS_LINE_R;</span></span>
<span class="tr"><span class="th" id="line697">697</span><span class="td">&nbsp;sline1&nbsp;=&nbsp;score;&nbsp;sline2&nbsp;=&nbsp;turns;</span></span>
<span class="tr"><span class="th" id="line698">698</span><span class="td">&nbsp;rfalse;</span></span>
<span class="tr"><span class="th" id="line699">699</span><span class="td">];</span></span>
</div><footer><hr><p><em>From I6T lib 6/12N &copy; Graham Nelson and published under the <a href="https://github.com/zedlopez/standard_rules/blob/main/LICENSE.md">Artistic License 2.0</a>. Distributed with <a href="http://inform7.com/">Inform 7 6M62</a>.</em></p></footer></body></html>
