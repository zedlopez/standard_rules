<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head><title>Introduction</title>
  <style>
span.th, span.td { display: table-cell; }
span.td { padding-left: 2rem; }
span.th { width:4rem; text-align: right; }
span.tr { display: table-row;     counter-increment: linenum; }
span.line_no::before {
    content: counter(linenum);
    text-align: right;
    display: block;
    font-family: monospace;
    font-weight: normal;
}
h1 { margin: 0; }
.fixed { font-family: monospace }
.em { font-style: italic; }
.center { text-align: center; }
    body { font-family: sans-serif; margin: 1.5rem 0 0 3rem; background-color: #fafaf0; width: 80rem; }
    .pre { font-family: monospace; margin: auto; width: 80rem; }
#front_matter,.text { width: 50rem; }
.text { border-bottom: .5px solid black; border-top: .5px solid black; margin-top: 1rem;
padding-bottom: 1rem; margin-bottom: 2rem; }
/*.subtitle { font-weight: bold; font-size: 1.2rem; }*/
    </style>
</head>
<body>
<header>
<h1>I6 Template Layer</h1>
<div class="subtitle"><a href="http://inform7.com/">Inform 7 6M62</a> &bull; <a href="./index.html">Index</a> &bull; <a href="./Introduction.i6t.html">Introduction</a></div><hr></header>
<div id="front_matter">
<h2><a href="./Introduction.i6t">Introduction.i6t</a></h2><h3 id="#introduction-the-software-stack">The Software Stack.</h3><p><p> The term &quot;software stack&quot; is sometimes used to refer to the total body of code running in a computer. As the word &quot;stack&quot; implies, there tends to be a fairly clear division between components, and an architecture in which one component is supported by another. The ground on which the stack rests is the hardware. Then come device drivers, for communicating with hardware, and a kernel of very low-level code to regulate who talks to the hardware and when. On top of that are usually several layers of operating-system facilities and utility programs, and on top of all of that are Firefox, iTunes and other consumer programs which the user has made a conscious decision to run. These top-level programs are visible, while the lower layers are concealed from the user and are generally very reliable, so it is easy to forget that they are there at all.<p></p><p> Similarly, when writing and testing a work with I7, it&#39;s easy to think that the only code running is the code directly generated by the source text. In fact, though, it runs inside a simulated computer called the virtual machine (or VM), and the VM has a software stack just as other computers do. Here the distinction between &quot;program&quot; and &quot;operating system&quot; is more blurred, because it can afford to be &ndash; the VM only ever has a single program running, and is not connected to any valuable hardware or data, so there is no need to protect the system&#39;s integrity from a malicious program, or to protect one program from the failings of another running at the same time. But there is still a recognisable software stack. From top to bottom, the VM at run-time contains:<p></p><p> (a) The rules, text and tables written by the author of this specific work of IF; (b) Material contributed by Extensions which the author chose to borrow from; (c) Rules, phrases and other constructions made by the Standard Rules extension, whose use is compulsory; (d1) Infrastructure for rulebooks and code for maintaining a world model common to all works of IF; (d2) The code needed to manage complex data structures such as relations, tables, texts, and so on; (e) The interface to the VM, which is abstracted so that higher levels do not need to know whether Glulx or the Z-machine is being used.<p></p><p> Here (d1) and (d2) are independent blocks, so the picture is roughly so:<p></p><p></p><div class="center em"> the player typing at a keyboard</div><p></p><p></p><div class="center">(a) MATERIAL WRITTEN BY THE AUTHOR</div><p></p><p></p><div class="center">(b) EXTENSIONS CHOSEN BY THE AUTHOR</div><p></p><p></p><div class="center">(c) THE STANDARD RULES</div><p></p><p></p><div class="center">(d1) MECHANICS OF PLAY&emsp;&emsp;(d2) DATA STRUCTURE SUPPORT</div><p></p><p></p><div class="center">(e) VIRTUAL MACHINE INTERFACE</div><p></p><p></p><div class="center em"> virtual machine &quot;hardware&quot;</div><p></p><p> NI is not like a compiler for a conventional program, because it has to conjure up the entire software stack whenever it compiles anything. (Until 2008, NI compiled code which ran on top of the traditional I6 library:nowadays it compiles stand-alone code which never uses the <span class="fixed">#Include</span><br> directive. While it&#39;s true that the I6 compiler does add a very thin extra layer of code itself &ndash; the &quot;veneer&quot; &ndash; in all other respects NI specifies every single line of I6 code which makes up the eventual story file.)<p></p><p> NI compiles layers (a), (b) and (c) from the I7 source text found in the project file, in the Extensions installed by the user, and in the Standard Rules extension which comes pre-installed. But parts (d1), (d2) and (e) are almost exactly the same I6 code whatever may be sitting above them: they are simply copied, with minor variations, from a large body of standing code installed in the I7 application which is called the &quot;template&quot;.<p></p><p><h3 id="#introduction-segments-and-paragraphs">Segments and Paragraphs.</h3><p><p> The template is divided into about 40 individual &quot;segments&quot;, each stored in its own file and with the <span class="fixed">.i6t</span> file extensions. This stands for &quot;I6 template&quot;, because the code generated by NI is Inform 6 (I6) code. What makes the file a template rather than being raw code is that it is divided into named paragraphs which contain both commentary and also I6 code: when NI turns a template into the output code, the commentary (and each paragraph heading) is stripped out.<p></p><p> See the Inform documentation for how to modify the template in use for any particular project: I6 code can be added before, instead of or after any named segment or paragraph, and in addition, it&#39;s possible to replace entire segment files with your own versions stored in the Materials folder for a project.<p></p><p><h3 id="#introduction-architecture">Architecture.</h3><p><p> To recap, then, the template contributes the following parts of the software stack:<p></p><p></p><div class="center">(d1) MECHANICS OF PLAY&emsp;&emsp;(d2) DATA STRUCTURE SUPPORT</div><p></p><p></p><div class="center">(e) VIRTUAL MACHINE INTERFACE</div><p></p><p> A more detailed version of how this diagram organises its segments follows:<p></p><p> <strong> NI Control</strong>. <a href="./Main.i6t.html">Main.i6t</a>, <a href="./Load-Core.i6t.html">Load-Core.i6t</a> (and several others like it), <a href="./Output.i6t.html">Output.i6t</a>, <a href="./Definitions.i6t.html">Definitions.i6t</a>.<p></p><p> <strong> Mechanics of Play I: Rules</strong>. <a href="./OrderOfPlay.i6t.html">OrderOfPlay.i6t</a>, <a href="./Actions.i6t.html">Actions.i6t</a>, <a href="./Activities.i6t.html">Activities.i6t</a>, <a href="./Rulebooks.i6t.html">Rulebooks.i6t</a>.<p></p><p> <strong> II: Infrastructure</strong>. <a href="./Parser.i6t.html">Parser.i6t</a>, <a href="./ListWriter.i6t.html">ListWriter.i6t</a>, <a href="./OutOfWorld.i6t.html">OutOfWorld.i6t</a>, <a href="./WorldModel.i6t.html">WorldModel.i6t</a>, <a href="./Light.i6t.html">Light.i6t</a>, <a href="./Tests.i6t.html">Tests.i6t</a>.<p></p><p> <strong> III: Basic Services</strong>. <a href="./Language.i6t.html">Language.i6t</a>, <a href="./MStack.i6t.html">MStack.i6t</a>, <a href="./Chronology.i6t.html">Chronology.i6t</a>, <a href="./Printing.i6t.html">Printing.i6t</a>, <a href="./RTP.i6t.html">RTP.i6t</a>, <a href="./Utilities.i6t.html">Utilities.i6t</a>.<p></p><p> <strong> Data Structure Support I: Basics</strong>. <a href="./Number.i6t.html">Number.i6t</a>, <a href="./Time.i6t.html">Time.i6t</a>, <a href="./Tables.i6t.html">Tables.i6t</a>, <a href="./Sort.i6t.html">Sort.i6t</a>, <a href="./Relations.i6t.html">Relations.i6t</a>, <a href="./Figures.i6t.html">Figures.i6t</a>.<p></p><p> <strong> II: Block Values</strong>. <a href="./Text.i6t.html">Text.i6t</a>, <a href="./RegExp.i6t.html">RegExp.i6t</a>, <a href="./Char.i6t.html">Char.i6t</a>, <a href="./UnicodeData.i6t.html">UnicodeData.i6t</a>, <a href="./StoredAction.i6t.html">StoredAction.i6t</a>, <a href="./Lists.i6t.html">Lists.i6t</a>, <a href="./RelationKind.i6t.html">RelationKind.i6t</a>, <a href="./BlockValues.i6t.html">BlockValues.i6t</a>, <a href="./Flex.i6t.html">Flex.i6t</a>.<p></p><p> <strong> Virtual Machine Interface</strong>. <a href="./ZMachine.i6t.html">ZMachine.i6t</a> <strong> or</strong> <a href="./Glulx.i6t.html">Glulx.i6t</a> and <a href="./FileIO.i6t.html">FileIO.i6t</a>.<p></p><p> To elaborate:<p></p><p> <strong> NI Control</strong>. As well as containing commentary and I6 code, template files can also contain commands to tell NI to do something more interesting than simply copying over material verbatim into its output. Four of the segments use this ability a great deal: the remaining segments hardly use it at all. These four segments therefore don&#39;t fit anywhere in the diagram of the software stack above. <a href="./Main.i6t.html">Main.i6t</a> controls the top-level logic of NI and gives the sequence of operations; <a href="./Load-.i6t.html">Load-.i6t</a> specifies the basic kinds of value known to NI &ndash; numbers, times, texts, rulebooks and so on; <a href="./Output.i6t.html">Output.i6t</a> is essentially the arrangement used to join all the many fragments of I6 from the template and the I7 source text into a single end-to-end I6 program which will become the story file; <a href="./Definitions.i6t.html">Definitions.i6t</a> defines many named constants which are used across the template.<p></p><p> <strong> Mechanics of Play I: Rules</strong>. <a href="./OrderOfPlay.i6t.html">OrderOfPlay.i6t</a> is the highest-level description of what happens when a story file runs: it contains the I6 <span class="fixed"><a href="./Output-Stub.i6t.html#line12">Main</a></span> routine, and definitions of the primitive rules in the most important rulebooks. <p></p><p> <a href="./Actions.i6t.html">Actions.i6t</a> and <a href="./Activities.i6t.html">Activities.i6t</a> contain code which runs actions and activities, respectively: these sit on top of <a href="./Rulebooks.i6t.html">Rulebooks.i6t</a>, which performs general rulebook-running.<p></p><p> <strong> Mechanics of Play II: Infrastructure</strong>. <a href="./Parser.i6t.html">Parser.i6t</a> breaks down a command typed by the player into a slate of variables which can be formed into an action. <a href="./ListWriter.i6t.html">ListWriter.i6t</a> is a general-purpose service for printing lists of objects satisfying various descriptions, and formatted in different ways. <a href="./OutOfWorld.i6t.html">OutOfWorld.i6t</a> provides code to handle out-of-world actions not needing direct access to VM internals: PRONOUNS and SUPERBRIEF, for instance. <a href="./Tests.i6t.html">Tests.i6t</a> provides code for the testing commands &ndash; TEST, ACTIONS, SHOWME and so forth.<p></p><p> <a href="./WorldModel.i6t.html">WorldModel.i6t</a> contains code for performing object movements and the like in such a way that the world model rules are preserved: it handles component parts, decides touchability and so on. <a href="./Light.i6t.html">Light.i6t</a> determines the level of light and decides on visibility.<p></p><p> <strong> Mechanics of Play III: Basic Services</strong>. <a href="./Language.i6t.html">Language.i6t</a> provides English-language messages issued by template routines and the Standard Rules during play: replacing this segment is the way to translate I7 story files into other languages of play. (It&#39;s the equivalent of the old I6 &quot;language definition files&quot;, and retains most of the same structure.) <a href="./MStack.i6t.html">MStack.i6t</a> provides a small general-purpose memory stack. <a href="./Chronology.i6t.html">Chronology.i6t</a> performs the continuous monitoring required to ensure that past-tense conditions work: for instance we can only determine whether or not &quot;the Black Door has been open&quot; if we have spent the whole time so far checking on whether it is open or not, and this is where the checking is done. <a href="./Printing.i6t.html">Printing.i6t</a> handles paragraph-breaking, the printing of object names with suitable articles attached, and miscellaneous other printing needs. <a href="./RTP.i6t.html">RTP.i6t</a> issues run-time problem messages as needed: these should appear only if the story file does something clearly illegal, and point to bugs not yet removed from the author&#39;s code. <a href="./Utilities.i6t.html">Utilities.i6t</a> provides miscellaneous utility functions at a very low level, such as for unsigned comparison of two numbers.<p></p><p> <strong> Data Structure Support I: Basics</strong>. Many kinds of value need no maintenance, and little or no support. <a href="./Number.i6t.html">Number.i6t</a> and <a href="./Time.i6t.html">Time.i6t</a> contain code to parse numbers and times of day from text typed by the player, together with a few basic operations: for instance, the rounding off of times of day. <a href="./Tables.i6t.html">Tables.i6t</a> provides access to table entries, specified in a variety of direct and indirect ways; this makes use of <a href="./Sort.i6t.html">Sort.i6t</a>, which abstracts a choice of sorting algorithms for use on tables and other I6 data. <a href="./Relations.i6t.html">Relations.i6t</a> provides code for testing and asserting relations: the information about what is related to what else is stored in a variety of different ways, depending on the relation, to make best use of memory. <a href="./Figures.i6t.html">Figures.i6t</a> displays figures and plays back sound effects, or rather, passes instructions to do so down to the VM.<p></p><p> <strong> Data Structure Support II: Block Values</strong>. Kinds of value can be divided into the ordinary ones &ndash; number, object, time and so on &ndash; together with &quot;block values&quot; such as text, stored action and list. Block values have to be stored in dynamically allocated memory from a heap. It would be wasteful to include all of this code, and to spare memory for the heap, if no block values were actually needed, so the following segments are only compiled if the source text makes specific reference to at least one block value. <a href="./Text.i6t.html">Text.i6t</a> manages strings of text, which can shrink or stretch to arbitrary lengths: it makes use of <a href="./RegExp.i6t.html">RegExp.i6t</a> for regular expression matching and search-and-replace; and also of <a href="./Char.i6t.html">Char.i6t</a> for code to deal with lower and upper casing of letters, and <a href="./UnicodeData.i6t.html">UnicodeData.i6t</a> to provide character set details, mechanically converted from the Unicode 4.0 standard. <a href="./StoredAction.i6t.html">StoredAction.i6t</a> manages stored actions: it can convert the current action into a stored one, and also try a long-stored action so that it now takes place. <a href="./Lists.i6t.html">Lists.i6t</a> manages the flexibly sized lists produced by values whose kind is list of numbers, list of texts, list of lists of lists of stored actions, and so forth: it can merge, insert, delete, resize, rotate, and reverse lists, and makes use once again of <a href="./Sort.i6t.html">Sort.i6t</a> (q.v.) to sort them.<p></p><p> <a href="./BlockValues.i6t.html">BlockValues.i6t</a> provides the basic support for kinds of value which can&#39;t be stored as single words of data.<p></p><p> At the lowest level, <a href="./Flex.i6t.html">Flex.i6t</a> manages flexible memory allocation as required by <a href="./BlockValues.i6t.html">BlockValues.i6t</a>: it organises the heap of unclaimed memory, for instance, and maks allocations and deallocations when needed.<p></p><p> <strong> Virtual Machine Interface</strong>. Depending on the Settings used for the I7 project being compiled, we either use <a href="./ZMachine.i6t.html">ZMachine.i6t</a> or <a href="./Glulx.i6t.html">Glulx.i6t</a>: if Glulx, we also add <a href="./FileIO.i6t.html">FileIO.i6t</a>, which provides support for the limited file-handling abilities offered by Glulx.<p></p><p> Properly speaking, there is one further template file: <a href="./Introduction.i6t.html">Introduction.i6t</a>. It provides the commentary you are now reading, but has no other function, contains no code, and is finished now anyway.</div><footer><hr><p><em>From I6T lib 6/12N &copy; Graham Nelson and published under the <a href="https://github.com/zedlopez/standard_rules/blob/main/LICENSE.md">Artistic License 2.0</a>. Distributed with <a href="http://inform7.com/">Inform 7 6M62</a>.</em></p></footer></body></html>
